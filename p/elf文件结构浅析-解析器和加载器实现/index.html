<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="前言 近期冲浪刷到大佬博客ELF文件格式, 心血来潮\n网上有不少ELF文件结构相关的文章,但大都介绍原理,具体的代码实现并不多(或许是因为有开源代码)\n">
<title>ELF文件结构浅析-解析器和加载器实现</title>

<link rel='canonical' href='https://example.com/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/'>

<link rel="stylesheet" href="/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css"><meta property='og:title' content="ELF文件结构浅析-解析器和加载器实现">
<meta property='og:description' content="前言 近期冲浪刷到大佬博客ELF文件格式, 心血来潮\n网上有不少ELF文件结构相关的文章,但大都介绍原理,具体的代码实现并不多(或许是因为有开源代码)\n">
<meta property='og:url' content='https://example.com/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/'>
<meta property='og:site_name' content='OrientalGlass'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2024-11-24T16:56:01&#43;08:00'/><meta property='article:modified_time' content='2024-11-24T16:56:01&#43;08:00'/><meta property='og:image' content='https://example.com/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/1-%E7%9B%AE%E6%A0%87%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F.png' />
<meta name="twitter:title" content="ELF文件结构浅析-解析器和加载器实现">
<meta name="twitter:description" content="前言 近期冲浪刷到大佬博客ELF文件格式, 心血来潮\n网上有不少ELF文件结构相关的文章,但大都介绍原理,具体的代码实现并不多(或许是因为有开源代码)\n"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://example.com/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/1-%E7%9B%AE%E6%A0%87%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F.png' />
    <link rel="shortcut icon" href="/favicon.jpg" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu_149d93b4b8d2abf8.jpg" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">OrientalGlass</a></h1>
            <h2 class="site-description">Welcome to my blog!</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://space.bilibili.com/21031513'
                        target="_blank"
                        title="Bilibili"
                        rel="me"
                    >
                        
                        
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-brand-bilibili"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 10a4 4 0 0 1 4 -4h10a4 4 0 0 1 4 4v6a4 4 0 0 1 -4 4h-10a4 4 0 0 1 -4 -4v-6z" /><path d="M8 3l2 3" /><path d="M16 3l-2 3" /><path d="M9 13v-2" /><path d="M15 11v2" /></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='oriental0glass@gmail.com'
                        target="_blank"
                        title="Eamil"
                        rel="me"
                    >
                        
                        
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-mail"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 7a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v10a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-10z" /><path d="M3 7l9 6l9 -6" /></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/OrientalGlass'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>主页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#前言">前言</a></li>
    <li><a href="#elf文件结构概述">ELF文件结构概述</a></li>
    <li><a href="#elf-header">ELF Header</a>
      <ol>
        <li><a href="#e_ident">e_ident</a></li>
        <li><a href="#e_type">e_type</a></li>
        <li><a href="#e_machine">e_machine</a></li>
        <li><a href="#e_version">e_version</a></li>
        <li><a href="#e_entry">e_entry</a></li>
        <li><a href="#e_phoff">e_phoff</a></li>
        <li><a href="#e_shoff">e_shoff</a></li>
        <li><a href="#e_flags">e_flags</a></li>
        <li><a href="#e_ehsize">e_ehsize</a></li>
        <li><a href="#e_phentsize">e_phentsize</a></li>
        <li><a href="#e_phnum">e_phnum</a></li>
        <li><a href="#e_shentsize">e_shentsize</a></li>
        <li><a href="#e_shnum">e_shnum</a></li>
        <li><a href="#e_shstrndx">e_shstrndx</a></li>
        <li><a href="#打印文件头">打印文件头</a></li>
      </ol>
    </li>
    <li><a href="#section-header">Section Header</a>
      <ol>
        <li><a href="#sh_name">sh_name</a></li>
        <li><a href="#sh_type">sh_type</a></li>
        <li><a href="#sh_flags">sh_flags</a></li>
        <li><a href="#sh_addr">sh_addr</a></li>
        <li><a href="#sh_offset">sh_offset</a></li>
        <li><a href="#sh_size">sh_size</a></li>
        <li><a href="#sh_link">sh_link</a></li>
        <li><a href="#sh_info">sh_info</a></li>
        <li><a href="#sh_addralign">sh_addralign</a></li>
        <li><a href="#sh_entsize">sh_entsize</a></li>
        <li><a href="#打印节表头">打印节表头</a></li>
      </ol>
    </li>
    <li><a href="#program-header">Program Header</a>
      <ol>
        <li><a href="#p_type">p_type</a></li>
        <li><a href="#p_offset">p_offset</a></li>
        <li><a href="#p_vaddr">p_vaddr</a></li>
        <li><a href="#p_paddr">p_paddr</a></li>
        <li><a href="#p_filesz">p_filesz</a></li>
        <li><a href="#p_memsz">p_memsz</a></li>
        <li><a href="#p_flags">p_flags</a></li>
        <li><a href="#p_align">p_align</a></li>
        <li><a href="#打印段表头">打印段表头</a></li>
      </ol>
    </li>
    <li><a href="#特殊节">特殊节</a></li>
    <li><a href="#string-table">String Table</a></li>
    <li><a href="#symbol-table">Symbol Table</a>
      <ol>
        <li><a href="#st_name">st_name</a></li>
        <li><a href="#st_value">st_value</a></li>
        <li><a href="#st_size">st_size</a></li>
        <li><a href="#st_info">st_info</a>
          <ol>
            <li><a href="#symbol-binding">Symbol Binding</a></li>
            <li><a href="#symbol-type">Symbol Type</a></li>
          </ol>
        </li>
        <li><a href="#st_other">st_other</a></li>
        <li><a href="#st_shndx">st_shndx</a></li>
        <li><a href="#打印符号表">打印符号表</a></li>
      </ol>
    </li>
    <li><a href="#relocation-table">Relocation Table</a>
      <ol>
        <li><a href="#r_offset">r_offset</a></li>
        <li><a href="#r_info">r_info</a></li>
        <li><a href="#r_addend">r_addend</a></li>
        <li><a href="#重定位类型">重定位类型</a>
          <ol>
            <li><a href="#r_386_got_dat">R_386_GOT_DAT</a></li>
            <li><a href="#r_386_jmp_slot">R_386_JMP_SLOT</a></li>
            <li><a href="#r_386_relative">R_386_RELATIVE</a></li>
          </ol>
        </li>
        <li><a href="#打印重定位表">打印重定位表</a></li>
        <li><a href="#修复重定位表">修复重定位表</a></li>
      </ol>
    </li>
    <li><a href="#dynamic-segment">Dynamic Segment</a>
      <ol>
        <li><a href="#d_tag">d_tag</a></li>
        <li><a href="#dt_needed">DT_NEEDED</a></li>
        <li><a href="#d_un">d_un</a></li>
        <li><a href="#打印动态段">打印动态段</a></li>
      </ol>
    </li>
    <li><a href="#hash-table-export-table">Hash Table (Export Table)</a>
      <ol>
        <li><a href="#elf-hash">ELF Hash</a>
          <ol>
            <li><a href="#android-elf-hash">Android Elf Hash</a></li>
            <li><a href="#sysv-hash">Sysv Hash</a></li>
          </ol>
        </li>
        <li><a href="#gnu-hash">GNU Hash</a></li>
        <li><a href="#打印哈希表">打印哈希表</a></li>
      </ol>
    </li>
    <li><a href="#elf-loader">ELF Loader</a></li>
    <li><a href="#references">References</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/">
                <img src="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/1-%E7%9B%AE%E6%A0%87%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F_hu_c29df699cd870da4.png"
                        srcset="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/1-%E7%9B%AE%E6%A0%87%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F_hu_c29df699cd870da4.png 800w, /p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/1-%E7%9B%AE%E6%A0%87%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F_hu_e74eac1507f881c5.png 1600w"
                        width="800" 
                        height="756" 
                        loading="lazy"
                        alt="Featured image of post ELF文件结构浅析-解析器和加载器实现" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/android/" >
                Android
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/">ELF文件结构浅析-解析器和加载器实现</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2024-11-24</time>
            </div>
        

        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="前言">前言
</h1><p>近期冲浪刷到大佬博客<a class="link" href="https://xialuohun.top/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F"  target="_blank" rel="noopener"
    >ELF文件格式</a>, 心血来潮</p>
<p>网上有不少ELF文件结构相关的文章,但大都介绍原理,具体的代码实现并不多(或许是因为有开源代码)</p>
<p>然而阅读开源代码不是我的强项(看的头大), 于是依据当年学习PE文件结构的思路,学习ELF文件格式</p>
<p>仿照 readelf 的输出结果编写解析器, 最后编写了简单的ELF加载器</p>
<p>代码支持x86和x64的ELF文件:</p>
<ul>
<li>
<p>解析器针对x86/x64有两套实现, 支持解析x86和x64平台的ELF文件</p>
</li>
<li>
<p>加载器依赖编译环境,只能加载对应平台的ELF文件,要分别编译x86和x64的加载器</p>
</li>
<li>
<p>内容讲解演示主要以x86为主</p>
</li>
</ul>
<p>环境&amp;工具:</p>
<ul>
<li>VMware pro 17.6.1</li>
<li>Kali Linux 2023.4 vmware amd64</li>
<li>gcc (Debian 14.2.0-8) 14.2.0</li>
<li>CLion 2024.2.3</li>
<li>010 Editor 13.0.1</li>
<li>IDA Pro 7.7</li>
</ul>
<p><strong>由于本人水平有限, 内容错误之处还望大佬多多包涵, 批评指正</strong></p>
<h1 id="elf文件结构概述">ELF文件结构概述
</h1><p>ELF是UNIX系统实验室(USL)作为应用程序二进制接口(Application Binary Interface,ABI)而开发和发布的,也是Linux的主要可执行文件格式, 全称是Executable and Linking Format,这个名字相当关键,包含了ELF所需要支持的两个功能——执行和链接</p>
<p>ELF文件包含3大部分,<strong>ELF头,ELF节,ELF段</strong>:</p>
<ul>
<li>
<p>节头表指向节, 类似PE的节表, 描述各个节区的信息</p>
</li>
<li>
<p>程序头表描述段信息,一个段可以包含多个节,指导ELF文件如何映射至文件</p>
</li>
<li>
<p>在OBJ文件中,段是可选的,在可执行文件中,节是可选的,但NDK编译的ELF文件同时有段和节</p>
</li>
</ul>
<p><img src="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/1-%E7%9B%AE%E6%A0%87%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F.png"
	width="471"
	height="445"
	srcset="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/1-%E7%9B%AE%E6%A0%87%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F_hu_edf77d9418ec38da.png 480w, /p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/1-%E7%9B%AE%E6%A0%87%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F_hu_539648ae793f3a43.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="105"
		data-flex-basis="254px"
	
></p>
<p>ELF文件封装了部分数据类型</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">uint16_t</span> <span class="n">Elf32_Half</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">uint16_t</span> <span class="n">Elf64_Half</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Types for signed and unsigned 32-bit quantities.  */</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">uint32_t</span> <span class="n">Elf32_Word</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span>	<span class="kt">int32_t</span>  <span class="n">Elf32_Sword</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">uint32_t</span> <span class="n">Elf64_Word</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span>	<span class="kt">int32_t</span>  <span class="n">Elf64_Sword</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Types for signed and unsigned 64-bit quantities.  */</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">uint64_t</span> <span class="n">Elf32_Xword</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span>	<span class="kt">int64_t</span>  <span class="n">Elf32_Sxword</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">uint64_t</span> <span class="n">Elf64_Xword</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span>	<span class="kt">int64_t</span>  <span class="n">Elf64_Sxword</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Type of addresses.  */</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">uint32_t</span> <span class="n">Elf32_Addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">uint64_t</span> <span class="n">Elf64_Addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Type of file offsets.  */</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">uint32_t</span> <span class="n">Elf32_Off</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">uint64_t</span> <span class="n">Elf64_Off</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Type for section indices, which are 16-bit quantities.  */</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">uint16_t</span> <span class="n">Elf32_Section</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">uint16_t</span> <span class="n">Elf64_Section</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Type for version symbol information.  */</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="n">Elf32_Half</span> <span class="n">Elf32_Versym</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="n">Elf64_Half</span> <span class="n">Elf64_Versym</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以发现,32和64位定义的数据结构仅有Addr和Off有位宽差距,我们可以定义对应的通用类型</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>ELF数据结构</th>
          <th>原始类型</th>
          <th>备注</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Elfn_Half</td>
          <td>uint16_t</td>
          <td></td>
      </tr>
      <tr>
          <td>Elfn_Word</td>
          <td>uint32_t</td>
          <td></td>
      </tr>
      <tr>
          <td>Elfn_Sword</td>
          <td>int32_t</td>
          <td></td>
      </tr>
      <tr>
          <td>Elfn_Xword</td>
          <td>uint64_t</td>
          <td></td>
      </tr>
      <tr>
          <td>Elfn_Sxword</td>
          <td>int64_t</td>
          <td></td>
      </tr>
      <tr>
          <td>Elf32_Addr</td>
          <td>uint32_t</td>
          <td>地址</td>
      </tr>
      <tr>
          <td>Elf64_Addr</td>
          <td>uint64_t</td>
          <td></td>
      </tr>
      <tr>
          <td>Elf32_Off</td>
          <td>uint32_t</td>
          <td>文件偏移</td>
      </tr>
      <tr>
          <td>Elf64_Off</td>
          <td>uint64_t</td>
          <td></td>
      </tr>
      <tr>
          <td>Elfn_Section</td>
          <td>uint16_t</td>
          <td>节索引</td>
      </tr>
      <tr>
          <td>Elfn_Versym</td>
          <td>uint16_t</td>
          <td></td>
      </tr>
  </tbody>
</table></div>
<p>使用gcc分别编译32/64位的elf可执行文件用于测试</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[]){</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Hello ELF!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">gcc -m32 -O0 main.c -o HelloELF32
</span></span><span class="line"><span class="cl">gcc -m64 -O0 main.c -o HelloELF64 
</span></span></code></pre></td></tr></table>
</div>
</div><p>编写ELF解析器/加载器前,定义文件读取函数</p>
<p>读取指定路径文件,返回字节指针和读取文件大小</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// 读取文件,返回buffer和读取字节数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">uint8_t</span><span class="o">*</span> <span class="nf">readFileToBytes</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fileName</span><span class="p">,</span><span class="kt">size_t</span><span class="o">*</span> <span class="n">readSize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">FILE</span> <span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="nf">fopen</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">file</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Error opening file</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fclose</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fseek</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="n">SEEK_END</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">size_t</span> <span class="n">fileSize</span> <span class="o">=</span> <span class="nf">ftell</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fseek</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="n">SEEK_SET</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="nf">malloc</span><span class="p">(</span><span class="n">fileSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Error allocating memory</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fclose</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">size_t</span> <span class="n">bytesRead</span> <span class="o">=</span> <span class="nf">fread</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fileSize</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">bytesRead</span><span class="o">!=</span><span class="n">fileSize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Read bytes not equal file size!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">free</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fclose</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fclose</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">readSize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">readSize</span><span class="o">=</span><span class="n">bytesRead</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="elf-header">ELF Header
</h1><p>定义在elf.h中</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define EI_NIDENT (16)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">typedef</span> <span class="k">struct</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span>    <span class="n">e_ident</span><span class="p">[</span><span class="n">EI_NIDENT</span><span class="p">];</span>    <span class="cm">/* Magic number and other info */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Half</span>    <span class="n">e_type</span><span class="p">;</span>            <span class="cm">/* Object file type */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Half</span>    <span class="n">e_machine</span><span class="p">;</span>        <span class="cm">/* Architecture */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Word</span>    <span class="n">e_version</span><span class="p">;</span>        <span class="cm">/* Object file version */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Addr</span>    <span class="n">e_entry</span><span class="p">;</span>        <span class="cm">/* Entry point virtual address */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Off</span>     <span class="n">e_phoff</span><span class="p">;</span>        <span class="cm">/* Program header table file offset */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Off</span>     <span class="n">e_shoff</span><span class="p">;</span>        <span class="cm">/* Section header table file offset */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Word</span>    <span class="n">e_flags</span><span class="p">;</span>        <span class="cm">/* Processor-specific flags */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Half</span>    <span class="n">e_ehsize</span><span class="p">;</span>        <span class="cm">/* ELF header size in bytes */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Half</span>    <span class="n">e_phentsize</span><span class="p">;</span>        <span class="cm">/* Program header table entry size */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Half</span>    <span class="n">e_phnum</span><span class="p">;</span>        <span class="cm">/* Program header table entry count */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Half</span>    <span class="n">e_shentsize</span><span class="p">;</span>        <span class="cm">/* Section header table entry size */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Half</span>    <span class="n">e_shnum</span><span class="p">;</span>        <span class="cm">/* Section header table entry count */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Half</span>    <span class="n">e_shstrndx</span><span class="p">;</span>        <span class="cm">/* Section header string table index */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">Elf32_Ehdr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//64位
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">typedef</span> <span class="k">struct</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">e_ident</span><span class="p">[</span><span class="n">EI_NIDENT</span><span class="p">];</span>	<span class="cm">/* Magic number and other info */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Half</span>	<span class="n">e_type</span><span class="p">;</span>			<span class="cm">/* Object file type */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Half</span>	<span class="n">e_machine</span><span class="p">;</span>		<span class="cm">/* Architecture */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Word</span>	<span class="n">e_version</span><span class="p">;</span>		<span class="cm">/* Object file version */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Addr</span>	<span class="n">e_entry</span><span class="p">;</span>		<span class="cm">/* Entry point virtual address */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Off</span>		<span class="n">e_phoff</span><span class="p">;</span>		<span class="cm">/* Program header table file offset */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Off</span>		<span class="n">e_shoff</span><span class="p">;</span>		<span class="cm">/* Section header table file offset */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Word</span>	<span class="n">e_flags</span><span class="p">;</span>		<span class="cm">/* Processor-specific flags */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Half</span>	<span class="n">e_ehsize</span><span class="p">;</span>		<span class="cm">/* ELF header size in bytes */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Half</span>	<span class="n">e_phentsize</span><span class="p">;</span>		<span class="cm">/* Program header table entry size */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Half</span>	<span class="n">e_phnum</span><span class="p">;</span>		<span class="cm">/* Program header table entry count */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Half</span>	<span class="n">e_shentsize</span><span class="p">;</span>		<span class="cm">/* Section header table entry size */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Half</span>	<span class="n">e_shnum</span><span class="p">;</span>		<span class="cm">/* Section header table entry count */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Half</span>	<span class="n">e_shstrndx</span><span class="p">;</span>		<span class="cm">/* Section header string table index */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">Elf64_Ehdr</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以使用readelf查看</p>
<p><img src="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/2-ELFHeader.png"
	width="645"
	height="364"
	srcset="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/2-ELFHeader_hu_d9461ec4a9e5bebf.png 480w, /p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/2-ELFHeader_hu_5a608dc22531b8ec.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="177"
		data-flex-basis="425px"
	
></p>
<h2 id="e_ident">e_ident
</h2><p>16字节ELF标识,前4字节是ELF文件标识&quot;\x7fELF&quot;,不可修改</p>
<p><img src="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/3-e_ident.png"
	width="397"
	height="487"
	srcset="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/3-e_ident_hu_a5f3adf0fab1822d.png 480w, /p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/3-e_ident_hu_72f80a274cc2951.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="81"
		data-flex-basis="195px"
	
></p>
<p>010editor中解析如下</p>
<p><img src="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/4-e_ident-010editor.png"
	width="555"
	height="502"
	srcset="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/4-e_ident-010editor_hu_13404a26eda270a7.png 480w, /p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/4-e_ident-010editor_hu_2a732bf62ae133db.png 1024w"
	loading="lazy"
	
		alt="4-e_ident-010editor"
	
	
		class="gallery-image" 
		data-flex-grow="110"
		data-flex-basis="265px"
	
></p>
<ol>
<li>
<p>e_ident[EI_CLASS]</p>
<p>该字节指明了文件类型</p>
<p>Android系统不检查该字节,通过判断指令集v7a/v8a确定是32或64位</p>
<p>IDA检查该字节,如果修改了这个字节,IDA就无法反汇编</p>
<p><img src="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/5-EI_CLASS.png"
	width="387"
	height="196"
	srcset="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/5-EI_CLASS_hu_a6999712b6677ee1.png 480w, /p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/5-EI_CLASS_hu_15b1a9c26a0420b4.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="197"
		data-flex-basis="473px"
	
></p>
</li>
<li>
<p>e_ident[EI_DATA]</p>
<p>该字节指明了目标文件的数据编码格式(大小端序)</p>
<p>Android不检查该字节,默认小端序; IDA检查该字节,如果修改该字节则IDA无法正确反汇编</p>
<p><img src="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/6-EI_DATA.png"
	width="426"
	height="200"
	srcset="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/6-EI_DATA_hu_c54277d883337ca6.png 480w, /p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/6-EI_DATA_hu_98c875de61552459.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="213"
		data-flex-basis="511px"
	
></p>
</li>
<li>
<p>e_ident[EI_VERSION]</p>
<p>ELF文件头的版本</p>
</li>
</ol>
<h2 id="e_type">e_type
</h2><p>2字节,表明目标文件属于哪种类型</p>
<p>Android5.0后,可执行文件全部为so,这个标志只能为03不可修改</p>
<p><img src="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/7-e_type.png"
	width="534"
	height="395"
	srcset="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/7-e_type_hu_4ac6351355a1a928.png 480w, /p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/7-e_type_hu_887caf0645888504.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="135"
		data-flex-basis="324px"
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/* Legal values for e_type (object file type).  */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#define ET_NONE		0		/* No file type */
</span></span><span class="line"><span class="cl">#define ET_REL		1		/* Relocatable file */
</span></span><span class="line"><span class="cl">#define ET_EXEC		2		/* Executable file */
</span></span><span class="line"><span class="cl">#define ET_DYN		3		/* Shared object file */
</span></span><span class="line"><span class="cl">#define ET_CORE		4		/* Core file */
</span></span><span class="line"><span class="cl">#define	ET_NUM		5		/* Number of defined types */
</span></span><span class="line"><span class="cl">#define ET_LOOS		0xfe00		/* OS-specific range start */
</span></span><span class="line"><span class="cl">#define ET_HIOS		0xfeff		/* OS-specific range end */
</span></span><span class="line"><span class="cl">#define ET_LOPROC	0xff00		/* Processor-specific range start */
</span></span><span class="line"><span class="cl">#define ET_HIPROC	0xffff		/* Processor-specific range end */
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="e_machine">e_machine
</h2><p>2字节,该字段用于指定ELF文件适用的处理器架构,部分定义如下, 对于intel,固定为EM_386</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define EM_NONE		 0	</span><span class="cm">/* No machine */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define EM_M32		 1	</span><span class="cm">/* AT&amp;T WE 32100 */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define EM_SPARC	 2	</span><span class="cm">/* SUN SPARC */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define EM_386		 3	</span><span class="cm">/* Intel 80386 */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define EM_68K		 4	</span><span class="cm">/* Motorola m68k family */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define EM_88K		 5	</span><span class="cm">/* Motorola m88k family */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define EM_IAMCU	 6	</span><span class="cm">/* Intel MCU */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define EM_860		 7	</span><span class="cm">/* Intel 80860 */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define EM_MIPS		 8	</span><span class="cm">/* MIPS R3000 big-endian */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define EM_S370		 9	</span><span class="cm">/* IBM System/370 */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define EM_MIPS_RS3_LE	10	</span><span class="cm">/* MIPS R3000 little-endian */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>				<span class="cm">/* reserved 11-14 */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define EM_PARISC	15	</span><span class="cm">/* HPPA */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>				<span class="cm">/* reserved 16 */</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="e_version">e_version
</h2><p>4字节,指明目标文件版本</p>
<p>Android不检查该字段,IDA检查,但对反汇编无影响</p>
<h2 id="e_entry">e_entry
</h2><p>4或8字节,程序入口点(OEP) RVA, 如果e_type=2 即可执行程序, 则该字段为VA; 如果是so,则为0</p>
<h2 id="e_phoff">e_phoff
</h2><p>4或8字节,程序头表偏移FOA,如果没有程序头表则该字段为0</p>
<h2 id="e_shoff">e_shoff
</h2><p>4或8字节,节头表偏移FOA,如果没有节头表则该字段为0</p>
<p>Android对抗中经常会删除节表</p>
<h2 id="e_flags">e_flags
</h2><p>4字节标志,无用</p>
<h2 id="e_ehsize">e_ehsize
</h2><p>2字节,ELF文件头大小</p>
<p>Android不检查,默认ELF Header大小为52字节; IDA检查,修改该字段只会产生警告不影响反汇编</p>
<h2 id="e_phentsize">e_phentsize
</h2><p>2字节,表示程序头表每一个表项的大小</p>
<h2 id="e_phnum">e_phnum
</h2><p>2字节,表示程序头表的表项数目</p>
<h2 id="e_shentsize">e_shentsize
</h2><p>2字节,节头表表项大小</p>
<h2 id="e_shnum">e_shnum
</h2><p>2字节,节头表表项个数</p>
<h2 id="e_shstrndx">e_shstrndx
</h2><p>2字节,节头表中与节名表相对应表项的索引</p>
<h2 id="打印文件头">打印文件头
</h2><p>根据枚举值,定义对应的字符串数组以打印相关信息</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// Print ELF Header
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">char</span> <span class="n">ELF_Class</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#34;NONE&#34;</span><span class="p">,</span> <span class="s">&#34;ELF32&#34;</span><span class="p">,</span> <span class="s">&#34;ELF64&#34;</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="n">ELF_Data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#34;NONE&#34;</span><span class="p">,</span> <span class="s">&#34;Little Endian&#34;</span><span class="p">,</span> <span class="s">&#34;Big Endian&#34;</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="n">objectFileType</span><span class="p">[</span><span class="mi">7</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#34;NONE&#34;</span><span class="p">,</span> <span class="s">&#34;REL&#34;</span><span class="p">,</span> <span class="s">&#34;EXEC&#34;</span><span class="p">,</span> <span class="s">&#34;DYN&#34;</span><span class="p">,</span> <span class="s">&#34;CORE&#34;</span><span class="p">,</span> <span class="s">&#34;LOPROC&#34;</span><span class="p">,</span> <span class="s">&#34;HIPROC&#34;</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">printELFHeader32</span><span class="p">(</span><span class="k">const</span> <span class="n">Elf32_Ehdr</span><span class="o">*</span> <span class="n">pElfHeader</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;ELF Header:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">Magic:</span><span class="se">\t</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EI_NIDENT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%02x &#34;</span><span class="p">,</span> <span class="n">pElfHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">e_ident</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%-36s%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="s">&#34;Class:&#34;</span><span class="p">,</span> <span class="n">ELF_Class</span><span class="p">[</span><span class="n">pElfHeader</span><span class="o">-&gt;</span><span class="n">e_ident</span><span class="p">[</span><span class="n">EI_CLASS</span><span class="p">]]);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%-36s%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="s">&#34;Data:&#34;</span><span class="p">,</span> <span class="n">ELF_Data</span><span class="p">[</span><span class="n">pElfHeader</span><span class="o">-&gt;</span><span class="n">e_ident</span><span class="p">[</span><span class="n">EI_DATA</span><span class="p">]]);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%-36s%#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="s">&#34;Version:&#34;</span><span class="p">,</span> <span class="n">pElfHeader</span><span class="o">-&gt;</span><span class="n">e_version</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%-36s%#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="s">&#34;Machine:&#34;</span><span class="p">,</span> <span class="n">pElfHeader</span><span class="o">-&gt;</span><span class="n">e_machine</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%-36s%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="s">&#34;Type:&#34;</span><span class="p">,</span> <span class="n">objectFileType</span><span class="p">[</span><span class="n">pElfHeader</span><span class="o">-&gt;</span><span class="n">e_type</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%-36s%#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="s">&#34;Size Of ELF Header:&#34;</span><span class="p">,</span> <span class="n">pElfHeader</span><span class="o">-&gt;</span><span class="n">e_ehsize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%-36s%#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="s">&#34;Entry point:&#34;</span><span class="p">,</span> <span class="n">pElfHeader</span><span class="o">-&gt;</span><span class="n">e_entry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%-36s%#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="s">&#34;Start Of Program Headers:&#34;</span><span class="p">,</span> <span class="n">pElfHeader</span><span class="o">-&gt;</span><span class="n">e_phoff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%-36s%#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="s">&#34;Start Of Section Headers:&#34;</span><span class="p">,</span> <span class="n">pElfHeader</span><span class="o">-&gt;</span><span class="n">e_shoff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%-36s%#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="s">&#34;Size Of Program Headers:&#34;</span><span class="p">,</span> <span class="n">pElfHeader</span><span class="o">-&gt;</span><span class="n">e_phentsize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%-36s%#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="s">&#34;Number Of Program Headers:&#34;</span><span class="p">,</span> <span class="n">pElfHeader</span><span class="o">-&gt;</span><span class="n">e_phnum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%-36s%#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="s">&#34;Size Of Section Headers:&#34;</span><span class="p">,</span> <span class="n">pElfHeader</span><span class="o">-&gt;</span><span class="n">e_shentsize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%-36s%#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="s">&#34;Number Of Sections:&#34;</span><span class="p">,</span> <span class="n">pElfHeader</span><span class="o">-&gt;</span><span class="n">e_shnum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%-36s%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="s">&#34;Section Header String Table Index:&#34;</span><span class="p">,</span> <span class="n">pElfHeader</span><span class="o">-&gt;</span><span class="n">e_shstrndx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;ELF Header End</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>打印效果如下</p>
<p><img src="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/8-ElfHeader-printElfHeader.png"
	width="536"
	height="410"
	srcset="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/8-ElfHeader-printElfHeader_hu_3f26eed398fd12a0.png 480w, /p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/8-ElfHeader-printElfHeader_hu_6eef99d486b72f74.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="130"
		data-flex-basis="313px"
	
></p>
<h1 id="section-header">Section Header
</h1><p>类似PE文件的节表(IMAGE_SECTION_HEADER)</p>
<p>节表保存了节的基本属性,是ELF文件中除了文件头之外最重要的结构,编译器,链接器和装载器都依赖节表定位和访问各个节的属性</p>
<p>节表数组第0个元素固定为SHN_UNDEF, 节表成员结构定义如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Word</span>	<span class="n">sh_name</span><span class="p">;</span>		<span class="cm">/* Section name (string tbl index) */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Word</span>	<span class="n">sh_type</span><span class="p">;</span>		<span class="cm">/* Section type */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Word</span>	<span class="n">sh_flags</span><span class="p">;</span>		<span class="cm">/* Section flags */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Addr</span>	<span class="n">sh_addr</span><span class="p">;</span>		<span class="cm">/* Section virtual addr at execution */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Off</span>	<span class="n">sh_offset</span><span class="p">;</span>		<span class="cm">/* Section file offset */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Word</span>	<span class="n">sh_size</span><span class="p">;</span>		<span class="cm">/* Section size in bytes */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Word</span>	<span class="n">sh_link</span><span class="p">;</span>		<span class="cm">/* Link to another section */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Word</span>	<span class="n">sh_info</span><span class="p">;</span>		<span class="cm">/* Additional section information */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Word</span>	<span class="n">sh_addralign</span><span class="p">;</span>		<span class="cm">/* Section alignment */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Word</span>	<span class="n">sh_entsize</span><span class="p">;</span>		<span class="cm">/* Entry size if section holds table */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">Elf32_Shdr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Word</span>	<span class="n">sh_name</span><span class="p">;</span>		<span class="cm">/* Section name (string tbl index) */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Word</span>	<span class="n">sh_type</span><span class="p">;</span>		<span class="cm">/* Section type */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Xword</span>	<span class="n">sh_flags</span><span class="p">;</span>		<span class="cm">/* Section flags */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Addr</span>	<span class="n">sh_addr</span><span class="p">;</span>		<span class="cm">/* Section virtual addr at execution */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Off</span>		<span class="n">sh_offset</span><span class="p">;</span>		<span class="cm">/* Section file offset */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Xword</span>	<span class="n">sh_size</span><span class="p">;</span>		<span class="cm">/* Section size in bytes */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Word</span>	<span class="n">sh_link</span><span class="p">;</span>		<span class="cm">/* Link to another section */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Word</span>	<span class="n">sh_info</span><span class="p">;</span>		<span class="cm">/* Additional section information */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Xword</span>	<span class="n">sh_addralign</span><span class="p">;</span>		<span class="cm">/* Section alignment */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Xword</span>	<span class="n">sh_entsize</span><span class="p">;</span>		<span class="cm">/* Entry size if section holds table */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">Elf64_Shdr</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>readelf查看节表</p>
<p><img src="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/9-SectionHeaderTable.png"
	width="665"
	height="668"
	srcset="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/9-SectionHeaderTable_hu_eee62c5af5c88559.png 480w, /p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/9-SectionHeaderTable_hu_ffddcb4ebb825c40.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="99"
		data-flex-basis="238px"
	
></p>
<h2 id="sh_name">sh_name
</h2><p>4字节,偏移值,通过ELF File Header.e_shstrndx拿到节表中节名称表对应项的索引</p>
<p>然后在节表中找到该项,找到sh_offset的文件偏移 sh_name+sh_offset即为该节名的字符串的FOA</p>
<h2 id="sh_type">sh_type
</h2><p>4字节,指示节的类型, 定义如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* Legal values for sh_type (section type).  */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define SHT_NULL	  0		</span><span class="cm">/* Section header table entry unused */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHT_PROGBITS	  1		</span><span class="cm">/* Program data */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHT_SYMTAB	  2		</span><span class="cm">/* Symbol table */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHT_STRTAB	  3		</span><span class="cm">/* String table */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHT_RELA	  4		</span><span class="cm">/* Relocation entries with addends */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHT_HASH	  5		</span><span class="cm">/* Symbol hash table */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHT_DYNAMIC	  6		</span><span class="cm">/* Dynamic linking information */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHT_NOTE	  7		</span><span class="cm">/* Notes */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHT_NOBITS	  8		</span><span class="cm">/* Program space with no data (bss) */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHT_REL		  9		</span><span class="cm">/* Relocation entries, no addends */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHT_SHLIB	  10		</span><span class="cm">/* Reserved */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHT_DYNSYM	  11		</span><span class="cm">/* Dynamic linker symbol table */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHT_INIT_ARRAY	  14		</span><span class="cm">/* Array of constructors */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHT_FINI_ARRAY	  15		</span><span class="cm">/* Array of destructors */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHT_PREINIT_ARRAY 16		</span><span class="cm">/* Array of pre-constructors */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHT_GROUP	  17		</span><span class="cm">/* Section group */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHT_SYMTAB_SHNDX  18		</span><span class="cm">/* Extended section indices */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHT_RELR	  19            </span><span class="cm">/* RELR relative relocations */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define	SHT_NUM		  20		</span><span class="cm">/* Number of defined types.  */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHT_LOOS	  0x60000000	</span><span class="cm">/* Start OS-specific.  */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHT_GNU_ATTRIBUTES 0x6ffffff5	</span><span class="cm">/* Object attributes.  */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHT_GNU_HASH	  0x6ffffff6	</span><span class="cm">/* GNU-style hash table.  */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHT_GNU_LIBLIST	  0x6ffffff7	</span><span class="cm">/* Prelink library list */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHT_CHECKSUM	  0x6ffffff8	</span><span class="cm">/* Checksum for DSO content.  */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHT_LOSUNW	  0x6ffffffa	</span><span class="cm">/* Sun-specific low bound.  */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHT_SUNW_move	  0x6ffffffa
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHT_SUNW_COMDAT   0x6ffffffb
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHT_SUNW_syminfo  0x6ffffffc
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHT_GNU_verdef	  0x6ffffffd	</span><span class="cm">/* Version definition section.  */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHT_GNU_verneed	  0x6ffffffe	</span><span class="cm">/* Version needs section.  */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHT_GNU_versym	  0x6fffffff	</span><span class="cm">/* Version symbol table.  */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHT_HISUNW	  0x6fffffff	</span><span class="cm">/* Sun-specific high bound.  */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHT_HIOS	  0x6fffffff	</span><span class="cm">/* End OS-specific type */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHT_LOPROC	  0x70000000	</span><span class="cm">/* Start of processor-specific */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHT_HIPROC	  0x7fffffff	</span><span class="cm">/* End of processor-specific */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHT_LOUSER	  0x80000000	</span><span class="cm">/* Start of application-specific */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHT_HIUSER	  0x8fffffff	</span><span class="cm">/* End of application-specific */</span><span class="cp">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>比较常见的节类型如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">SHT_NULL   	//无效节
</span></span><span class="line"><span class="cl">SHT_STRTAB 	//本节是字符串表 ELF文件可以有多个字符串表节
</span></span><span class="line"><span class="cl">SHT_RELA   	//重定位节
</span></span><span class="line"><span class="cl">SHT_HASH   	//表明本节包含一张哈希表 目前一个ELF文件最多只能有一张哈希表
</span></span><span class="line"><span class="cl">SHT_DYNAMIC //表明本节包含动态链接信息 目前一个目标文件最多一个dynamic节
</span></span><span class="line"><span class="cl">SHT_NOBITS  //表明本节内容为空,不占用实际内存空间
</span></span><span class="line"><span class="cl">SHT_REL 	//重定位节
</span></span><span class="line"><span class="cl">SHT_DYNSYM 	//表明本节是符号表,同SHT_SYMTAB
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="sh_flags">sh_flags
</h2><p>4字节,由一系列标志bit位组成</p>
<p><img src="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/10-sh_flags.png"
	width="448"
	height="231"
	srcset="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/10-sh_flags_hu_84416e147e8afa71.png 480w, /p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/10-sh_flags_hu_7b3fdfad5845b303.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="193"
		data-flex-basis="465px"
	
></p>
<ol>
<li>
<p>SHF_WRITE 表示本节在进程中可写</p>
</li>
<li>
<p>SHF_ALLOC 表示本节在运行中需要占用内存</p>
<p>不是所有节都要占用实际内存,部分起控制作用的节在文件映射至内存时不需要占用</p>
</li>
<li>
<p>SHF_EXECINSTR 表示本节的内容是指令代码</p>
</li>
<li>
<p>SHF_MASKPROC 被该值覆盖的位都保留做特殊处理器扩展用</p>
</li>
</ol>
<h2 id="sh_addr">sh_addr
</h2><p>4字节,节的内存虚拟地址</p>
<h2 id="sh_offset">sh_offset
</h2><p>4字节,节的FOA</p>
<h2 id="sh_size">sh_size
</h2><p>4字节,段的大小</p>
<h2 id="sh_link">sh_link
</h2><p>4字节,索引值</p>
<h2 id="sh_info">sh_info
</h2><p>4字节,节的附加信息</p>
<p>根据节类型不同,sh_info和sh_link有不同的含义</p>
<p><img src="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/11-sh_link%E5%92%8Csh_info.png"
	width="746"
	height="389"
	srcset="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/11-sh_link%E5%92%8Csh_info_hu_bf879261dc4b620a.png 480w, /p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/11-sh_link%E5%92%8Csh_info_hu_9c4215c669196f23.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="191"
		data-flex-basis="460px"
	
></p>
<h2 id="sh_addralign">sh_addralign
</h2><p>4字节,段地址对齐值,假如为0或者1表示该段没有对齐要求; 假如为3表示对齐2^3=8</p>
<p>节的sh_addr必须能被sh_addralign整除,即sh_addr%sh_addralign=0</p>
<h2 id="sh_entsize">sh_entsize
</h2><p>4字节,部分节的内容是一张表,每个表项的大小固定(例如符号表), 该字段指定其每个表项的大小</p>
<p>为0则表示不是这些表</p>
<h2 id="打印节表头">打印节表头
</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// Print ELF Section Headers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">char</span> <span class="o">*</span><span class="nf">getSectionTypeString</span><span class="p">(</span><span class="n">Elf_Word</span> <span class="n">sectionType</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">sectionType</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHT_NULL</span><span class="p">:</span>           <span class="k">return</span> <span class="s">&#34;NULL&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHT_PROGBITS</span><span class="p">:</span>       <span class="k">return</span> <span class="s">&#34;PROGBITS&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHT_SYMTAB</span><span class="p">:</span>         <span class="k">return</span> <span class="s">&#34;SYMTAB&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHT_STRTAB</span><span class="p">:</span>         <span class="k">return</span> <span class="s">&#34;STRTAB&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHT_RELA</span><span class="p">:</span>           <span class="k">return</span> <span class="s">&#34;RELA&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHT_HASH</span><span class="p">:</span>           <span class="k">return</span> <span class="s">&#34;HASH&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHT_DYNAMIC</span><span class="p">:</span>        <span class="k">return</span> <span class="s">&#34;DYNAMIC&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHT_NOTE</span><span class="p">:</span>           <span class="k">return</span> <span class="s">&#34;NOTE&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHT_NOBITS</span><span class="p">:</span>         <span class="k">return</span> <span class="s">&#34;NOBITS&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHT_REL</span><span class="p">:</span>            <span class="k">return</span> <span class="s">&#34;REL&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHT_SHLIB</span><span class="p">:</span>          <span class="k">return</span> <span class="s">&#34;SHLIB&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHT_DYNSYM</span><span class="p">:</span>         <span class="k">return</span> <span class="s">&#34;DYNSYM&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHT_INIT_ARRAY</span><span class="p">:</span>     <span class="k">return</span> <span class="s">&#34;INIT_ARRAY&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHT_FINI_ARRAY</span><span class="p">:</span>     <span class="k">return</span> <span class="s">&#34;FINI_ARRAY&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHT_PREINIT_ARRAY</span><span class="p">:</span>  <span class="k">return</span> <span class="s">&#34;PREINIT_ARRAY&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHT_GROUP</span><span class="p">:</span>          <span class="k">return</span> <span class="s">&#34;GROUP&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHT_SYMTAB_SHNDX</span><span class="p">:</span>   <span class="k">return</span> <span class="s">&#34;SYMTAB_SHNDX&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHT_RELR</span><span class="p">:</span>           <span class="k">return</span> <span class="s">&#34;RELR&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHT_NUM</span><span class="p">:</span>            <span class="k">return</span> <span class="s">&#34;NUM&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHT_LOOS</span><span class="p">:</span>           <span class="k">return</span> <span class="s">&#34;LOOS&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHT_GNU_ATTRIBUTES</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;GNU_ATTRIBUTES&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHT_GNU_HASH</span><span class="p">:</span>       <span class="k">return</span> <span class="s">&#34;GNU_HASH&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHT_GNU_LIBLIST</span><span class="p">:</span>    <span class="k">return</span> <span class="s">&#34;GNU_LIBLIST&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHT_CHECKSUM</span><span class="p">:</span>       <span class="k">return</span> <span class="s">&#34;CHECKSUM&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHT_LOSUNW</span><span class="p">:</span>         <span class="k">return</span> <span class="s">&#34;LOSUNW&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHT_SUNW_COMDAT</span><span class="p">:</span>    <span class="k">return</span> <span class="s">&#34;SUNW_COMDAT&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHT_SUNW_syminfo</span><span class="p">:</span>   <span class="k">return</span> <span class="s">&#34;SUNW_syminfo&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHT_GNU_verdef</span><span class="p">:</span>     <span class="k">return</span> <span class="s">&#34;GNU_verdef&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHT_GNU_verneed</span><span class="p">:</span>    <span class="k">return</span> <span class="s">&#34;GNU_verneed&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHT_GNU_versym</span><span class="p">:</span>     <span class="k">return</span> <span class="s">&#34;GNU_versym&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHT_LOPROC</span><span class="p">:</span>         <span class="k">return</span> <span class="s">&#34;LOPROC&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHT_HIPROC</span><span class="p">:</span>         <span class="k">return</span> <span class="s">&#34;HIPROC&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHT_LOUSER</span><span class="p">:</span>         <span class="k">return</span> <span class="s">&#34;LOUSER&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHT_HIUSER</span><span class="p">:</span>         <span class="k">return</span> <span class="s">&#34;HIUSER&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="o">:</span>                 <span class="k">return</span> <span class="s">&#34;UNKNOWN&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="nf">getSectionFlagStr</span><span class="p">(</span><span class="n">Elf_Word</span> <span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHF_ALLOC</span><span class="p">:</span>             <span class="k">return</span> <span class="s">&#34;  A&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHF_WRITE</span><span class="p">:</span>             <span class="k">return</span> <span class="s">&#34;  W&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">SHF_WRITE</span> <span class="o">|</span> <span class="nl">SHF_ALLOC</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34; WA&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHF_EXECINSTR</span><span class="p">:</span>         <span class="k">return</span> <span class="s">&#34;  X&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">SHF_ALLOC</span> <span class="o">|</span> <span class="nl">SHF_EXECINSTR</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34; AX&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SHF_MASKPROC</span><span class="p">:</span>          <span class="k">return</span> <span class="s">&#34;MKP&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="o">:</span>                    <span class="k">return</span> <span class="s">&#34;   &#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">printElfSectionHeader32</span><span class="p">(</span><span class="k">const</span> <span class="n">Elf32_Shdr</span><span class="o">*</span> <span class="n">pSectionHeader</span><span class="p">,</span><span class="n">Elf_Half</span> <span class="n">sectionNum</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">pStringTable</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;ELF Section Headers:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">[Nr] Name</span><span class="se">\t\t\t</span><span class="s">Type</span><span class="se">\t\t\t</span><span class="s">Addr</span><span class="se">\t\t</span><span class="s">Offset</span><span class="se">\t\t</span><span class="s">Size</span><span class="se">\t\t</span><span class="s">EntSize</span><span class="se">\t</span><span class="s">Flag</span><span class="se">\t</span><span class="s">Link</span><span class="se">\t</span><span class="s">Info</span><span class="se">\t</span><span class="s">Align</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sectionNum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">[%2d] %-20s&#34;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pStringTable</span><span class="p">[</span><span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_name</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%-16s&#34;</span><span class="p">,</span> <span class="nf">getSectionTypeString</span><span class="p">(</span><span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_type</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%08x&#34;</span><span class="p">,</span> <span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%08x&#34;</span><span class="p">,</span> <span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%08x&#34;</span><span class="p">,</span> <span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%x&#34;</span><span class="p">,</span> <span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_entsize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%s&#34;</span><span class="p">,</span> <span class="nf">getSectionFlagStr</span><span class="p">(</span><span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_flags</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%x&#34;</span><span class="p">,</span> <span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_link</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%x&#34;</span><span class="p">,</span> <span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_info</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_addralign</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;ELF Section Headers End</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>打印结果如下</p>
<p><img src="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/12-SectionHeader-printSectionHeader.png"
	width="1230"
	height="801"
	srcset="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/12-SectionHeader-printSectionHeader_hu_e8322826b534253a.png 480w, /p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/12-SectionHeader-printSectionHeader_hu_53923bc208239335.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="153"
		data-flex-basis="368px"
	
></p>
<h1 id="program-header">Program Header
</h1><p>程序头表用于描述ELF文件如何映射到内存中,用段(segment)表示</p>
<p>定义如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Word</span>	<span class="n">p_type</span><span class="p">;</span>			<span class="cm">/* Segment type */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Off</span>		<span class="n">p_offset</span><span class="p">;</span>		<span class="cm">/* Segment file offset */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Addr</span>	<span class="n">p_vaddr</span><span class="p">;</span>		<span class="cm">/* Segment virtual address */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Addr</span>	<span class="n">p_paddr</span><span class="p">;</span>		<span class="cm">/* Segment physical address */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Word</span>	<span class="n">p_filesz</span><span class="p">;</span>		<span class="cm">/* Segment size in file */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Word</span>	<span class="n">p_memsz</span><span class="p">;</span>		<span class="cm">/* Segment size in memory */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Word</span>	<span class="n">p_flags</span><span class="p">;</span>		<span class="cm">/* Segment flags */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Word</span>	<span class="n">p_align</span><span class="p">;</span>		<span class="cm">/* Segment alignment */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">Elf32_Phdr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Word</span>	<span class="n">p_type</span><span class="p">;</span>			<span class="cm">/* Segment type */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Word</span>	<span class="n">p_flags</span><span class="p">;</span>		<span class="cm">/* Segment flags */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Off</span>		<span class="n">p_offset</span><span class="p">;</span>		<span class="cm">/* Segment file offset */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Addr</span>	<span class="n">p_vaddr</span><span class="p">;</span>		<span class="cm">/* Segment virtual address */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Addr</span>	<span class="n">p_paddr</span><span class="p">;</span>		<span class="cm">/* Segment physical address */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Xword</span>	<span class="n">p_filesz</span><span class="p">;</span>		<span class="cm">/* Segment size in file */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Xword</span>	<span class="n">p_memsz</span><span class="p">;</span>		<span class="cm">/* Segment size in memory */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Xword</span>	<span class="n">p_align</span><span class="p">;</span>		<span class="cm">/* Segment alignment */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">Elf64_Phdr</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="p_type">p_type
</h2><p>指定了程序头描述的段类型(或如何解析本程序头的信息)</p>
<p>段类型如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* Legal values for p_type (segment type).  */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define	PT_NULL		0		</span><span class="cm">/* Program header table entry unused */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PT_LOAD		1		</span><span class="cm">/* Loadable program segment */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PT_DYNAMIC	2		</span><span class="cm">/* Dynamic linking information */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PT_INTERP	3		</span><span class="cm">/* Program interpreter */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PT_NOTE		4		</span><span class="cm">/* Auxiliary information */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PT_SHLIB	5		</span><span class="cm">/* Reserved */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PT_PHDR		6		</span><span class="cm">/* Entry for header table itself */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PT_TLS		7		</span><span class="cm">/* Thread-local storage segment */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define	PT_NUM		8		</span><span class="cm">/* Number of defined types */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PT_LOOS			0x60000000	</span><span class="cm">/* Start of OS-specific */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PT_GNU_EH_FRAME	0x6474e550	</span><span class="cm">/* GCC .eh_frame_hdr segment */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PT_GNU_STACK	0x6474e551	</span><span class="cm">/* Indicates stack executability */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PT_GNU_RELRO	0x6474e552	</span><span class="cm">/* Read-only after relocation */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PT_GNU_PROPERTY	0x6474e553	</span><span class="cm">/* GNU property */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PT_GNU_SFRAME	0x6474e554	</span><span class="cm">/* SFrame segment.  */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PT_LOSUNW		0x6ffffffa
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PT_SUNWBSS		0x6ffffffa	</span><span class="cm">/* Sun Specific segment */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PT_SUNWSTACK	0x6ffffffb	</span><span class="cm">/* Stack segment */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PT_HISUNW		0x6fffffff
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PT_HIOS			0x6fffffff	</span><span class="cm">/* End of OS-specific */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PT_LOPROC		0x70000000	</span><span class="cm">/* Start of processor-specific */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PT_HIPROC		0x7fffffff	</span><span class="cm">/* End of processor-specific */</span><span class="cp">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="p_offset">p_offset
</h2><p>段的文件偏移值</p>
<h2 id="p_vaddr">p_vaddr
</h2><p>段的内存虚拟地址</p>
<h2 id="p_paddr">p_paddr
</h2><p>段的内存物理地址, 由于多数现代操作系统的设计不可预知段的物理地址,故该字段多数情况下保留</p>
<h2 id="p_filesz">p_filesz
</h2><p>段的文件大小</p>
<h2 id="p_memsz">p_memsz
</h2><p>段的内存大小</p>
<h2 id="p_flags">p_flags
</h2><p>段的属性</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* Legal values for p_flags (segment flags).  */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define PF_X		(1 &lt;&lt; 0)	</span><span class="cm">/* Segment is executable */</span><span class="cp"> </span><span class="c1">//可读 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define PF_W		(1 &lt;&lt; 1)	</span><span class="cm">/* Segment is writable */</span><span class="cp">	</span><span class="c1">//可写
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define PF_R		(1 &lt;&lt; 2)	</span><span class="cm">/* Segment is readable */</span><span class="cp">	</span><span class="c1">//可执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define PF_MASKOS	0x0ff00000	</span><span class="cm">/* OS-specific */</span><span class="cp">			</span><span class="c1">//系统指定
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define PF_MASKPROC	0xf0000000	</span><span class="cm">/* Processor-specific */</span><span class="cp">	</span><span class="c1">//进程指定
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="p_align">p_align
</h2><p>段的内存对齐值</p>
<h2 id="打印段表头">打印段表头
</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// Print ELF Program Headers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">getSegmentTypeStr</span><span class="p">(</span><span class="n">Elf32_Word</span> <span class="n">segmentType</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">segmentType</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">PT_NULL</span><span class="p">:</span><span class="k">return</span> <span class="s">&#34;NULL&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">PT_LOAD</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;LOAD&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">PT_DYNAMIC</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;DYNAMIC&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">PT_INTERP</span><span class="p">:</span><span class="k">return</span> <span class="s">&#34;INTERP&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">PT_NOTE</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;NOTE&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">PT_SHLIB</span><span class="p">:</span><span class="k">return</span> <span class="s">&#34;SHLIB&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">PT_PHDR</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;PHDR&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">PT_TLS</span><span class="p">:</span><span class="k">return</span> <span class="s">&#34;TLS&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">PT_NUM</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;PT_NUM&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">PT_LOOS</span><span class="p">:</span><span class="k">return</span> <span class="s">&#34;LOOS&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">PT_GNU_EH_FRAME</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;GNU_EH_FRAME&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">PT_GNU_STACK</span><span class="p">:</span><span class="k">return</span> <span class="s">&#34;GNU_STACK&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">PT_GNU_RELRO</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;GNU_RELRO&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">PT_GNU_PROPERTY</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;GNU_PROPERTY&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">PT_GNU_SFRAME</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;GNU_SFRAME&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">PT_SUNWBSS</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;SUNWBSS&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">PT_SUNWSTACK</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;SUNWSTACK&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">PT_HIOS</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;HIOS&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">PT_LOPROC</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;LOPROC&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">PT_HIPROC</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;HIPROC&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;UNKNOWN&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="nf">getSegmentFlagStr</span><span class="p">(</span><span class="n">Elf_Word</span> <span class="n">segmentFlags</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="kt">char</span> <span class="n">segmentFlagStr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#34;    &#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">segmentFlags</span> <span class="o">&amp;</span> <span class="n">PF_R</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">segmentFlagStr</span><span class="p">[</span><span class="n">count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;R&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">segmentFlags</span> <span class="o">&amp;</span> <span class="n">PF_W</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">segmentFlagStr</span><span class="p">[</span><span class="n">count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;W&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">segmentFlags</span> <span class="o">&amp;</span> <span class="n">PF_X</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">segmentFlagStr</span><span class="p">[</span><span class="n">count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;X&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">segmentFlagStr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">printElfProgramHeader32</span><span class="p">(</span><span class="k">const</span> <span class="n">Elf32_Phdr</span> <span class="o">*</span><span class="n">pProgramHeader</span><span class="p">,</span><span class="n">Elf_Half</span> <span class="n">segmentNum</span><span class="p">,</span><span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">pFileBuffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;ELF ProgramHeader:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">[Nr] Type</span><span class="se">\t\t</span><span class="s">FileOff</span><span class="se">\t\t</span><span class="s">VirAddr</span><span class="se">\t\t</span><span class="s">PhyAddr</span><span class="se">\t\t</span><span class="s">FileSize</span><span class="se">\t</span><span class="s">MemSize</span><span class="se">\t\t</span><span class="s">Flag</span><span class="se">\t</span><span class="s">Align</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span>  <span class="n">segmentNum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">[%02d] %-16s&#34;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nf">getSegmentTypeStr</span><span class="p">(</span><span class="n">pProgramHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_type</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%08x&#34;</span><span class="p">,</span> <span class="n">pProgramHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%08x&#34;</span><span class="p">,</span> <span class="n">pProgramHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_vaddr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%08x&#34;</span><span class="p">,</span> <span class="n">pProgramHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_paddr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%08x&#34;</span><span class="p">,</span> <span class="n">pProgramHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_filesz</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%08x&#34;</span><span class="p">,</span> <span class="n">pProgramHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_memsz</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%#4s&#34;</span><span class="p">,</span> <span class="nf">getSegmentFlagStr</span><span class="p">(</span><span class="n">pProgramHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_flags</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pProgramHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_align</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">pProgramHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_type</span> <span class="o">==</span> <span class="n">PT_INTERP</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t\t</span><span class="s"> [Request Program Interpreter Path: %s]</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pFileBuffer</span> <span class="o">+</span> <span class="n">pProgramHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_offset</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;ELF ProgramHeader End</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// print segment mapping
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">printSectionToSegmentMapping32</span><span class="p">(</span><span class="k">const</span> <span class="n">Elf32_Phdr</span><span class="o">*</span> <span class="n">pProgramHeader</span><span class="p">,</span><span class="k">const</span> <span class="n">Elf32_Shdr</span><span class="o">*</span> <span class="n">pSectionHeader</span><span class="p">,</span><span class="n">Elf_Half</span> <span class="n">segmentNum</span><span class="p">,</span><span class="n">Elf_Half</span> <span class="n">sectionNum</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">pSectionHeaderStringTable</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Segtion to Segment Mapping:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">Segment</span><span class="se">\t</span><span class="s">Sections</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//Traverse program headers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">segmentNum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Elf32_Addr</span> <span class="n">segmentStartAddr</span> <span class="o">=</span> <span class="n">pProgramHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_vaddr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">Elf32_Addr</span> <span class="n">segmentEndAddr</span> <span class="o">=</span> <span class="n">segmentStartAddr</span> <span class="o">+</span> <span class="n">pProgramHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_memsz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%02d</span><span class="se">\t\t</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//Traverse section headers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">sectionNum</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Elf32_Addr</span> <span class="n">sectionStartAddr</span> <span class="o">=</span> <span class="n">pSectionHeader</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">sh_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//Check whether the start addr of a section is in the segment addr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">sectionStartAddr</span> <span class="o">&gt;=</span> <span class="n">segmentStartAddr</span> <span class="o">&amp;&amp;</span> <span class="n">sectionStartAddr</span> <span class="o">&lt;</span> <span class="n">segmentEndAddr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//SHF_ALLOC means need alloc memory, some control sections don&#39;t need mapping to memory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="n">pSectionHeader</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">sh_flags</span> <span class="o">&amp;</span> <span class="n">SHF_ALLOC</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%s &#34;</span><span class="p">,(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSectionHeaderStringTable</span> <span class="o">+</span> <span class="n">pSectionHeader</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">sh_name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>打印结果如下</p>
<p><img src="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/13-ProgramHeader-printProgramHeader.png"
	width="1105"
	height="674"
	srcset="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/13-ProgramHeader-printProgramHeader_hu_f5649c96ad4ab44e.png 480w, /p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/13-ProgramHeader-printProgramHeader_hu_bac29ee9203eb1e.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="163"
		data-flex-basis="393px"
	
></p>
<h1 id="特殊节">特殊节
</h1><p>ELF 文件中有一些特定的节是预定义好的，其内容是指令代码或者控制信息</p>
<p>这些节专门为操作系统使用，对于不同的操作系统，这些节的类型和属性有所不同</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>节名</th>
          <th>作用</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>.text</strong></td>
          <td><strong>代码段</strong></td>
      </tr>
      <tr>
          <td><strong>.data</strong></td>
          <td><strong>保存已经初始化的全局变量和局部静态变量</strong></td>
      </tr>
      <tr>
          <td><strong>.bss</strong></td>
          <td><strong>保存未初始化的全局变量和局部静态变量</strong></td>
      </tr>
      <tr>
          <td>.rodata</td>
          <td>存放只读数据, 例如常量字符串</td>
      </tr>
      <tr>
          <td>.comment</td>
          <td>编译器版本信息</td>
      </tr>
      <tr>
          <td>.debug</td>
          <td>调试信息</td>
      </tr>
      <tr>
          <td><strong>.dynamic</strong></td>
          <td><strong>动态链接信息</strong>, linker解析该段以加载elf文件</td>
      </tr>
      <tr>
          <td>.hash</td>
          <td>符号哈希表 (可查导入和导出符号)</td>
      </tr>
      <tr>
          <td>.gnu.hash</td>
          <td>GNU哈希表 (只可查导出符号,导出表)</td>
      </tr>
      <tr>
          <td>.line</td>
          <td>调试行号表 即源代码行号与编译后指令的对应表</td>
      </tr>
      <tr>
          <td>.note</td>
          <td>额外的编译器信息 例如公司名,版本号</td>
      </tr>
      <tr>
          <td>.rel.dyn</td>
          <td>动态链接重定位表 存放全局变量重定位项</td>
      </tr>
      <tr>
          <td>.rel.plt</td>
          <td>动态链接函数跳转重定位表 存放plt重定位项</td>
      </tr>
      <tr>
          <td>.symtab</td>
          <td>符号表</td>
      </tr>
      <tr>
          <td>.dynsym</td>
          <td>动态链接符号表</td>
      </tr>
      <tr>
          <td>.strtab</td>
          <td>字符串表</td>
      </tr>
      <tr>
          <td>.shstrtab</td>
          <td>节名表</td>
      </tr>
      <tr>
          <td>.dynstr</td>
          <td>动态链接字符串表</td>
      </tr>
      <tr>
          <td>.plt</td>
          <td>动态链接跳转表</td>
      </tr>
      <tr>
          <td>.got</td>
          <td>动态链接全局偏移表</td>
      </tr>
      <tr>
          <td>.init</td>
          <td>程序初始化代码段(节)</td>
      </tr>
      <tr>
          <td>.fini</td>
          <td>程序结束代码段(节)</td>
      </tr>
  </tbody>
</table></div>
<h1 id="string-table">String Table
</h1><p>ELF文件中有很多字符串,例如段名,变量名等, 由于字符串长度往往不固定,所以使用固定结构描述比较困难</p>
<p>常见做法是将字符串集中起来存放到一张字符串表,然后通过索引查表来引用字符串</p>
<p>常见的有:</p>
<ol>
<li>
<p>.strtab(字符串表,保存普通字符串)</p>
<p>遍历section header, 查找type==SHT_STRTAB的即为字符串表 (包括段表字符串表)</p>
</li>
<li>
<p>.shstrtab(段表字符串表,保存段表用到的字符串)</p>
<p>获取该表可以通过ELF Header的e_shstrndx成员做索引,查找ELF Section Header Table</p>
<p>即p_shstrtab=ELFSectionHeaderTable[ELFHeader.e_shstrndx]</p>
</li>
</ol>
<p>打印代码如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// Print String Table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">printStringTable32</span><span class="p">(</span><span class="k">const</span> <span class="n">Elf32_Shdr</span><span class="o">*</span> <span class="n">pSectionHeader</span><span class="p">,</span><span class="n">Elf_Half</span> <span class="n">sectionNum</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">pSectionHeaderStringTable</span><span class="p">,</span><span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">pFileBuffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//Traverse the section header table then find string table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;ELF String Table:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sectionNum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//not only just one string table such as .dynstr .strtab
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_type</span> <span class="o">==</span> <span class="n">SHT_STRTAB</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">==========String Table %s==========</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="nf">getSectionName</span><span class="p">(</span><span class="n">pSectionHeaderStringTable</span><span class="p">,</span><span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_name</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="kt">char</span> <span class="o">*</span><span class="n">pStringTable</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pFileBuffer</span> <span class="o">+</span> <span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Elf32_Word</span> <span class="n">stringTableSize</span> <span class="o">=</span> <span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_size</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">//遍历字符串表, 遇到0时pos+1打印字符串, 非0时继续搜索
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">stringTableSize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">pStringTable</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pStringTable</span> <span class="o">+</span> <span class="n">pos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">//find zero
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">while</span> <span class="p">(</span><span class="n">pStringTable</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">pos</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;ELF String Table End</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/14-StringTable-printStringTable.png"
	width="474"
	height="651"
	srcset="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/14-StringTable-printStringTable_hu_ed709d75b7fa8261.png 480w, /p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/14-StringTable-printStringTable_hu_6faa92246905a71.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="72"
		data-flex-basis="174px"
	
></p>
<h1 id="symbol-table">Symbol Table
</h1><p>符号表的作用是描述导入和导出符号,这里的符号可以是全局变量,函数,外部引用等</p>
<p>通过符号表和对应的字符串表可以得到符号名,符号大小,符号地址等信息</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="p">.</span><span class="n">dynsym</span> <span class="c1">//动态链接符号表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">.</span><span class="n">symtab</span> <span class="c1">//符号表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="n">dynstr</span> <span class="c1">//动态链接符号表的字符串表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">.</span><span class="n">strtab</span> <span class="c1">//符号表的字符串表
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>符号表表项结构</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Word</span>	<span class="n">st_name</span><span class="p">;</span>		<span class="cm">/* Symbol name (string tbl index) */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Addr</span>	<span class="n">st_value</span><span class="p">;</span>		<span class="cm">/* Symbol value */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Word</span>	<span class="n">st_size</span><span class="p">;</span>		<span class="cm">/* Symbol size */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">st_info</span><span class="p">;</span>		<span class="cm">/* Symbol type and binding */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">st_other</span><span class="p">;</span>		<span class="cm">/* Symbol visibility */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Section</span>	<span class="n">st_shndx</span><span class="p">;</span>		<span class="cm">/* Section index */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">Elf32_Sym</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Word</span>	<span class="n">st_name</span><span class="p">;</span>		<span class="cm">/* Symbol name (string tbl index) */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">st_info</span><span class="p">;</span>		<span class="cm">/* Symbol type and binding */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">st_other</span><span class="p">;</span>		<span class="cm">/* Symbol visibility */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Section</span>	<span class="n">st_shndx</span><span class="p">;</span>		<span class="cm">/* Section index */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Addr</span>	<span class="n">st_value</span><span class="p">;</span>		<span class="cm">/* Symbol value */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Xword</span>	<span class="n">st_size</span><span class="p">;</span>		<span class="cm">/* Symbol size */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">Elf64_Sym</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="st_name">st_name
</h2><p>符号名, 字符串表的索引下标, 节表的sh_link说明了是在哪个字符串表中</p>
<h2 id="st_value">st_value
</h2><p>符号对应的值, 和符号有关, 可能是绝对值,也可能是一个地址, 不同符号的含义不同</p>
<h2 id="st_size">st_size
</h2><p>符号大小, 对于包含数据的符号, 是该数据类型的大小</p>
<p>例如一个double型的符号占用8字节,如果该值为0表示符号大小为0或未知</p>
<h2 id="st_info">st_info
</h2><p>符号的类型和属性,高4bit标识了符号绑定(symbol binding), 低4bit标识了符号类型(symbol type),组成符号信息(symbol information)</p>
<p>有3个宏分别读取这三个属性值</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* How to extract and insert information held in the st_info field.  */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define ELF32_ST_BIND(val)		(((unsigned char) (val)) &gt;&gt; 4)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define ELF32_ST_TYPE(val)		((val) &amp; 0xf)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define ELF32_ST_INFO(bind, type)	(((bind) &lt;&lt; 4) + ((type) &amp; 0xf))
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="symbol-binding">Symbol Binding
</h3><p>符号绑定的合法属性如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* Legal values for ST_BIND subfield of st_info (symbol binding).  */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define STB_LOCAL	0		</span><span class="cm">/* Local symbol */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define STB_GLOBAL	1		</span><span class="cm">/* Global symbol */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define STB_WEAK	2		</span><span class="cm">/* Weak symbol */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define	STB_NUM		3		</span><span class="cm">/* Number of defined types.  */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define STB_LOOS	10		</span><span class="cm">/* Start of OS-specific */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define STB_GNU_UNIQUE	10	</span><span class="cm">/* Unique symbol.  */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define STB_HIOS	12		</span><span class="cm">/* End of OS-specific */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define STB_LOPROC	13		</span><span class="cm">/* Start of processor-specific */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define STB_HIPROC	15		</span><span class="cm">/* End of processor-specific */</span><span class="cp">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>几个重要属性解释如下:</p>
<ol>
<li>
<p>STB_LOCAL</p>
<p>该符号是本地符号,只出现在本文件中,在其他文件中无效</p>
<p>所以在不同文件中可以定义相同的符号名,不会互相影响</p>
</li>
<li>
<p>STB_GLOBAL</p>
<p>该符号是全局符号,当有多个文件被链接在一起时,在所有文件中该符号都是可见的</p>
<p>所以在一个文件中定义的全局符号,一定是在其他文件中需要被引用,否则无需定义为全局</p>
</li>
<li>
<p>STB_WEAK</p>
<p>弱符号,类似于全局符号,但优先级比global更低</p>
</li>
<li>
<p>STB_LOPROC~STB_HIPROC</p>
<p>为特殊处理器保留</p>
</li>
</ol>
<h3 id="symbol-type">Symbol Type
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Legal values for ST_TYPE subfield of st_info (symbol type).  */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define STT_NOTYPE	0		</span><span class="cm">/* Symbol type is unspecified */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define STT_OBJECT	1		</span><span class="cm">/* Symbol is a data object */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define STT_FUNC	2		</span><span class="cm">/* Symbol is a code object */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define STT_SECTION	3		</span><span class="cm">/* Symbol associated with a section */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define STT_FILE	4		</span><span class="cm">/* Symbol&#39;s name is file name */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define STT_COMMON	5		</span><span class="cm">/* Symbol is a common data object */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define STT_TLS		6		</span><span class="cm">/* Symbol is thread-local data object*/</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define	STT_NUM		7		</span><span class="cm">/* Number of defined types.  */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define STT_LOOS	10		</span><span class="cm">/* Start of OS-specific */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define STT_GNU_IFUNC	10	</span><span class="cm">/* Symbol is indirect code object */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define STT_HIOS	12		</span><span class="cm">/* End of OS-specific */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define STT_LOPROC	13		</span><span class="cm">/* Start of processor-specific */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define STT_HIPROC	15		</span><span class="cm">/* End of processor-specific */</span><span class="cp">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>几个重要符号解析如下</p>
<ol>
<li>
<p>STT_NOTYPE</p>
<p>该符号类型未指定</p>
</li>
<li>
<p>STT_OBJECT</p>
<p>该符号是一个数据对象,例如变量,数组等</p>
</li>
<li>
<p>STT_FUNC</p>
<p>该符号是一个函数,或者其他的可执行代码</p>
</li>
<li>
<p>STT_SECTION</p>
<p>该符号和一个节相关联,用于重定位,通常具有STB_LOCAL属性</p>
</li>
<li>
<p>STT_FILE</p>
<p>该符号是一个文件符号,具有STB_LOCAL属性</p>
</li>
<li>
<p>STT_LOPROC~STT_HIPROC</p>
<p>为特殊处理器保留</p>
</li>
</ol>
<h2 id="st_other">st_other
</h2><p>低2位保存了符号可见性</p>
<h2 id="st_shndx">st_shndx
</h2><p>符号所在的段</p>
<h2 id="打印符号表">打印符号表
</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// Print Symbol Table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">getSymbolBindingString</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">symbolBinding</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">symbolBinding</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">STB_LOCAL</span><span class="p">:</span>        <span class="k">return</span> <span class="s">&#34;LOCAL&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">STB_GLOBAL</span><span class="p">:</span>       <span class="k">return</span> <span class="s">&#34;GLOBAL&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">STB_WEAK</span><span class="p">:</span>         <span class="k">return</span> <span class="s">&#34;WEAK&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">STB_NUM</span><span class="p">:</span>          <span class="k">return</span> <span class="s">&#34;STB_NUM&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">STB_GNU_UNIQUE</span><span class="p">:</span>   <span class="k">return</span> <span class="s">&#34;GNU_UNIQUE&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">STB_HIOS</span><span class="p">:</span>         <span class="k">return</span> <span class="s">&#34;STB_HIOS&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">STB_LOPROC</span><span class="p">:</span>       <span class="k">return</span> <span class="s">&#34;STB_LOPROC&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">STB_HIPROC</span><span class="p">:</span>       <span class="k">return</span> <span class="s">&#34;STB_HIPROC&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="o">:</span>               <span class="k">return</span> <span class="s">&#34;UNKNOWN&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">getSymbolTypeString</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">symbolType</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">symbolType</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">STT_NOTYPE</span><span class="p">:</span>    <span class="k">return</span> <span class="s">&#34;NOTYPE&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">STT_OBJECT</span><span class="p">:</span>    <span class="k">return</span> <span class="s">&#34;OBJECT&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">STT_FUNC</span><span class="p">:</span>      <span class="k">return</span> <span class="s">&#34;FUNC&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">STT_SECTION</span><span class="p">:</span>   <span class="k">return</span> <span class="s">&#34;SECTION&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">STT_FILE</span><span class="p">:</span>      <span class="k">return</span> <span class="s">&#34;FILE&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">STT_COMMON</span><span class="p">:</span>    <span class="k">return</span> <span class="s">&#34;COMMON&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">STT_TLS</span><span class="p">:</span>       <span class="k">return</span> <span class="s">&#34;TLS&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">STT_NUM</span><span class="p">:</span>       <span class="k">return</span> <span class="s">&#34;STT_NUM&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">STT_GNU_IFUNC</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;GNU_IFUNC&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">STT_HIOS</span><span class="p">:</span>      <span class="k">return</span> <span class="s">&#34;HIOS&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">STT_LOPROC</span><span class="p">:</span>    <span class="k">return</span> <span class="s">&#34;LOPROC&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">STT_HIPROC</span><span class="p">:</span>    <span class="k">return</span> <span class="s">&#34;HIPROC&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="o">:</span>            <span class="k">return</span> <span class="s">&#34;UNKNOWN&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">getSymbolVisibility</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">st_other</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">visibility</span> <span class="o">=</span> <span class="n">st_other</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">visibility</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>            <span class="k">return</span> <span class="s">&#34;DEFAULT&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>            <span class="k">return</span> <span class="s">&#34;INTERNAL&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>            <span class="k">return</span> <span class="s">&#34;HIDDEN&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>            <span class="k">return</span> <span class="s">&#34;PROTECTED&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="o">:</span>           <span class="k">return</span> <span class="s">&#34;UNKNOWN&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">printSymbolTable32</span><span class="p">(</span><span class="k">const</span> <span class="n">Elf32_Shdr</span><span class="o">*</span> <span class="n">pSectionHeader</span><span class="p">,</span><span class="n">Elf_Half</span> <span class="n">sectionNum</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">pSectionHeaderStringTable</span><span class="p">,</span><span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">pFileBuffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;ELF Symbol Tables:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sectionNum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//全局静态符号表和动态符号表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_type</span> <span class="o">==</span> <span class="n">SHT_SYMTAB</span> <span class="o">||</span> <span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_type</span> <span class="o">==</span> <span class="n">SHT_DYNSYM</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Elf32_Word</span> <span class="n">symbolNum</span> <span class="o">=</span> <span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_size</span> <span class="o">/</span> <span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_entsize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//获取符号表对应的字符串表,全局静态符号和动态符号表对应字符串表可能不同 sh_link is index of string table, fileBuffer+offset is real string table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">char</span><span class="o">*</span> <span class="n">pSymbolNameTable</span> <span class="o">=</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="n">pFileBuffer</span> <span class="o">+</span> <span class="n">pSectionHeader</span><span class="p">[</span><span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_link</span><span class="p">].</span><span class="n">sh_offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">Symbol Table &#39;%s&#39; contains %#x entries:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="nf">getSectionName</span><span class="p">(</span><span class="n">pSectionHeaderStringTable</span><span class="p">,</span><span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_name</span><span class="p">),</span> <span class="n">symbolNum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">Num </span><span class="se">\t</span><span class="s">Value</span><span class="se">\t\t</span><span class="s">Size</span><span class="se">\t\t</span><span class="s">Type</span><span class="se">\t\t</span><span class="s">Bind</span><span class="se">\t\t</span><span class="s">Visible</span><span class="se">\t\t</span><span class="s">Index</span><span class="se">\t\t</span><span class="s">Name</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Elf32_Sym</span> <span class="o">*</span><span class="n">pSymbolTable</span> <span class="o">=</span> <span class="p">(</span><span class="n">Elf32_Sym</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pFileBuffer</span> <span class="o">+</span> <span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">symbolNum</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%04d&#34;</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%08x&#34;</span><span class="p">,</span> <span class="n">pSymbolTable</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">st_value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%08x&#34;</span><span class="p">,</span> <span class="n">pSymbolTable</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">st_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//symbol type and binding
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%s</span><span class="se">\t</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">getSymbolTypeString</span><span class="p">(</span><span class="nf">ELF32_ST_TYPE</span><span class="p">(</span><span class="n">pSymbolTable</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">st_info</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%s</span><span class="se">\t</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">getSymbolBindingString</span><span class="p">(</span><span class="nf">ELF32_ST_BIND</span><span class="p">(</span><span class="n">pSymbolTable</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">st_info</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%-10s&#34;</span><span class="p">,</span> <span class="nf">getSymbolVisibility</span><span class="p">(</span><span class="n">pSymbolTable</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">st_other</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">pSymbolTable</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">st_shndx</span> <span class="o">==</span> <span class="n">SHN_UNDEF</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%4s</span><span class="se">\t</span><span class="s">&#34;</span><span class="p">,</span> <span class="s">&#34;UDEF&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pSymbolTable</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">st_shndx</span> <span class="o">==</span> <span class="n">SHN_ABS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%4s</span><span class="se">\t</span><span class="s">&#34;</span><span class="p">,</span> <span class="s">&#34;ABS&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%04x</span><span class="se">\t</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pSymbolTable</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">st_shndx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pSymbolNameTable</span> <span class="o">+</span> <span class="n">pSymbolTable</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">st_name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/15-SymbolTable-printSymbolTable.png"
	width="1244"
	height="796"
	srcset="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/15-SymbolTable-printSymbolTable_hu_f0c588ce8b5e6a27.png 480w, /p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/15-SymbolTable-printSymbolTable_hu_8a8856965049f27.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="156"
		data-flex-basis="375px"
	
></p>
<h1 id="relocation-table">Relocation Table
</h1><p>一般有两张重定位表:</p>
<ol>
<li>
<p><strong>.rel.plt</strong> 修复外部函数地址</p>
</li>
<li>
<p><strong>.rel.dyn</strong> 修复全局变量地址</p>
</li>
</ol>
<p>重定位表有SHT_REL, SHT_RELA, SHT_RELR三种类型,对应表项定义如下</p>
<p><strong>注: Intel x86架构只使用REL重定位项</strong>, x64架构似乎只使用RELA重定位项, 在后续修复重定位表可以得知</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* Relocation table entry without addend (in section of type SHT_REL).  */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Addr</span>	<span class="n">r_offset</span><span class="p">;</span>		<span class="cm">/* Address */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Word</span>	<span class="n">r_info</span><span class="p">;</span>			<span class="cm">/* Relocation type and symbol index */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">Elf32_Rel</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Addr</span>	<span class="n">r_offset</span><span class="p">;</span>		<span class="cm">/* Address */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Xword</span>	<span class="n">r_info</span><span class="p">;</span>			<span class="cm">/* Relocation type and symbol index */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">Elf64_Rel</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Relocation table entry with addend (in section of type SHT_RELA).  */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Addr</span>	<span class="n">r_offset</span><span class="p">;</span>		<span class="cm">/* Address */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Word</span>	<span class="n">r_info</span><span class="p">;</span>			<span class="cm">/* Relocation type and symbol index */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Sword</span>	<span class="n">r_addend</span><span class="p">;</span>		<span class="cm">/* Addend */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">Elf32_Rela</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Addr</span>	<span class="n">r_offset</span><span class="p">;</span>		<span class="cm">/* Address */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Xword</span>	<span class="n">r_info</span><span class="p">;</span>			<span class="cm">/* Relocation type and symbol index */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Sxword</span>	<span class="n">r_addend</span><span class="p">;</span>		<span class="cm">/* Addend */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">Elf64_Rela</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* RELR relocation table entry */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="n">Elf32_Word</span>	<span class="n">Elf32_Relr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="n">Elf64_Xword</span>	<span class="n">Elf64_Relr</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="r_offset">r_offset
</h2><p>重定位的位置</p>
<p>对于重定位文件而言,该值是待重定位单元在节中的偏移量</p>
<p>对于可执行文件或链接库文件而言,该值是待重定位单元的虚拟地址</p>
<h2 id="r_info">r_info
</h2><p>给出了待重定位单元的符号表索引和重定位类型</p>
<p>获取信息的宏</p>
<p>SYM获取高24/32位, 是符号表索引, 指明符号</p>
<p>TYPE获取低8/32位, 是重定位类型</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* How to extract and insert information held in the r_info field.  */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define ELF32_R_SYM(val)		((val) &gt;&gt; 8)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define ELF32_R_TYPE(val)		((val) &amp; 0xff)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define ELF32_R_INFO(sym, type)		(((sym) &lt;&lt; 8) + ((type) &amp; 0xff))
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define ELF64_R_SYM(i)			((i) &gt;&gt; 32)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define ELF64_R_TYPE(i)			((i) &amp; 0xffffffff)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define ELF64_R_INFO(sym,type)		((((Elf64_Xword) (sym)) &lt;&lt; 32) + (type))
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="r_addend">r_addend
</h2><p>指定加数,用于计算需要重定位的域的值</p>
<p>Rela使用该字段显式地指出加数,Rel的加数隐含在被修改的位置中</p>
<p>一个重定位节(Relocation Section)需要引用另外两个节: 符号表和待修复节</p>
<p>重定位节节头的sh_info和sh_link分别指明了引用关系</p>
<p>不同目标文件中,重定位项的r_offset成员含义略有不同</p>
<ol>
<li>
<p>重定位文件</p>
<p>r_offset指向待修改节的重定位单元偏移地址</p>
</li>
<li>
<p>可执行文件/共享目标文件</p>
<p>r_offset指向待修改单元的虚拟地址</p>
</li>
</ol>
<h2 id="重定位类型">重定位类型
</h2><p>重定位项用于描述如何修改以下的指令和数据域(被重定位域)</p>
<p><img src="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/16-%E8%A2%AB%E9%87%8D%E5%AE%9A%E4%BD%8D%E5%9F%9F.png"
	width="788"
	height="167"
	srcset="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/16-%E8%A2%AB%E9%87%8D%E5%AE%9A%E4%BD%8D%E5%9F%9F_hu_a7aae6b2fb0af9c8.png 480w, /p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/16-%E8%A2%AB%E9%87%8D%E5%AE%9A%E4%BD%8D%E5%9F%9F_hu_5cd21d08ab72e736.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="471"
		data-flex-basis="1132px"
	
></p>
<p>定义以下几种运算符号便于描述</p>
<p><img src="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/17-%E9%87%8D%E5%AE%9A%E4%BD%8D%E8%BF%90%E7%AE%97%E7%AC%A6%E5%8F%B7.png"
	width="749"
	height="729"
	srcset="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/17-%E9%87%8D%E5%AE%9A%E4%BD%8D%E8%BF%90%E7%AE%97%E7%AC%A6%E5%8F%B7_hu_33e6f5e113541992.png 480w, /p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/17-%E9%87%8D%E5%AE%9A%E4%BD%8D%E8%BF%90%E7%AE%97%E7%AC%A6%E5%8F%B7_hu_3e2ceb7006ad7f57.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="102"
		data-flex-basis="246px"
	
></p>
<p>常见重定位类型如下</p>
<p><img src="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/18-RelocationType.png"
	width="837"
	height="509"
	srcset="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/18-RelocationType_hu_79dccd2af9df6566.png 480w, /p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/18-RelocationType_hu_998dfbc291fee8a2.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="164"
		data-flex-basis="394px"
	
></p>
<h3 id="r_386_got_dat">R_386_GOT_DAT
</h3><p>将指定的符号地址设置为一个GOT表项</p>
<p>修复方法: elf加载后, 填入符号对应真实地址</p>
<h3 id="r_386_jmp_slot">R_386_JMP_SLOT
</h3><p>用于动态链接的PLT表项</p>
<p>修复方法: elf加载后, 修改跳转地址为符号地址</p>
<h3 id="r_386_relative">R_386_RELATIVE
</h3><p>相对偏移地址重定位</p>
<p>修复方法: 将offset指出的位置解引用,加上elf加载的基地址</p>
<p>全部的intel x86架构重定位类型如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* Intel 80386 specific definitions.  */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* i386 relocs.  */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define R_386_NONE	   0		</span><span class="cm">/* No reloc */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_32	   1		</span><span class="cm">/* Direct 32 bit  */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_PC32	   2		</span><span class="cm">/* PC relative 32 bit */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_GOT32	   3		</span><span class="cm">/* 32 bit GOT entry */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_PLT32	   4		</span><span class="cm">/* 32 bit PLT address */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_COPY	   5		</span><span class="cm">/* Copy symbol at runtime */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_GLOB_DAT	   6		</span><span class="cm">/* Create GOT entry */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_JMP_SLOT	   7		</span><span class="cm">/* Create PLT entry */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_RELATIVE	   8		</span><span class="cm">/* Adjust by program base */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_GOTOFF	   9		</span><span class="cm">/* 32 bit offset to GOT */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_GOTPC	   10		</span><span class="cm">/* 32 bit PC relative offset to GOT */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_32PLT	   11
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_TLS_TPOFF	   14		</span><span class="cm">/* Offset in static TLS block */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_TLS_IE	   15		</span><span class="cm">/* Address of GOT entry for static TLS
</span></span></span><span class="line"><span class="cl"><span class="cm">					   block offset */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_TLS_GOTIE	   16		</span><span class="cm">/* GOT entry for static TLS block
</span></span></span><span class="line"><span class="cl"><span class="cm">					   offset */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_TLS_LE	   17		</span><span class="cm">/* Offset relative to static TLS
</span></span></span><span class="line"><span class="cl"><span class="cm">					   block */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_TLS_GD	   18		</span><span class="cm">/* Direct 32 bit for GNU version of
</span></span></span><span class="line"><span class="cl"><span class="cm">					   general dynamic thread local data */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_TLS_LDM	   19		</span><span class="cm">/* Direct 32 bit for GNU version of
</span></span></span><span class="line"><span class="cl"><span class="cm">					   local dynamic thread local data
</span></span></span><span class="line"><span class="cl"><span class="cm">					   in LE code */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_16	   20
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_PC16	   21
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_8		   22
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_PC8	   23
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_TLS_GD_32	   24		</span><span class="cm">/* Direct 32 bit for general dynamic
</span></span></span><span class="line"><span class="cl"><span class="cm">					   thread local data */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_TLS_GD_PUSH  25		</span><span class="cm">/* Tag for pushl in GD TLS code */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_TLS_GD_CALL  26		</span><span class="cm">/* Relocation for call to
</span></span></span><span class="line"><span class="cl"><span class="cm">					   __tls_get_addr() */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_TLS_GD_POP   27		</span><span class="cm">/* Tag for popl in GD TLS code */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_TLS_LDM_32   28		</span><span class="cm">/* Direct 32 bit for local dynamic
</span></span></span><span class="line"><span class="cl"><span class="cm">					   thread local data in LE code */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_TLS_LDM_PUSH 29		</span><span class="cm">/* Tag for pushl in LDM TLS code */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_TLS_LDM_CALL 30		</span><span class="cm">/* Relocation for call to
</span></span></span><span class="line"><span class="cl"><span class="cm">					   __tls_get_addr() in LDM code */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_TLS_LDM_POP  31		</span><span class="cm">/* Tag for popl in LDM TLS code */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_TLS_LDO_32   32		</span><span class="cm">/* Offset relative to TLS block */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_TLS_IE_32	   33		</span><span class="cm">/* GOT entry for negated static TLS
</span></span></span><span class="line"><span class="cl"><span class="cm">					   block offset */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_TLS_LE_32	   34		</span><span class="cm">/* Negated offset relative to static
</span></span></span><span class="line"><span class="cl"><span class="cm">					   TLS block */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_TLS_DTPMOD32 35		</span><span class="cm">/* ID of module containing symbol */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_TLS_DTPOFF32 36		</span><span class="cm">/* Offset in TLS block */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_TLS_TPOFF32  37		</span><span class="cm">/* Negated offset in static TLS block */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_SIZE32	   38 		</span><span class="cm">/* 32-bit symbol size */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_TLS_GOTDESC  39		</span><span class="cm">/* GOT offset for TLS descriptor.  */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_TLS_DESC_CALL 40		</span><span class="cm">/* Marker of call through TLS
</span></span></span><span class="line"><span class="cl"><span class="cm">					   descriptor for
</span></span></span><span class="line"><span class="cl"><span class="cm">					   relaxation.  */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_TLS_DESC     41		</span><span class="cm">/* TLS descriptor containing
</span></span></span><span class="line"><span class="cl"><span class="cm">					   pointer to code and to
</span></span></span><span class="line"><span class="cl"><span class="cm">					   argument, returning the TLS
</span></span></span><span class="line"><span class="cl"><span class="cm">					   offset for the symbol.  */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_IRELATIVE	   42		</span><span class="cm">/* Adjust indirectly by program base */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define R_386_GOT32X	   43		</span><span class="cm">/* Load from 32 bit GOT entry,
</span></span></span><span class="line"><span class="cl"><span class="cm">					   relaxable. */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="cm">/* Keep this the last entry.  */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define R_386_NUM	   44
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>x64重定位类型定义如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/* AMD x86-64 relocations.  */
</span></span><span class="line"><span class="cl">#define R_X86_64_NONE		0	/* No reloc */
</span></span><span class="line"><span class="cl">#define R_X86_64_64		1	/* Direct 64 bit  */
</span></span><span class="line"><span class="cl">#define R_X86_64_PC32		2	/* PC relative 32 bit signed */
</span></span><span class="line"><span class="cl">#define R_X86_64_GOT32		3	/* 32 bit GOT entry */
</span></span><span class="line"><span class="cl">#define R_X86_64_PLT32		4	/* 32 bit PLT address */
</span></span><span class="line"><span class="cl">#define R_X86_64_COPY		5	/* Copy symbol at runtime */
</span></span><span class="line"><span class="cl">#define R_X86_64_GLOB_DAT	6	/* Create GOT entry */
</span></span><span class="line"><span class="cl">#define R_X86_64_JUMP_SLOT	7	/* Create PLT entry */
</span></span><span class="line"><span class="cl">#define R_X86_64_RELATIVE	8	/* Adjust by program base */
</span></span><span class="line"><span class="cl">#define R_X86_64_GOTPCREL	9	/* 32 bit signed PC relative
</span></span><span class="line"><span class="cl">					   offset to GOT */
</span></span><span class="line"><span class="cl">#define R_X86_64_32		10	/* Direct 32 bit zero extended */
</span></span><span class="line"><span class="cl">#define R_X86_64_32S		11	/* Direct 32 bit sign extended */
</span></span><span class="line"><span class="cl">#define R_X86_64_16		12	/* Direct 16 bit zero extended */
</span></span><span class="line"><span class="cl">#define R_X86_64_PC16		13	/* 16 bit sign extended pc relative */
</span></span><span class="line"><span class="cl">#define R_X86_64_8		14	/* Direct 8 bit sign extended  */
</span></span><span class="line"><span class="cl">#define R_X86_64_PC8		15	/* 8 bit sign extended pc relative */
</span></span><span class="line"><span class="cl">#define R_X86_64_DTPMOD64	16	/* ID of module containing symbol */
</span></span><span class="line"><span class="cl">#define R_X86_64_DTPOFF64	17	/* Offset in module&#39;s TLS block */
</span></span><span class="line"><span class="cl">#define R_X86_64_TPOFF64	18	/* Offset in initial TLS block */
</span></span><span class="line"><span class="cl">#define R_X86_64_TLSGD		19	/* 32 bit signed PC relative offset
</span></span><span class="line"><span class="cl">					   to two GOT entries for GD symbol */
</span></span><span class="line"><span class="cl">#define R_X86_64_TLSLD		20	/* 32 bit signed PC relative offset
</span></span><span class="line"><span class="cl">					   to two GOT entries for LD symbol */
</span></span><span class="line"><span class="cl">#define R_X86_64_DTPOFF32	21	/* Offset in TLS block */
</span></span><span class="line"><span class="cl">#define R_X86_64_GOTTPOFF	22	/* 32 bit signed PC relative offset
</span></span><span class="line"><span class="cl">					   to GOT entry for IE symbol */
</span></span><span class="line"><span class="cl">#define R_X86_64_TPOFF32	23	/* Offset in initial TLS block */
</span></span><span class="line"><span class="cl">#define R_X86_64_PC64		24	/* PC relative 64 bit */
</span></span><span class="line"><span class="cl">#define R_X86_64_GOTOFF64	25	/* 64 bit offset to GOT */
</span></span><span class="line"><span class="cl">#define R_X86_64_GOTPC32	26	/* 32 bit signed pc relative
</span></span><span class="line"><span class="cl">					   offset to GOT */
</span></span><span class="line"><span class="cl">#define R_X86_64_GOT64		27	/* 64-bit GOT entry offset */
</span></span><span class="line"><span class="cl">#define R_X86_64_GOTPCREL64	28	/* 64-bit PC relative offset
</span></span><span class="line"><span class="cl">					   to GOT entry */
</span></span><span class="line"><span class="cl">#define R_X86_64_GOTPC64	29	/* 64-bit PC relative offset to GOT */
</span></span><span class="line"><span class="cl">#define R_X86_64_GOTPLT64	30 	/* like GOT64, says PLT entry needed */
</span></span><span class="line"><span class="cl">#define R_X86_64_PLTOFF64	31	/* 64-bit GOT relative offset
</span></span><span class="line"><span class="cl">					   to PLT entry */
</span></span><span class="line"><span class="cl">#define R_X86_64_SIZE32		32	/* Size of symbol plus 32-bit addend */
</span></span><span class="line"><span class="cl">#define R_X86_64_SIZE64		33	/* Size of symbol plus 64-bit addend */
</span></span><span class="line"><span class="cl">#define R_X86_64_GOTPC32_TLSDESC 34	/* GOT offset for TLS descriptor.  */
</span></span><span class="line"><span class="cl">#define R_X86_64_TLSDESC_CALL   35	/* Marker for call through TLS
</span></span><span class="line"><span class="cl">					   descriptor.  */
</span></span><span class="line"><span class="cl">#define R_X86_64_TLSDESC        36	/* TLS descriptor.  */
</span></span><span class="line"><span class="cl">#define R_X86_64_IRELATIVE	37	/* Adjust indirectly by program base */
</span></span><span class="line"><span class="cl">#define R_X86_64_RELATIVE64	38	/* 64-bit adjust by program base */
</span></span><span class="line"><span class="cl">					/* 39 Reserved was R_X86_64_PC32_BND */
</span></span><span class="line"><span class="cl">					/* 40 Reserved was R_X86_64_PLT32_BND */
</span></span><span class="line"><span class="cl">#define R_X86_64_GOTPCRELX	41	/* Load from 32 bit signed pc relative
</span></span><span class="line"><span class="cl">					   offset to GOT entry without REX
</span></span><span class="line"><span class="cl">					   prefix, relaxable.  */
</span></span><span class="line"><span class="cl">#define R_X86_64_REX_GOTPCRELX	42	/* Load from 32 bit signed pc relative
</span></span><span class="line"><span class="cl">					   offset to GOT entry with REX prefix,
</span></span><span class="line"><span class="cl">					   relaxable.  */
</span></span><span class="line"><span class="cl">#define R_X86_64_NUM		43
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="打印重定位表">打印重定位表
</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// Print Relocation Table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">getRelocationTypeString32</span><span class="p">(</span><span class="n">Elf_Word</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">R_386_NONE</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;R_386_NONE&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_32&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">2</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_PC32&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">3</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_GOT32&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">4</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_PLT32&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">5</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_COPY&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">6</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_GLOB_DAT&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">7</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_JMP_SLOT&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">8</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_RELATIVE&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">9</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_GOTOFF&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">10</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_GOTPC&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">11</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_32PLT&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">14</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_TLS_TPOFF&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">15</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_TLS_IE&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">16</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_TLS_GOTIE&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">17</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_TLS_LE&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">18</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_TLS_GD&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">19</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_TLS_LDM&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">20</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_16&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">21</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_PC16&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">22</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_8&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">23</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_PC8&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">24</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_TLS_GD_32&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">25</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_TLS_GD_PUSH&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">26</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_TLS_GD_CALL&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">27</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_TLS_GD_POP&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">28</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_TLS_LDM_32&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">29</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_TLS_LDM_PUSH&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">30</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_TLS_LDM_CALL&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">31</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_TLS_LDM_POP&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">32</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_TLS_LDO_32&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">33</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_TLS_IE_32&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">34</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_TLS_LE_32&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">35</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_TLS_DTPMOD32&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">36</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_TLS_DTPOFF32&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">37</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_TLS_TPOFF32&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">38</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_SIZE32&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">39</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_TLS_GOTDESC&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">40</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_TLS_DESC_CALL&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">41</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_TLS_DESC&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">42</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_IRELATIVE&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">43</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;R_386_GOT32X&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;Unknown relocation type&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">printRelocationTable32</span><span class="p">(</span><span class="k">const</span> <span class="n">Elf32_Shdr</span><span class="o">*</span> <span class="n">pSectionHeader</span><span class="p">,</span><span class="n">Elf_Half</span> <span class="n">sectionNum</span><span class="p">,</span><span class="kt">uint8_t</span><span class="o">*</span> <span class="n">pFileBuffer</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">pSectionHeaderStringTable</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Relocation Tables:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sectionNum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_type</span> <span class="o">==</span> <span class="n">SHT_REL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Elf32_Shdr</span> <span class="o">*</span><span class="n">pRelocationTableHeader</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="n">Elf32_Rel</span> <span class="o">*</span><span class="n">pRelocationTable</span> <span class="o">=</span> <span class="p">(</span><span class="n">Elf32_Rel</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pFileBuffer</span> <span class="o">+</span> <span class="n">pRelocationTableHeader</span><span class="o">-&gt;</span><span class="n">sh_offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Elf32_Word</span> <span class="n">relocItemNum</span> <span class="o">=</span> <span class="n">pRelocationTableHeader</span><span class="o">-&gt;</span><span class="n">sh_size</span> <span class="o">/</span> <span class="n">pRelocationTableHeader</span><span class="o">-&gt;</span><span class="n">sh_entsize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// relocation table sh_link is index of symbol table header
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">Elf32_Shdr</span> <span class="o">*</span><span class="n">pSymbolTableHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">Elf32_Shdr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSectionHeader</span><span class="p">[</span><span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_link</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//real symbol table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">Elf32_Sym</span> <span class="o">*</span><span class="n">pSymbolTable</span> <span class="o">=</span> <span class="p">(</span><span class="n">Elf32_Sym</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pFileBuffer</span> <span class="o">+</span> <span class="n">pSymbolTableHeader</span><span class="o">-&gt;</span><span class="n">sh_offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//string table for symbol name
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">char</span> <span class="o">*</span><span class="n">pSymbolTableStringTable</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">pFileBuffer</span> <span class="o">+</span> <span class="n">pSectionHeader</span><span class="p">[</span><span class="n">pSymbolTableHeader</span><span class="o">-&gt;</span><span class="n">sh_link</span><span class="p">].</span><span class="n">sh_offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Relocation Section &#39;%s&#39; at offset contains %d entries</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="n">pSectionHeaderStringTable</span> <span class="o">+</span> <span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_name</span><span class="p">,</span> <span class="n">relocItemNum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">Offset</span><span class="se">\t\t</span><span class="s">Info</span><span class="se">\t\t</span><span class="s">Type</span><span class="se">\t\t\t\t</span><span class="s">Sym.value</span><span class="se">\t\t</span><span class="s">Sym.name</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">relocItemNum</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%08x&#34;</span><span class="p">,</span> <span class="n">pRelocationTable</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">r_offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%08x&#34;</span><span class="p">,</span> <span class="n">pRelocationTable</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">r_info</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%s</span><span class="se">\t</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">getRelocationTypeString32</span><span class="p">(</span><span class="nf">ELF32_R_TYPE</span><span class="p">(</span><span class="n">pRelocationTable</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">r_info</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%08x</span><span class="se">\t</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pSymbolTable</span><span class="p">[</span><span class="nf">ELF32_R_SYM</span><span class="p">(</span><span class="n">pRelocationTable</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">r_info</span><span class="p">)].</span><span class="n">st_value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//R_SYM get the index of symbol in symbol table, st_name is index of symbol name in string table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%s&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pSymbolTableStringTable</span><span class="p">[</span><span class="n">pSymbolTable</span><span class="p">[</span><span class="nf">ELF32_R_SYM</span><span class="p">(</span><span class="n">pRelocationTable</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">r_info</span><span class="p">)].</span><span class="n">st_name</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/19-RelocationTable-printRelocationTable.png"
	width="934"
	height="369"
	srcset="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/19-RelocationTable-printRelocationTable_hu_6666dd897e51c4ee.png 480w, /p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/19-RelocationTable-printRelocationTable_hu_23e1dcd864ed0c72.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="253"
		data-flex-basis="607px"
	
></p>
<h2 id="修复重定位表">修复重定位表
</h2><p>r_offset指定了待修复的地址,这是一个RVA, 需要将该地址存储的数据加上elf文件加载的基地址</p>
<p>例如readelf读取的重定位表信息如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Relocation section &#39;.rel.dyn&#39; at offset 0x384 contains 8 entries:
</span></span><span class="line"><span class="cl"> Offset     Info    Type            Sym.Value  Sym. Name
</span></span><span class="line"><span class="cl">00003ee8  00000008 R_386_RELATIVE   
</span></span><span class="line"><span class="cl">00003eec  00000008 R_386_RELATIVE   
</span></span><span class="line"><span class="cl">00003fec  00000008 R_386_RELATIVE   
</span></span><span class="line"><span class="cl">0000400c  00000008 R_386_RELATIVE   
</span></span><span class="line"><span class="cl">00003fe0  00000206 R_386_GLOB_DAT    00000000   _ITM_deregisterTM[...]
</span></span><span class="line"><span class="cl">00003fe4  00000306 R_386_GLOB_DAT    00000000   __cxa_finalize@GLIBC_2.1.3
</span></span><span class="line"><span class="cl">00003fe8  00000506 R_386_GLOB_DAT    00000000   __gmon_start__
</span></span><span class="line"><span class="cl">00003ff0  00000606 R_386_GLOB_DAT    00000000   _ITM_registerTMCl[...]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Relocation section &#39;.rel.plt&#39; at offset 0x3c4 contains 2 entries:
</span></span><span class="line"><span class="cl"> Offset     Info    Type            Sym.Value  Sym. Name
</span></span><span class="line"><span class="cl">00004000  00000107 R_386_JUMP_SLOT   00000000   __libc_start_main@GLIBC_2.34
</span></span><span class="line"><span class="cl">00004004  00000407 R_386_JUMP_SLOT   00000000   puts@GLIBC_2.0
</span></span><span class="line"><span class="cl">No processor specific unwind information to decode
</span></span></code></pre></td></tr></table>
</div>
</div><p>3ee8和3eec分别在init_array和fini_array段,均为RELATIVE类型重定位项</p>
<p><img src="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/20-init_array%E5%92%8Cfini_array.png"
	width="1184"
	height="563"
	srcset="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/20-init_array%E5%92%8Cfini_array_hu_7a04a524aa0521ff.png 480w, /p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/20-init_array%E5%92%8Cfini_array_hu_6eaab39679e35727.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="210"
		data-flex-basis="504px"
	
></p>
<p>3fec, 3fe0,3fe4,3fe8,3ff0是GOT表项, 其中3fec (main_ptr) 是RELATIVE类型,其他均为GLOB_DAT类型</p>
<p>表项填充的函数为虚拟extern段中函数的地址,该段在内存中实际不存在</p>
<p><img src="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/21-got.png"
	width="1191"
	height="542"
	srcset="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/21-got_hu_312501d76efd301.png 480w, /p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/21-got_hu_ccc762a67928194b.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="219"
		data-flex-basis="527px"
	
></p>
<p>4000,4004是plt表项, 均为JUMP_SLOT类型, 400c是dso_handle, 为RELATIVE类型</p>
<p>got.plt表填充的也是外部函数地址,在虚拟extern段</p>
<p><img src="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/22-plt.png"
	width="1127"
	height="623"
	srcset="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/22-plt_hu_51910cd848ee55f6.png 480w, /p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/22-plt_hu_7ead3f505bae77b7.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="180"
		data-flex-basis="434px"
	
></p>
<p>在elf文件末尾,ida自动追加extern段(该段在内存中不存在,仅供分析)</p>
<p><img src="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/23-EndOfELF.png"
	width="1442"
	height="657"
	srcset="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/23-EndOfELF_hu_5eec94e8b60af7f7.png 480w, /p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/23-EndOfELF_hu_6f21bf2c5b0d8bd1.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="219"
		data-flex-basis="526px"
	
></p>
<p>综上所述,重定位有以下情况:</p>
<ol>
<li>
<p>将待重定位地址处的内容解引用并加上elf加载的基地址即可</p>
<p>这种情况是针对elf文件内部变量绝对地址引用需要修复</p>
<p>例如RELATIVE类型</p>
</li>
<li>
<p>加载动态库,写入外部函数地址</p>
<p>针对外部引用地址修复</p>
<p>例如GLOB_DAT和JUMP_SLOT类型</p>
</li>
</ol>
<h1 id="dynamic-segment">Dynamic Segment
</h1><p>如果目标文件参与动态链接,必定包含一个类型为 PT_DYNAMIC 的Program表项, 对应节名为 .dynamic (type=SHT_DYNAMIC)</p>
<p>动态段的作用是提供动态链接器所需要的信息,比如依赖哪些共享库文件,动态链接符号表的位置,动态链接重定位表的位置等</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* Dynamic section entry.  */</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Sword</span>	<span class="n">d_tag</span><span class="p">;</span>			<span class="cm">/* Dynamic entry type */</span>
</span></span><span class="line"><span class="cl">  <span class="k">union</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">Elf32_Word</span> <span class="n">d_val</span><span class="p">;</span>			<span class="cm">/* Integer value */</span>
</span></span><span class="line"><span class="cl">      <span class="n">Elf32_Addr</span> <span class="n">d_ptr</span><span class="p">;</span>			<span class="cm">/* Address value */</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">d_un</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">Elf32_Dyn</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf64_Sxword</span>	<span class="n">d_tag</span><span class="p">;</span>			<span class="cm">/* Dynamic entry type */</span>
</span></span><span class="line"><span class="cl">  <span class="k">union</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">Elf64_Xword</span> <span class="n">d_val</span><span class="p">;</span>		<span class="cm">/* Integer value */</span>
</span></span><span class="line"><span class="cl">      <span class="n">Elf64_Addr</span> <span class="n">d_ptr</span><span class="p">;</span>			<span class="cm">/* Address value */</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">d_un</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">Elf64_Dyn</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="d_tag">d_tag
</h2><p>d_tag决定了如何对d_un解析</p>
<p>合法的d_tag值定义如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* Legal values for d_tag (dynamic entry type).  */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define DT_NULL		0		</span><span class="cm">/* Marks end of dynamic section */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_NEEDED	1		</span><span class="cm">/* Name of needed library */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_PLTRELSZ	2		</span><span class="cm">/* Size in bytes of PLT relocs */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_PLTGOT	3		</span><span class="cm">/* Processor defined value */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_HASH		4		</span><span class="cm">/* Address of symbol hash table */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_STRTAB	5		</span><span class="cm">/* Address of string table */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_SYMTAB	6		</span><span class="cm">/* Address of symbol table */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_RELA		7		</span><span class="cm">/* Address of Rela relocs */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_RELASZ	8		</span><span class="cm">/* Total size of Rela relocs */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_RELAENT	9		</span><span class="cm">/* Size of one Rela reloc */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_STRSZ	10		</span><span class="cm">/* Size of string table */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_SYMENT	11		</span><span class="cm">/* Size of one symbol table entry */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_INIT		12		</span><span class="cm">/* Address of init function */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_FINI		13		</span><span class="cm">/* Address of termination function */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_SONAME	14		</span><span class="cm">/* Name of shared object */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_RPATH	15		</span><span class="cm">/* Library search path (deprecated) */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_SYMBOLIC	16		</span><span class="cm">/* Start symbol search here */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_REL		17		</span><span class="cm">/* Address of Rel relocs */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_RELSZ	18		</span><span class="cm">/* Total size of Rel relocs */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_RELENT	19		</span><span class="cm">/* Size of one Rel reloc */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_PLTREL	20		</span><span class="cm">/* Type of reloc in PLT */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_DEBUG	21		</span><span class="cm">/* For debugging; unspecified */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_TEXTREL	22		</span><span class="cm">/* Reloc might modify .text */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_JMPREL	23		</span><span class="cm">/* Address of PLT relocs */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define	DT_BIND_NOW	24		</span><span class="cm">/* Process relocations of object */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define	DT_INIT_ARRAY	25		</span><span class="cm">/* Array with addresses of init fct */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define	DT_FINI_ARRAY	26		</span><span class="cm">/* Array with addresses of fini fct */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define	DT_INIT_ARRAYSZ	27		</span><span class="cm">/* Size in bytes of DT_INIT_ARRAY */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define	DT_FINI_ARRAYSZ	28		</span><span class="cm">/* Size in bytes of DT_FINI_ARRAY */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_RUNPATH	29		</span><span class="cm">/* Library search path */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_FLAGS	30		</span><span class="cm">/* Flags for the object being loaded */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_ENCODING	32		</span><span class="cm">/* Start of encoded range */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_PREINIT_ARRAY 32		</span><span class="cm">/* Array with addresses of preinit fct*/</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_PREINIT_ARRAYSZ 33		</span><span class="cm">/* size in bytes of DT_PREINIT_ARRAY */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_SYMTAB_SHNDX	34		</span><span class="cm">/* Address of SYMTAB_SHNDX section */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_RELRSZ	35		</span><span class="cm">/* Total size of RELR relative relocations */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_RELR		36		</span><span class="cm">/* Address of RELR relative relocations */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_RELRENT	37		</span><span class="cm">/* Size of one RELR relative relocaction */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define	DT_NUM		38		</span><span class="cm">/* Number used */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_LOOS		0x6000000d	</span><span class="cm">/* Start of OS-specific */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_HIOS		0x6ffff000	</span><span class="cm">/* End of OS-specific */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_LOPROC	0x70000000	</span><span class="cm">/* Start of processor-specific */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_HIPROC	0x7fffffff	</span><span class="cm">/* End of processor-specific */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define	DT_PROCNUM	DT_MIPS_NUM	</span><span class="cm">/* Most used by any processor */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/* DT_* entries which fall between DT_VALRNGHI &amp; DT_VALRNGLO use the
</span></span></span><span class="line"><span class="cl"><span class="cm">   Dyn.d_un.d_val field of the Elf*_Dyn structure.  This follows Sun&#39;s
</span></span></span><span class="line"><span class="cl"><span class="cm">   approach.  */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define DT_VALRNGLO	0x6ffffd00
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_GNU_PRELINKED 0x6ffffdf5	</span><span class="cm">/* Prelinking timestamp */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_GNU_CONFLICTSZ 0x6ffffdf6	</span><span class="cm">/* Size of conflict section */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_GNU_LIBLISTSZ 0x6ffffdf7	</span><span class="cm">/* Size of library list */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_CHECKSUM	0x6ffffdf8
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_PLTPADSZ	0x6ffffdf9
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_MOVEENT	0x6ffffdfa
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_MOVESZ	0x6ffffdfb
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_FEATURE_1	0x6ffffdfc	</span><span class="cm">/* Feature selection (DTF_*).  */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_POSFLAG_1	0x6ffffdfd	</span><span class="cm">/* Flags for DT_* entries, effecting
</span></span></span><span class="line"><span class="cl"><span class="cm">					   the following DT_* entry.  */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_SYMINSZ	0x6ffffdfe	</span><span class="cm">/* Size of syminfo table (in bytes) */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_SYMINENT	0x6ffffdff	</span><span class="cm">/* Entry size of syminfo */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_VALRNGHI	0x6ffffdff
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_VALTAGIDX(tag)	(DT_VALRNGHI - (tag))	</span><span class="cm">/* Reverse order! */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_VALNUM 12
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/* DT_* entries which fall between DT_ADDRRNGHI &amp; DT_ADDRRNGLO use the
</span></span></span><span class="line"><span class="cl"><span class="cm">   Dyn.d_un.d_ptr field of the Elf*_Dyn structure.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">   If any adjustment is made to the ELF object after it has been
</span></span></span><span class="line"><span class="cl"><span class="cm">   built these entries will need to be adjusted.  */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define DT_ADDRRNGLO	0x6ffffe00
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_GNU_HASH	0x6ffffef5	</span><span class="cm">/* GNU-style hash table.  */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_TLSDESC_PLT	0x6ffffef6
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_TLSDESC_GOT	0x6ffffef7
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_GNU_CONFLICT	0x6ffffef8	</span><span class="cm">/* Start of conflict section */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_GNU_LIBLIST	0x6ffffef9	</span><span class="cm">/* Library list */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_CONFIG	0x6ffffefa	</span><span class="cm">/* Configuration information.  */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_DEPAUDIT	0x6ffffefb	</span><span class="cm">/* Dependency auditing.  */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_AUDIT	0x6ffffefc	</span><span class="cm">/* Object auditing.  */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define	DT_PLTPAD	0x6ffffefd	</span><span class="cm">/* PLT padding.  */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define	DT_MOVETAB	0x6ffffefe	</span><span class="cm">/* Move table.  */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_SYMINFO	0x6ffffeff	</span><span class="cm">/* Syminfo table.  */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_ADDRRNGHI	0x6ffffeff
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_ADDRTAGIDX(tag)	(DT_ADDRRNGHI - (tag))	</span><span class="cm">/* Reverse order! */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_ADDRNUM 11
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/* The versioning entry types.  The next are defined as part of the GNU extension.  */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define DT_VERSYM	0x6ffffff0
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define DT_RELACOUNT	0x6ffffff9
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_RELCOUNT	0x6ffffffa
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/* These were chosen by Sun.  */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define DT_FLAGS_1	0x6ffffffb	</span><span class="cm">/* State flags, see DF_1_* below.  */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define	DT_VERDEF	0x6ffffffc	</span><span class="cm">/* Address of version definition table */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define	DT_VERDEFNUM	0x6ffffffd	</span><span class="cm">/* Number of version definitions */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define	DT_VERNEED	0x6ffffffe	</span><span class="cm">/* Address of table with needed versions */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define	DT_VERNEEDNUM	0x6fffffff	</span><span class="cm">/* Number of needed versions */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_VERSIONTAGIDX(tag)	(DT_VERNEEDNUM - (tag))	</span><span class="cm">/* Reverse order! */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_VERSIONTAGNUM 16
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/* Sun added these machine-independent extensions in the &#34;processor-specific&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">   range.  Be compatible.  */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define DT_AUXILIARY    0x7ffffffd      </span><span class="cm">/* Shared object to load before self */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_FILTER       0x7fffffff      </span><span class="cm">/* Shared object to get values from */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_EXTRATAGIDX(tag)	((Elf32_Word)-((Elf32_Sword) (tag) &lt;&lt;1&gt;&gt;1)-1)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_EXTRANUM	3
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="dt_needed">DT_NEEDED
</h2><p>该tag对应的即为elf文件依赖的动态库文件,使用d_val解析后得到索引值</p>
<p>通过索引查找.dynstr即可得到链接库名</p>
<p>动态段的sh_link字段是指向动态链接字符串表的索引值</p>
<p>另外通过d_tag==DT_STRTAB解析对应的d_val可以得到.dynstr的文件偏移值</p>
<h2 id="d_un">d_un
</h2><p>d_val 代表整数值</p>
<p>d_ptr 代表进程空间的虚拟地址</p>
<p>解析规则如下</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>名称</th>
          <th>值</th>
          <th>d_un</th>
          <th>可执行文件</th>
          <th>共享目标文件</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>DT_NULL</td>
          <td>0</td>
          <td>忽略</td>
          <td>必需</td>
          <td>必需</td>
      </tr>
      <tr>
          <td>DT_NEEDED</td>
          <td>1</td>
          <td>d_val</td>
          <td>可选</td>
          <td>可选</td>
      </tr>
      <tr>
          <td>DT_PLTRELSZ</td>
          <td>2</td>
          <td>d_val</td>
          <td>可选</td>
          <td>可选</td>
      </tr>
      <tr>
          <td>DT_PLTGOT</td>
          <td>3</td>
          <td>d_ptr</td>
          <td>可选</td>
          <td>可选</td>
      </tr>
      <tr>
          <td>DT_HASH</td>
          <td>4</td>
          <td>d_ptr</td>
          <td>必需</td>
          <td>必需</td>
      </tr>
      <tr>
          <td>DT_STRTAB</td>
          <td>5</td>
          <td>d_ptr</td>
          <td>必需</td>
          <td>必需</td>
      </tr>
      <tr>
          <td>DT_SYMTAB</td>
          <td>6</td>
          <td>d_ptr</td>
          <td>必需</td>
          <td>必需</td>
      </tr>
      <tr>
          <td>DT_RELA</td>
          <td>7</td>
          <td>d_ptr</td>
          <td>必需</td>
          <td>可选</td>
      </tr>
      <tr>
          <td>DT_RELASZ</td>
          <td>8</td>
          <td>d_val</td>
          <td>必需</td>
          <td>可选</td>
      </tr>
      <tr>
          <td>DT_RELAENT</td>
          <td>9</td>
          <td>d_val</td>
          <td>必需</td>
          <td>可选</td>
      </tr>
      <tr>
          <td>DT_STRSZ</td>
          <td>10</td>
          <td>d_val</td>
          <td>必需</td>
          <td>必需</td>
      </tr>
      <tr>
          <td>DT_SYMENT</td>
          <td>11</td>
          <td>d_val</td>
          <td>必需</td>
          <td>必需</td>
      </tr>
      <tr>
          <td>DT_INIT</td>
          <td>12</td>
          <td>d_ptr</td>
          <td>可选</td>
          <td>可选</td>
      </tr>
      <tr>
          <td>DT_FINI</td>
          <td>13</td>
          <td>d_ptr</td>
          <td>可选</td>
          <td>可选</td>
      </tr>
      <tr>
          <td>DT_SONAME</td>
          <td>14</td>
          <td>d_val</td>
          <td>忽略</td>
          <td>可选</td>
      </tr>
      <tr>
          <td>DT_RPATH</td>
          <td>15</td>
          <td>d_val</td>
          <td>可选</td>
          <td>忽略</td>
      </tr>
      <tr>
          <td>DT_SYMBOLIC</td>
          <td>16</td>
          <td>忽略</td>
          <td>忽略</td>
          <td>可选</td>
      </tr>
      <tr>
          <td>DT_REL</td>
          <td>17</td>
          <td>d_ptr</td>
          <td>必需</td>
          <td>可选</td>
      </tr>
      <tr>
          <td>DT_RELSZ</td>
          <td>18</td>
          <td>d_val</td>
          <td>必需</td>
          <td>可选</td>
      </tr>
      <tr>
          <td>DT_RELENT</td>
          <td>19</td>
          <td>d_val</td>
          <td>必需</td>
          <td>可选</td>
      </tr>
      <tr>
          <td>DT_PLTREL</td>
          <td>20</td>
          <td>d_val</td>
          <td>可选</td>
          <td>可选</td>
      </tr>
      <tr>
          <td>DT_DEBUG</td>
          <td>21</td>
          <td>d_ptr</td>
          <td>可选</td>
          <td>忽略</td>
      </tr>
      <tr>
          <td>DT_TEXTREL</td>
          <td>22</td>
          <td>忽略</td>
          <td>可选</td>
          <td>可选</td>
      </tr>
      <tr>
          <td>DT_JMPREL</td>
          <td>23</td>
          <td>d_ptr</td>
          <td>可选</td>
          <td>可选</td>
      </tr>
      <tr>
          <td>DT_BIND_NOW</td>
          <td>24</td>
          <td>忽略</td>
          <td>可选</td>
          <td>可选</td>
      </tr>
      <tr>
          <td>DT_LOPROC</td>
          <td>0x70000000</td>
          <td>未定义</td>
          <td>未定义</td>
          <td>未定义</td>
      </tr>
      <tr>
          <td>DT_HIPROC</td>
          <td>0x7fffffff</td>
          <td>未定义</td>
          <td>未定义</td>
          <td>未定义</td>
      </tr>
  </tbody>
</table></div>
<h2 id="打印动态段">打印动态段
</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// Print Dynamic Segment
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define DT_VAL 0
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_PTR 1
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">getDynamicType</span><span class="p">(</span><span class="n">Elf_Xword</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="n">DT_LOOS</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="n">DT_HIOS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;OS-Specific&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="n">DT_LOPROC</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="n">DT_HIPROC</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;Processor-Specific&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_NULL</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;NULL&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_NEEDED</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;NEEDED&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_PLTRELSZ</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;PLTRELSZ&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_PLTGOT</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;PLTGOT&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_HASH</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;HASH&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_STRTAB</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;STRTAB&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_SYMTAB</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;SYMTAB&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_RELA</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;RELA&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_RELASZ</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;RELASZ&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_RELAENT</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;RELAENT&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_STRSZ</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;STRSZ&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_SYMENT</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;SYMENT&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_INIT</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;INIT&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_FINI</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;FINI&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_SONAME</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;SONAME&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_RPATH</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;RPATH&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_SYMBOLIC</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;SYMBOLIC&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_REL</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;REL&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_RELSZ</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;RELSZ&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_RELENT</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;RELENT&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_PLTREL</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;PLTREL&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_DEBUG</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;DEBUG&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_TEXTREL</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;TEXTREL&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_JMPREL</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;JMPREL&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_BIND_NOW</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;BIND_NOW&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_INIT_ARRAY</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;INIT_ARRAY&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_FINI_ARRAY</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;FINI_ARRAY&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_INIT_ARRAYSZ</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;INIT_ARRAYSZ&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_FINI_ARRAYSZ</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;FINI_ARRAYSZ&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_RUNPATH</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;RUNPATH&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_FLAGS</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;FLAGS&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_ENCODING</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;ENCODING&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_SYMTAB_SHNDX</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;SYMTAB_SHNDX&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_RELRSZ</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;RELRSZ&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_RELR</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;RELR&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_RELRENT</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;RELRENT&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_NUM</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;NUM&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_VALRNGLO</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;VALRNGLO&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_GNU_PRELINKED</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;GNU_PRELINKED&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_GNU_CONFLICTSZ</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;GNU_CONFLICTSZ&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_GNU_LIBLISTSZ</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;GNU_LIBLISTSZ&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_CHECKSUM</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;CHECKSUM&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_PLTPADSZ</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;PLTPADSZ&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_MOVEENT</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;MOVEENT&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_MOVESZ</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;MOVESZ&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_FEATURE_1</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;FEATURE_1&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_POSFLAG_1</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;POSFLAG_1&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_SYMINSZ</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;SYMINSZ&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_SYMINENT</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;SYMINENT&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_ADDRRNGLO</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;ADDRRNGLO&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_GNU_HASH</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;GNU_HASH&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_TLSDESC_PLT</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;TLSDESC_PLT&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_TLSDESC_GOT</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;TLSDESC_GOT&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_GNU_CONFLICT</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;GNU_CONFLICT&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_GNU_LIBLIST</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;GNU_LIBLIST&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_CONFIG</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;CONFIG&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_DEPAUDIT</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;DEPAUDIT&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_AUDIT</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;AUDIT&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_PLTPAD</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;PLTPAD&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_MOVETAB</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;MOVETAB&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_SYMINFO</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;SYMINFO&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_VERSYM</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;VERSYM&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_RELACOUNT</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;RELACOUNT&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_RELCOUNT</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;RELCOUNT&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_FLAGS_1</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;FLAGS_1&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_VERDEF</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;VERDEF&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_VERDEFNUM</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;VERDEFNUM&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_VERNEED</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;VERNEED&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_VERNEEDNUM</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;VERNEEDNUM&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_AUXILIARY</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;AUXILIARY&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_FILTER</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#34;FILTER&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="o">:</span> <span class="k">return</span> <span class="s">&#34;Unknown Type&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">uint32_t</span> <span class="nf">getDynamicDunType</span><span class="p">(</span><span class="n">Elf_Xword</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_NULL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_NEEDED</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_PLTRELSZ</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_RELASZ</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_RELAENT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_STRSZ</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_SYMENT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_SONAME</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_RPATH</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_SYMBOLIC</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_RELSZ</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_RELENT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_PLTREL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_TEXTREL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_BIND_NOW</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_LOPROC</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_HIPROC</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">DT_VAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_PLTGOT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_HASH</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_STRTAB</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_SYMTAB</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_RELA</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_INIT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_FINI</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_JMPREL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_DEBUG</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_REL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">DT_PTR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">DT_VAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">printDynamicSegment32</span><span class="p">(</span><span class="k">const</span> <span class="n">Elf32_Shdr</span><span class="o">*</span> <span class="n">pSectionHeader</span><span class="p">,</span><span class="n">Elf_Half</span> <span class="n">sectionNum</span><span class="p">,</span><span class="kt">uint8_t</span><span class="o">*</span> <span class="n">pFileBuffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sectionNum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_type</span> <span class="o">==</span> <span class="n">SHT_DYNAMIC</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Elf32_Shdr</span> <span class="o">*</span><span class="n">pDynamicSection</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="n">Elf32_Word</span> <span class="n">dynamicItemNum</span> <span class="o">=</span> <span class="n">pDynamicSection</span><span class="o">-&gt;</span><span class="n">sh_size</span> <span class="o">/</span> <span class="n">pDynamicSection</span><span class="o">-&gt;</span><span class="n">sh_entsize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Dynamic Section At File Offset %#x Contains %d Entries:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pDynamicSection</span><span class="o">-&gt;</span><span class="n">sh_offset</span><span class="p">,</span><span class="n">dynamicItemNum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">Tag </span><span class="se">\t\t</span><span class="s">Type</span><span class="se">\t\t\t\t</span><span class="s">Name/Value</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Elf32_Dyn</span> <span class="o">*</span><span class="n">pDynamicTable</span> <span class="o">=</span> <span class="p">(</span><span class="n">Elf32_Dyn</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pFileBuffer</span> <span class="o">+</span> <span class="n">pDynamicSection</span><span class="o">-&gt;</span><span class="n">sh_offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Elf32_Shdr</span> <span class="o">*</span><span class="n">pDynamicStringTableHeader</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pSectionHeader</span><span class="p">[</span><span class="n">pDynamicSection</span><span class="o">-&gt;</span><span class="n">sh_link</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// dynamic string table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">char</span> <span class="o">*</span><span class="n">pDynamicStringTable</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">pFileBuffer</span> <span class="o">+</span> <span class="n">pDynamicStringTableHeader</span><span class="o">-&gt;</span><span class="n">sh_offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">dynamicItemNum</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%08x&#34;</span><span class="p">,</span> <span class="n">pDynamicTable</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">d_tag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%-16s&#34;</span><span class="p">,</span> <span class="nf">getDynamicType</span><span class="p">(</span><span class="n">pDynamicTable</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">d_tag</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%08x</span><span class="se">\t</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pDynamicTable</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nf">getDynamicDunType</span><span class="p">(</span><span class="n">pDynamicTable</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">d_tag</span><span class="p">)</span> <span class="o">==</span> <span class="n">DT_PTR</span><span class="p">)</span> <span class="c1">//Some special item is ptr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;(PTR)&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//Index of shared library path in dynamic string table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">switch</span> <span class="p">(</span><span class="n">pDynamicTable</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">d_tag</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="nl">DT_NEEDED</span><span class="p">:</span> <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[%s]&#34;</span><span class="p">,</span> <span class="n">pDynamicStringTable</span> <span class="o">+</span> <span class="n">pDynamicTable</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">case</span> <span class="nl">DT_SONAME</span><span class="p">:</span> <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[%s]&#34;</span><span class="p">,</span> <span class="n">pDynamicStringTable</span> <span class="o">+</span> <span class="n">pDynamicTable</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">default</span><span class="o">:</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/24-DynamicSegment-printDynamicSegment.png"
	width="614"
	height="769"
	srcset="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/24-DynamicSegment-printDynamicSegment_hu_18f2de063ff9b3a4.png 480w, /p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/24-DynamicSegment-printDynamicSegment_hu_79d4c0eb90e0318e.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="79"
		data-flex-basis="191px"
	
></p>
<h1 id="hash-table-export-table">Hash Table (Export Table)
</h1><p>哈希表可用于查询导出函数, 有两种, 目前的elf文件主要是用GNU HASH表作为导出表</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">.hash 		//旧版,可以查导入和导出函数 DT_HASH
</span></span><span class="line"><span class="cl">.gnu.hash 	//新版,只能查导出函数 DT_GNU_HASH
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="elf-hash">ELF Hash
</h2><p>Hash表定义如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">ELFHash</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span>  <span class="n">nbucket</span><span class="p">;</span>  <span class="c1">//bucket的数目
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint32_t</span>  <span class="n">nchain</span><span class="p">;</span>  	<span class="c1">//chain的数目,和动态符号表的符号数相同
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint32_t</span>  <span class="n">buckets</span><span class="p">[];</span>  <span class="c1">//nbucket个项的数组
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint32_t</span>  <span class="n">chains</span><span class="p">[];</span>   <span class="c1">//nchain个项的数组
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Linux原始Elf Hash算法如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">uint32_t</span> <span class="nf">elf_hash</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="kt">uint32_t</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">g</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="o">*</span><span class="n">name</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">g</span> <span class="o">=</span> <span class="n">h</span> <span class="o">&amp;</span> <span class="mh">0xf0000000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  	<span class="n">h</span> <span class="o">^=</span> <span class="n">g</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">h</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">g</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="k">return</span> <span class="n">h</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ELF Hash Table根据符号名查找符号地址的流程如下</p>
<ol>
<li>
<p>根据elfhash函数计算符号名的hash</p>
</li>
<li>
<p>index=buckets[hash%nbucket]</p>
<p>index即为符号在符号表中的索引</p>
</li>
<li>
<p>如果index==SHT_UNDEF(0)则未找到符号,结束</p>
<p>否则判断符号表中索引index的符号和目标符号是否相同</p>
</li>
<li>
<p>如果符号名不同则根据index从chains表找下一个符号索引,继续第3步</p>
<p>index=chains[index] (如果chains[index]==0说明不存在该符号)</p>
</li>
</ol>
<p>代码表示如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">uint32_t</span> <span class="nf">findSymbolIndexByElfHash</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">symbolName</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                  <span class="kt">uint32_t</span><span class="o">*</span> <span class="n">pHashTable</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">Elf32_Sym</span><span class="o">*</span> <span class="n">pSymbolTable</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">pSymbolStringTable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">nbucket</span><span class="o">=</span><span class="n">pHashTable</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">nchain</span><span class="o">=</span><span class="n">pHashTable</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span><span class="o">*</span> <span class="n">buckets</span><span class="o">=&amp;</span><span class="n">pHashTable</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="o">*</span><span class="n">chains</span><span class="o">=&amp;</span><span class="n">pHashTable</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">nbucket</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">hash</span> <span class="o">=</span> <span class="nf">elf_hash</span><span class="p">(</span><span class="n">symbolName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">index</span><span class="o">=</span><span class="n">buckets</span><span class="p">[</span><span class="n">hash</span> <span class="o">%</span> <span class="n">nbucket</span><span class="p">];</span> <span class="n">index</span><span class="p">;</span> <span class="n">index</span> <span class="o">=</span> <span class="n">chains</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">strcmp</span><span class="p">(</span><span class="n">symbolName</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pSymbolStringTable</span><span class="p">[</span><span class="n">pSymbolTable</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">st_name</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>手工查找流程示例:</p>
<p>由于x86_64下gcc编译的elf程序默认只使用gnu.hash,以Android NDK得到的64位so为例</p>
<p>找到.hash节,发现nbucket=nchain=0x36</p>
<p><img src="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/25-HashTable-libfindflagso.png"
	width="1859"
	height="759"
	srcset="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/25-HashTable-libfindflagso_hu_821cc05c05e2d1a4.png 480w, /p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/25-HashTable-libfindflagso_hu_c8f0a7f6091605d.png 1024w"
	loading="lazy"
	
		alt="HashTable-libfindflagso"
	
	
		class="gallery-image" 
		data-flex-grow="244"
		data-flex-basis="587px"
	
></p>
<p>根据elfhash计算bucket下标, index=hash%nbucket =48</p>
<p><img src="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/26-HashTable-%E8%AE%A1%E7%AE%97bucket%E4%B8%8B%E6%A0%87.png"
	width="981"
	height="734"
	srcset="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/26-HashTable-%E8%AE%A1%E7%AE%97bucket%E4%B8%8B%E6%A0%87_hu_27c254f86bb50e48.png 480w, /p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/26-HashTable-%E8%AE%A1%E7%AE%97bucket%E4%B8%8B%E6%A0%87_hu_5062c4351001d569.png 1024w"
	loading="lazy"
	
		alt="HashTable-计算bucket下标"
	
	
		class="gallery-image" 
		data-flex-grow="133"
		data-flex-basis="320px"
	
></p>
<p>由于bucket项大小为4字节,从0x960开始+48*4=0xA20</p>
<p>得到动态符号表下标为0xE(14), 查找符号表正好对应dlopen函数</p>
<p><img src="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/27-HashTable-%E6%89%BE%E5%88%B0dlopen.png"
	width="1784"
	height="750"
	srcset="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/27-HashTable-%E6%89%BE%E5%88%B0dlopen_hu_5fdcdef10b69d9e6.png 480w, /p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/27-HashTable-%E6%89%BE%E5%88%B0dlopen_hu_463eaa58e53fd056.png 1024w"
	loading="lazy"
	
		alt="HashTable-找到dlopen"
	
	
		class="gallery-image" 
		data-flex-grow="237"
		data-flex-basis="570px"
	
></p>
<h3 id="android-elf-hash">Android Elf Hash
</h3><p>Android的elfhash算法代码有所不同,但和原始elfhash等价</p>
<p>参考 <a class="link" href="https://cs.android.com/android/platform/superproject/&#43;/android-4.1.2_r2.1:bionic/linker/linker.c"  target="_blank" rel="noopener"
    >https://cs.android.com/android/platform/superproject/+/android-4.1.2_r2.1:bionic/linker/linker.c</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">elfhash</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">_name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">g</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span><span class="o">*</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="o">*</span><span class="n">name</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">g</span> <span class="o">=</span> <span class="n">h</span> <span class="o">&amp;</span> <span class="mh">0xf0000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">h</span> <span class="o">^=</span> <span class="n">g</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">h</span> <span class="o">^=</span> <span class="n">g</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">h</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">Elf32_Sym</span> <span class="o">*</span><span class="nf">_elf_lookup</span><span class="p">(</span><span class="n">soinfo</span> <span class="o">*</span><span class="n">si</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">hash</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Elf32_Sym</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Elf32_Sym</span> <span class="o">*</span><span class="n">symtab</span> <span class="o">=</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">symtab</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">strtab</span> <span class="o">=</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">strtab</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">TRACE_TYPE</span><span class="p">(</span><span class="n">LOOKUP</span><span class="p">,</span> <span class="s">&#34;%5d SEARCH %s in %s@0x%08x %08x %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="n">name</span><span class="p">,</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">hash</span><span class="p">,</span> <span class="n">hash</span> <span class="o">%</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">nbucket</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">n</span> <span class="o">=</span> <span class="n">hash</span> <span class="o">%</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">nbucket</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">bucket</span><span class="p">[</span><span class="n">hash</span> <span class="o">%</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">nbucket</span><span class="p">];</span> <span class="n">n</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">[</span><span class="n">n</span><span class="p">]){</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span> <span class="o">=</span> <span class="n">symtab</span> <span class="o">+</span> <span class="n">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="nf">strcmp</span><span class="p">(</span><span class="n">strtab</span> <span class="o">+</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">st_name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="cm">/* only concern ourselves with global and weak symbol definitions */</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span><span class="p">(</span><span class="nf">ELF32_ST_BIND</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">st_info</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">STB_GLOBAL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">STB_WEAK</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="cm">/* no section == undefined */</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">st_shndx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nf">TRACE_TYPE</span><span class="p">(</span><span class="n">LOOKUP</span><span class="p">,</span> <span class="s">&#34;%5d FOUND %s in %s (%08x) %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                       <span class="n">name</span><span class="p">,</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">st_value</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">st_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="sysv-hash">Sysv Hash
</h3><p>Elf Hash在Android又定义为为Sysv Hash,参考https://cs.android.com/android/platform/superproject/+/android14-qpr3-release:external/musl/ldso/dynlink.c</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">uint32_t</span> <span class="nf">sysv_hash</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">s0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">uint_fast32_t</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">h</span> <span class="o">=</span> <span class="mi">16</span><span class="o">*</span><span class="n">h</span> <span class="o">+</span> <span class="o">*</span><span class="n">s</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">h</span> <span class="o">^=</span> <span class="n">h</span><span class="o">&gt;&gt;</span><span class="mi">24</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">h</span> <span class="o">&amp;</span> <span class="mh">0xfffffff</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">Sym</span> <span class="o">*</span><span class="nf">sysv_lookup</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">h</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dso</span> <span class="o">*</span><span class="n">dso</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">Sym</span> <span class="o">*</span><span class="n">syms</span> <span class="o">=</span> <span class="n">dso</span><span class="o">-&gt;</span><span class="n">syms</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">Elf_Symndx</span> <span class="o">*</span><span class="n">hashtab</span> <span class="o">=</span> <span class="n">dso</span><span class="o">-&gt;</span><span class="n">hashtab</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span> <span class="o">*</span><span class="n">strings</span> <span class="o">=</span> <span class="n">dso</span><span class="o">-&gt;</span><span class="n">strings</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">hashtab</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">h</span><span class="o">%</span><span class="n">hashtab</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">=</span><span class="n">hashtab</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">hashtab</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">dso</span><span class="o">-&gt;</span><span class="n">versym</span> <span class="o">||</span> <span class="n">dso</span><span class="o">-&gt;</span><span class="n">versym</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="nf">strcmp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">strings</span><span class="o">+</span><span class="n">syms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">st_name</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="n">syms</span><span class="o">+</span><span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="gnu-hash">GNU Hash
</h2><p>GNU Hash表项如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">GnuHash</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">nbucket</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">symndx</span><span class="p">;</span>  		<span class="c1">//支持查找index&gt;=symndx的符号, index&lt;symndx的不能直接通过GNU Hash表查找
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint32_t</span> <span class="n">bloomSize</span><span class="p">;</span>  	<span class="c1">// 布隆过滤器需要的3个数据,用于快速判断某个符号是否查不到
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint32_t</span> <span class="n">bloomShift</span><span class="p">;</span>  	<span class="c1">//  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">ElfW</span><span class="p">(</span><span class="n">Addr</span><span class="p">)</span> <span class="n">blooms</span><span class="p">[];</span>	<span class="c1">// bloomSize个项的数组 32/64位下, 元素大小分别为uint32_t/uint64_t  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint32_t</span>  <span class="n">buckets</span><span class="p">[];</span>  	<span class="c1">// nbucket个项的数组
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint32_t</span>  <span class="n">chains</span><span class="p">[];</span>     <span class="c1">// 和符号表索引一一对应, chain的大小等于导出函数个数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以发现,GNU Hash并没有给出nchain字段,如何计算?</p>
<ul>
<li>chains数组前面是连续的blooms和buckets数组,只要根据哈希表大小减去前面的成员大小即可</li>
<li>32位 nchain=GNUHashTable.sh_size/sizeof(uint32_t) - (4+bloomSize+nbucket)</li>
<li>64位 nchain=GNUHashTable.sh_size/sizeof(uint32_t) - (4+bloomSize*2+nbucket)</li>
</ul>
<p>查找GNU Hash表的示意图如下:</p>
<ol>
<li>
<p>chain表的虚线部分并不存在</p>
<p>除了导出符号之外的符号chain表并无必要保存,但chain表的索引和符号表要一一对应</p>
<p>所以chain表的理论起始地址=buckets+nbucket-symndx</p>
<p>但在文件的排列上,各项是连续的,chains有效内容仍然在buckets后方</p>
</li>
<li>
<p>chain表每个表项保存符号的哈希值</p>
<p>最低位为0时表示对应的符号有剩余哈希冲突项</p>
<p>为1时表示没有剩余冲突项</p>
</li>
</ol>
<p>详细可参考<a class="link" href="https://juejin.cn/post/7303741790674173989"  target="_blank" rel="noopener"
    >ELF 通过 Sysv Hash &amp; Gnu Hash 查找符号的实现及对比</a>和<a class="link" href="https://www.bilibili.com/video/BV1gq4y1H7P9"  target="_blank" rel="noopener"
    >ELF解析07_哈希表, 导出表</a></p>
<p><img src="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/28-HashTable.png"
	width="785"
	height="724"
	srcset="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/28-HashTable_hu_319d6d507d27faf5.png 480w, /p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/28-HashTable_hu_bef3355e095d1256.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="108"
		data-flex-basis="260px"
	
></p>
<p>参考https://cs.android.com/android/platform/superproject/+/android14-qpr3-release:external/musl/ldso/dynlink.c</p>
<p>Android Linker的源码实现如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">uint32_t</span> <span class="nf">gnu_hash</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">uint_32</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">5381</span><span class="p">;</span><span class="c1">// 0x1505
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">while</span><span class="p">(</span><span class="o">*</span><span class="n">str</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">h</span> <span class="o">+=</span> <span class="p">(</span><span class="n">h</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">)</span> <span class="o">+*</span><span class="n">str</span><span class="o">++</span><span class="p">;</span><span class="c1">// 33 * h + *str = h*33 + c = h + h * 32 + c = h + h &lt;&lt; 5 + c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">h</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">Sym</span> <span class="o">*</span><span class="nf">gnu_lookup</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">h1</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">hashtab</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dso</span> <span class="o">*</span><span class="n">dso</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">uint32_t</span> <span class="n">nbuckets</span> <span class="o">=</span> <span class="n">hashtab</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">buckets</span> <span class="o">=</span> <span class="n">hashtab</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">hashtab</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="n">buckets</span><span class="p">[</span><span class="n">h1</span> <span class="o">%</span> <span class="n">nbuckets</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">hashval</span> <span class="o">=</span> <span class="n">buckets</span> <span class="o">+</span> <span class="n">nbuckets</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">hashtab</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="n">h1</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">uint32_t</span> <span class="n">h2</span> <span class="o">=</span> <span class="o">*</span><span class="n">hashval</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">((</span><span class="n">h1</span> <span class="o">==</span> <span class="p">(</span><span class="n">h2</span><span class="o">|</span><span class="mi">1</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">dso</span><span class="o">-&gt;</span><span class="n">versym</span> <span class="o">||</span> <span class="n">dso</span><span class="o">-&gt;</span><span class="n">versym</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nf">strcmp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">dso</span><span class="o">-&gt;</span><span class="n">strings</span> <span class="o">+</span> <span class="n">dso</span><span class="o">-&gt;</span><span class="n">syms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">st_name</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="n">dso</span><span class="o">-&gt;</span><span class="n">syms</span><span class="o">+</span><span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">h2</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="打印哈希表">打印哈希表
</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">elf_hash</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">g</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="o">*</span><span class="n">name</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">g</span> <span class="o">=</span> <span class="n">h</span> <span class="o">&amp;</span> <span class="mh">0xf0000000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">h</span> <span class="o">^=</span> <span class="n">g</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">h</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">g</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">h</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">printHashTable32</span><span class="p">(</span><span class="n">Elf32_Shdr</span><span class="o">*</span> <span class="n">pSectionHeader</span><span class="p">,</span><span class="n">Elf_Half</span> <span class="n">sectionNum</span><span class="p">,</span><span class="kt">uint8_t</span><span class="o">*</span> <span class="n">pFileBuffer</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">pSectionHeaderStringTable</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;ELF Hash Tables:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">sectionNum</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_type</span><span class="o">==</span><span class="n">SHT_HASH</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//SHT_HASH 可同时查询导入和导出函数,linux默认弃用,android保留该节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//对于SHT_HASH类型而言,index=buckets[elfhash(symbolName)%nbucket]作为符号表索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//如果index==0则符号不存在,如果符号不等则index=chains[index]继续循环判断
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">Elf32_Shdr</span><span class="o">*</span> <span class="n">pDynamicSymbolTableHeader</span><span class="o">=&amp;</span><span class="n">pSectionHeader</span><span class="p">[</span><span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_link</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="n">Elf32_Sym</span><span class="o">*</span> <span class="n">pDynamicSymbolTable</span><span class="o">=</span><span class="p">(</span><span class="n">Elf32_Sym</span><span class="o">*</span><span class="p">)(</span><span class="n">pDynamicSymbolTableHeader</span><span class="o">-&gt;</span><span class="n">sh_offset</span><span class="o">+</span><span class="n">pFileBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">pDynamicSymbolStringTable</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">)(</span><span class="n">pSectionHeader</span><span class="p">[</span><span class="n">pDynamicSymbolTableHeader</span><span class="o">-&gt;</span><span class="n">sh_link</span><span class="p">].</span><span class="n">sh_offset</span><span class="o">+</span><span class="n">pFileBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint32_t</span><span class="o">*</span> <span class="n">pHashTable</span><span class="o">=</span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)(</span><span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_offset</span><span class="o">+</span><span class="n">pFileBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint32_t</span> <span class="n">nbucket</span><span class="o">=</span><span class="n">pHashTable</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">nchain</span><span class="o">=</span><span class="n">pHashTable</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint32_t</span><span class="o">*</span> <span class="n">buckets</span><span class="o">=&amp;</span><span class="n">pHashTable</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint32_t</span><span class="o">*</span> <span class="n">chains</span><span class="o">=&amp;</span><span class="n">pHashTable</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">nbucket</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">Hash Table &#39;%s&#39; contains %d entries</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">pSectionHeaderStringTable</span><span class="p">[</span><span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_name</span><span class="p">],</span><span class="n">nchain</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t\t</span><span class="s">Num</span><span class="se">\t\t</span><span class="s">Hash \% Nbucket</span><span class="se">\t\t</span><span class="s">Index</span><span class="se">\t\t\t</span><span class="s">Value</span><span class="se">\t\t\t</span><span class="s">Name</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">nbucket</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">uint32_t</span> <span class="n">index</span><span class="o">=</span><span class="n">buckets</span><span class="p">[</span><span class="n">j</span><span class="p">];</span><span class="c1">//遍历buckets
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">//index!=0 说明存在对应符号,打印首个符号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t\t</span><span class="s">%d</span><span class="se">\t\t</span><span class="s">%08x</span><span class="se">\t\t</span><span class="s">%08x</span><span class="se">\t\t</span><span class="s">%08x</span><span class="se">\t\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="o">++</span><span class="n">count</span><span class="p">,</span><span class="nf">elf_hash</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDynamicSymbolStringTable</span><span class="p">[</span><span class="n">pDynamicSymbolTable</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">st_name</span><span class="p">])</span><span class="o">%</span><span class="n">nbucket</span><span class="p">,</span><span class="n">index</span><span class="p">,</span><span class="n">pDynamicSymbolTable</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">st_value</span><span class="p">,</span><span class="o">&amp;</span><span class="n">pDynamicSymbolStringTable</span><span class="p">[</span><span class="n">pDynamicSymbolTable</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">st_name</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//判断是否存在chain,打印相同hash%nbucket的其余符号,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">while</span><span class="p">(</span><span class="n">chains</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">index</span><span class="o">=</span><span class="n">chains</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t\t</span><span class="s">%d</span><span class="se">\t\t</span><span class="s">%08x</span><span class="se">\t\t</span><span class="s">%08x</span><span class="se">\t\t</span><span class="s">%08x</span><span class="se">\t\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="o">++</span><span class="n">count</span><span class="p">,</span><span class="nf">elf_hash</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDynamicSymbolStringTable</span><span class="p">[</span><span class="n">pDynamicSymbolTable</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">st_name</span><span class="p">])</span><span class="o">%</span><span class="n">nbucket</span><span class="p">,</span><span class="n">index</span><span class="p">,</span><span class="n">pDynamicSymbolTable</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">st_value</span><span class="p">,</span><span class="o">&amp;</span><span class="n">pDynamicSymbolStringTable</span><span class="p">[</span><span class="n">pDynamicSymbolTable</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">st_name</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_type</span><span class="o">==</span><span class="n">SHT_GNU_HASH</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//SHT_GNU_HASH 只能查询导出函数,作为elf的导出函数表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">Elf32_Shdr</span><span class="o">*</span> <span class="n">pDynamicSymbolTableHeader</span><span class="o">=&amp;</span><span class="n">pSectionHeader</span><span class="p">[</span><span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_link</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="n">Elf32_Sym</span><span class="o">*</span> <span class="n">pDynamicSymbolTable</span><span class="o">=</span><span class="p">(</span><span class="n">Elf32_Sym</span><span class="o">*</span><span class="p">)(</span><span class="n">pDynamicSymbolTableHeader</span><span class="o">-&gt;</span><span class="n">sh_offset</span><span class="o">+</span><span class="n">pFileBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">pDynamicSymbolStringTable</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">)(</span><span class="n">pSectionHeader</span><span class="p">[</span><span class="n">pDynamicSymbolTableHeader</span><span class="o">-&gt;</span><span class="n">sh_link</span><span class="p">].</span><span class="n">sh_offset</span><span class="o">+</span><span class="n">pFileBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint32_t</span><span class="o">*</span> <span class="n">pGNUHashTable</span><span class="o">=</span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)(</span><span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_offset</span><span class="o">+</span><span class="n">pFileBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint32_t</span> <span class="n">nbucket</span><span class="o">=</span><span class="n">pGNUHashTable</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint32_t</span> <span class="n">symndx</span><span class="o">=</span><span class="n">pGNUHashTable</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint32_t</span> <span class="n">bloomSize</span><span class="o">=</span><span class="n">pGNUHashTable</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint32_t</span> <span class="n">bloomShift</span><span class="o">=</span><span class="n">pGNUHashTable</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="n">Elf32_Addr</span><span class="o">*</span> <span class="n">blooms</span><span class="o">=</span><span class="p">(</span><span class="n">Elf32_Addr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pGNUHashTable</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint32_t</span><span class="o">*</span> <span class="n">buckets</span><span class="o">=</span><span class="n">pGNUHashTable</span><span class="o">+</span><span class="mi">4</span><span class="o">+</span><span class="n">bloomSize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint32_t</span><span class="o">*</span> <span class="n">chains</span><span class="o">=</span><span class="n">buckets</span><span class="o">+</span><span class="n">nbucket</span><span class="o">-</span><span class="n">symndx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//chain的个数等于导出符号个数,但GNU HASH没有nchain,需要手动计算
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">uint32_t</span> <span class="n">nchain</span><span class="o">=</span><span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_size</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="mi">4</span><span class="o">+</span><span class="n">bloomSize</span><span class="o">+</span><span class="n">nbucket</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">Hash Table &#39;%s&#39; contains %d entries, nbucket: %d, symndx: %#x </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">pSectionHeaderStringTable</span><span class="p">[</span><span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_name</span><span class="p">],</span><span class="n">nchain</span><span class="p">,</span><span class="n">nbucket</span><span class="p">,</span><span class="n">symndx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t\t</span><span class="s">Num</span><span class="se">\t\t</span><span class="s">Index</span><span class="se">\t\t\t</span><span class="s">Value</span><span class="se">\t\t\t</span><span class="s">Name</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">nbucket</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">uint32_t</span> <span class="n">index</span><span class="o">=</span><span class="n">buckets</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t\t</span><span class="s">%d</span><span class="se">\t\t</span><span class="s">%08x</span><span class="se">\t\t</span><span class="s">%08x</span><span class="se">\t\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="o">++</span><span class="n">count</span><span class="p">,</span><span class="n">index</span><span class="p">,</span><span class="n">pDynamicSymbolTable</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">st_value</span><span class="p">,</span><span class="o">&amp;</span><span class="n">pDynamicSymbolStringTable</span><span class="p">[</span><span class="n">pDynamicSymbolTable</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">st_name</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//chain最低位为0时表示有,为1时表示无
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">while</span><span class="p">((</span><span class="n">chains</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">index</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t\t</span><span class="s">%d</span><span class="se">\t\t</span><span class="s">%08x</span><span class="se">\t\t</span><span class="s">%08x</span><span class="se">\t\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="o">++</span><span class="n">count</span><span class="p">,</span><span class="n">index</span><span class="p">,</span><span class="n">pDynamicSymbolTable</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">st_value</span><span class="p">,</span><span class="o">&amp;</span><span class="n">pDynamicSymbolStringTable</span><span class="p">[</span><span class="n">pDynamicSymbolTable</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">st_name</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/29-HashTable-printHashTable.png"
	width="1103"
	height="655"
	srcset="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/29-HashTable-printHashTable_hu_2a6ea875cfb9c6ee.png 480w, /p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/29-HashTable-printHashTable_hu_ce8ed4ae8d0fb0c8.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="168"
		data-flex-basis="404px"
	
></p>
<h1 id="elf-loader">ELF Loader
</h1><p>ELF Program Header描述了ELF文件的哪些段需要映射到内存,ELF程序的加载流程如下:</p>
<ol>
<li>
<p>将elf文件加载到内存中,成为filebuffer</p>
</li>
<li>
<p>根据program header,映射filebuffer至imagebuffer</p>
<p>这一步需要给予不同段正确的权限</p>
</li>
<li>
<p>重定位,修复全局变量地址和外部引用地址</p>
<p>根据elf加载的基地址修复全局变量地址</p>
<p>外部引用地址需要加载并遍历needed libso,根据符号查找函数真实地址并修复</p>
</li>
<li>
<p>跳转至入口点</p>
</li>
</ol>
<p>分别编译loadelf32/64以加载x86/x64的elf文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-zsh" data-lang="zsh"><span class="line"><span class="cl">gcc -m32 main.c LoadELF.h LoadELF.c -o loadelf32
</span></span><span class="line"><span class="cl">gcc -m64 main.c LoadELF.h LoadELF.c -o loadelf64
</span></span></code></pre></td></tr></table>
</div>
</div><p>main.c</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// LoadELF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="cp">#include</span> <span class="cpf">&#34;LoadELF.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span> <span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span> <span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="p">(</span><span class="n">argc</span><span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Usage: %s &lt;filepath&gt;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="nf">LoadAndExecElf</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>LoadELF.h</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#ifndef LOADELF_H
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LOADELF_H
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stddef.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">uint8_t</span><span class="o">*</span> <span class="nf">readFileToBytes</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fileName</span><span class="p">,</span><span class="kt">size_t</span><span class="o">*</span> <span class="n">readSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">LoadAndExecElf</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif </span><span class="c1">//LOADELF_H
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>LoadELF.c</p>
<p>根据x86/x64不同环境,定义对应宏</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;LoadELF.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;elf.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;dlfcn.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/mman.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;link.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#ifdef __x86_64__
</span></span></span><span class="line"><span class="cl"><span class="cp">#define Elf_Ehdr Elf64_Ehdr
</span></span></span><span class="line"><span class="cl"><span class="cp">#define Elf_Phdr Elf64_Phdr
</span></span></span><span class="line"><span class="cl"><span class="cp">#define Elf_Shdr Elf64_Shdr
</span></span></span><span class="line"><span class="cl"><span class="cp">#define Elf_Addr Elf64_Addr
</span></span></span><span class="line"><span class="cl"><span class="cp">#define Elf_Dyn Elf64_Dyn
</span></span></span><span class="line"><span class="cl"><span class="cp">#define Elf_Rel Elf64_Rela
</span></span></span><span class="line"><span class="cl"><span class="cp">#define Elf_Sym Elf64_Sym
</span></span></span><span class="line"><span class="cl"><span class="cp">#define ELF_R_TYPE ELF64_R_TYPE
</span></span></span><span class="line"><span class="cl"><span class="cp">#define ELF_R_SYM ELF64_R_SYM
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_REL_ITEM DT_RELA
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_REL_SZ DT_RELASZ
</span></span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp">#define Elf_Ehdr Elf32_Ehdr
</span></span></span><span class="line"><span class="cl"><span class="cp">#define Elf_Phdr Elf32_Phdr
</span></span></span><span class="line"><span class="cl"><span class="cp">#define Elf_Shdr Elf32_Shdr
</span></span></span><span class="line"><span class="cl"><span class="cp">#define Elf_Addr Elf32_Addr
</span></span></span><span class="line"><span class="cl"><span class="cp">#define Elf_Dyn  Elf32_Dyn
</span></span></span><span class="line"><span class="cl"><span class="cp">#define Elf_Rel Elf32_Rel
</span></span></span><span class="line"><span class="cl"><span class="cp">#define Elf_Sym Elf32_Sym
</span></span></span><span class="line"><span class="cl"><span class="cp">#define ELF_R_TYPE ELF32_R_TYPE
</span></span></span><span class="line"><span class="cl"><span class="cp">#define ELF_R_SYM ELF32_R_SYM
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_REL_ITEM DT_REL
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DT_REL_SZ DT_RELSZ
</span></span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">uint8_t</span><span class="o">*</span> <span class="nf">readFileToBytes</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fileName</span><span class="p">,</span><span class="kt">size_t</span><span class="o">*</span> <span class="n">readSize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">FILE</span> <span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="nf">fopen</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">file</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Error opening file</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fclose</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fseek</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="n">SEEK_END</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">size_t</span> <span class="n">fileSize</span> <span class="o">=</span> <span class="nf">ftell</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fseek</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="n">SEEK_SET</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="nf">malloc</span><span class="p">(</span><span class="n">fileSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Error allocating memory</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fclose</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">size_t</span> <span class="n">bytesRead</span> <span class="o">=</span> <span class="nf">fread</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fileSize</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">bytesRead</span><span class="o">!=</span><span class="n">fileSize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Read bytes not equal file size!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">free</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fclose</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fclose</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">readSize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">readSize</span><span class="o">=</span><span class="n">bytesRead</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//以指定对齐值对齐
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">uint64_t</span> <span class="nf">alignValue</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">value</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">alignment</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">value</span> <span class="o">%</span> <span class="n">alignment</span> <span class="o">?</span> <span class="p">(</span><span class="n">value</span> <span class="o">/</span> <span class="n">alignment</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nl">alignment</span> <span class="p">:</span> <span class="n">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">size_t</span> <span class="nf">getElfMemorySize</span><span class="p">(</span><span class="n">Elf_Phdr</span><span class="o">*</span> <span class="n">pProgramHeader</span><span class="p">,</span><span class="n">Elf_Half</span> <span class="n">segmentNum</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//从后往前遍历段表,最后一个段的内存起始地址+大小对齐后即为镜像大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">segmentNum</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">pProgramHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_type</span> <span class="o">==</span> <span class="n">PT_LOAD</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">size</span> <span class="o">=</span> <span class="n">pProgramHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_vaddr</span> <span class="o">+</span> <span class="n">pProgramHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_memsz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">alignValue</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">Elf_Word</span> <span class="nf">getDynamicTableValueByType</span><span class="p">(</span><span class="n">Elf_Dyn</span> <span class="o">*</span><span class="n">dynamicTable</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">dynamicTableSize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dynamicTableSize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">dynamicTable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_tag</span> <span class="o">==</span> <span class="n">type</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">dynamicTable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span><span class="o">**</span> <span class="nf">getNeededLibraryPath</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span> <span class="n">pElfBuffer</span><span class="p">,</span><span class="n">Elf_Dyn</span> <span class="o">*</span><span class="n">pDynamicTable</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">dynamicTableSize</span><span class="p">,</span><span class="kt">size_t</span><span class="o">*</span> <span class="n">neededLibraryNum</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//Traverse dynamic segment find needed library
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">char</span><span class="o">**</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">num</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span><span class="o">*</span> <span class="n">pImageStringTable</span><span class="o">=</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">pElfBuffer</span><span class="o">+</span><span class="nf">getDynamicTableValueByType</span><span class="p">(</span><span class="n">pDynamicTable</span><span class="p">,</span><span class="n">dynamicTableSize</span><span class="p">,</span><span class="n">DT_STRTAB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dynamicTableSize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">pDynamicTable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_tag</span> <span class="o">==</span> <span class="n">DT_NEEDED</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">num</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">buffer</span><span class="o">=</span><span class="p">(</span><span class="kt">char</span><span class="o">**</span><span class="p">)</span><span class="nf">realloc</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="n">num</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="n">buffer</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Error reallocating memory</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">buffer</span><span class="p">[</span><span class="n">num</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">pImageStringTable</span><span class="o">+</span> <span class="n">pDynamicTable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">neededLibraryNum</span><span class="o">=</span><span class="n">num</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">**</span><span class="p">)</span><span class="n">buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Elf_Addr</span> <span class="nf">getSymbolAddress</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">**</span> <span class="n">neededLibrary</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">neededLibraryNum</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">symbolName</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//Load needed dynamic libraries,and traverse libraries, get symbol address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">neededLibraryNum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">void</span> <span class="o">*</span><span class="n">handle</span> <span class="o">=</span> <span class="nf">dlopen</span><span class="p">(</span><span class="n">neededLibrary</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">RTLD_NOW</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">handle</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Error opening library %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">dlerror</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">            <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="kt">void</span> <span class="o">*</span><span class="n">address</span> <span class="o">=</span> <span class="nf">dlsym</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">symbolName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="n">Elf_Addr</span><span class="p">)</span><span class="n">address</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Can&#39;t find address of symbol: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">symbolName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">mapSegmentToMemory</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span> <span class="n">pImageBuffer</span><span class="p">,</span><span class="kt">uint8_t</span><span class="o">*</span> <span class="n">pFileBuffer</span><span class="p">,</span><span class="n">Elf_Phdr</span><span class="o">*</span> <span class="n">pProgramHeader</span><span class="p">,</span><span class="n">Elf_Half</span> <span class="n">segmentNum</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">segmentNum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">pProgramHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_type</span> <span class="o">==</span> <span class="n">PT_LOAD</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">pImageAddr</span> <span class="o">=</span> <span class="n">pImageBuffer</span> <span class="o">+</span> <span class="n">pProgramHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_vaddr</span><span class="p">;</span><span class="c1">//根据内存地址和大小进行映射
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">size_t</span> <span class="n">memorySize</span> <span class="o">=</span> <span class="n">pProgramHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_memsz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">Elf_Word</span> <span class="n">segmentFlags</span> <span class="o">=</span> <span class="n">pProgramHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">protection</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nf">memcpy</span><span class="p">(</span><span class="n">pImageAddr</span><span class="p">,</span> <span class="n">pFileBuffer</span> <span class="o">+</span> <span class="n">pProgramHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_offset</span><span class="p">,</span> <span class="n">pProgramHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_filesz</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">segmentFlags</span> <span class="o">&amp;</span> <span class="n">PF_R</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">protection</span> <span class="o">|=</span> <span class="n">PROT_READ</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">segmentFlags</span> <span class="o">&amp;</span> <span class="n">PF_W</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">protection</span> <span class="o">|=</span> <span class="n">PROT_WRITE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">segmentFlags</span> <span class="o">&amp;</span> <span class="n">PF_X</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">protection</span> <span class="o">|=</span> <span class="n">PROT_EXEC</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nf">mprotect</span><span class="p">(</span><span class="n">pImageAddr</span><span class="p">,</span> <span class="nf">alignValue</span><span class="p">(</span><span class="n">memorySize</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">),</span> <span class="n">protection</span><span class="p">);</span><span class="c1">//页面权限设置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">fixRelocationItem</span><span class="p">(</span><span class="n">Elf_Rel</span><span class="o">*</span> <span class="n">pRelocationTable</span><span class="p">,</span><span class="n">Elf_Word</span> <span class="n">relocationItemNum</span><span class="p">,</span><span class="kt">uint8_t</span><span class="o">*</span> <span class="n">pImageBuffer</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">pDynamicStringTable</span><span class="p">,</span><span class="n">Elf_Sym</span><span class="o">*</span> <span class="n">pDynamicSymbolTable</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span><span class="o">**</span> <span class="n">neededLibrary</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">neededLibraryNum</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Elf_Addr</span><span class="o">*</span> <span class="n">fixItem</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span><span class="c1">//根据位数不同,修复项4/8字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Elf_Addr</span> <span class="n">baseAddr</span><span class="o">=</span><span class="p">(</span><span class="n">Elf_Addr</span><span class="p">)</span><span class="n">pImageBuffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">relocationItemNum</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="p">(</span><span class="nf">ELF_R_TYPE</span><span class="p">(</span><span class="n">pRelocationTable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r_info</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//Relocate base address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">case</span> <span class="nl">R_386_RELATIVE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">fixItem</span><span class="o">=</span><span class="p">(</span><span class="n">Elf_Addr</span><span class="o">*</span><span class="p">)(</span><span class="n">pImageBuffer</span><span class="o">+</span><span class="n">pRelocationTable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r_offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">*</span><span class="n">fixItem</span><span class="o">+=</span><span class="n">baseAddr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//Fix GOT and PLT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">case</span> <span class="nl">R_386_GLOB_DAT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nl">R_386_JMP_SLOT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Get symbol name and real address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">symbolName</span><span class="o">=&amp;</span><span class="n">pDynamicStringTable</span><span class="p">[</span> <span class="n">pDynamicSymbolTable</span><span class="p">[</span><span class="nf">ELF_R_SYM</span><span class="p">(</span><span class="n">pRelocationTable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r_info</span><span class="p">)].</span><span class="n">st_name</span> <span class="p">];</span><span class="c1">//符号表表项的name属性是字符串表下标
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">fixItem</span><span class="o">=</span><span class="p">(</span><span class="n">Elf_Addr</span><span class="o">*</span><span class="p">)(</span><span class="n">pImageBuffer</span><span class="o">+</span><span class="n">pRelocationTable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r_offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">Elf_Addr</span> <span class="n">symbolAddr</span><span class="o">=</span><span class="nf">getSymbolAddress</span><span class="p">(</span><span class="n">neededLibrary</span><span class="p">,</span><span class="n">neededLibraryNum</span><span class="p">,</span><span class="n">symbolName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">*</span><span class="n">fixItem</span><span class="o">=</span><span class="n">symbolAddr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">LoadAndExecElf</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//1. Read file to memory buffer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">size_t</span> <span class="n">readFileSize</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">pFileBuffer</span><span class="o">=</span><span class="nf">readFileToBytes</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span><span class="o">&amp;</span><span class="n">readFileSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">pFileBuffer</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Error reading file</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">Elf_Ehdr</span><span class="o">*</span> <span class="n">pElfHeader</span><span class="o">=</span><span class="p">(</span><span class="n">Elf_Ehdr</span><span class="o">*</span><span class="p">)</span><span class="n">pFileBuffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Elf_Phdr</span> <span class="o">*</span><span class="n">pProgramHeader</span><span class="o">=</span><span class="p">(</span><span class="n">Elf_Phdr</span><span class="o">*</span><span class="p">)(</span><span class="n">pFileBuffer</span><span class="o">+</span><span class="n">pElfHeader</span><span class="o">-&gt;</span><span class="n">e_phoff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Elf_Half</span> <span class="n">segmentNum</span><span class="o">=</span><span class="n">pElfHeader</span><span class="o">-&gt;</span><span class="n">e_phnum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">pImageBuffer</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//2. Mapping file buffer to image buffer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">size_t</span> <span class="n">elfMemorySize</span> <span class="o">=</span> <span class="nf">getElfMemorySize</span><span class="p">(</span><span class="n">pProgramHeader</span><span class="p">,</span><span class="n">segmentNum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">elfMemorySize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;ELF memory size is 0!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">posix_memalign</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pImageBuffer</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">elfMemorySize</span><span class="p">);</span> <span class="c1">//Alloc align memory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">pImageBuffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Error allocating memory</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">pImageBuffer</span><span class="p">,</span><span class="mi">0</span>  <span class="p">,</span><span class="n">elfMemorySize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Mapping segments to memory and set protection
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">mapSegmentToMemory</span><span class="p">(</span><span class="n">pImageBuffer</span><span class="p">,</span><span class="n">pFileBuffer</span><span class="p">,</span><span class="n">pProgramHeader</span><span class="p">,</span><span class="n">segmentNum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//3. Relocate
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Elf_Phdr</span> <span class="o">*</span><span class="n">pDynamicTableHeader</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Elf_Dyn</span> <span class="o">*</span><span class="n">pDynamicTable</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">segmentNum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">pProgramHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_type</span> <span class="o">==</span> <span class="n">PT_DYNAMIC</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">pDynamicTableHeader</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pProgramHeader</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">pDynamicTable</span> <span class="o">=</span> <span class="p">(</span><span class="n">Elf_Dyn</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pImageBuffer</span> <span class="o">+</span> <span class="n">pDynamicTableHeader</span><span class="o">-&gt;</span><span class="n">p_vaddr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">size_t</span> <span class="n">dynamicItemNum</span> <span class="o">=</span> <span class="n">pDynamicTableHeader</span><span class="o">-&gt;</span><span class="n">p_filesz</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Elf_Dyn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Elf_Rel</span> <span class="o">*</span><span class="n">pRelocationTable</span> <span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">size_t</span> <span class="n">relocationItemNum</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Elf_Rel</span> <span class="o">*</span><span class="n">pJmpRelocationTable</span> <span class="o">=</span> <span class="p">(</span><span class="n">Elf_Rel</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pImageBuffer</span> <span class="o">+</span> <span class="nf">getDynamicTableValueByType</span><span class="p">(</span><span class="n">pDynamicTable</span><span class="p">,</span> <span class="n">dynamicItemNum</span><span class="p">,</span><span class="n">DT_JMPREL</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="kt">size_t</span> <span class="n">jmpRelocationItemNum</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Elf_Sym</span> <span class="o">*</span><span class="n">pDynamicSymbolTable</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">pDynamicStringTable</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">dynamicItemNum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="p">(</span><span class="n">pDynamicTable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_tag</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nl">DT_REL_ITEM</span><span class="p">:</span> <span class="n">pRelocationTable</span><span class="o">=</span><span class="p">(</span><span class="n">Elf_Rel</span><span class="o">*</span><span class="p">)(</span><span class="n">pImageBuffer</span><span class="o">+</span><span class="n">pDynamicTable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nl">DT_JMPREL</span><span class="p">:</span> <span class="n">pJmpRelocationTable</span><span class="o">=</span><span class="p">(</span><span class="n">Elf_Rel</span><span class="o">*</span><span class="p">)(</span><span class="n">pImageBuffer</span><span class="o">+</span><span class="n">pDynamicTable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nl">DT_REL_SZ</span><span class="p">:</span> <span class="n">relocationItemNum</span><span class="o">=</span><span class="n">pDynamicTable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Elf_Rel</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nl">DT_PLTRELSZ</span><span class="p">:</span> <span class="n">jmpRelocationItemNum</span><span class="o">=</span><span class="n">pDynamicTable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Elf_Rel</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nl">DT_SYMTAB</span><span class="p">:</span><span class="n">pDynamicSymbolTable</span><span class="o">=</span><span class="p">(</span><span class="n">Elf_Sym</span><span class="o">*</span><span class="p">)(</span><span class="n">pImageBuffer</span><span class="o">+</span><span class="n">pDynamicTable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="p">);</span><span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nl">DT_STRTAB</span><span class="p">:</span><span class="n">pDynamicStringTable</span><span class="o">=</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)(</span><span class="n">pImageBuffer</span><span class="o">+</span><span class="n">pDynamicTable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="p">);</span><span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">size_t</span> <span class="n">neededLibraryNum</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span><span class="o">**</span> <span class="n">neededLibrary</span><span class="o">=</span><span class="nf">getNeededLibraryPath</span><span class="p">(</span><span class="n">pImageBuffer</span><span class="p">,</span><span class="n">pDynamicTable</span><span class="p">,</span><span class="n">dynamicItemNum</span><span class="p">,</span><span class="o">&amp;</span><span class="n">neededLibraryNum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fixRelocationItem</span><span class="p">(</span><span class="n">pRelocationTable</span><span class="p">,</span><span class="n">relocationItemNum</span><span class="p">,</span><span class="n">pImageBuffer</span><span class="p">,</span><span class="n">pDynamicStringTable</span><span class="p">,</span><span class="n">pDynamicSymbolTable</span><span class="p">,</span><span class="n">neededLibrary</span><span class="p">,</span><span class="n">neededLibraryNum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fixRelocationItem</span><span class="p">(</span><span class="n">pJmpRelocationTable</span><span class="p">,</span><span class="n">jmpRelocationItemNum</span><span class="p">,</span><span class="n">pImageBuffer</span><span class="p">,</span><span class="n">pDynamicStringTable</span><span class="p">,</span><span class="n">pDynamicSymbolTable</span><span class="p">,</span><span class="n">neededLibrary</span><span class="p">,</span><span class="n">neededLibraryNum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//4. Jump to entry point
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">VoidFunctionPtr</span><span class="p">)();</span>
</span></span><span class="line"><span class="cl">    <span class="n">VoidFunctionPtr</span> <span class="n">entry</span><span class="o">=</span><span class="p">(</span><span class="n">VoidFunctionPtr</span><span class="p">)(</span><span class="n">pImageBuffer</span><span class="o">+</span><span class="n">pElfHeader</span><span class="o">-&gt;</span><span class="n">e_entry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Load ELF success!Jump to entry point:%#lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">entry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">entry</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Come back</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>效果如下</p>
<p><img src="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/30-LoadELF.png"
	width="518"
	height="435"
	srcset="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/30-LoadELF_hu_b064789628e6ad77.png 480w, /p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/30-LoadELF_hu_c84af7196ff21776.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="119"
		data-flex-basis="285px"
	
></p>
<h1 id="references">References
</h1><p><a class="link" href="https://xialuohun.top/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F"  target="_blank" rel="noopener"
    >ELF文件格式</a></p>
<p><a class="link" href="https://xialuohun.top/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/ELF%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E8%A7%A3%E6%9E%90.pdf"  target="_blank" rel="noopener"
    >ELF文件格式解析</a></p>
<p>《程序员的自我修养》</p>
<p><a class="link" href="https://blog.csdn.net/GoolyOh/article/details/119801160"  target="_blank" rel="noopener"
    >ELF加载器的原理与实现</a></p>
<p><a class="link" href="https://www.cnblogs.com/lianyihong/p/17911643.html"  target="_blank" rel="noopener"
    >【内核】ELF 文件执行流程</a></p>
<p><a class="link" href="https://www.bilibili.com/video/BV1sb421p7qf"  target="_blank" rel="noopener"
    >说一下Linux可执行文件的格式，ELF格式</a></p>
<p><a class="link" href="https://www.bilibili.com/video/BV1gq4y1H7P9"  target="_blank" rel="noopener"
    >ELF解析07_哈希表, 导出表</a></p>
<p><a class="link" href="https://juejin.cn/post/7303741790674173989"  target="_blank" rel="noopener"
    >ELF 通过 Sysv Hash &amp; Gnu Hash 查找符号的实现及对比</a></p>
<p><a class="link" href="https://bbs.kanxue.com/thread-223668.htm#msg_header_h3_1"  target="_blank" rel="noopener"
    >[翻译]GNU Hash ELF Sections</a></p>

</section>


    <footer class="article-footer">
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI&#43;WdtXRGWt2kTvGFasHpSy3SV"crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG&#43;vnGctmUb0ZY0l8"crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"integrity="sha384-&#43;VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4&#43;/RRE05"crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.body, {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist"]
        });})
</script>
    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">相关文章</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/android%E4%BB%8E%E6%95%B4%E4%BD%93%E5%8A%A0%E5%9B%BA%E5%88%B0%E6%8A%BD%E5%8F%96%E5%8A%A0%E5%9B%BA%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86/">
        
        
            <div class="article-image">
                <img src="/p/android%E4%BB%8E%E6%95%B4%E4%BD%93%E5%8A%A0%E5%9B%BA%E5%88%B0%E6%8A%BD%E5%8F%96%E5%8A%A0%E5%9B%BA%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86/27-Apk%E5%90%88%E5%B9%B6%E5%9B%BE.46f2f51dac420eddd22372d9ad26e97c_hu_9ee9f24bdfd2b321.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Android从整体加固到抽取加固的实现及原理"
                        
                        data-hash="md5-RvL1HaxCDt3SI3LZrSbpfA==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Android从整体加固到抽取加固的实现及原理</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/">
        
        
            <div class="article-image">
                <img src="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/1-dex%E6%96%87%E4%BB%B6%E6%95%B4%E4%BD%93%E7%BB%93%E6%9E%84.578be309c60b9810690dcc195717c187_hu_a4b169926d45edd6.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Dex文件结构解析 ReadDex解析器实现"
                        
                        data-hash="md5-V4vjCcYLmBBpDcwZVxfBhw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Dex文件结构解析 ReadDex解析器实现</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/fridastudy/">
        
        

        <div class="article-details">
            <h2 class="article-title">FridaStudy</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/androidbasicstudy/">
        
        
            <div class="article-image">
                <img src="/p/androidbasicstudy/8_%E6%B4%BB%E5%8A%A8%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.b6d9e6ef6be71ee1bd6ad48f04fc0eb5_hu_b0bc600821d22529.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post AndroidBasicStudy"
                        
                        data-hash="md5-ttnm72vnHuG9atSPBPwOtQ==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">AndroidBasicStudy</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/ndkstudy/">
        
        

        <div class="article-details">
            <h2 class="article-title">NDKStudy</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script src="https://utteranc.es/client.js" 
        repo="OrientalGlass/utterances-comments"
        issue-term="pathname"
        
        crossorigin="anonymous"
        async
        >
</script>

<style>
    .utterances {
        max-width: unset;
    }
</style>

<script>
    let utterancesLoaded = false;

    function setUtterancesTheme(theme) {
        let utterances = document.querySelector('.utterances iframe');
        if (utterances) {
            utterances.contentWindow.postMessage(
                {
                    type: 'set-theme',
                    theme: `github-${theme}`
                },
                'https://utteranc.es'
            );
        }
    }

    addEventListener('message', event => {
        if (event.origin !== 'https://utteranc.es') return;

        
        utterancesLoaded = true;
        setUtterancesTheme(document.documentElement.dataset.scheme)
    });

    window.addEventListener('onColorSchemeChange', (e) => {
        if (!utterancesLoaded) return;
        setUtterancesTheme(e.detail)
    })
</script>


    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2024 - 
        
        2025 OrientalGlass
    </section>
    
    <section class="powerby">
        使用 <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> 构建 <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.27.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
