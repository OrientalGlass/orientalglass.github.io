<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="一. 前言 虽然网上针对整体加固和抽取加固已经有不少文章讨论如何实现以及脱壳,也有很多成熟的加固方案\n但是在学习这方面技术时发现涉及到的理论知识很多,不能局限于基本流程和代码实现而不明白底层原理\n">
<title>Android从整体加固到抽取加固的实现及原理</title>

<link rel='canonical' href='https://example.com/p/android%E4%BB%8E%E6%95%B4%E4%BD%93%E5%8A%A0%E5%9B%BA%E5%88%B0%E6%8A%BD%E5%8F%96%E5%8A%A0%E5%9B%BA%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86/'>

<link rel="stylesheet" href="/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css"><meta property='og:title' content="Android从整体加固到抽取加固的实现及原理">
<meta property='og:description' content="一. 前言 虽然网上针对整体加固和抽取加固已经有不少文章讨论如何实现以及脱壳,也有很多成熟的加固方案\n但是在学习这方面技术时发现涉及到的理论知识很多,不能局限于基本流程和代码实现而不明白底层原理\n">
<meta property='og:url' content='https://example.com/p/android%E4%BB%8E%E6%95%B4%E4%BD%93%E5%8A%A0%E5%9B%BA%E5%88%B0%E6%8A%BD%E5%8F%96%E5%8A%A0%E5%9B%BA%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86/'>
<meta property='og:site_name' content='OrientalGlass'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2025-05-22T10:43:13&#43;08:00'/><meta property='article:modified_time' content='2025-05-22T10:43:13&#43;08:00'/><meta property='og:image' content='https://example.com/p/android%E4%BB%8E%E6%95%B4%E4%BD%93%E5%8A%A0%E5%9B%BA%E5%88%B0%E6%8A%BD%E5%8F%96%E5%8A%A0%E5%9B%BA%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86/27-Apk%E5%90%88%E5%B9%B6%E5%9B%BE.png' />
<meta name="twitter:title" content="Android从整体加固到抽取加固的实现及原理">
<meta name="twitter:description" content="一. 前言 虽然网上针对整体加固和抽取加固已经有不少文章讨论如何实现以及脱壳,也有很多成熟的加固方案\n但是在学习这方面技术时发现涉及到的理论知识很多,不能局限于基本流程和代码实现而不明白底层原理\n"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://example.com/p/android%E4%BB%8E%E6%95%B4%E4%BD%93%E5%8A%A0%E5%9B%BA%E5%88%B0%E6%8A%BD%E5%8F%96%E5%8A%A0%E5%9B%BA%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86/27-Apk%E5%90%88%E5%B9%B6%E5%9B%BE.png' />
    <link rel="shortcut icon" href="/favicon.jpg" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu_149d93b4b8d2abf8.jpg" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">OrientalGlass</a></h1>
            <h2 class="site-description">Welcome to my blog!</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://space.bilibili.com/21031513'
                        target="_blank"
                        title="Bilibili"
                        rel="me"
                    >
                        
                        
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-brand-bilibili"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 10a4 4 0 0 1 4 -4h10a4 4 0 0 1 4 4v6a4 4 0 0 1 -4 4h-10a4 4 0 0 1 -4 -4v-6z" /><path d="M8 3l2 3" /><path d="M16 3l-2 3" /><path d="M9 13v-2" /><path d="M15 11v2" /></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='oriental0glass@gmail.com'
                        target="_blank"
                        title="Eamil"
                        rel="me"
                    >
                        
                        
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-mail"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 7a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v10a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-10z" /><path d="M3 7l9 6l9 -6" /></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/OrientalGlass'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>主页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#一-前言">一. 前言</a></li>
    <li><a href="#二-android壳简介">二. Android壳简介</a></li>
    <li><a href="#三-java反射机制">三. Java反射机制</a>
      <ol>
        <li><a href="#反射机制简介">反射机制简介</a></li>
        <li><a href="#反射的本质">反射的本质</a></li>
        <li><a href="#反射的入口-class类">反射的入口-Class类</a></li>
        <li><a href="#反射获取class">反射获取Class</a></li>
        <li><a href="#反射获取constructor">反射获取Constructor</a></li>
        <li><a href="#反射获取field">反射获取Field</a></li>
        <li><a href="#反射获取method">反射获取Method</a></li>
        <li><a href="#反射创建对象">反射创建对象</a></li>
        <li><a href="#反射操作属性">反射操作属性</a></li>
        <li><a href="#反射调用方法">反射调用方法</a></li>
        <li><a href="#封装反射类">封装反射类</a></li>
      </ol>
    </li>
    <li><a href="#四-classloader机制">四. ClassLoader机制</a>
      <ol>
        <li><a href="#java中的classloader">Java中的ClassLoader</a>
          <ol>
            <li><a href="#classloader的类型">ClassLoader的类型</a></li>
            <li><a href="#classloader的继承关系">ClassLoader的继承关系</a></li>
            <li><a href="#classloader的双亲委托机制">ClassLoader的双亲委托机制</a></li>
          </ol>
        </li>
        <li><a href="#android中的classloader">Android中的ClassLoader</a></li>
        <li><a href="#classloader加载dex流程简介">ClassLoader加载Dex流程简介</a></li>
        <li><a href="#classloader加载class流程简介">ClassLoader加载Class流程简介</a></li>
        <li><a href="#loaddexdemo">LoadDexDemo</a></li>
      </ol>
    </li>
    <li><a href="#五-android应用程序启动流程">五. Android应用程序启动流程</a>
      <ol>
        <li><a href="#创建应用程序进程简介">创建应用程序进程简介</a></li>
        <li><a href="#创建application简介">创建Application简介</a></li>
        <li><a href="#启动根activity简介">启动根Activity简介</a></li>
      </ol>
    </li>
    <li><a href="#六-dex文件结构和代码抽取">六. Dex文件结构和代码抽取</a></li>
    <li><a href="#七-一代加固-整体加固落地加载">七. 一代加固-整体加固(落地加载)</a>
      <ol>
        <li><a href="#原理">原理</a></li>
        <li><a href="#源程序">源程序</a>
          <ol>
            <li><a href="#mainactivityjava">MainActivity.java</a></li>
            <li><a href="#myapplicationjava">MyApplication.java</a></li>
            <li><a href="#native-libcpp">native-lib.cpp</a></li>
            <li><a href="#androidmanifestxml">AndroidManifest.xml</a></li>
            <li><a href="#activity_mainxml">activity_main.xml</a></li>
          </ol>
        </li>
        <li><a href="#加壳程序">加壳程序</a></li>
        <li><a href="#脱壳程序">脱壳程序</a>
          <ol>
            <li><a href="#firstproxyapplicationjava">FirstProxyApplication.java</a></li>
            <li><a href="#reflectionjava">Reflection.java</a></li>
            <li><a href="#androidmanifestxml-1">AndroidManifest.xml</a></li>
          </ol>
        </li>
        <li><a href="#总结">总结</a></li>
      </ol>
    </li>
    <li><a href="#八-二代加固-整体加固不落地加载">八. 二代加固-整体加固(不落地加载)</a>
      <ol>
        <li><a href="#原理-1">原理</a></li>
        <li><a href="#源程序-1">源程序</a></li>
        <li><a href="#加壳程序-1">加壳程序</a></li>
        <li><a href="#脱壳程序-1">脱壳程序</a></li>
        <li><a href="#总结-1">总结</a></li>
      </ol>
    </li>
    <li><a href="#九-三代加固-抽取加固">九. 三代加固-抽取加固</a>
      <ol>
        <li><a href="#原理-2">原理</a></li>
        <li><a href="#源程序-2">源程序</a></li>
        <li><a href="#加壳程序-2">加壳程序</a></li>
        <li><a href="#脱壳程序-2">脱壳程序</a>
          <ol>
            <li><a href="#环境初始化">环境初始化</a></li>
            <li><a href="#替换classloader">替换ClassLoader</a></li>
            <li><a href="#替换application">替换Application</a></li>
            <li><a href="#native层">Native层</a></li>
            <li><a href="#thirdproxyapplicationjava">ThirdProxyApplication.java</a></li>
            <li><a href="#shellcpp">shell.cpp</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#十-加固工具测试">十. 加固工具测试</a></li>
    <li><a href="#十一-classloader加载dex流程详解">十一. ClassLoader加载Dex流程详解</a>
      <ol>
        <li><a href="#pathdexclassloader-java层">Path/DexClassLoader Java层</a>
          <ol>
            <li><a href="#basedexclassloader">BaseDexClassLoader</a></li>
            <li><a href="#dexpathlistdexpathlist">DexPathList::DexPathList</a></li>
            <li><a href="#dexpathlistmakedexelements">DexPathList::makeDexElements</a></li>
            <li><a href="#dexfileloaddexfile">DexFile::loadDexFile</a></li>
            <li><a href="#dexfiledexfile">DexFile::DexFile</a></li>
            <li><a href="#dexfileloaddex">DexFile::loadDex</a></li>
            <li><a href="#dexfileopendexfile">DexFile::openDexFile</a></li>
          </ol>
        </li>
        <li><a href="#pathdexclassloader-native层">Path/DexClassLoader Native层</a>
          <ol>
            <li><a href="#dexfile_opendexfilenative">DexFile_openDexFileNative</a></li>
            <li><a href="#oatfilemanageropendexfilesfromoat">OatFileManager::OpenDexFilesFromOat</a></li>
            <li><a href="#oatfileassistantgetbestoatfile">OatFileAssistant::GetBestOatFile</a></li>
            <li><a href="#oatfileassistantloaddexfiles">OatFileAssistant::LoadDexFiles</a>
              <ol>
                <li><a href="#oatfilegetoatdexfile">OatFile::GetOatDexFile</a></li>
                <li><a href="#oatdexfileopendexfile">OatDexFile::OpenDexFile</a></li>
              </ol>
            </li>
          </ol>
        </li>
        <li><a href="#artdexfileloaderopen">ArtDexFileLoader::Open</a>
          <ol>
            <li><a href="#artdexfileloaderopenzip">ArtDexFileLoader::OpenZip</a>
              <ol>
                <li><a href="#artdexfileloaderopenalldexfilesfromzip">ArtDexFileLoader::OpenAllDexFilesFromZip</a></li>
                <li><a href="#artdexfileloaderopenonedexfilefromzip">ArtDexFileLoader::OpenOneDexFileFromZip</a></li>
              </ol>
            </li>
            <li><a href="#artdexfileloaderopenfile">ArtDexFileLoader::OpenFile</a></li>
            <li><a href="#artdexfileloaderopencommon">ArtDexFileLoader::OpenCommon</a></li>
            <li><a href="#dexfileloaderopencommon">DexFileLoader::OpenCommon</a>
              <ol>
                <li><a href="#dexfileinit">DexFile::Init</a></li>
                <li><a href="#dexfileverifierverify">DexFileVerifier::Verify</a></li>
              </ol>
            </li>
            <li><a href="#dexfiledexfile-1">DexFile::DexFile</a>
              <ol>
                <li><a href="#dexfileinitializesectionsfrommaplist">DexFile::InitializeSectionsFromMapList</a></li>
              </ol>
            </li>
          </ol>
        </li>
        <li><a href="#inmemorydexclassloader">InMemoryDexClassLoader</a>
          <ol>
            <li><a href="#basedexclassloader-1">BaseDexClassLoader</a>
              <ol>
                <li><a href="#dexpathlistdexpathlist-1">DexPathList::DexPathList</a></li>
                <li><a href="#dexpathlistmakepathelements">DexPathList::makePathElements</a></li>
              </ol>
            </li>
            <li><a href="#dexpathlistinitbytebufferdexpath">DexPathList::initByteBufferDexPath</a></li>
            <li><a href="#dexfiledexfile-2">DexFile::DexFile</a></li>
            <li><a href="#dexfileopeninmemorydexfiles">DexFile::openInMemoryDexFiles</a></li>
            <li><a href="#dexfile_openinmemorydexfilesnative">DexFile_openInMemoryDexFilesNative</a></li>
            <li><a href="#oatfilemanageropendexfilesfromoat-1">OatFileManager::OpenDexFilesFromOat</a></li>
            <li><a href="#oatfilemanageropendexfilesfromoat_impl">OatFileManager::OpenDexFilesFromOat_Impl</a></li>
            <li><a href="#artdexfileloaderopen-1">ArtDexFileLoader::Open</a></li>
            <li><a href="#artdexfileloaderopencommon-1">ArtDexFileLoader::OpenCommon</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#十二-classloader加载class流程详解">十二. ClassLoader加载Class流程详解</a>
      <ol>
        <li><a href="#classloaderloadclass">ClassLoader::LoadClass</a></li>
        <li><a href="#basedexclassloaderfindclass">BaseDexClassLoader::findClass</a></li>
        <li><a href="#defineclassnative-jni">defineClassNative (JNI)</a></li>
        <li><a href="#dexfile_defineclassnative">DexFile_defineClassNative</a></li>
        <li><a href="#classlinkerdefineclass">ClassLinker::DefineClass</a></li>
        <li><a href="#classlinkerloadclass">ClassLinker::LoadClass</a></li>
      </ol>
    </li>
    <li><a href="#十三-创建应用程序进程详解">十三. 创建应用程序进程详解</a>
      <ol>
        <li><a href="#ams发送启动应用程序进程请求">AMS发送启动应用程序进程请求</a></li>
        <li><a href="#zygote接收请求并创建应用程序进程">Zygote接收请求并创建应用程序进程</a></li>
      </ol>
    </li>
    <li><a href="#十四-创建application详解">十四. 创建Application详解</a>
      <ol>
        <li><a href="#activitythreadmain">ActivityThread.main</a></li>
        <li><a href="#activitythreadattach">ActivityThread.attach</a></li>
        <li><a href="#activitymanagerserviceattachapplication">ActivityManagerService.attachApplication</a></li>
        <li><a href="#activitymanagerserviceattachapplicationlocked">ActivityManagerService.attachApplicationLocked</a></li>
        <li><a href="#iapplicationthreadbindapplication">IApplicationThread.bindApplication</a></li>
        <li><a href="#activitythreadhandlemessage">ActivityThread.handleMessage</a></li>
        <li><a href="#activitythreadhandlebindapplication">ActivityThread.handleBindApplication</a>
          <ol>
            <li><a href="#activitythreadgetpackageinfonocheck">ActivityThread.getPackageInfoNoCheck</a></li>
            <li><a href="#contextimplcreateappcontext">ContextImpl.createAppContext</a>
              <ol>
                <li><a href="#contextimplcontextimpl">ContextImpl.ContextImpl</a></li>
              </ol>
            </li>
            <li><a href="#loadedapkmakeapplication">LoadedApk.makeApplication</a>
              <ol>
                <li><a href="#instrumentationnewapplication">Instrumentation.newApplication</a></li>
                <li><a href="#applicationattach">Application.attach</a></li>
              </ol>
            </li>
            <li><a href="#instrumentationcallapplicationoncreate">Instrumentation.callApplicationOnCreate</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#十五-启动根activity详解">十五. 启动根Activity详解</a>
      <ol>
        <li>
          <ol>
            <li><a href="#activitythread启动activity的过程">ActivityThread启动Activity的过程</a></li>
            <li><a href="#根activity启动过程中涉及的进程">根Activity启动过程中涉及的进程</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#十六-references">十六. References</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/android%E4%BB%8E%E6%95%B4%E4%BD%93%E5%8A%A0%E5%9B%BA%E5%88%B0%E6%8A%BD%E5%8F%96%E5%8A%A0%E5%9B%BA%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86/">
                <img src="/p/android%E4%BB%8E%E6%95%B4%E4%BD%93%E5%8A%A0%E5%9B%BA%E5%88%B0%E6%8A%BD%E5%8F%96%E5%8A%A0%E5%9B%BA%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86/27-Apk%E5%90%88%E5%B9%B6%E5%9B%BE_hu_331fcc2edb464567.png"
                        srcset="/p/android%E4%BB%8E%E6%95%B4%E4%BD%93%E5%8A%A0%E5%9B%BA%E5%88%B0%E6%8A%BD%E5%8F%96%E5%8A%A0%E5%9B%BA%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86/27-Apk%E5%90%88%E5%B9%B6%E5%9B%BE_hu_331fcc2edb464567.png 800w, /p/android%E4%BB%8E%E6%95%B4%E4%BD%93%E5%8A%A0%E5%9B%BA%E5%88%B0%E6%8A%BD%E5%8F%96%E5%8A%A0%E5%9B%BA%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86/27-Apk%E5%90%88%E5%B9%B6%E5%9B%BE_hu_7b04dc77574fa4b2.png 1600w"
                        width="800" 
                        height="321" 
                        loading="lazy"
                        alt="Featured image of post Android从整体加固到抽取加固的实现及原理" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/android/" >
                Android
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/android%E4%BB%8E%E6%95%B4%E4%BD%93%E5%8A%A0%E5%9B%BA%E5%88%B0%E6%8A%BD%E5%8F%96%E5%8A%A0%E5%9B%BA%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86/">Android从整体加固到抽取加固的实现及原理</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2025-05-22</time>
            </div>
        

        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="一-前言">一. 前言
</h1><p>虽然网上针对整体加固和抽取加固已经有不少文章讨论如何实现以及脱壳,也有很多成熟的加固方案</p>
<p>但是在学习这方面技术时发现涉及到的理论知识很多,不能局限于基本流程和代码实现而不明白底层原理</p>
<p>身为初学者最大的痛苦是知识体系庞大不知道如何下手,所以希望本文能抛砖引玉,对于入门Android加固的师傅有所帮助</p>
<p>本文主要内容如下:</p>
<ul>
<li>Android加固涉及的理论知识 包括Java反射机制,ClassLoader机制,Android应用程序启动流程等</li>
<li>整体加固和抽取加固的自动化 整体加固的落地和不落地加载,抽取加固的代码抽取与回填</li>
</ul>
<p>由于涉及的知识较多,分为了3部分:</p>
<ol>
<li>相关理论基础知识简介</li>
<li>一代到三代加固的实现</li>
<li>相关理论基础知识详解</li>
</ol>
<p>阅读本文的正确姿势:</p>
<ol>
<li>
<p>刚开始不要试图把握每一个细节,先把握整体再逐步学习细节部分,可以多看看流程图</p>
</li>
<li>
<p>了解相关理论基础知识后,再看一到三代加固的实现,如果部分原理和代码不明白则阅读详解部分</p>
</li>
<li>
<p>原理部分强烈推荐阅读Android进阶解密和Andorid系统源码</p>
</li>
</ol>
<p>附件attachments.zip (31.7MB)内容如下:</p>
<ol>
<li>
<p>AndroidShell</p>
<p>Android壳程序项目,包括一代到三代加固的代理类,其中整体加固已注释,默认为三代抽取加固</p>
</li>
<li>
<p>ReadDex</p>
<p>Dex文件解析器项目,支持抽取指定dex文件所有DexClassDef的代码,过滤系统类</p>
</li>
<li>
<p>ShellScripts</p>
<p>一代到三代的加壳程序自动化脚本</p>
<p>ShellScripts\tools目录下提供以下工具</p>
<ul>
<li>apktool 提供APK的解包和打包功能</li>
<li>uber-apk-signer-1.3.0.jar 提供APK的签名功能</li>
<li>ReadDex.exe 提供Dex文件代码抽取功能</li>
</ul>
</li>
<li>
<p>JavaReflectionDemo</p>
<p>java反射的demo</p>
</li>
<li>
<p>LoadDexDemo</p>
<p>加载dex文件并调用其中指定类的demo</p>
</li>
<li>
<p>ShellTestResults.zip (76.7MB 单独压缩)</p>
<p>一代到三代加固的测试文件,包括源程序,壳程序,加壳后的程序</p>
</li>
</ol>
<p>附件链接: AndroidShell <a class="link" href="https://pan.baidu.com/s/14jry11WpTlzWI6JW3r4HTw?pwd=qsyw"  target="_blank" rel="noopener"
    >https://pan.baidu.com/s/14jry11WpTlzWI6JW3r4HTw?pwd=qsyw</a></p>
<p>References: 列举了本文参考的部分资料,常用脱壳工具和第四代加固——Dex2C和DexVMP相关项目</p>
<p><strong>由于本人知识水平有限,如有不足之处望各位师傅指出</strong></p>
<h1 id="二-android壳简介">二. Android壳简介
</h1><ol>
<li>
<p>加密壳</p>
<ul>
<li>一代	动态加载型 DexClassLoader 落地加载</li>
<li>二代	动态加载型 InMemoryDexClassLoader 不落地加载</li>
<li>三代	代码抽取型 Dex代码抽取与回填 落地加载</li>
</ul>
<p>落地指释放Dex文件到文件系统,不落地则不释放Dex文件,直接在内存中加载</p>
</li>
<li>
<p>四代壳</p>
<p>DexVMP Dex2C</p>
</li>
<li>
<p>混淆壳</p>
<p>OLLVM</p>
</li>
</ol>
<p>在学习Android加固之前,一定要了解以下知识:</p>
<ol>
<li>Java反射机制</li>
<li>ClassLoader机制</li>
<li>Android应用程序启动流程</li>
<li>Dex文件结构</li>
</ol>
<h1 id="三-java反射机制">三. Java反射机制
</h1><p>参考 <a class="link" href="https://gal2xy.github.io/2023/11/23/Android%E5%AE%89%E5%85%A8/java%E5%8F%8D%E5%B0%84%E6%8A%80%E6%9C%AF%E5%AD%A6%E4%B9%A0/"  target="_blank" rel="noopener"
    >java反射技术学习 </a>和 <a class="link" href="https://zhuanlan.zhihu.com/p/405325823"  target="_blank" rel="noopener"
    >Java反射机制-十分钟搞懂</a></p>
<p>示例文件: attachments\JavaReflectionDemo\ReflectionDemo.java</p>
<h2 id="反射机制简介">反射机制简介
</h2><p>反射的原理:</p>
<ol>
<li>
<p>Java反射机制的核心是在程序运行时动态加载类并获取类的详细信息,从而操作类或对象的属性和方法</p>
<p>本质是JVM得到class对象之后,再通过class对象进行<strong>反编译</strong>,从而获取对象的各种信息</p>
</li>
<li>
<p>Java属于先编译再运行的语言</p>
<p>程序中对象的类型在编译期就确定下来了,而当程序在运行时可能需要动态加载某些类,这些类因为之前用不到,所以没有被加载到JVM.通过反射,可以在运行时动态地创建对象并调用其属性,不需要提前在编译期知道运行的对象是谁.</p>
</li>
<li>
<p>反射是实现动态加载的技术之一</p>
</li>
</ol>
<p>反射的优缺点:</p>
<ol>
<li>
<p>优点</p>
<p>在运行时获得类的各种内容,进行反编译,对于Java这种先编译再运行的语言,能够让我们很方便的创建灵活的代码,这些代码可以在运行时装配,无需在组件之间进行源代码的链接,更加容易实现面向对象.</p>
</li>
<li>
<p>缺点</p>
<p>反射会消耗一定的系统资源,因此,如果不需要动态地创建一个对象,那么就不需要用反射；</p>
<p>反射调用方法时可以忽略权限检查,因此可能会破坏封装性而导致安全问题.</p>
</li>
</ol>
<p>反射的作用: 反射机制在实现壳程序动态加载被保护程序时非常关键,它可以突破默认的权限访问控制,访问安卓系统默认情况下禁止用户代码访问的以及不公开的部分.</p>
<h2 id="反射的本质">反射的本质
</h2><p>正常类的加载过程:</p>
<ol>
<li>执行Student student=new Student(),向JVM请求创建student实例</li>
<li>JVM寻找Student.class文件并加载到内存中</li>
<li>JVM创建Student对应的Class对象（一个类只对应一个Class对象）</li>
<li>JVM创建student实例</li>
</ol>
<p>对于同一个类而言,无论有多少个实例,都只对应一个Class对象</p>
<p>Java反射的本质: 获取Class对象后,反向访问实例对象</p>
<p><img src="/photos/1-JVM%e5%88%9b%e5%bb%baClass%e5%af%b9%e8%b1%a1.png"
	
	
	
	loading="lazy"
	
		alt="1-JVM创建Class对象"
	
	
></p>
<h2 id="反射的入口-class类">反射的入口-Class类
</h2><p>反射相关文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">Class</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">reflect</span><span class="p">.</span><span class="na">Constructor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">reflect</span><span class="p">.</span><span class="na">Field</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">reflect</span><span class="p">.</span><span class="na">Method</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">reflect</span><span class="p">.</span><span class="na">Modifier</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>JDK中,主要由以下类来实现Java反射机制,这些类都位于<strong>java.lang.reflect</strong>包中</p>
<ul>
<li>
<p>Class类: 代表一个类</p>
</li>
<li>
<p>Constructor 类: 代表类的构造方法</p>
</li>
<li>
<p>Field 类: 代表类的成员变量(属性)</p>
</li>
<li>
<p>Method类: 代表类的成员方法</p>
</li>
</ul>
<p>反射的入口-Class类:</p>
<ol>
<li>
<p>Class类的对象称为类对象</p>
</li>
<li>
<p>Class类是Java反射机制的起源和入口</p>
<ul>
<li>
<p>用于获取与类相关的各种信息</p>
</li>
<li>
<p>提供了获取类信息的相关方法</p>
</li>
<li>
<p>Class类继承自Object类</p>
</li>
</ul>
</li>
<li>
<p>Class类是所有类的共同的图纸</p>
<ul>
<li>
<p>每个类有自己的对象,好比图纸和实物的关系</p>
</li>
<li>
<p>每个类也可看做是一个对象,有共同的图纸Class,存放类的结构信息,比如类的名字、属性、方法、构造方法、父类和接口,能够通过相应方法取出相应信息</p>
</li>
</ul>
</li>
</ol>
<p>示例类,用于后续操作</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 示例类</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">class</span> <span class="nc">Person</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Runnable</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">age</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//默认构造函数和有参构造函数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">Person</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="nf">Person</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">str</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Private constructor:&#34;</span><span class="o">+</span><span class="n">str</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">Person</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">age</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">age</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">age</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 不同访问权限的方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">introduce</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;我是&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;,年龄&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">age</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">privateMethod</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="kt">int</span><span class="w"> </span><span class="n">age</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;这是Person的私有方法,&#34;</span><span class="o">+</span><span class="s">&#34;name=&#34;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s">&#34;,&#34;</span><span class="o">+</span><span class="s">&#34;age=&#34;</span><span class="o">+</span><span class="n">age</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Hello World&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="反射获取class">反射获取Class
</h2><p>非动态加载时,可通过.class属性或实例.getClass()方法获取Class类</p>
<p>动态加载时,可使用Class.forName()和ClassLoader.loadClass()加载并获取类对象</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//1. 获取类对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 动态加载</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;MyUnidbgScripts.Person&#34;</span><span class="p">);</span><span class="w"> </span><span class="c1">// 通过类的完整名加载</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">clazz2</span><span class="o">=</span><span class="n">ClassLoader</span><span class="p">.</span><span class="na">getSystemClassLoader</span><span class="p">().</span><span class="na">loadClass</span><span class="p">(</span><span class="s">&#34;MyUnidbgScripts.Person&#34;</span><span class="p">);</span><span class="c1">// 通过classloader加载</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 非动态加载</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">clazz3</span><span class="o">=</span><span class="n">Person</span><span class="p">.</span><span class="na">class</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">clazz4</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">Person</span><span class="p">().</span><span class="na">getClass</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Load Class:&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">clazz</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">clazz2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">clazz3</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">clazz4</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//2. 从类对象获取类的各种信息</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Class info:&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">clazz</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span><span class="w">       </span><span class="c1">// 完整类名</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">clazz</span><span class="p">.</span><span class="na">getSimpleName</span><span class="p">());</span><span class="w"> </span><span class="c1">// 类名</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">clazz</span><span class="p">.</span><span class="na">getSuperclass</span><span class="p">());</span><span class="w"> </span><span class="c1">// 父类类对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">Arrays</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">clazz</span><span class="p">.</span><span class="na">getInterfaces</span><span class="p">()));</span><span class="w">    </span><span class="c1">//接口类对象数组</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>输出如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Load Class:
</span></span><span class="line"><span class="cl">class MyUnidbgScripts.Person
</span></span><span class="line"><span class="cl">class MyUnidbgScripts.Person
</span></span><span class="line"><span class="cl">class MyUnidbgScripts.Person
</span></span><span class="line"><span class="cl">class MyUnidbgScripts.Person
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Class info:
</span></span><span class="line"><span class="cl">MyUnidbgScripts.Person
</span></span><span class="line"><span class="cl">Person
</span></span><span class="line"><span class="cl">class java.lang.Object
</span></span><span class="line"><span class="cl">[interface java.lang.Runnable]
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="反射获取constructor">反射获取Constructor
</h2><ul>
<li>class.getConstructor(Class<?>&hellip; ParameterTypes)                 获取class类指定参数类型的public构造方法</li>
<li>class.getConstructors()                                                           获取class类中的所有public权限的构造方法</li>
<li>class.getDeclaredConstructor(Class<?>&hellip; ParameterTypes)  获取class类中的任意构造方法</li>
<li>class.getDeclaredConstructors()                                             获取class类中的所有构造方法</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//3. 获取构造方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 获取无参构造方法(默认构造方法)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Get constructor:&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Constructor</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">constructor</span><span class="o">=</span><span class="n">clazz</span><span class="p">.</span><span class="na">getConstructor</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">constructor</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 获取public构造方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Get public constructors:&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Constructor</span><span class="o">&lt;?&gt;[]</span><span class="w"> </span><span class="n">constructors</span><span class="o">=</span><span class="n">clazz</span><span class="p">.</span><span class="na">getConstructors</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">Arrays</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">constructors</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 获取所有构造方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Get all constructors:&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">constructors</span><span class="o">=</span><span class="n">clazz</span><span class="p">.</span><span class="na">getDeclaredConstructors</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">Arrays</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">constructors</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Print All Constructors:&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">Constructor</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">cons</span><span class="p">:</span><span class="n">constructors</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;constructor: &#34;</span><span class="o">+</span><span class="n">cons</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;\tname: &#34;</span><span class="o">+</span><span class="n">cons</span><span class="p">.</span><span class="na">getName</span><span class="p">()</span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="s">&#34;\n\tModifiers: &#34;</span><span class="o">+</span><span class="n">Modifier</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">cons</span><span class="p">.</span><span class="na">getModifiers</span><span class="p">())</span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="s">&#34;\n\tParameterTypes: &#34;</span><span class="o">+</span><span class="n">Arrays</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">cons</span><span class="p">.</span><span class="na">getParameterTypes</span><span class="p">()));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>输出如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">Get</span> <span class="n">constructor</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="n">public</span> <span class="n">MyUnidbgScripts</span><span class="o">.</span><span class="n">Person</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Get</span> <span class="n">public</span> <span class="n">constructors</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">public</span> <span class="n">MyUnidbgScripts</span><span class="o">.</span><span class="n">Person</span><span class="p">(</span><span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">String</span><span class="p">,</span><span class="ne">int</span><span class="p">),</span> <span class="n">public</span> <span class="n">MyUnidbgScripts</span><span class="o">.</span><span class="n">Person</span><span class="p">()]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Get</span> <span class="n">all</span> <span class="n">constructors</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">public</span> <span class="n">MyUnidbgScripts</span><span class="o">.</span><span class="n">Person</span><span class="p">(</span><span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">String</span><span class="p">,</span><span class="ne">int</span><span class="p">),</span> <span class="n">private</span> <span class="n">MyUnidbgScripts</span><span class="o">.</span><span class="n">Person</span><span class="p">(</span><span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">String</span><span class="p">),</span> <span class="n">public</span> <span class="n">MyUnidbgScripts</span><span class="o">.</span><span class="n">Person</span><span class="p">()]</span>
</span></span><span class="line"><span class="cl"><span class="n">Print</span> <span class="n">All</span> <span class="n">Constructors</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="n">constructor</span><span class="p">:</span> <span class="n">public</span> <span class="n">MyUnidbgScripts</span><span class="o">.</span><span class="n">Person</span><span class="p">(</span><span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">String</span><span class="p">,</span><span class="ne">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">name</span><span class="p">:</span> <span class="n">MyUnidbgScripts</span><span class="o">.</span><span class="n">Person</span>
</span></span><span class="line"><span class="cl">	<span class="n">Modifiers</span><span class="p">:</span> <span class="n">public</span>
</span></span><span class="line"><span class="cl">	<span class="n">ParameterTypes</span><span class="p">:</span> <span class="p">[</span><span class="k">class</span> <span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="ne">int</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">constructor</span><span class="p">:</span> <span class="n">private</span> <span class="n">MyUnidbgScripts</span><span class="o">.</span><span class="n">Person</span><span class="p">(</span><span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">String</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">name</span><span class="p">:</span> <span class="n">MyUnidbgScripts</span><span class="o">.</span><span class="n">Person</span>
</span></span><span class="line"><span class="cl">	<span class="n">Modifiers</span><span class="p">:</span> <span class="n">private</span>
</span></span><span class="line"><span class="cl">	<span class="n">ParameterTypes</span><span class="p">:</span> <span class="p">[</span><span class="k">class</span> <span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">String</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">constructor</span><span class="p">:</span> <span class="n">public</span> <span class="n">MyUnidbgScripts</span><span class="o">.</span><span class="n">Person</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="n">name</span><span class="p">:</span> <span class="n">MyUnidbgScripts</span><span class="o">.</span><span class="n">Person</span>
</span></span><span class="line"><span class="cl">	<span class="n">Modifiers</span><span class="p">:</span> <span class="n">public</span>
</span></span><span class="line"><span class="cl">	<span class="n">ParameterTypes</span><span class="p">:</span> <span class="p">[]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="反射获取field">反射获取Field
</h2><ul>
<li>class.getField(FieldName)                获取class类中的带public声明的FieldName变量</li>
<li>class.getFields()                                获取class类中的带public声明的所有变量</li>
<li>class.getDeclaredField(FieldName)  获取class类中的FieldName变量</li>
<li>class.getDeclaredFields()                  获取class类中的所有变量</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//3. 获取属性</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 获取所有public属性</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Get public fields:&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Field</span><span class="o">[]</span><span class="w"> </span><span class="n">fields</span><span class="o">=</span><span class="n">clazz</span><span class="p">.</span><span class="na">getFields</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">Arrays</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">fields</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 获取所有属性</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Get all fields:&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">fields</span><span class="o">=</span><span class="n">clazz</span><span class="p">.</span><span class="na">getDeclaredFields</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">Arrays</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">fields</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Print all fields:&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">Field</span><span class="w"> </span><span class="n">field</span><span class="p">:</span><span class="n">fields</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;field: &#34;</span><span class="o">+</span><span class="n">field</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;\ttype: &#34;</span><span class="o">+</span><span class="n">field</span><span class="p">.</span><span class="na">getType</span><span class="p">()</span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="s">&#34;\n\tname: &#34;</span><span class="o">+</span><span class="n">field</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Get specific field:&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 获取public权限的指定属性</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Field</span><span class="w"> </span><span class="n">field</span><span class="o">=</span><span class="n">clazz</span><span class="p">.</span><span class="na">getField</span><span class="p">(</span><span class="s">&#34;name&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">field</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 获取任意权限的指定属性</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">field</span><span class="o">=</span><span class="n">clazz</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;age&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">field</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>输出如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Get public fields:
</span></span><span class="line"><span class="cl">[public java.lang.String MyUnidbgScripts.Person.name]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Get all fields:
</span></span><span class="line"><span class="cl">[public java.lang.String MyUnidbgScripts.Person.name, private int MyUnidbgScripts.Person.age]
</span></span><span class="line"><span class="cl">Print all fields:
</span></span><span class="line"><span class="cl">field: public java.lang.String MyUnidbgScripts.Person.name
</span></span><span class="line"><span class="cl">	type: class java.lang.String
</span></span><span class="line"><span class="cl">	name: name
</span></span><span class="line"><span class="cl">field: private int MyUnidbgScripts.Person.age
</span></span><span class="line"><span class="cl">	type: int
</span></span><span class="line"><span class="cl">	name: age
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Get specific field:
</span></span><span class="line"><span class="cl">public java.lang.String MyUnidbgScripts.Person.name
</span></span><span class="line"><span class="cl">private int MyUnidbgScripts.Person.age
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="反射获取method">反射获取Method
</h2><ul>
<li>class.getMethod(MethodName,&hellip;ParameterTypes)               获取指定方法名和指定参数的public方法</li>
<li>class.getMethods()                                                                 获取class类中所有public方法</li>
<li>class.getDeclaredMethod(MethodName,&hellip;ParameterTypes) 获取class类中指定方法名和指定参数的任意方法</li>
<li>class.getDeclaredMethods()                                                   获取class类的所有方法</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//4. 获取方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Get public methods:&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Method</span><span class="o">[]</span><span class="w"> </span><span class="n">methods</span><span class="o">=</span><span class="n">clazz</span><span class="p">.</span><span class="na">getMethods</span><span class="p">();</span><span class="w">   </span><span class="c1">// 注意会获取所实现接口的public方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">Arrays</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">methods</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Get all methods:&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">methods</span><span class="o">=</span><span class="n">clazz</span><span class="p">.</span><span class="na">getDeclaredMethods</span><span class="p">();</span><span class="w">    </span><span class="c1">// 获取所有声明的方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">Arrays</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">methods</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Print all methods:&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">Method</span><span class="w"> </span><span class="n">method</span><span class="p">:</span><span class="n">methods</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;method: &#34;</span><span class="o">+</span><span class="n">method</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;\tname: &#34;</span><span class="o">+</span><span class="n">method</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;\treturnType: &#34;</span><span class="o">+</span><span class="n">method</span><span class="p">.</span><span class="na">getReturnType</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;\tparameterTypes: &#34;</span><span class="o">+</span><span class="n">Arrays</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">method</span><span class="p">.</span><span class="na">getParameterTypes</span><span class="p">()));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 获取public的指定方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Method</span><span class="w"> </span><span class="n">method</span><span class="o">=</span><span class="n">clazz</span><span class="p">.</span><span class="na">getMethod</span><span class="p">(</span><span class="s">&#34;introduce&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">method</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 获取任意权限的指定方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">method</span><span class="o">=</span><span class="n">clazz</span><span class="p">.</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="s">&#34;privateMethod&#34;</span><span class="p">,</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="kt">int</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">method</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>输出如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Get public methods:
</span></span><span class="line"><span class="cl">[public void MyUnidbgScripts.Person.run(), public void MyUnidbgScripts.Person.introduce(), public final void java.lang.Object.wait(long,int) throws java.lang.InterruptedException, public final void java.lang.Object.wait() throws java.lang.InterruptedException, public final native void java.lang.Object.wait(long) throws java.lang.InterruptedException, public boolean java.lang.Object.equals(java.lang.Object), public java.lang.String java.lang.Object.toString(), public native int java.lang.Object.hashCode(), public final native java.lang.Class java.lang.Object.getClass(), public final native void java.lang.Object.notify(), public final native void java.lang.Object.notifyAll()]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Get all methods:
</span></span><span class="line"><span class="cl">[public void MyUnidbgScripts.Person.run(), public void MyUnidbgScripts.Person.introduce(), private void MyUnidbgScripts.Person.privateMethod(java.lang.String,int)]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Print all methods:
</span></span><span class="line"><span class="cl">method: public void MyUnidbgScripts.Person.run()
</span></span><span class="line"><span class="cl">	name: run
</span></span><span class="line"><span class="cl">	returnType: void
</span></span><span class="line"><span class="cl">	parameterTypes: []
</span></span><span class="line"><span class="cl">method: public void MyUnidbgScripts.Person.introduce()
</span></span><span class="line"><span class="cl">	name: introduce
</span></span><span class="line"><span class="cl">	returnType: void
</span></span><span class="line"><span class="cl">	parameterTypes: []
</span></span><span class="line"><span class="cl">method: private void MyUnidbgScripts.Person.privateMethod(java.lang.String,int)
</span></span><span class="line"><span class="cl">	name: privateMethod
</span></span><span class="line"><span class="cl">	returnType: void
</span></span><span class="line"><span class="cl">	parameterTypes: [class java.lang.String, int]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">public void MyUnidbgScripts.Person.introduce()
</span></span><span class="line"><span class="cl">private void MyUnidbgScripts.Person.privateMethod(java.lang.String,int)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="反射创建对象">反射创建对象
</h2><ol>
<li>通过Class.newInstance()            调用无参构造方法创建实例 不能传递参数</li>
<li>通过Constructor.newInstance() 调用指定构造方法创建实例 可传递参数</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//5. 反射创建对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Create instance by reflection:&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//5.1 Class.newInstance() 要求Class对象对应类有无参构造方法,执行无参构造方法创建实例</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Create instance by Class.newInstance():&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">obj</span><span class="o">=</span><span class="n">clazz</span><span class="p">.</span><span class="na">newInstance</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//5.2 Constructor.newInstance() 通过Class获取Constructor,再创建对象,可使用指定构造方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Create instance by Constructor.newInstance():&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Constructor</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">cons</span><span class="o">=</span><span class="n">clazz</span><span class="p">.</span><span class="na">getConstructor</span><span class="p">();</span><span class="c1">// 获取无参构造方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">obj</span><span class="o">=</span><span class="n">cons</span><span class="p">.</span><span class="na">newInstance</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">cons</span><span class="o">=</span><span class="n">clazz</span><span class="p">.</span><span class="na">getDeclaredConstructors</span><span class="p">()</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">;</span><span class="c1">// 获取有参构造方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">obj</span><span class="o">=</span><span class="n">cons</span><span class="p">.</span><span class="na">newInstance</span><span class="p">(</span><span class="s">&#34;张三&#34;</span><span class="p">,</span><span class="n">18</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>输出如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Create instance by reflection:
</span></span><span class="line"><span class="cl">Create instance by Class.newInstance():
</span></span><span class="line"><span class="cl">MyUnidbgScripts.Person@30dae81
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Create instance by Constructor.newInstance():
</span></span><span class="line"><span class="cl">MyUnidbgScripts.Person@1b2c6ec2
</span></span><span class="line"><span class="cl">MyUnidbgScripts.Person@4edde6e5
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="反射操作属性">反射操作属性
</h2><ol>
<li>Class.getField(FieldName)                获取指定名称的public属性</li>
<li>Class.getDeclaredField(FieldName)  获取指定名称的任意属性</li>
<li>Field.get(Object obj)                         获取指定实例的值</li>
<li>Field.set(Object obj,Object value)    设置指定实例的值</li>
<li>Field.setAccessible(true)                   突破属性权限控制</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">       </span><span class="c1">//6. 反射操作属性</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Access field by reflection:&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Field</span><span class="w"> </span><span class="n">nameField</span><span class="o">=</span><span class="n">clazz</span><span class="p">.</span><span class="na">getField</span><span class="p">(</span><span class="s">&#34;name&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">nameField</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="s">&#34;王五&#34;</span><span class="p">);</span><span class="w">    </span><span class="c1">// 修改指定对象的指定属性</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Field</span><span class="w"> </span><span class="n">ageField</span><span class="o">=</span><span class="n">clazz</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;age&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ageField</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="c1">// 突破权限控制</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ageField</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">20</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">nameField</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">obj</span><span class="p">));</span><span class="c1">// get方法获取字段值</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">ageField</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">obj</span><span class="p">));</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>输出如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Access field by reflection:
</span></span><span class="line"><span class="cl">王五
</span></span><span class="line"><span class="cl">20
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="反射调用方法">反射调用方法
</h2><ol>
<li>Class.getMethod(String name,Class<?>&hellip; parameterTypes)                获取指定名称和参数类型的public方法</li>
<li>Class.getDeclaredMethod(String name,Class<?>&hellip; parameterTypes)  获取指定名称和参数类型的方法</li>
<li>Method.setAccessible(true)                                                                  突破访问权限控制</li>
<li>Method.invoke(Object obj,Object&hellip; args)                                             调用指定实例的方法,可传递参数</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">       </span><span class="c1">//7. 反射调用方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Run method by reflection:&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Method</span><span class="w"> </span><span class="n">introduceMethod</span><span class="o">=</span><span class="n">clazz</span><span class="p">.</span><span class="na">getMethod</span><span class="p">(</span><span class="s">&#34;introduce&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">introduceMethod</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span><span class="w"> </span><span class="c1">//person.introduce()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Method</span><span class="w"> </span><span class="n">privateMethod</span><span class="o">=</span><span class="n">clazz</span><span class="p">.</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="s">&#34;privateMethod&#34;</span><span class="p">,</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="kt">int</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="c1">// person.privateMethod(&#34;赵四&#34;,19)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">privateMethod</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">privateMethod</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="s">&#34;赵四&#34;</span><span class="p">,</span><span class="n">19</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>输出如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Run method by reflection:
</span></span><span class="line"><span class="cl">我是王五,年龄20
</span></span><span class="line"><span class="cl">这是Person的私有方法,name=赵四,age=19
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="封装反射类">封装反射类
</h2><p>封装Reflection.java反射类便于后续使用,提供以下功能:</p>
<ol>
<li>调用静态/实例方法</li>
<li>访问静态/实例字段</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.androidshell</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.util.Log</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Field</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Method</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Reflection</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">TAG</span><span class="o">=</span><span class="s">&#34;glass&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">invokeStaticMethod</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">class_name</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">method_name</span><span class="p">,</span><span class="n">Class</span><span class="o">&lt;?&gt;[]</span><span class="w"> </span><span class="n">parameterTypes</span><span class="p">,</span><span class="n">Object</span><span class="o">[]</span><span class="w"> </span><span class="n">parameterValues</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="n">class_name</span><span class="p">);</span><span class="w"> </span><span class="c1">//反射获取Class类对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Method</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">getMethod</span><span class="p">(</span><span class="n">method_name</span><span class="p">,</span><span class="n">parameterTypes</span><span class="p">);</span><span class="c1">//反射获取方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">method</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="c1">//突破权限访问控制</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">method</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="n">parameterValues</span><span class="p">);</span><span class="c1">//反射调用,静态方法无需指定所属实例,直接传参即可</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">invokeMethod</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">class_name</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">method_name</span><span class="p">,</span><span class="n">Object</span><span class="w"> </span><span class="n">obj</span><span class="p">,</span><span class="n">Class</span><span class="o">&lt;?&gt;[]</span><span class="w"> </span><span class="n">parameterTypes</span><span class="p">,</span><span class="n">Object</span><span class="o">[]</span><span class="w"> </span><span class="n">parameterValues</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="n">class_name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Method</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">getMethod</span><span class="p">(</span><span class="n">method_name</span><span class="p">,</span><span class="n">parameterTypes</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">method</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="c1">//突破权限访问控制</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">method</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">parameterValues</span><span class="p">);</span><span class="c1">// 反射调用,动态方法需要指定所属实例</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">getField</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">class_name</span><span class="p">,</span><span class="n">Object</span><span class="w"> </span><span class="n">obj</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">field_name</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="n">class_name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Field</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="n">field_name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">field</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span><span class="w">  </span><span class="c1">//获取实例字段,需要指定实例对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">getStaticField</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">class_name</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">field_name</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="n">class_name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Field</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="n">field_name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">field</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setField</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">class_name</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">field_name</span><span class="p">,</span><span class="n">Object</span><span class="w"> </span><span class="n">obj</span><span class="p">,</span><span class="n">Object</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="n">class_name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Field</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="n">field_name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setStaticField</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">class_name</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">field_name</span><span class="p">,</span><span class="n">Object</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="n">class_name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Field</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="n">field_name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h1 id="四-classloader机制">四. ClassLoader机制
</h1><p>热修复和插件化技术依赖于ClassLoader,JVM虚拟机运行class文件,而Dalvik/ART运行dex文件,所以它们的ClassLoader有部分区别</p>
<h2 id="java中的classloader">Java中的ClassLoader
</h2><h3 id="classloader的类型">ClassLoader的类型
</h3><p>Java的ClassLoader分为两种:</p>
<ul>
<li>
<p>系统类加载器</p>
<p>BootstrapClassLoader, ExtensionsClassLoader, ApplicationClassLoader</p>
</li>
<li>
<p>自定义类加载器</p>
<p>Custom ClassLoader, 通过继承java.lang.ClassLoader实现</p>
</li>
</ul>
<p>具体分析如下</p>
<ol>
<li>
<p>Bootstrap ClassLoader (引导类加载器)</p>
<p>是使用C/C++实现的加载器(不能被Java代码访问),用于加载JDK的核心类库,例如java.lang和java.util等系统类</p>
<p>会加载JAVA_HOME/jre/lib和-Xbootclasspath参数指定的目录</p>
<p>JVM虚拟机的启动就是通过BootstrapClassLoader创建的初始类完成的</p>
<p>可通过如下代码得出其加载的目录(java8)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Test0</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="s">&#34;sun.boot.class.path&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>效果如下</p>
<p><img src="/photos%5c2-ClassLoader-JavaBootstrapClassLoader.png"
	
	
	
	loading="lazy"
	
	
></p>
</li>
<li>
<p>Extensions ClassLoader (拓展类加载器)</p>
<p>该类在Java中的实现类为ExtClassLoader,用于加载java的拓展类,提供除系统类之外的额外功能</p>
<p>用于加载JAVA_HOME/jre/lib/ext和java.ext.dir指定的目录</p>
<p>以下代码可以打印ExtClassLoader的加载目录</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JavaClassLoaderTest</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">ext</span><span class="p">.</span><span class="na">dirs</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/photos%5c3-ClassLoader-JavaExtensionsClassLoader.png"
	
	
	
	loading="lazy"
	
	
></p>
</li>
<li>
<p>Application ClassLoader (应用程序类加载器)</p>
<p>对应的实现类为AppClassLoader,又可以称作System ClassLoader(系统类加载器),因为它可以通过ClassLoader.getSystemClassLoader()方法获取</p>
<p>用于加载程序的Classpath目录和系统属性java.class.path指定的目录</p>
</li>
<li>
<p>Custom ClassLoader (自定义加载器)</p>
<p>除了以上3个系统提供的类加载器之外,还可以通过继承java.lang.ClassLoader实现自定义类加载器</p>
<p>Extensions和Application ClassLoader也继承了该类</p>
</li>
</ol>
<h3 id="classloader的继承关系">ClassLoader的继承关系
</h3><p>运行一个Java程序需要几种类型的类加载器呢?可以使用如下代码验证</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JavaClassLoaderTest</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">loader</span><span class="o">=</span><span class="n">JavaClassLoaderTest</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getClassLoader</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">while</span><span class="p">(</span><span class="n">loader</span><span class="o">!=</span><span class="kc">null</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">loader</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">loader</span><span class="o">=</span><span class="n">loader</span><span class="p">.</span><span class="na">getParent</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>打印出了AppClassLoader和ExtClassLoader,由于BootstrapClassLoader由C/C++编写,并非Java类,所以无法在Java中获取它的引用</p>
<p><img src="/photos%5c4-ClassLoader-JavaClassLoaderCallOrder.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>注意:</p>
<ol>
<li>
<p>系统提供的类加载器有3种类型,但是系统提供的ClassLoader不止3个</p>
</li>
<li>
<p>并且,AppClassLoader的父类加载器为ExtClassLoader,不代表AppClassLoader继承自ExtClassLoader</p>
</li>
</ol>
<p>ClassLoader的继承关系如图所示:</p>
<ol>
<li>
<p>ClassLoader 是一个抽象类,定义了ClassLoader的主要功能</p>
</li>
<li>
<p>SecureClassLoader 继承自ClassLoader,但并不是ClassLoader的实现类,而是拓展并加入了权限管理方面的功能,增强了安全性</p>
</li>
<li>
<p>URLClassLoader 继承自SecureClassLoader 可通过URL路径从jar文件和文件夹中加载类和资源</p>
</li>
<li>
<p>ExtClassLoader和AppClassLoader都继承自URLClassLoader</p>
<p>它们都是Launcher的内部类,而Launcher是JVM虚拟机的入口应用,所以ExtClassLoader和AppClassLoader都在Launcher中初始化</p>
</li>
</ol>
<p><img src="/photos%5c5-ClassLoader-JavaClassLoaders.png"
	
	
	
	loading="lazy"
	
	
></p>
<h3 id="classloader的双亲委托机制">ClassLoader的双亲委托机制
</h3><p>类加载器查找Class采用了双亲委托模式:</p>
<ol>
<li>先判断该Class是否加载,如果没有则先委托父类加载器查找,并依次递归直到顶层的Bootstrap ClassLoader</li>
<li>如果Bootstrap ClassLoader找到了则返回该Class,否则依次向下查找</li>
<li>如果所有父类都没找到Class则调用自身findClass进行查找</li>
</ol>
<p>双亲委托机制的优点:</p>
<ol>
<li>
<p>避免重复加载</p>
<p>如果已经加载过Class则无需重复加载,只需要读取加载的Class即可</p>
</li>
<li>
<p>更加安全</p>
<p>保证无法使用自定义的类替代系统类,并且只有两个类名一致并且被同一个加载器加载的类才会被认为是同一个类</p>
</li>
</ol>
<p><img src="/photos%5c6-ClassLoader-JavaClassLoaderParentalDelegation.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>ClassLoader.loadClass方法源码如下(Java17)</p>
<ol>
<li>
<p>注释1处 检查传入的类是否被加载, 如果已经加载则不执行后续代码</p>
</li>
<li>
<p>注释2处 若父类加载器不为null则调用父类loadClass方法加载Class</p>
</li>
<li>
<p>注释3处 如果父类加载器为null则调用findBootstrapClassOrNull方法</p>
<p>该方法内部调用了Native方法findBootstrapClass,最终用Bootstrap ClassLoader检查该类是否被加载</p>
<p><strong>注意: 在Android中,该方法直接返回null</strong>,因为Android中没有BootstrapClassLoader</p>
</li>
<li>
<p>注释4处 调用自身的findClass查找类</p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">loadClass</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">resolve</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">throws</span><span class="w"> </span><span class="n">ClassNotFoundException</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">getClassLoadingLock</span><span class="p">(</span><span class="n">name</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findLoadedClass</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="c1">//1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">long</span><span class="w"> </span><span class="n">t0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">nanoTime</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">parent</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parent</span><span class="p">.</span><span class="na">loadClass</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="c1">//2.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findBootstrapClassOrNull</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="c1">//3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">// ClassNotFoundException thrown if class not found</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">// from the non-null parent class loader</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">// If still not found, then invoke findClass in order</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">// to find the class.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="kt">long</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">nanoTime</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findClass</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="c1">//4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">// this is the defining class loader; record the stats</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">PerfCounter</span><span class="p">.</span><span class="na">getParentDelegationTime</span><span class="p">().</span><span class="na">addTime</span><span class="p">(</span><span class="n">t1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">PerfCounter</span><span class="p">.</span><span class="na">getFindClassTime</span><span class="p">().</span><span class="na">addElapsedTimeFrom</span><span class="p">(</span><span class="n">t1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">PerfCounter</span><span class="p">.</span><span class="na">getFindClasses</span><span class="p">().</span><span class="na">increment</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">resolve</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">resolveClass</span><span class="p">(</span><span class="n">c</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>以上流程示意图如下</p>
<p><img src="/photos%5c7-ClassLoader-LoadClass.png"
	
	
	
	loading="lazy"
	
		alt="3-ClassLoader-LoadClass"
	
	
></p>
<h2 id="android中的classloader">Android中的ClassLoader
</h2><p>Java中的ClassLoader可以加载jar和class文件（本质都是加载class文件）</p>
<p>而在Android中,无论DVM还是ART加载的文件都是dex文件,所以需要重新设计ClassLoader的相关类.</p>
<p>Android中的ClassLoader分为系统类加载器和自定义加载器:</p>
<ul>
<li>
<p>系统类加载器</p>
<p>包括 BootClassLoader, PathClassLoader, DexClassLoader等</p>
</li>
<li>
<p>自定义加载器</p>
<p>通过继承BaseDexClassLoader实现,它们的继承关系如图所示:</p>
</li>
</ul>
<p><img src="/photos%5c8-ClassLoader%e7%bb%a7%e6%89%bf%e5%85%b3%e7%b3%bb.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>各个ClassLoader的作用:</p>
<ol>
<li>
<p>ClassLoader</p>
<p>抽象类,定义了ClassLoader的主要功能.</p>
</li>
<li>
<p>BootClassLoader</p>
<p>继承自ClassLoader,用于Android系统启动时预加载常用类.</p>
</li>
<li>
<p>SecureClassLoader</p>
<p>继承自ClassLoader扩展了类权限方面的功能,加强了安全性.</p>
</li>
<li>
<p>URLClassLoader</p>
<p>继承自SecureClassLoader,用于通过URL路径加载类和资源.</p>
</li>
<li>
<p>BaseDexClassLoader</p>
<p>继承自ClassLoader,是抽象类ClassLoader的具体实现类.</p>
</li>
<li>
<p>InMemoryDexClassLoader（Android8.0新增）</p>
<p>继承自BaseDexClassLoader,用于加载内存中的dex文件.</p>
</li>
<li>
<p>PathClassLoader</p>
<p>继承自BaseDexClassLoader,用于加载已安装的apk的dex文件.</p>
</li>
<li>
<p>DexClassLoader</p>
<p>继承自BaseDexClassLoader,用于加载已安装的apk的dex文件,以及从SD卡中加载未安装的apk的dex文件.</p>
</li>
</ol>
<p>实现Android加固时,壳程序动态加载被保护程序的dex文件主要使用以下3个类加载器:</p>
<ol>
<li>
<p>DexClassLoader 可以加载未安装apk的dex文件</p>
<p>它是一代加固——整体加固（落地加载）的核心之一</p>
</li>
<li>
<p>InMemoryDexClassLoader 可以加载内存中的dex文件</p>
<p>它是二代加固——整体加固（不落地加载）的核心之一</p>
</li>
<li>
<p>BaseDexClassLoader是ClassLoader的具体实现类</p>
<p>实际上DexClassLoader,PathClassLoader以及InMemoryDexClassLoader加载类时,均通过委托BaseDexClassLoader实现</p>
</li>
</ol>
<h2 id="classloader加载dex流程简介">ClassLoader加载Dex流程简介
</h2><p>Dex文件的加载依赖于前文提到的PathClassLoader,DexClassLoader和InMemoryDexClassLoader</p>
<p>加载Dex文件的功能均通过委托父加载器BaseDexClassLoader实现.其中PathClassLoader和DexClassLoader调用相同的BaseDexClassLoader构造函数,InMemoryDexClassLoader调用另一个构造函数.</p>
<p>最终通过ArtDexFileLoader::OpenCommon方法在ART虚拟机中创建DexFile::DexFile对象,该对象是Dex文件在内存中的表示,用于安卓程序运行时加载类以及执行方法代码,也是后续第三代加固——代码抽取加固,进行指令回填时的关键对象.</p>
<p>三种ClassLoader加载Dex文件的流程如下(基于Android10.0):</p>
<ol>
<li>
<p>Java层</p>
<p>PathClassLoader和DexClassLoader委托BaseDexClassLoader最终执行JNI方法DexFile.openDexFileNative进入Native层.</p>
<p>而InMemoryDexClassLoader委托BaseDexClassLoader后则执行DexFile.openInMemoryDexFiles进入Native层.</p>
<p><img src="/photos%5c9-LoadDex-JavaLevel.png"
	
	
	
	loading="lazy"
	
		alt="4-LoadDex-JavaLevel"
	
	
></p>
</li>
<li>
<p>Native层</p>
<p>PathClassLoader和DexClassLoader这条委托链会根据不同情况,调用ArtDexFileLoader::Open的不同重载,或者调用OpenOneDexFileFromZip.</p>
<p>InMemoryDexClassLoader调用ArtDexFileLoader::Open的第3种重载.</p>
<p>无论是调用哪个函数,最终都会调用ArtDexFileLoader::OpenCommon.</p>
<p><img src="/photos%5c10-LoadDex-NativeLevel.png"
	
	
	
	loading="lazy"
	
		alt="5-LoadDex-NativeLevel"
	
	
></p>
<p>经过以上调用流程后进入ArtDexFileLoader::OpenCommon,经过DexFile的初始化和验证操作后便成功创建了DexFile对象:</p>
<p><img src="/photos%5c11-LoadDex-CreateDexFile.png"
	
	
	
	loading="lazy"
	
		alt="6-LoadDex-CreateDexFile"
	
	
></p>
</li>
</ol>
<p>创建DexFile对象后,Class对应的文件便被加载到ART虚拟机中</p>
<h2 id="classloader加载class流程简介">ClassLoader加载Class流程简介
</h2><p>前文通过ClassLoader.loadClass讲解了双亲委托机制,那么一个Class具体是如何被加载到JVM中的呢？</p>
<p>首先,继承自BaseDexClassLoader的3种ClassLoader调用自身loadClass方法时,委托父类查找,委托到ClassLoader.loadClass时返回.</p>
<p>BaseDexClassLoader.findClass调用DexPathList.findClass,其内部调用Element.findClass,最终调用DexFile.loadClassBinaryName进入DexFile中,该流程如图所示:</p>
<p><img src="/photos%5c12-loadClass1.png"
	
	
	
	loading="lazy"
	
		alt="7-loadClass1"
	
	
></p>
<p>进入DexFile后,主要执行以下操作:</p>
<ol>
<li>
<p>DexFile</p>
<p>通过JNI函数defineClassNative进入Native层.</p>
</li>
<li>
<p>DexFile_defineClassNative</p>
<p>通过FindClassDef枚举DexFile的所有DexClassDef结构并使用ClassLinker::DefineClass创建对应的Class对象.</p>
<p>之后调用ClassLinker::InsertDexFileInToClassLoader将对应的DexFile对象添加到ClassLoader的ClassTable中.</p>
</li>
<li>
<p>ClassLinker::DefineClass</p>
<p>调用LoadField加载类的相关字段,之后调用LoadMethod加载方法,再调用LinkCode执行方法代码的链接.</p>
</li>
</ol>
<p>该流程如图所示:</p>
<p><img src="/photos%5c13-loadClass2.png"
	
	
	
	loading="lazy"
	
		alt="8-loadClass2"
	
	
></p>
<p>综上所述,ClassLoader最终通过ClassLinker::DefineClass创建Class对象,并完成Field和Method的加载以及Code的链接.</p>
<p>调用链中有一个核心函数——ClassLinker::LoadMethod,通过该函数可以获取方法字节码在DexFile中的偏移值code_off,它是实现指令回填的核心之一</p>
<h2 id="loaddexdemo">LoadDexDemo
</h2><p>参考<a class="link" href="https://xialuohun.top/posts/android/android%E5%A3%B3%E4%B8%96%E7%95%8C/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/#%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E7%A4%BA%E4%BE%8B"  target="_blank" rel="noopener"
    >动态加载示例</a></p>
<p>示例文件: attachments\LoadDexDemo</p>
<p>经过前文的介绍,我们知道Android中可使用ClassLoader加载dex文件,并调用其保存的类的方法</p>
<p>创建空项目,编写一个测试类用于打印信息,编译后提取apk文件和该类所在的dex文件并推送至手机的tmp目录</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.emptydemo</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.util.Log</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">TestClass</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">print</span><span class="p">(){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="s">&#34;glass&#34;</span><span class="p">,</span><span class="s">&#34;com.example.emptydemo.print is called!&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>创建另一个项目,通过DexClassLoader加载apk和提取的dex文件并反射执行print方法</p>
<ol>
<li>
<p>创建私有目录用于创建DexClassLoader</p>
<p>分别是odex和lib目录</p>
</li>
<li>
<p>创建DexClassLoader</p>
</li>
<li>
<p>加载指定类</p>
</li>
<li>
<p>反射加载并执行类的方法</p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.testdemo</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.content.Context</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.os.Bundle</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">androidx.appcompat.app.AppCompatActivity</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.File</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.InvocationTargetException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Method</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">dalvik.system.DexClassLoader</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MainActivity</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AppCompatActivity</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onCreate</span><span class="p">(</span><span class="n">Bundle</span><span class="w"> </span><span class="n">savedInstanceState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">.</span><span class="na">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setContentView</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">layout</span><span class="p">.</span><span class="na">activity_main</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Context</span><span class="w"> </span><span class="n">appContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getApplicationContext</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//com.example.emptydemo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">loadDexClassAndExecuteMethod</span><span class="p">(</span><span class="n">appContext</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;/data/local/tmp/classes3.dex&#34;</span><span class="p">);</span><span class="w"> </span><span class="c1">//直接加载dex文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">loadDexClassAndExecuteMethod</span><span class="p">(</span><span class="n">appContext</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;/data/local/tmp/EmptyDemo.apk&#34;</span><span class="p">);</span><span class="w"> </span><span class="c1">//加载apk文件 本质还是加载dex</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">loadDexClassAndExecuteMethod</span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">strDexFilePath</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//1.创建优化私有目录app_opt_dex和app_lib_dex,用于ClassLoader</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">File</span><span class="w"> </span><span class="n">optFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getDir</span><span class="p">(</span><span class="s">&#34;opt_dex&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">);</span><span class="c1">// /data/user/0/com.example.testdemo/app_opt_dex</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">File</span><span class="w"> </span><span class="n">libFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getDir</span><span class="p">(</span><span class="s">&#34;lib_dex&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">);</span><span class="c1">// /data/user/0/com.example.testdemo/app_lib_dex</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//2.创建ClassLoader用于加载Dex文件 依次指定dex文件路径 Odex目录 lib库目录 父类加载器</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">DexClassLoader</span><span class="w"> </span><span class="n">dexClassLoader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DexClassLoader</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">strDexFilePath</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">optFile</span><span class="p">.</span><span class="na">getAbsolutePath</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">libFile</span><span class="p">.</span><span class="na">getAbsolutePath</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">MainActivity</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getClassLoader</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//3.通过创建的DexClassLoader加载dex文件的指定类</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dexClassLoader</span><span class="p">.</span><span class="na">loadClass</span><span class="p">(</span><span class="s">&#34;com.example.emptydemo.TestClass&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clazz</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">//3.反射获取并调用类的方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">Object</span><span class="w"> </span><span class="n">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">newInstance</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">Method</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="s">&#34;print&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">method</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InvocationTargetException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">NoSuchMethodException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IllegalAccessException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InstantiationException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>效果如下</p>
<p><img src="/photos%5c14-%e5%8a%a8%e6%80%81%e5%8a%a0%e8%bd%bddex-demo.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>DexClassLoader构造函数如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	参数一: String dexPath, Dex文件路径
</span></span></span><span class="line"><span class="cl"><span class="cm">	参数二: String optimizedDirectory, 优化后的dex即Odex目录
</span></span></span><span class="line"><span class="cl"><span class="cm">	Android中内存中不会出现上述参数一的Dex文件, 会先优化,然后运行,优化后为.odex文件
</span></span></span><span class="line"><span class="cl"><span class="cm">	参数三: String librarySearchPath, lib库搜索路径
</span></span></span><span class="line"><span class="cl"><span class="cm">	参数四: ClassLoader parent, 父类加载器
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DexClassLoader</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">BaseDexClassLoader</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">DexClassLoader</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">dexPath</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">optimizedDirectory</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">librarySearchPath</span><span class="p">,</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">parent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">((</span><span class="n">String</span><span class="p">)</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">File</span><span class="p">)</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">ClassLoader</span><span class="p">)</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&#34;Stub!&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h1 id="五-android应用程序启动流程">五. Android应用程序启动流程
</h1><p>Android应用程序启动流程相关知识是实现壳程序加载被保护程序的核心,只有了解该机制,才能理解壳程序的工作原理</p>
<p>Android应用程序启动涉及4个进程: Zygote进程,Launcher进程,AMS所在进程（SystemServer进程）,应用程序进程</p>
<p>总体流程如下:</p>
<ol>
<li>点击桌面应用图标后,Launcher进程使用Binder通信,向SystemServer进程的AMS发起startActivity请求创建根Activity</li>
<li>AMS接收Launcher请求后,判断应用程序进程是否存在,不存在则通过Socket通信,调用zygoteSendArgsAndGetResult请求Zygote创建应用程序进程</li>
<li>Zygote进程接收AMS的Socket请求后,通过forkAndSpecialize创建应用程序进程,之后进行初始化工作</li>
<li>应用程序进程启动后,AMS通过ApplicationThread代理类与应用程序进程的ApplicationThread进行Binder通信,发送scheduleLaunchActivity请求</li>
<li>应用程序进程的Binder线程ApplicationThread接受请求后,通过sendMessage与主线程ActivityThread进行Handler通信,发送LAUNCH_ACTIVITY消息</li>
<li>主线程ActivityThread接收消息后,调用handleLaunchActivity,通过反射机制创建Activity实例后调用Activity.onCreate方法</li>
</ol>
<p>调用Activity.onCreate后便进入应用程序的生命周期,至此,成功启动应用程序</p>
<p><img src="/photos%5c15-StartActivity2.png"
	
	
	
	loading="lazy"
	
		alt="13-StartActivity2"
	
	
></p>
<p>以上流程的核心可总结为三个部分,后续将围绕这三部分展开:</p>
<ol>
<li>创建应用程序进程</li>
<li>创建Application</li>
<li>启动根Activity</li>
</ol>
<h2 id="创建应用程序进程简介">创建应用程序进程简介
</h2><p>要想启用一个Android应用程序,要保证该程序所需的应用程序进程存在.</p>
<p>当点击应用程序图标后,触发Launcher.onClick方法,经过一系列方法调用后,在ActivityStackSupervisor.startSpecificActivityLocked中会判断当前应用程序进程是否存在.</p>
<p>若不存在则调用AMS代理类ActivityManagerProxy的startProcessLocked请求AMS创建应用程序进程,AMS接收Launcher的请求后又向Zygote发送请求.</p>
<p>这一过程可分为两部分:</p>
<ul>
<li>AMS向Zygote发送启动应用程序进程的请求</li>
<li>Zygote接收AMS的请求并创建应用程序进程.</li>
</ul>
<p>AMS向Zygote发送启动应用程序进程的请求的流程如下:</p>
<p>Launcher请求AMS,AMS请求Zygote,通过ZygoteInit.main进入Zygote</p>
<p><img src="/photos%5c16-CreateAppProcess1.png"
	
	
	
	loading="lazy"
	
		alt="9-CreateAppProcess1"
	
	
></p>
<p>Zygote接收AMS的请求并创建应用程序进程的流程如下:</p>
<ol>
<li>
<p>在进行一系列处理后进入ZygoteConnection.handleChildProc,该函数内部配置子进程的初始环境后并调用ZygoteInit.zygoteInit初始化应用程序进程.</p>
</li>
<li>
<p>ZygoteInit.zygoteInit中调用ZygoteInit.nativeZygoteInit启动了应用程序进程的Binder线程池,使得进程可以进行Binder通讯,之后调用RuntimeInit.applicationInit.</p>
</li>
<li>
<p>RuntimeInit调用invokeStaticMain并抛出Zygote.MethodAndArgsCaller异常,经过异常处理清空设置过程中的堆栈帧后,调用主线程管理类ActivityThread的main方法,至此,应用程序进程被成功创建.</p>
</li>
</ol>
<p><img src="/photos%5c17-CreateAppProcess2.png"
	
	
	
	loading="lazy"
	
		alt="10-CreateAppProcess2"
	
	
></p>
<h2 id="创建application简介">创建Application简介
</h2><p>ActivityThread.main进行部分初始化配置后,创建并启动主线程消息循环管理类Looper用于进行消息处理,并且调用attach方法通知AMS附加自身ApplicationThread类.</p>
<p>AMS中通过ApplicationThread的代理类IApplicationThread发送BIND_APPLICATION消息到应用程序的消息队列.</p>
<p>之后应用程序主线程管理类ActivityThread的handleMessage处理该消息,并调用handleBindApplication创建Application并绑定,主要执行以下4个步骤:</p>
<ol>
<li>
<p>ActivityThread.getPackageInfoNoCheck</p>
<p>创建LoadedApk对象,设置ApplicationInfo和ClassLoader并加入mPackages中,该对象是应用程序apk包的管理类</p>
</li>
<li>
<p>ContextImpl.createAppContext</p>
<p>创建应用程序的上下文环境Context类</p>
</li>
<li>
<p>LoadedApk.makeApplication</p>
<p>创建Application,并调用Application.attachBaseContext方法</p>
</li>
<li>
<p>Instrumentation.callApplicationOnCreate</p>
<p>调用Application.onCreate方法</p>
</li>
</ol>
<p>至此,Application创建完成,以上流程如图所示:</p>
<p><img src="/photos%5c18-CreateApplication2.png"
	
	
	
	loading="lazy"
	
		alt="11-CreateApplication2"
	
	
></p>
<h2 id="启动根activity简介">启动根Activity简介
</h2><p>经过以上步骤后,创建了应用程序进程和对应的Application,回到Launcher请求AMS过程,在ActivityStackSupervisor.startSpecificActivityLocked中调用了ActivityStackSupervisor.realStartActivityLocked,其内部通过调用ApplicationThread.scheduleLaunchActivity通知应用程序启动Activity.</p>
<p>ApplicationThread通过sendMessage向H类(应用程序进程中主线程的消息管理类)发送H.LAUNCH_ACTIVITY消息,H.handleMessage接收到消息后调用ActivityThread.handleLaunchActivity将控制权转移给ActivityThread.</p>
<p>handleLaunchActivity调用performLaunchActivity执行启动Activity的步骤:</p>
<ol>
<li>
<p>获取Activity信息类ActivityInfo</p>
</li>
<li>
<p>获取Apk文件描述类LoadedApk</p>
</li>
<li>
<p>为Activity创建上下文环境</p>
</li>
<li>
<p>获取Activity完整类名并通过ClassLoader创建Activity实例</p>
</li>
<li>
<p>调用LoadedApk.makeApplication</p>
<p>这一步需要解释,Application类是Android的应用程序描述类,每个应用程序只有一个全局单例的Application.</p>
<p>此处调用makeApplication时,由于ActivityThread.main中已经创建Application,所以会直接返回已创建的Application.</p>
<p>而performLaunchActivity用于启动任意Activity,根Activity必定使用ActivityThread.main创建的Application,但其他Activity可能在子进程中运行,所以此处的调用主要用于处理一般Activity.</p>
</li>
<li>
<p>调用Activity.attach初始化Activity</p>
</li>
<li>
<p>调用Instrumentation.callActivityOnCreate启动Activity</p>
</li>
</ol>
<p>以上流程如图所示:</p>
<p><img src="/photos%5c19-StartActivity.png"
	
	
	
	loading="lazy"
	
		alt="12-StartActivity"
	
	
></p>
<p>经过以上步骤后,安卓应用程序正式启动（根Activity启动）,其中最值得关注的便是ActivityThread,Application和LoadedApk类.</p>
<ol>
<li>
<p>ActivityThread是安卓应用程序进程的主线程管理类</p>
<p>保存了很多关键信息,通过该类可以反射获取应用程序进程的Application和LoadedApk.</p>
</li>
<li>
<p>Application用于描述当前的应用程序</p>
<p>应用程序启动过程中,Application实例是最先创建的,早于应用程序启动以及任何Activity或Service,它的生命周期是整个应用程序中最长的,等于应用程序的生命周期.</p>
<p>安卓应用程序开发时,可通过继承该类并重写attachBaseContext和onCreate方法进行部分资源的初始化配置.如果被保护程序没有指定自定义的Application,使用系统创建的默认Application即可；如果存在自定义的Application,则脱壳程序需要替换.</p>
</li>
<li>
<p>LoadedApk用于描述当前应用程序对应的APK文件</p>
<p>其mClassLoader字段保存了当前APK对应的类加载器,mApplication字段保存了当前Application.</p>
</li>
</ol>
<h1 id="六-dex文件结构和代码抽取">六. Dex文件结构和代码抽取
</h1><p>关于Dex文件结构和解析器,由于篇幅限制此处不展开,可参考我的另一篇文章<a class="link" href="https://bbs.kanxue.com/thread-284995.htm"  target="_blank" rel="noopener"
    >Dex文件结构-ReadDex解析器实现</a></p>
<p>在解析功能的基础之上,添加代码抽取功能,支持抽取指定dex文件的所有方法代码,并输出classes.dex置空指令后的.patched文件和字节码.codes文件.</p>
<p>原理:</p>
<ol>
<li>DexClassDef结构定义了一个ART虚拟机中的Class对象,其classDataOff字段,指向DexClassData结构.</li>
<li>DexClassData结构保存了类的数据,字段和方法的数据由4个按顺序连续排列的字段和方法数组保存,DexClassDataHeader结构的header保存了4个数组结构的大小.值得注意的是DexClassData除header之外的成员不一定有效,只有当header中指定了对应结构体数组的大小才有效.</li>
<li>DexMethod.codeOff字段指向了DexCode结构,是代码抽取的关键结构,该结构的insnsSize和insns字段分别保存了指令码的个数和指令码数组.</li>
</ol>
<p><img src="/photos%5c20-DexClassDefToDexCode.png"
	
	
	
	loading="lazy"
	
		alt="16-DexClassDefToDexCode"
	
	
></p>
<p>代码抽取的步骤如下:</p>
<ol>
<li>遍历所有DexClassDef,通过classDataOff访问对应DexClassData结构.</li>
<li>对于每个DexClassData,解析header,确定DexField和DexMethod的大小,忽略DexField结构数组后解析DexMethod结构数组.</li>
<li>对于每个DexMethod结构,通过其codeOff字段访问DexCode的insnsSize和insns,执行代码抽取并将原始的insns内容设置为空指令NOP(字节码0x0000).</li>
</ol>
<p>对应ReadDex项目中的关键函数如下:</p>
<ol>
<li>
<p>extractAllClassDefCodes</p>
<p>功能: 抽取所有DexClassDef的代码.</p>
<p>逻辑: 遍历所有DexClassDef并过滤系统类,并解析对应DexClassData结构从而抽取代码.</p>
</li>
<li>
<p>extractClassDataCodes</p>
<p>功能: 抽取单个DexClassData的代码.</p>
<p>逻辑: 先通过readAndGetSizeUleb128读取获取DexClassDataHeader结构的staticFieldsSize,instanceFieldsSize,directMethodsSize和virtualMethodsSize.</p>
<p>再计算DexField数组占据的长度得到偏移值,最后访问DexMethod数组并进行代码抽取.</p>
</li>
<li>
<p>extractDexMethodArrayCodes</p>
<p>功能: 抽取DexMethod结构体数组的代码.</p>
<p>逻辑: 遍历DexMethod数组,对于每个DexMethod结构,通过DexFile基地址加codeOff得到DexCode的引用,之后根据insnsSize指定的大小抽取insns数组保存的指令字节码,每个DexCode抽取后保存为CodeItem并写入文件.自定义CodeItem结构用于后续代码回填时解析codes文件.</p>
<p>经过代码抽取后的Dex文件示意图如下:</p>
</li>
</ol>
<p><img src="/photos%5c21-Dex%e6%8a%bd%e5%8f%96%e4%bb%a3%e7%a0%81%e5%9b%be.png"
	
	
	
	loading="lazy"
	
		alt="26-Dex抽取代码图"
	
	
></p>
<p>详情可参考ReadDex项目,编译为ReadDex.exe后供加壳程序调用,通过-file参数指定dex文件路径,-extractAllCodes参数指定抽取所有代码.</p>
<h1 id="七-一代加固-整体加固落地加载">七. 一代加固-整体加固(落地加载)
</h1><p>一代加固是所有加固的基础,了解一代加固的基本思路有助于理解后续加固技术的演进</p>
<h2 id="原理">原理
</h2><p>主要涉及三个对象:</p>
<ol>
<li>待加固的源程序APK</li>
<li>（脱）壳程序APK 负责加载,解密和执行被保护的源程序</li>
<li>加壳程序 负责解析源程序并利用壳程序对其进行加固保护,将壳程序和源程序合并为新的程序</li>
</ol>
<p><img src="/photos%5c22-%e4%b8%80%e4%bb%a3%e5%8a%a0%e5%9b%ba%e5%a3%b3%e5%8e%9f%e7%90%86.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>加壳程序:</p>
<ol>
<li>
<p>解包壳程序和源程序</p>
<p>得到壳程序的dex以及源程序的AndroidManifest.xml和资源文件等</p>
</li>
<li>
<p>复制源程序解包后的文件到新apk临时目录（忽略部分文件）</p>
</li>
<li>
<p>处理源程序AndroidManifest.xml 写入新apk临时目录</p>
<p>判断是否存在application标签的name属性指定了自定义Application</p>
<p>若存在则添加meta-data标签保存原始application</p>
<p>无论是否存在都要指定name值为壳的Application</p>
</li>
<li>
<p>合并壳dex和源程序apk 写入新apk临时目录</p>
</li>
<li>
<p>重打包新的Apk</p>
</li>
<li>
<p>对新Apk签名</p>
</li>
<li>
<p>删除临时目录</p>
</li>
</ol>
<p>加壳后的壳Dex文件示意图如下</p>
<p><img src="/photos%5c23-%e5%8a%a0%e5%a3%b3%e5%90%8e%e7%9a%84%e7%a8%8b%e5%ba%8f%e7%a4%ba%e6%84%8f%e5%9b%be.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>最终新APK中包括以下内容:</p>
<ol>
<li>修改过的AndroidManifest.xml</li>
<li>由壳dex和源APK合并而来的classes.dex</li>
<li>源APK的所有其他资源文件（包括lib,assets,resources等）</li>
</ol>
<p>（脱）壳程序:</p>
<ol>
<li>在壳程序dex末尾追加源程序所有dex</li>
<li>在壳程序Application的attachBaseContext方法释放源程序所有dex并替换mClassLoader</li>
<li>在壳程序Application的onCreate方法注册源程序Application并开始生命周期</li>
</ol>
<h2 id="源程序">源程序
</h2><p>源程序即一般的用户程序,我们的主要目的是对源程序进行加固保护,所以需要注意源程序可能涉及到的技术点:</p>
<ul>
<li>
<p>源程序自定义Application</p>
<p>Application.attachBaseContext是app进程真正的入口点</p>
<p>如果源程序没有使用自定义Application,则可以直接复用壳程序Application</p>
<p>如果源程序有自定义Application,必定在AndroidManifest.xml文件中由**&lt;application android:name=&quot;&quot;&gt;**标签声明指定,可以替换属性值为壳application,同时添加meta-data标签保存源程序application</p>
</li>
<li>
<p>Native</p>
<p>源程序使用NDK开发时会生成lib文件夹和对应so文件,需要进行处理</p>
<p>主要是创建lib库的释放文件夹,提供给新的ClassLoader</p>
</li>
</ul>
<p>源程序主要包括以下文件:</p>
<ol>
<li>MainActivity.java</li>
<li>MyApplication.java</li>
<li>native-lib.cpp</li>
<li>AndroidManifest.xml</li>
<li>activity_main.xml</li>
</ol>
<p><strong>注意关闭Multidex支持,保证只编译出一个Dex文件</strong></p>
<h3 id="mainactivityjava">MainActivity.java
</h3><p>主要功能:</p>
<ol>
<li>Java层组件TextView</li>
<li>Native层JNI函数调用</li>
</ol>
<p>注意点:</p>
<ol>
<li>MainActivity继承自Activity类而非AppCompatActivity,这一步是为了方便资源处理</li>
<li>使用到了native函数,所以要处理lib文件</li>
<li>关闭MultiDex支持,只生成一个dex文件便于处理</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.nativedemo</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.app.Activity</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.os.Bundle</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.util.Log</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.widget.TextView</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MainActivity</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Activity</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">loadLibrary</span><span class="p">(</span><span class="s">&#34;nativedemo&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">native</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">stringFromJNI</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">native</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">native</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">sub</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onCreate</span><span class="p">(</span><span class="n">Bundle</span><span class="w"> </span><span class="n">savedInstanceState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">.</span><span class="na">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setContentView</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">layout</span><span class="p">.</span><span class="na">activity_main</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Example of a call to a native method</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">TextView</span><span class="w"> </span><span class="n">tv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">id</span><span class="p">.</span><span class="na">sample_text</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">result</span><span class="o">=</span><span class="n">stringFromJNI</span><span class="p">()</span><span class="o">+</span><span class="s">&#34; add(111,222)=&#34;</span><span class="o">+</span><span class="n">add</span><span class="p">(</span><span class="n">111</span><span class="p">,</span><span class="n">222</span><span class="p">)</span><span class="o">+</span><span class="s">&#34; sub(999,333)=&#34;</span><span class="o">+</span><span class="n">sub</span><span class="p">(</span><span class="n">999</span><span class="p">,</span><span class="n">333</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">tv</span><span class="p">.</span><span class="na">setText</span><span class="p">(</span><span class="n">result</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="s">&#34;glass&#34;</span><span class="p">,</span><span class="s">&#34;Run source MainActivity.onCreate &#34;</span><span class="o">+</span><span class="k">this</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="myapplicationjava">MyApplication.java
</h3><p>主要功能: log输出便于定位执行流程</p>
<p>注意:</p>
<ol>
<li>
<p>程序执行的顺序为Application.attachBaseContext-&gt;Application.onCreate-&gt;MainActivity.onCreate</p>
</li>
<li>
<p>该类主要用于模拟存在自定义Application的情况</p>
<p>如果源程序不存在自定义Application则使用默认的Application即可,否则需要解析源Application并进行创建和替换</p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.nativedemo</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.app.Application</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.content.Context</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.util.Log</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyApplication</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Application</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">attachBaseContext</span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="n">base</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">.</span><span class="na">attachBaseContext</span><span class="p">(</span><span class="n">base</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="s">&#34;glass&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;Run source MyApplication.attachBaseContext &#34;</span><span class="o">+</span><span class="k">this</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onCreate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">.</span><span class="na">onCreate</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="s">&#34;glass&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;Run source MyApplication.onCreate &#34;</span><span class="o">+</span><span class="k">this</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="native-libcpp">native-lib.cpp
</h3><p>定义了静态注册的方法stringFromJNI和动态注册的方法add,sub</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;jni.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// 静态注册
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">extern</span> <span class="s">&#34;C&#34;</span> <span class="n">JNIEXPORT</span> <span class="n">jstring</span> <span class="n">JNICALL</span>
</span></span><span class="line"><span class="cl"><span class="n">Java_com_example_nativedemo_MainActivity_stringFromJNI</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">jobject</span> <span class="cm">/* this */</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">hello</span> <span class="o">=</span> <span class="s">&#34;Hello from C++&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewStringUTF</span><span class="p">(</span><span class="n">hello</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//native函数对应的java方法所属类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ClassName</span><span class="o">=</span><span class="s">&#34;com/example/nativedemo/MainActivity&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">jint</span> <span class="nf">add</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span><span class="n">jobject</span> <span class="n">obj</span><span class="p">,</span><span class="n">jint</span> <span class="n">x</span><span class="p">,</span><span class="n">jint</span> <span class="n">y</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">jint</span> <span class="nf">sub</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span><span class="n">jobject</span> <span class="n">obj</span><span class="p">,</span><span class="n">jint</span> <span class="n">x</span><span class="p">,</span><span class="n">jint</span> <span class="n">y</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">x</span><span class="o">-</span><span class="n">y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//定义本地方法数组 建立映射关系
</span></span></span><span class="line"><span class="cl"><span class="c1">//JNINativeMethod结构体成员为函数名,函数签名,函数指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="n">JNINativeMethod</span> <span class="n">methods</span><span class="p">[]</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="s">&#34;add&#34;</span><span class="p">,</span><span class="s">&#34;(II)I&#34;</span><span class="p">,(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">add</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="s">&#34;sub&#34;</span><span class="p">,</span><span class="s">&#34;(II)I&#34;</span><span class="p">,(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">sub</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//编写加载注册方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">jint</span> <span class="nf">JNI_OnLoad</span><span class="p">(</span><span class="n">JavaVM</span><span class="o">*</span> <span class="n">vm</span><span class="p">,</span><span class="kt">void</span><span class="o">*</span> <span class="n">reserved</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="o">=</span><span class="k">nullptr</span><span class="p">;</span><span class="c1">//获取JNIEnv对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">vm</span><span class="o">-&gt;</span><span class="n">GetEnv</span><span class="p">((</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">env</span><span class="p">,</span><span class="n">JNI_VERSION_1_6</span><span class="p">)</span><span class="o">!=</span><span class="n">JNI_OK</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//获取对应java方法所属的类对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">jclass</span> <span class="n">clazz</span><span class="o">=</span><span class="n">env</span><span class="o">-&gt;</span><span class="n">FindClass</span><span class="p">(</span><span class="n">ClassName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//调用RegisterNatives注册方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">clazz</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">env</span><span class="o">-&gt;</span><span class="n">RegisterNatives</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span><span class="n">methods</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">methods</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">methods</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">JNI_VERSION_1_6</span><span class="p">;</span><span class="c1">//注意必须返回JNI版本
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="androidmanifestxml">AndroidManifest.xml
</h3><p>主要功能:</p>
<ol>
<li>指定根activity为MainActivity</li>
<li>指定android:name为MyApplication</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;manifest</span> <span class="na">xmlns:android=</span><span class="s">&#34;http://schemas.android.com/apk/res/android&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="na">xmlns:tools=</span><span class="s">&#34;http://schemas.android.com/tools&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;application</span>
</span></span><span class="line"><span class="cl">        <span class="na">android:allowBackup=</span><span class="s">&#34;true&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="na">android:dataExtractionRules=</span><span class="s">&#34;@xml/data_extraction_rules&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="na">android:fullBackupContent=</span><span class="s">&#34;@xml/backup_rules&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="na">android:icon=</span><span class="s">&#34;@mipmap/ic_launcher&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="na">android:label=</span><span class="s">&#34;@string/app_name&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="na">android:roundIcon=</span><span class="s">&#34;@mipmap/ic_launcher_round&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="na">android:supportsRtl=</span><span class="s">&#34;true&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="na">android:theme=</span><span class="s">&#34;@style/Theme.NativeDemo&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="na">tools:targetApi=</span><span class="s">&#34;29&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="na">android:name=</span><span class="s">&#34;.MyApplication&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;activity</span>
</span></span><span class="line"><span class="cl">            <span class="na">android:name=</span><span class="s">&#34;.MainActivity&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="na">android:exported=</span><span class="s">&#34;true&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;intent-filter&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">&#34;android.intent.action.MAIN&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;category</span> <span class="na">android:name=</span><span class="s">&#34;android.intent.category.LAUNCHER&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;/intent-filter&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/activity&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/application&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/manifest&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="activity_mainxml">activity_main.xml
</h3><p>LinearLayout</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">&#34;http://schemas.android.com/apk/res/android&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="na">xmlns:app=</span><span class="s">&#34;http://schemas.android.com/apk/res-auto&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="na">xmlns:tools=</span><span class="s">&#34;http://schemas.android.com/tools&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="na">android:layout_width=</span><span class="s">&#34;match_parent&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="na">android:layout_height=</span><span class="s">&#34;match_parent&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="na">android:gravity=</span><span class="s">&#34;center&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="na">tools:context=</span><span class="s">&#34;com.example.nativedemo.MainActivity&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;TextView</span>
</span></span><span class="line"><span class="cl">        <span class="na">android:id=</span><span class="s">&#34;@+id/sample_text&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="na">android:layout_width=</span><span class="s">&#34;wrap_content&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="na">android:layout_height=</span><span class="s">&#34;wrap_content&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="na">android:text=</span><span class="s">&#34;Hello World!&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="na">android:textAlignment=</span><span class="s">&#34;center&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/LinearLayout&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="加壳程序">加壳程序
</h2><p>加壳程序主要需要完成以下工作:</p>
<ol>
<li>
<p>解包壳程序和源程序</p>
<p>得到壳程序的dex以及源程序的AndroidManifest.xml和资源文件等</p>
</li>
<li>
<p>复制源程序解包后的文件到新apk临时目录（忽略部分文件）</p>
</li>
<li>
<p>处理源程序AndroidManifest.xml 写入新apk临时目录</p>
<p>判断是否存在application标签的name属性指定了自定义Application</p>
<p>若存在则添加meta-data标签保存原始application</p>
<p>无论是否存在都要指定name值为壳的Application</p>
</li>
<li>
<p>合并壳dex和源程序apk 写入新apk临时目录</p>
</li>
<li>
<p>重打包新的Apk</p>
</li>
<li>
<p>对新Apk签名</p>
</li>
<li>
<p>删除临时目录</p>
</li>
</ol>
<p>FirstShell.py代码如下</p>
<ol>
<li>
<p>封装Paths类,保存全局使用到的路径 主要是apk路径和临时目录</p>
</li>
<li>
<p>封装Apktool类,通过apktool提供apk解包和打包功能,通过uber-apk-signer提供apk签名功能</p>
</li>
<li>
<p>封装ManifeseEditor类,提供ManifestEditor解析功能,支持获取和修改标签属性,添加新标签</p>
</li>
<li>
<p>combineShellDexAndSrcApk 合并壳dex和源apk</p>
<p>将原apk加密后填充到壳dex后方,并添加4字节标识apk大小</p>
<p>新dex=壳dex+加密后的源APK+源APK大小</p>
</li>
<li>
<p>handleManifest 处理AndroidManifest</p>
<p>分别提取源apk和壳的manifest文件,以源manifest为基准</p>
<p>根据源apk是否指定自定义application确定是否添加meta-data标签保存</p>
<p>最后修改application:name为壳application</p>
</li>
<li>
<p>start 完整的处理函数</p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">zlib</span> <span class="kn">import</span> <span class="n">adler32</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha1</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">binascii</span> <span class="kn">import</span> <span class="n">unhexlify</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">subprocess</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">shutil</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">argparse</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 封装path类,保存全局用到的路径</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Paths</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">srcApk</span><span class="p">:</span><span class="n">Path</span><span class="p">,</span> <span class="n">shellApk</span><span class="p">:</span><span class="n">Path</span><span class="p">,</span> <span class="n">outputApk</span><span class="p">:</span><span class="n">Path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Apk file paths</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">srcApkPath</span><span class="o">=</span> <span class="n">srcApk</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span> <span class="c1"># 解析为绝对路径</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">shellApkPath</span><span class="o">=</span> <span class="n">shellApk</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">newApkPath</span><span class="o">=</span> <span class="n">outputApk</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Temp directories default python file path</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">/</span><span class="s1">&#39;temp&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">srcApkTempDir</span><span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="o">/</span> <span class="s1">&#39;srcApkTemp&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">shellApkTempDir</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="o">/</span><span class="s1">&#39;shellApkTemp&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">newApkTempDir</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="o">/</span> <span class="s1">&#39;newApkTemp&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Apktool类 提供解包,打包,签名功能</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Apktool</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">apktool_path</span><span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">/</span><span class="s1">&#39;tools/apktool/apktool.bat&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">signer_path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">/</span><span class="s1">&#39;tools/uber-apk-signer-1.3.0.jar&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">signApk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">unsignedApkPath</span><span class="p">:</span><span class="n">Path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">runCommand</span><span class="p">([</span><span class="s1">&#39;java&#39;</span><span class="p">,</span><span class="s1">&#39;-jar&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">signer_path</span><span class="p">,</span> <span class="s1">&#39;--apk&#39;</span><span class="p">,</span><span class="n">unsignedApkPath</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 使用apktool解包apk 只解包资源不解包dex</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">extractApk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">apkPath</span><span class="p">:</span><span class="n">Path</span><span class="p">,</span> <span class="n">outputDir</span><span class="p">:</span><span class="n">Path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">runCommand</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">apktool_path</span><span class="p">,</span> <span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span> <span class="p">,</span> <span class="n">apkPath</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">outputDir</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 重打包apk</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">repackApk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">inputDir</span><span class="p">:</span><span class="n">Path</span><span class="p">,</span> <span class="n">outApk</span><span class="p">:</span><span class="n">Path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">runCommand</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">apktool_path</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span> <span class="p">,</span> <span class="n">inputDir</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">outApk</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">runCommand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">args</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">)</span> <span class="c1">#仅调用工具,不需要输出,重定向stdout到os.devnull</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 参数列表 捕获输出 输出转为字符串</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#print(subprocess.run(args,  capture_output=True,text=True).stdout)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># AndroidManifest.xml的editor 用于获取和修改标签属性,以及添加标签</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ManifestEditor</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml_content</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">ns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;android&#39;</span><span class="p">:</span> <span class="s1">&#39;http://schemas.android.com/apk/res/android&#39;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">xml_content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 获取指定标签的android属性值 examples: get_attr(&#39;application&#39;, &#39;name&#39;) get_attr(&#39;activity&#39;, &#39;name&#39;)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">getTagAttribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">tag_name</span> <span class="o">==</span> <span class="s1">&#39;manifest&#39;</span><span class="p">:</span>  <span class="c1"># 根标签特殊处理</span>
</span></span><span class="line"><span class="cl">            <span class="n">elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">elem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">elem</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attr_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># 寻找标签的属性</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;.//</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">elem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">elem</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">[</span><span class="s2">&#34;android&#34;</span><span class="p">]</span><span class="si">}</span><span class="se">}}</span><span class="si">{</span><span class="n">attr_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># 根标签之外的属性位于android命名空间下</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 设置指定标签的属性值 example:set_attr(&#39;application&#39;,&#39;name&#39;,&#34;com.example.ProxyApplication&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">setTagAttribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_value</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">tag_name</span> <span class="o">==</span> <span class="s1">&#39;manifest&#39;</span><span class="p">:</span>  <span class="c1"># 根标签特殊处理</span>
</span></span><span class="line"><span class="cl">            <span class="n">elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">elem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">elem</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attr_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">new_value</span><span class="p">)</span>  <span class="c1"># 设置属性值</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;.//</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">elem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">elem</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">[</span><span class="s2">&#34;android&#34;</span><span class="p">]</span><span class="si">}</span><span class="se">}}</span><span class="si">{</span><span class="n">attr_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">new_value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 在指定父标签下添加新子标签 example: add_tag(&#39;application&#39;,&#34;meta-data&#34;,{&#39;name&#39;: &#39;android.permission.CAMERA&#39;,&#39;value&#39;:&#39;hello&#39;})</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">addTagWithAttributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">attrs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">parent_tag</span> <span class="o">==</span> <span class="s1">&#39;manifest&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">new_elem</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">new_tag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  <span class="c1"># 支持一次给添加的标签设置多个属性</span>
</span></span><span class="line"><span class="cl">                    <span class="n">new_elem</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;.//</span><span class="si">{</span><span class="n">parent_tag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">new_elem</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">new_tag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                    <span class="n">new_elem</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">[</span><span class="s2">&#34;android&#34;</span><span class="p">]</span><span class="si">}</span><span class="se">}}</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 不以壳manifest为基准操作则用不到该函数,以源apk的manifest为基准自带,无需额外设置</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">getMainActivity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">activities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.//activity&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">activity</span> <span class="ow">in</span> <span class="n">activities</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">intent_filters</span> <span class="o">=</span> <span class="n">activity</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.//intent-filter&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">intent_filter</span> <span class="ow">in</span> <span class="n">intent_filters</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">action</span> <span class="o">=</span> <span class="n">intent_filter</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//action[@android:name=&#34;android.intent.action.MAIN&#34;]&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">category</span> <span class="o">=</span> <span class="n">intent_filter</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//category[@android:name=&#34;android.intent.category.LAUNCHER&#34;]&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                              <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">category</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="n">activity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">[</span><span class="s2">&#34;android&#34;</span><span class="p">]</span><span class="si">}</span><span class="se">}}</span><span class="s1">name&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">getApplication</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTagAttribute</span><span class="p">(</span><span class="s1">&#39;application&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">setApplication</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">application</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">setTagAttribute</span><span class="p">(</span><span class="s1">&#39;application&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">application</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">addMetaData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">addTagWithAttributes</span><span class="p">(</span><span class="s1">&#39;application&#39;</span><span class="p">,</span> <span class="s1">&#39;meta-data&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">getManifestData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;返回XML字符串&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="p">,</span> <span class="n">pretty_print</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">xml_declaration</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 合并壳dex和源apk</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">combineShellDexAndSrcApk</span><span class="p">(</span><span class="n">sourceApkPath</span><span class="p">:</span><span class="n">Path</span><span class="p">,</span> <span class="n">shellApkTempDir</span><span class="p">:</span><span class="n">Path</span><span class="p">,</span> <span class="n">newApkTempDir</span><span class="p">:</span><span class="n">Path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">fixCheckSum</span><span class="p">(</span><span class="n">dexBytesArray</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># dexfile[8:12]</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 小端存储</span>
</span></span><span class="line"><span class="cl">        <span class="n">value</span> <span class="o">=</span> <span class="n">adler32</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">dexBytesArray</span><span class="p">[</span><span class="mi">12</span><span class="p">:]))</span>
</span></span><span class="line"><span class="cl">        <span class="n">valueArray</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">valueArray</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="n">dexBytesArray</span><span class="p">[</span><span class="mi">8</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">valueArray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">fixSignature</span><span class="p">(</span><span class="n">dexBytesArray</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># dexfile[12:32]</span>
</span></span><span class="line"><span class="cl">        <span class="n">sha_1</span> <span class="o">=</span> <span class="n">sha1</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">sha_1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">dexBytesArray</span><span class="p">[</span><span class="mi">32</span><span class="p">:]))</span>
</span></span><span class="line"><span class="cl">        <span class="n">value</span> <span class="o">=</span> <span class="n">sha_1</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">valueArray</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">valueArray</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="n">dexBytesArray</span><span class="p">[</span><span class="mi">12</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">valueArray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">fixFileSize</span><span class="p">(</span><span class="n">dexBytesArray</span><span class="p">,</span> <span class="n">fileSize</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># dexfile[32:36]</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 小端存储</span>
</span></span><span class="line"><span class="cl">        <span class="n">fileSizeArray</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">fileSize</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s2">&#34;little&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fileSizeArray</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="n">dexBytesArray</span><span class="p">[</span><span class="mi">32</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fileSizeArray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">encrypto</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">file</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="n">file</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^=</span> <span class="mh">0xff</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">file</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 获取源apk</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sourceApkPath</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">SourceApkArray</span><span class="o">=</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 获取shelldex</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">shellApkTempDir</span><span class="o">/</span><span class="s1">&#39;classes.dex&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">shellDexArray</span><span class="o">=</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">SourceApkLen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">SourceApkArray</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">shellDexLen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellDexArray</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 新的dex文件长度</span>
</span></span><span class="line"><span class="cl">    <span class="n">newDexLen</span> <span class="o">=</span> <span class="n">shellDexLen</span> <span class="o">+</span> <span class="n">SourceApkLen</span> <span class="o">+</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 加密源文件</span>
</span></span><span class="line"><span class="cl">    <span class="n">enApkArray</span> <span class="o">=</span> <span class="n">encrypto</span><span class="p">(</span><span class="n">SourceApkArray</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 新的dex文件内容 = 壳dex + 加密的源apk + 四字节标识加密后源apk大小长度</span>
</span></span><span class="line"><span class="cl">    <span class="n">newDexArray</span> <span class="o">=</span> <span class="n">shellDexArray</span> <span class="o">+</span> <span class="n">enApkArray</span> <span class="o">+</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">SourceApkLen</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 修改filesize</span>
</span></span><span class="line"><span class="cl">    <span class="n">fixFileSize</span><span class="p">(</span><span class="n">newDexArray</span><span class="p">,</span> <span class="n">newDexLen</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 修改signature</span>
</span></span><span class="line"><span class="cl">    <span class="n">fixSignature</span><span class="p">(</span><span class="n">newDexArray</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 修改checksum</span>
</span></span><span class="line"><span class="cl">    <span class="n">fixCheckSum</span><span class="p">(</span><span class="n">newDexArray</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 导出文件</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">newApkTempDir</span><span class="o">/</span><span class="s1">&#39;classes.dex&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">newDexArray</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 提取源apk的Manifest文件,修改application为壳application(可能添加meta-data标签),输出新的Manifest文件</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">handleManifest</span><span class="p">(</span> <span class="n">srcApkTempDir</span><span class="p">:</span><span class="n">Path</span><span class="p">,</span><span class="n">shellApkTempDir</span><span class="p">:</span><span class="n">Path</span><span class="p">,</span><span class="n">newApkTempDir</span><span class="p">:</span><span class="n">Path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 从源apk提取AndroidManifest.xml</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">srcApkTempDir</span><span class="o">/</span><span class="s1">&#39;AndroidManifest.xml&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">srcManifestEditor</span><span class="o">=</span><span class="n">ManifestEditor</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">srcApplication</span><span class="o">=</span><span class="n">srcManifestEditor</span><span class="o">.</span><span class="n">getApplication</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 从壳apk提取AndroidManifest.xml</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">shellApkTempDir</span><span class="o">/</span><span class="s1">&#39;AndroidManifest.xml&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">shellManifestEditor</span><span class="o">=</span><span class="n">ManifestEditor</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ShellApplication:&#39;</span><span class="p">,</span><span class="n">shellManifestEditor</span><span class="o">.</span><span class="n">getApplication</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 修改源AndroidManifest.xml的application为壳的代理application</span>
</span></span><span class="line"><span class="cl">    <span class="n">srcManifestEditor</span><span class="o">.</span><span class="n">setApplication</span><span class="p">(</span><span class="n">shellManifestEditor</span><span class="o">.</span><span class="n">getApplication</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 写入meta-data标签 保存源apk的原始application</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">srcApplication</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Source application:&#39;</span><span class="p">,</span><span class="n">srcApplication</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">srcManifestEditor</span><span class="o">.</span><span class="n">addMetaData</span><span class="p">(</span><span class="s1">&#39;APPLICATION_CLASS_NAME&#39;</span><span class="p">,</span><span class="n">srcApplication</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 输出新的AndroidManifest.xml</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">newApkTempDir</span><span class="o">/</span><span class="s1">&#39;AndroidManifest.xml&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">srcManifestEditor</span><span class="o">.</span><span class="n">getManifestData</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">paths</span><span class="p">:</span><span class="n">Paths</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">apktool</span><span class="o">=</span><span class="n">Apktool</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 1.分别解包源文件和壳文件到临时目录</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Extracting source and shell apk...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">apktool</span><span class="o">.</span><span class="n">extractApk</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">srcApkPath</span><span class="p">,</span><span class="n">paths</span><span class="o">.</span><span class="n">srcApkTempDir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Extract source apk success!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Extracting shell apk...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">apktool</span><span class="o">.</span><span class="n">extractApk</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">shellApkPath</span><span class="p">,</span><span class="n">paths</span><span class="o">.</span><span class="n">shellApkTempDir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Extract shell apk success!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 2.复制源apk所有文件到新apk临时目录中</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Copying source apk files to new apk temp dir...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">srcApkTempDir</span><span class="p">,</span><span class="n">paths</span><span class="o">.</span><span class="n">newApkTempDir</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Copy source apk files success!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 3.处理AndroidManifest.xml</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Handling AndroidManifest.xml...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">handleManifest</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">srcApkTempDir</span><span class="p">,</span><span class="n">paths</span><span class="o">.</span><span class="n">shellApkTempDir</span><span class="p">,</span><span class="n">paths</span><span class="o">.</span><span class="n">newApkTempDir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Handle AndroidManifest.xml success!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 4.合并壳dex和源apk并导出文件</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Combining shell dex and source apk...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">combineShellDexAndSrcApk</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">srcApkPath</span><span class="p">,</span><span class="n">paths</span><span class="o">.</span><span class="n">shellApkTempDir</span><span class="p">,</span><span class="n">paths</span><span class="o">.</span><span class="n">newApkTempDir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Combine shell dex and source apk success!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 5.重打包apk</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Repacking apk...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">apktool</span><span class="o">.</span><span class="n">repackApk</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">newApkTempDir</span><span class="p">,</span><span class="n">paths</span><span class="o">.</span><span class="n">newApkPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Repack apk success!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 6.签名apk</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Signing apk...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">apktool</span><span class="o">.</span><span class="n">signApk</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">newApkPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Resign apk success!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 7.删除临时目录</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Deleting temp directories...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">)</span> <span class="c1"># 删除临时目录</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Delete temp directories success!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&#34;Android APK Packer&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-src&#39;</span><span class="p">,</span><span class="s1">&#39;--src-apk&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to source APK file&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-shell&#39;</span><span class="p">,</span><span class="s1">&#39;--shell-apk&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to shell APK file&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-o&#39;</span><span class="p">,</span><span class="s1">&#39;-out&#39;</span><span class="p">,</span><span class="s1">&#39;--output-apk&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Output path for packed APK (Default: ./out/&lt;src-apk&gt;_protected.apk)&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">output_apk</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">args</span><span class="o">.</span><span class="n">output_apk</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;./out&#39;</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">src_apk</span><span class="o">.</span><span class="n">stem</span><span class="o">+</span><span class="s1">&#39;_protected.apk&#39;</span><span class="p">)</span> <span class="c1"># 默认新apk名称及输出路径</span>
</span></span><span class="line"><span class="cl">    <span class="n">paths</span> <span class="o">=</span> <span class="n">Paths</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">src_apk</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">shell_apk</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">output_apk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Source APK:&#39;</span><span class="p">,</span> <span class="n">paths</span><span class="o">.</span><span class="n">srcApkPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Shell APK:&#39;</span><span class="p">,</span> <span class="n">paths</span><span class="o">.</span><span class="n">shellApkPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Output APK:&#39;</span><span class="p">,</span> <span class="n">paths</span><span class="o">.</span><span class="n">newApkPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">start</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="脱壳程序">脱壳程序
</h2><h3 id="firstproxyapplicationjava">FirstProxyApplication.java
</h3><p>注意关闭Multidex支持,保证只生成一个Dex文件</p>
<p>attachBaseContext中执行以下操作</p>
<ol>
<li>
<p>创建私有目录,用于保存释放的dex,lib,源apk</p>
</li>
<li>
<p>调用readDexFromApk,从壳apk中提取壳dex文件,保存为字节数组</p>
</li>
<li>
<p>调用extractSrcApkFromShellDex 从壳dex文件提取源程序apk文件 解包lib文件到lib私有目录</p>
</li>
<li>
<p>调用replaceClassLoader替换壳程序的ClassLoader</p>
<p>新的ClassLoader指定了源apk dex文件,lib文件,odex路径 也就是前面释放的源apk和源lib</p>
</li>
</ol>
<p>onCreate调用了replaceApplication</p>
<ol>
<li>
<p>判断manifest文件是否通过meta-data标签保存了源apk的application</p>
<p>如果源apk未指定application则使用默认的application（即壳applicaiton）</p>
</li>
<li>
<p>如果源apk指定了自定义application则创建对应实例,替换掉壳的application,之后调用onCreate方法</p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.androidshell</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.app.Application</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.app.Instrumentation</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.content.Context</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.content.pm.ApplicationInfo</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.content.pm.PackageManager</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.os.Bundle</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.util.ArrayMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.util.Log</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.BufferedInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ByteArrayOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.File</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.ref.WeakReference</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.nio.ByteBuffer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.nio.ByteOrder</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.ArrayList</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Iterator</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.zip.ZipEntry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.zip.ZipInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">dalvik.system.DexClassLoader</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">FirstProxyApplication</span><span class="w"> </span><span class="kd">extends</span><span class="w">  </span><span class="n">Application</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">TAG</span><span class="o">=</span><span class="s">&#34;glass&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">apkPath</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">dexPath</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">libPath</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="p">){</span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="n">message</span><span class="p">);}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">attachBaseContext</span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="n">base</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">.</span><span class="na">attachBaseContext</span><span class="p">(</span><span class="n">base</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;FirstProxyApplication.attachBaseContext() running!&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//1.创建私有目录,保存dex,lib和源apk 具体路径为data/user/0/&lt;package_name&gt;/app_tmp_dex</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">File</span><span class="w"> </span><span class="n">dex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getDir</span><span class="p">(</span><span class="s">&#34;tmp_dex&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">MODE_PRIVATE</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">File</span><span class="w"> </span><span class="n">lib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getDir</span><span class="p">(</span><span class="s">&#34;tmp_lib&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">MODE_PRIVATE</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">dexPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dex</span><span class="p">.</span><span class="na">getAbsolutePath</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">libPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lib</span><span class="p">.</span><span class="na">getAbsolutePath</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">apkPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dex</span><span class="p">.</span><span class="na">getAbsolutePath</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">File</span><span class="p">.</span><span class="na">separator</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;Source.apk&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;dexPath: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dexPath</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;libPath: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">libPath</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;apkPath: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">apkPath</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 根据文件路径创建File对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">File</span><span class="w"> </span><span class="n">apkFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">apkPath</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 只有首次运行时需要创建相关文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">apkFile</span><span class="p">.</span><span class="na">exists</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// 根据路径创建文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">apkFile</span><span class="p">.</span><span class="na">createNewFile</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">//读取Classes.dex文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">shellDexData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readDexFromApk</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">//从中分离出源apk文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">extractSrcApkFromShellDex</span><span class="p">(</span><span class="n">shellDexData</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//配置加载源程序的动态环境,即替换mClassLoader</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">replaceClassLoader</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">getStackTraceString</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 从当前程序的apk读取dex文件并存储为字节数组</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="nf">readDexFromApk</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//1.获取当前应用程序的源码路径(apk),一般是data/app目录下,该目录用于存放用户安装的软件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">sourceDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">getApplicationInfo</span><span class="p">().</span><span class="na">sourceDir</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;this.getApplicationInfo().sourceDir: &#34;</span><span class="w"> </span><span class="o">+</span><span class="n">sourceDir</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//2.创建相关输入流</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileInputStream</span><span class="w"> </span><span class="n">fileInputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileInputStream</span><span class="p">(</span><span class="n">sourceDir</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">BufferedInputStream</span><span class="w"> </span><span class="n">bufferedInputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BufferedInputStream</span><span class="p">(</span><span class="n">fileInputStream</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ZipInputStream</span><span class="w"> </span><span class="n">zipInputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ZipInputStream</span><span class="p">(</span><span class="n">bufferedInputStream</span><span class="p">);</span><span class="w"> </span><span class="c1">//用于解析apk文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ByteArrayOutputStream</span><span class="w"> </span><span class="n">byteArrayOutputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ByteArrayOutputStream</span><span class="p">();</span><span class="w"> </span><span class="c1">//用于存放dex文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//3.遍历apk的所有文件并提取dex文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ZipEntry</span><span class="w"> </span><span class="n">zipEntry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">while</span><span class="p">((</span><span class="n">zipEntry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zipInputStream</span><span class="p">.</span><span class="na">getNextEntry</span><span class="p">())</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">){</span><span class="w"> </span><span class="c1">//存在下一个文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 将classes.dex文件存储到bytearray中 壳dex和源apk合并后只保留一个dex便于处理</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">zipEntry</span><span class="p">.</span><span class="na">getName</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="s">&#34;classes.dex&#34;</span><span class="p">)){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="n">1024</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">num</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">while</span><span class="p">((</span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zipInputStream</span><span class="p">.</span><span class="na">read</span><span class="p">(</span><span class="n">bytes</span><span class="p">))</span><span class="o">!=-</span><span class="n">1</span><span class="p">){</span><span class="w">      </span><span class="c1">//每次读取1024byte,返回读取到的byte数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">byteArrayOutputStream</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">num</span><span class="p">);</span><span class="w"> </span><span class="c1">//存放到开辟的byteArrayOutputStream中</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">zipInputStream</span><span class="p">.</span><span class="na">closeEntry</span><span class="p">();</span><span class="w"> </span><span class="c1">//关闭当前文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">zipInputStream</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Read dex from apk succeed!&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">byteArrayOutputStream</span><span class="p">.</span><span class="na">toByteArray</span><span class="p">();</span><span class="w"> </span><span class="c1">//将读取到的dex文件以字节数组形式返回</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 从壳dex文件中提取源apk并解析</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">extractSrcApkFromShellDex</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">shellDexData</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">shellDexLen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shellDexData</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//开始解析dex文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//1.读取源apk的大小</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">srcApkSizeBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="n">4</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">arraycopy</span><span class="p">(</span><span class="n">shellDexData</span><span class="p">,</span><span class="w"> </span><span class="n">shellDexLen</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">4</span><span class="p">,</span><span class="w"> </span><span class="n">srcApkSizeBytes</span><span class="p">,</span><span class="n">0</span><span class="p">,</span><span class="n">4</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">srcApkSize</span><span class="w"> </span><span class="o">=</span><span class="n">ByteBuffer</span><span class="p">.</span><span class="na">wrap</span><span class="p">(</span><span class="n">srcApkSizeBytes</span><span class="p">).</span><span class="na">order</span><span class="p">(</span><span class="n">ByteOrder</span><span class="p">.</span><span class="na">LITTLE_ENDIAN</span><span class="p">).</span><span class="na">getInt</span><span class="p">();</span><span class="c1">//转成bytebuffer,方便4 bytes转int 将bytes转成int,加壳时,长度按小端存储</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//2.读取源apk</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">sourceApkData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="n">srcApkSize</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">arraycopy</span><span class="p">(</span><span class="n">shellDexData</span><span class="p">,</span><span class="w"> </span><span class="n">shellDexLen</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">srcApkSize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">4</span><span class="p">,</span><span class="w"> </span><span class="n">sourceApkData</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">srcApkSize</span><span class="p">);</span><span class="c1">//注意减4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//3.解密源apk</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">sourceApkData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decrypt</span><span class="p">(</span><span class="n">sourceApkData</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//写入新建的apk文件中</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">File</span><span class="w"> </span><span class="n">apkfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">apkPath</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">apkfileOutputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="n">apkfile</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">apkfileOutputStream</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">sourceApkData</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">apkfileOutputStream</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IOException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//分析源apk,取出so文件放入libPath目录中</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileInputStream</span><span class="w"> </span><span class="n">fileInputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileInputStream</span><span class="p">(</span><span class="n">apkfile</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">BufferedInputStream</span><span class="w"> </span><span class="n">bufferedInputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BufferedInputStream</span><span class="p">(</span><span class="n">fileInputStream</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ZipInputStream</span><span class="w"> </span><span class="n">zipInputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ZipInputStream</span><span class="p">(</span><span class="n">bufferedInputStream</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ZipEntry</span><span class="w"> </span><span class="n">nextEntry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">nextEntry</span><span class="o">=</span><span class="n">zipInputStream</span><span class="p">.</span><span class="na">getNextEntry</span><span class="p">())</span><span class="o">!=</span><span class="kc">null</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nextEntry</span><span class="p">.</span><span class="na">getName</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="na">startsWith</span><span class="p">(</span><span class="s">&#34;lib/&#34;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">.</span><span class="na">endsWith</span><span class="p">(</span><span class="s">&#34;.so&#34;</span><span class="p">)){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">//获取文件名并创建相应文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">nameSplit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">String</span><span class="w"> </span><span class="n">soFileStorePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">libPath</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">File</span><span class="p">.</span><span class="na">separator</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nameSplit</span><span class="o">[</span><span class="n">nameSplit</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">1</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">File</span><span class="w"> </span><span class="n">storeFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">soFileStorePath</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">storeFile</span><span class="p">.</span><span class="na">createNewFile</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">//读数据到相应so文件中</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">fileOutputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="n">storeFile</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="n">1024</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">num</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">while</span><span class="p">((</span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zipInputStream</span><span class="p">.</span><span class="na">read</span><span class="p">(</span><span class="n">bytes</span><span class="p">))</span><span class="o">!=-</span><span class="n">1</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">fileOutputStream</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span><span class="n">0</span><span class="p">,</span><span class="n">num</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">fileOutputStream</span><span class="p">.</span><span class="na">flush</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">fileOutputStream</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">zipInputStream</span><span class="p">.</span><span class="na">closeEntry</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">zipInputStream</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 解密函数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="nf">decrypt</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">data</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="n">0xff</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">data</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 替换壳App的ClassLoader为源App的ClassLoader</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">replaceClassLoader</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//1.获取当前的classloader</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">classLoader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">getClassLoader</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Current ClassLoader: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">classLoader</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Parent ClassLoader: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">classLoader</span><span class="p">.</span><span class="na">getParent</span><span class="p">().</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//2.反射获取ActivityThread</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">sCurrentActivityThreadObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">getStaticField</span><span class="p">(</span><span class="s">&#34;android.app.ActivityThread&#34;</span><span class="p">,</span><span class="s">&#34;sCurrentActivityThread&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;ActivityThread.sCurrentActivity: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sCurrentActivityThreadObj</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//3.反射获取LoadedApk</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//获取当前ActivityThread实例的mPackages字段 类型为ArrayMap&lt;String, WeakReference&lt;LoadedApk&gt;&gt;, 里面存放了当前应用的LoadedApk对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ArrayMap</span><span class="w"> </span><span class="n">mPackagesObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ArrayMap</span><span class="p">)</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">getField</span><span class="p">(</span><span class="s">&#34;android.app.ActivityThread&#34;</span><span class="p">,</span><span class="n">sCurrentActivityThreadObj</span><span class="p">,</span><span class="s">&#34;mPackages&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="w"> </span><span class="s">&#34;mPackagesObj: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mPackagesObj</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//获取mPackages中的当前应用包名</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">currentPackageName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">getPackageName</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;currentPackageName: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">currentPackageName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 获取loadedApk实例也有好几种,mInitialApplication mAllApplications mPackages</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 通过包名获取当前应用的loadedApk实例</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">WeakReference</span><span class="w"> </span><span class="n">weakReference</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">WeakReference</span><span class="p">)</span><span class="w"> </span><span class="n">mPackagesObj</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">currentPackageName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">loadedApkObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">weakReference</span><span class="p">.</span><span class="na">get</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="w"> </span><span class="s">&#34;LoadedApk: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">loadedApkObj</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//4.替换ClassLoader</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">DexClassLoader</span><span class="w"> </span><span class="n">dexClassLoader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DexClassLoader</span><span class="p">(</span><span class="n">apkPath</span><span class="p">,</span><span class="n">dexPath</span><span class="p">,</span><span class="n">libPath</span><span class="p">,</span><span class="w"> </span><span class="n">classLoader</span><span class="p">.</span><span class="na">getParent</span><span class="p">());</span><span class="w"> </span><span class="c1">//动态加载源程序的dex文件,以当前classloader的父加载器作为parent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reflection</span><span class="p">.</span><span class="na">setField</span><span class="p">(</span><span class="s">&#34;android.app.LoadedApk&#34;</span><span class="p">,</span><span class="s">&#34;mClassLoader&#34;</span><span class="p">,</span><span class="n">loadedApkObj</span><span class="p">,</span><span class="n">dexClassLoader</span><span class="p">);</span><span class="w"> </span><span class="c1">//替换当前loadedApk实例中的mClassLoader字段</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;New DexClassLoader: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dexClassLoader</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//替换壳程序LoadedApk的Application为源程序Application,并调用其onCreate方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">replaceApplication</span><span class="p">(){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Application实例存在于: LoadedApk.mApplication</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 以及ActivityThread的mInitialApplication和mAllApplications和mBoundApplication</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//判断源程序是否使用自定义Application 若使用则需要进行替换,若未使用则直接返回,使用壳的默认Application即可</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">appClassName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"> </span><span class="c1">//源程序的Application类名</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//获取AndroidManifest.xml 文件中的 &lt;meta-data&gt; 元素</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ApplicationInfo</span><span class="w"> </span><span class="n">applicationInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getPackageManager</span><span class="p">().</span><span class="na">getApplicationInfo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">getPackageName</span><span class="p">(),</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">GET_META_DATA</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Bundle</span><span class="w"> </span><span class="n">metaData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applicationInfo</span><span class="p">.</span><span class="na">metaData</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//获取xml文件声明的Application类</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">metaData</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">metaData</span><span class="p">.</span><span class="na">containsKey</span><span class="p">(</span><span class="s">&#34;APPLICATION_CLASS_NAME&#34;</span><span class="p">)){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">appClassName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metaData</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&#34;APPLICATION_CLASS_NAME&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;源程序中没有自定义Application&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="c1">//如果不存在直接返回,使用壳的application即可</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">PackageManager</span><span class="p">.</span><span class="na">NameNotFoundException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">(</span><span class="n">Log</span><span class="p">.</span><span class="na">getStackTraceString</span><span class="p">(</span><span class="n">e</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//源程序存在自定义application类,开始替换</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Try to replace Application&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//1.反射获取ActivityThread实例</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">sCurrentActivityThreadObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">getStaticField</span><span class="p">(</span><span class="s">&#34;android.app.ActivityThread&#34;</span><span class="p">,</span><span class="s">&#34;sCurrentActivityThread&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;ActivityThread: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sCurrentActivityThreadObj</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//2.获取并设置LoadedApk</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//获取mBoundApplication (AppBindData对象)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">mBoundApplicationObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">getField</span><span class="p">(</span><span class="s">&#34;android.app.ActivityThread&#34;</span><span class="p">,</span><span class="n">sCurrentActivityThreadObj</span><span class="p">,</span><span class="s">&#34;mBoundApplication&#34;</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;mBoundApplication: &#34;</span><span class="o">+</span><span class="n">mBoundApplicationObj</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//获取mBoundApplication.info (即LoadedApk)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">infoObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">getField</span><span class="p">(</span><span class="s">&#34;android.app.ActivityThread$AppBindData&#34;</span><span class="p">,</span><span class="n">mBoundApplicationObj</span><span class="p">,</span><span class="s">&#34;info&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="w"> </span><span class="s">&#34;LoadedApk: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">infoObj</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//把LoadedApk的mApplication设置为null,这样后续才能调用makeApplication() 否则由于已存在Application,无法进行替换</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reflection</span><span class="p">.</span><span class="na">setField</span><span class="p">(</span><span class="s">&#34;android.app.LoadedApk&#34;</span><span class="p">,</span><span class="s">&#34;mApplication&#34;</span><span class="p">,</span><span class="n">infoObj</span><span class="p">,</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//3.获取ActivityThread.mInitialApplication 即拿到旧的Application(对于要加载的Application来讲)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">mInitialApplicationObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">getField</span><span class="p">(</span><span class="s">&#34;android.app.ActivityThread&#34;</span><span class="p">,</span><span class="n">sCurrentActivityThreadObj</span><span class="p">,</span><span class="s">&#34;mInitialApplication&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;mInitialApplicationObj: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mInitialApplicationObj</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//4.获取ActivityThread.mAllApplications并删除旧的application</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Application</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mAllApplicationsObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Application</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">getField</span><span class="p">(</span><span class="s">&#34;android.app.ActivityThread&#34;</span><span class="p">,</span><span class="n">sCurrentActivityThreadObj</span><span class="p">,</span><span class="s">&#34;mAllApplications&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">mAllApplicationsObj</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">mInitialApplicationObj</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;mInitialApplication 从 mAllApplications 中移除成功&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//5.重置相关类的Application类名 便于后续创建Application</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//获取LoadedApk.mApplicationInfo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ApplicationInfo</span><span class="w"> </span><span class="n">applicationInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ApplicationInfo</span><span class="p">)</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">getField</span><span class="p">(</span><span class="s">&#34;android.app.LoadedApk&#34;</span><span class="p">,</span><span class="n">infoObj</span><span class="p">,</span><span class="s">&#34;mApplicationInfo&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="w"> </span><span class="s">&#34;LoadedApk.mApplicationInfo: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">applicationInfo</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//获取mBoundApplication.appInfo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ApplicationInfo</span><span class="w"> </span><span class="n">appinfoInAppBindData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ApplicationInfo</span><span class="p">)</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">getField</span><span class="p">(</span><span class="s">&#34;android.app.ActivityThread$AppBindData&#34;</span><span class="p">,</span><span class="n">mBoundApplicationObj</span><span class="p">,</span><span class="s">&#34;appInfo&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;ActivityThread.mBoundApplication.appInfo: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">appinfoInAppBindData</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//此处通过引用修改值,虽然后续没有使用,但是实际上是修改其指向的LoadedApk相关字段的值</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//设置两个appinfo的classname为源程序的application类名,以便后续调用makeApplication()创建源程序的application</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">applicationInfo</span><span class="p">.</span><span class="na">className</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">appClassName</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">appinfoInAppBindData</span><span class="p">.</span><span class="na">className</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">appClassName</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Source Application name: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">appClassName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//6.反射调用makeApplication方法创建源程序的application</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Application</span><span class="w"> </span><span class="n">application</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Application</span><span class="p">)</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">invokeMethod</span><span class="p">(</span><span class="s">&#34;android.app.LoadedApk&#34;</span><span class="p">,</span><span class="s">&#34;makeApplication&#34;</span><span class="p">,</span><span class="n">infoObj</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="kt">boolean</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Instrumentation</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="kc">false</span><span class="p">,</span><span class="kc">null</span><span class="p">});</span><span class="w"> </span><span class="c1">//使用源程序中的application</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//Application app = (Application)ReflectionMethods.invokeMethod(&#34;android.app.LoadedApk&#34;,&#34;makeApplication&#34;,infoObj,new Class[]{boolean.class, Instrumentation.class},new Object[]{true,null}); //使用自定义的application 强制为系统默认</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Create source Application succeed: &#34;</span><span class="o">+</span><span class="n">application</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//7.重置ActivityThread.mInitialApplication为新的Application</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reflection</span><span class="p">.</span><span class="na">setField</span><span class="p">(</span><span class="s">&#34;android.app.ActivityThread&#34;</span><span class="p">,</span><span class="s">&#34;mInitialApplication&#34;</span><span class="p">,</span><span class="n">sCurrentActivityThreadObj</span><span class="p">,</span><span class="n">application</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Reset ActivityThread.mInitialApplication by new Application succeed!&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//8.ContentProvider会持有代理的Application,需要特殊处理一下</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ArrayMap</span><span class="w"> </span><span class="n">mProviderMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ArrayMap</span><span class="p">)</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">getField</span><span class="p">(</span><span class="s">&#34;android.app.ActivityThread&#34;</span><span class="p">,</span><span class="n">sCurrentActivityThreadObj</span><span class="p">,</span><span class="s">&#34;mProviderMap&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;ActivityThread.mProviderMap: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mProviderMap</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//获取所有provider,装进迭代器中遍历</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Iterator</span><span class="w"> </span><span class="n">iterator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mProviderMap</span><span class="p">.</span><span class="na">values</span><span class="p">().</span><span class="na">iterator</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">while</span><span class="p">(</span><span class="n">iterator</span><span class="p">.</span><span class="na">hasNext</span><span class="p">()){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Object</span><span class="w"> </span><span class="n">providerClientRecord</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iterator</span><span class="p">.</span><span class="na">next</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//获取ProviderClientRecord.mLocalProvider,可能为空</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Object</span><span class="w"> </span><span class="n">mLocalProvider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">getField</span><span class="p">(</span><span class="s">&#34;android.app.ActivityThread$ProviderClientRecord&#34;</span><span class="p">,</span><span class="n">providerClientRecord</span><span class="p">,</span><span class="s">&#34;mLocalProvider&#34;</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">mLocalProvider</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;ProviderClientRecord.mLocalProvider: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mLocalProvider</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">//获取ContentProvider中的mContext字段,设置为新的Application</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Reflection</span><span class="p">.</span><span class="na">setField</span><span class="p">(</span><span class="s">&#34;android.content.ContentProvider&#34;</span><span class="p">,</span><span class="s">&#34;mContext&#34;</span><span class="p">,</span><span class="n">mLocalProvider</span><span class="p">,</span><span class="n">application</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="w"> </span><span class="s">&#34;Run Application.onCreate&#34;</span><span class="w"> </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">application</span><span class="p">.</span><span class="na">onCreate</span><span class="p">();</span><span class="w"> </span><span class="c1">//源程序,启动!</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onCreate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">.</span><span class="na">onCreate</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;ProxyApplication.onCreate() is running!&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">replaceApplication</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Replace application succeed!&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="reflectionjava">Reflection.java
</h3><p>封装的反射类,用于获取/设置指定类的成员变量,调用指定类的方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.androidshell</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.util.Log</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Field</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Method</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Reflection</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">TAG</span><span class="o">=</span><span class="s">&#34;glass&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">invokeStaticMethod</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">class_name</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">method_name</span><span class="p">,</span><span class="n">Class</span><span class="o">&lt;?&gt;[]</span><span class="w"> </span><span class="n">parameterTypes</span><span class="p">,</span><span class="n">Object</span><span class="o">[]</span><span class="w"> </span><span class="n">parameterValues</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="n">class_name</span><span class="p">);</span><span class="w"> </span><span class="c1">//反射获取Class类对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Method</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">getMethod</span><span class="p">(</span><span class="n">method_name</span><span class="p">,</span><span class="n">parameterTypes</span><span class="p">);</span><span class="c1">//反射获取方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">method</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="c1">//突破权限访问控制</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">method</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="n">parameterValues</span><span class="p">);</span><span class="c1">//反射调用,静态方法无需指定所属实例,直接传参即可</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">invokeMethod</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">class_name</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">method_name</span><span class="p">,</span><span class="n">Object</span><span class="w"> </span><span class="n">obj</span><span class="p">,</span><span class="n">Class</span><span class="o">&lt;?&gt;[]</span><span class="w"> </span><span class="n">parameterTypes</span><span class="p">,</span><span class="n">Object</span><span class="o">[]</span><span class="w"> </span><span class="n">parameterValues</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="n">class_name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Method</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">getMethod</span><span class="p">(</span><span class="n">method_name</span><span class="p">,</span><span class="n">parameterTypes</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">method</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="c1">//突破权限访问控制</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">method</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">parameterValues</span><span class="p">);</span><span class="c1">// 反射调用,动态方法需要指定所属实例</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">getField</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">class_name</span><span class="p">,</span><span class="n">Object</span><span class="w"> </span><span class="n">obj</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">field_name</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="n">class_name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Field</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="n">field_name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">field</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span><span class="w">  </span><span class="c1">//获取实例字段,需要指定实例对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">getStaticField</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">class_name</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">field_name</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="n">class_name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Field</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="n">field_name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">field</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setField</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">class_name</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">field_name</span><span class="p">,</span><span class="n">Object</span><span class="w"> </span><span class="n">obj</span><span class="p">,</span><span class="n">Object</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="n">class_name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Field</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="n">field_name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setStaticField</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">class_name</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">field_name</span><span class="p">,</span><span class="n">Object</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="n">class_name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Field</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="n">field_name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="androidmanifestxml-1">AndroidManifest.xml
</h3><p>通过name属性指定application</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;manifest</span> <span class="na">xmlns:android=</span><span class="s">&#34;http://schemas.android.com/apk/res/android&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="na">xmlns:tools=</span><span class="s">&#34;http://schemas.android.com/tools&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;application</span>
</span></span><span class="line"><span class="cl">        <span class="na">android:allowBackup=</span><span class="s">&#34;true&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="na">android:dataExtractionRules=</span><span class="s">&#34;@xml/data_extraction_rules&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="na">android:fullBackupContent=</span><span class="s">&#34;@xml/backup_rules&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="na">android:icon=</span><span class="s">&#34;@mipmap/ic_launcher&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="na">android:label=</span><span class="s">&#34;@string/app_name&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="na">android:roundIcon=</span><span class="s">&#34;@mipmap/ic_launcher_round&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="na">android:supportsRtl=</span><span class="s">&#34;true&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="na">android:theme=</span><span class="s">&#34;@style/Theme.AndroidShell&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="na">tools:targetApi=</span><span class="s">&#34;29&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="na">android:name=</span><span class="s">&#34;com.example.androidshell.FirstProxyApplication&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/application&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/manifest&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="总结">总结
</h2><p>整体加固-落地加载的核心思路是将源程序apk和壳dex进行合并,运行时动态解密并执行相关环境处理操作重新执行源apk的代码</p>
<p>优点: 易于实现</p>
<p>缺点: 由于文件落地释放,所以非常容易在文件系统中获取到源程序apk；两次加载源程序apk到内存,效率低</p>
<h1 id="八-二代加固-整体加固不落地加载">八. 二代加固-整体加固(不落地加载)
</h1><h2 id="原理-1">原理
</h2><p>针对落地加载的部分问题,引申出了不落地加载的思路: 即直接加载内存中的dex字节码,避免释放文件</p>
<p>如何在内存中加载dex？Android 8及以上系统中,可以使用系统提供的InMemoryDexClassLoader实现内存加载,Android7及以下则需要手动实现</p>
<p>另外需要针对第一代加固不支持Multidex进行优化:</p>
<p>源apk每个dex文件前添加4字节标识其大小,之后全部合并成一个文件再合并到壳dex,最后添加4字节标识文件总大小</p>
<p>结构如下</p>
<p><img src="/photos%5c24-Dex%e5%90%88%e5%b9%b6%e5%9b%be.png"
	
	
	
	loading="lazy"
	
		alt="23-Dex合并图"
	
	
></p>
<h2 id="源程序-1">源程序
</h2><p>同一代加固,可开启Multidex支持,其他部分不变</p>
<h2 id="加壳程序-1">加壳程序
</h2><p>主要改动如下:</p>
<ol>
<li>
<p>调用combineShellAndSourceDexs合并壳dex和源dex</p>
<p>内部调用readAndCombineDexs读取并合并源apk的多个dex为一个文件</p>
</li>
<li>
<p>复制源apk文件时忽略Manifest和dex文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">srcApkTempDir</span><span class="p">,</span><span class="n">paths</span><span class="o">.</span><span class="n">newApkTempDir</span><span class="p">,</span><span class="n">ignore</span><span class="o">=</span><span class="n">shutil</span><span class="o">.</span><span class="n">ignore_patterns</span><span class="p">(</span><span class="s1">&#39;AndroidManifest.xml&#39;</span><span class="p">,</span><span class="s1">&#39;classes*.dex&#39;</span><span class="p">))</span> 
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>ManifeseEditor</p>
<p>添加getEtractNativeLibs,获取application标签的android:extractNativeLibs属性值</p>
<p>添加resetExtractNativeLibs,重置extractNativeLibs=true 强制释放lib文件</p>
</li>
<li>
<p>handleManifest</p>
<p>判断源程序Manifest是否设置了android:extractNativeLibs=&ldquo;true&rdquo;,若为false(默认)则改为true</p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">zlib</span> <span class="kn">import</span> <span class="n">adler32</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha1</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">binascii</span> <span class="kn">import</span> <span class="n">unhexlify</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">subprocess</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">shutil</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">argparse</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 封装path类,保存全局用到的路径</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Paths</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">srcApk</span><span class="p">:</span><span class="n">Path</span><span class="p">,</span> <span class="n">shellApk</span><span class="p">:</span><span class="n">Path</span><span class="p">,</span> <span class="n">outputApk</span><span class="p">:</span><span class="n">Path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Apk file paths</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">srcApkPath</span><span class="o">=</span> <span class="n">srcApk</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span> <span class="c1"># 解析为绝对路径</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">shellApkPath</span><span class="o">=</span> <span class="n">shellApk</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">newApkPath</span><span class="o">=</span> <span class="n">outputApk</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Temp directories default python file path</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">/</span><span class="s1">&#39;temp&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">srcApkTempDir</span><span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="o">/</span> <span class="s1">&#39;srcApkTemp&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">shellApkTempDir</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="o">/</span><span class="s1">&#39;shellApkTemp&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">newApkTempDir</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="o">/</span> <span class="s1">&#39;newApkTemp&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Apktool类 提供解包,打包,签名功能</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Apktool</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">apktool_path</span><span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">/</span><span class="s1">&#39;tools/apktool/apktool.bat&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">signer_path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">/</span><span class="s1">&#39;tools/uber-apk-signer-1.3.0.jar&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">signApk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">unsignedApkPath</span><span class="p">:</span><span class="n">Path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">runCommand</span><span class="p">([</span><span class="s1">&#39;java&#39;</span><span class="p">,</span><span class="s1">&#39;-jar&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">signer_path</span><span class="p">,</span> <span class="s1">&#39;--apk&#39;</span><span class="p">,</span><span class="n">unsignedApkPath</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 使用apktool解包apk 只解包资源不解包dex</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">extractApk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">apkPath</span><span class="p">:</span><span class="n">Path</span><span class="p">,</span> <span class="n">outputDir</span><span class="p">:</span><span class="n">Path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">runCommand</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">apktool_path</span><span class="p">,</span> <span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span> <span class="p">,</span> <span class="n">apkPath</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">outputDir</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 重打包apk</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">repackApk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">inputDir</span><span class="p">:</span><span class="n">Path</span><span class="p">,</span> <span class="n">outApk</span><span class="p">:</span><span class="n">Path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">runCommand</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">apktool_path</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span> <span class="p">,</span> <span class="n">inputDir</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">outApk</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">runCommand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">args</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">)</span> <span class="c1">#仅调用工具,不需要输出,重定向stdout到os.devnull</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 参数列表 捕获输出 输出转为字符串</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#print(subprocess.run(args,  capture_output=True,text=True).stdout)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># AndroidManifest.xml的editor 用于获取和修改标签属性,以及添加标签</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ManifestEditor</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml_content</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">ns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;android&#39;</span><span class="p">:</span> <span class="s1">&#39;http://schemas.android.com/apk/res/android&#39;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">xml_content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 获取指定标签的android属性值 examples: get_attr(&#39;application&#39;, &#39;name&#39;) get_attr(&#39;activity&#39;, &#39;name&#39;)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">getTagAttribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">tag_name</span> <span class="o">==</span> <span class="s1">&#39;manifest&#39;</span><span class="p">:</span>  <span class="c1"># 根标签特殊处理</span>
</span></span><span class="line"><span class="cl">            <span class="n">elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">elem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">elem</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attr_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># 寻找标签的属性</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;.//</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">elem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">elem</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">[</span><span class="s2">&#34;android&#34;</span><span class="p">]</span><span class="si">}</span><span class="se">}}</span><span class="si">{</span><span class="n">attr_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># 根标签之外的属性位于android命名空间下</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 设置指定标签的属性值 example:set_attr(&#39;application&#39;,&#39;name&#39;,&#34;com.example.ProxyApplication&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">setTagAttribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_value</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">tag_name</span> <span class="o">==</span> <span class="s1">&#39;manifest&#39;</span><span class="p">:</span>  <span class="c1"># 根标签特殊处理</span>
</span></span><span class="line"><span class="cl">            <span class="n">elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">elem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">elem</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attr_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">new_value</span><span class="p">)</span>  <span class="c1"># 设置属性值</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;.//</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">elem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">elem</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">[</span><span class="s2">&#34;android&#34;</span><span class="p">]</span><span class="si">}</span><span class="se">}}</span><span class="si">{</span><span class="n">attr_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">new_value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 在指定父标签下添加新子标签 example: add_tag(&#39;application&#39;,&#34;meta-data&#34;,{&#39;name&#39;: &#39;android.permission.CAMERA&#39;,&#39;value&#39;:&#39;hello&#39;})</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">addTagWithAttributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">attrs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">parent_tag</span> <span class="o">==</span> <span class="s1">&#39;manifest&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">new_elem</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">new_tag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  <span class="c1"># 支持一次给添加的标签设置多个属性</span>
</span></span><span class="line"><span class="cl">                    <span class="n">new_elem</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;.//</span><span class="si">{</span><span class="n">parent_tag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">new_elem</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">new_tag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                    <span class="n">new_elem</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">[</span><span class="s2">&#34;android&#34;</span><span class="p">]</span><span class="si">}</span><span class="se">}}</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 不以壳manifest为基准操作则用不到该函数,以源apk的manifest为基准自带,无需额外设置</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">getMainActivity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">activities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.//activity&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">activity</span> <span class="ow">in</span> <span class="n">activities</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">intent_filters</span> <span class="o">=</span> <span class="n">activity</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.//intent-filter&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">intent_filter</span> <span class="ow">in</span> <span class="n">intent_filters</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">action</span> <span class="o">=</span> <span class="n">intent_filter</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//action[@android:name=&#34;android.intent.action.MAIN&#34;]&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">category</span> <span class="o">=</span> <span class="n">intent_filter</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//category[@android:name=&#34;android.intent.category.LAUNCHER&#34;]&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                              <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">category</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="n">activity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">[</span><span class="s2">&#34;android&#34;</span><span class="p">]</span><span class="si">}</span><span class="se">}}</span><span class="s1">name&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">getApplication</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTagAttribute</span><span class="p">(</span><span class="s1">&#39;application&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">setApplication</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">application</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">setTagAttribute</span><span class="p">(</span><span class="s1">&#39;application&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">application</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">addMetaData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">addTagWithAttributes</span><span class="p">(</span><span class="s1">&#39;application&#39;</span><span class="p">,</span> <span class="s1">&#39;meta-data&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">getManifestData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;返回XML字符串&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="p">,</span> <span class="n">pretty_print</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">xml_declaration</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">getEtractNativeLibs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;返回是否释放so文件&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTagAttribute</span><span class="p">(</span><span class="s1">&#39;application&#39;</span><span class="p">,</span> <span class="s1">&#39;extractNativeLibs&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">resetExtractNativeLibs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;重置etractNativeLibs属性为true&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">setTagAttribute</span><span class="p">(</span><span class="s1">&#39;application&#39;</span><span class="p">,</span> <span class="s1">&#39;extractNativeLibs&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 合并壳dex和源apk的dex</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">combineShellAndSourceDexs</span><span class="p">(</span><span class="n">shellApkTempDir</span><span class="p">:</span><span class="n">Path</span><span class="p">,</span><span class="n">srcApkTempDir</span><span class="p">:</span><span class="n">Path</span><span class="p">,</span><span class="n">newApkTempDir</span><span class="p">:</span><span class="n">Path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">fixCheckSum</span><span class="p">(</span><span class="n">dexBytesArray</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># dexfile[8:12]</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 小端存储</span>
</span></span><span class="line"><span class="cl">        <span class="n">value</span> <span class="o">=</span> <span class="n">adler32</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">dexBytesArray</span><span class="p">[</span><span class="mi">12</span><span class="p">:]))</span>
</span></span><span class="line"><span class="cl">        <span class="n">valueArray</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">valueArray</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="n">dexBytesArray</span><span class="p">[</span><span class="mi">8</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">valueArray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">fixSignature</span><span class="p">(</span><span class="n">dexBytesArray</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># dexfile[12:32]</span>
</span></span><span class="line"><span class="cl">        <span class="n">sha_1</span> <span class="o">=</span> <span class="n">sha1</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">sha_1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">dexBytesArray</span><span class="p">[</span><span class="mi">32</span><span class="p">:]))</span>
</span></span><span class="line"><span class="cl">        <span class="n">value</span> <span class="o">=</span> <span class="n">sha_1</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">valueArray</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">valueArray</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="n">dexBytesArray</span><span class="p">[</span><span class="mi">12</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">valueArray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">fixFileSize</span><span class="p">(</span><span class="n">dexBytesArray</span><span class="p">,</span> <span class="n">fileSize</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># dexfile[32:36]</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 小端存储</span>
</span></span><span class="line"><span class="cl">        <span class="n">fileSizeArray</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">fileSize</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s2">&#34;little&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fileSizeArray</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="n">dexBytesArray</span><span class="p">[</span><span class="mi">32</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fileSizeArray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">encrypto</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">file</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="n">file</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^=</span> <span class="mh">0xff</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">file</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">readAndCombineDexs</span><span class="p">(</span><span class="n">unpackedApkDir</span><span class="p">:</span><span class="n">Path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 读取解包后的apk的所有dex文件,并合并为一个dex文件</span>
</span></span><span class="line"><span class="cl">        <span class="n">combinedDex</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">         <span class="c1"># glob方法返回包含所有匹配文件的生成器</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">dex</span> <span class="ow">in</span> <span class="n">unpackedApkDir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;classes*.dex&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Source Apk Dex file:&#39;</span><span class="p">,</span> <span class="n">dex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dex</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                <span class="n">combinedDex</span><span class="o">+=</span><span class="nb">bytearray</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">))</span>  <span class="c1"># dex文件的长度,小端序</span>
</span></span><span class="line"><span class="cl">                <span class="n">combinedDex</span><span class="o">+=</span><span class="n">data</span> <span class="c1"># dex文件内容</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">combinedDex</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 获取shelldex</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">shellApkTempDir</span><span class="o">/</span><span class="s1">&#39;classes.dex&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">shellDexArray</span><span class="o">=</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 获取源apk的dex文件</span>
</span></span><span class="line"><span class="cl">    <span class="n">srcDexArray</span> <span class="o">=</span> <span class="n">readAndCombineDexs</span><span class="p">(</span><span class="n">srcApkTempDir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 新的dex文件长度</span>
</span></span><span class="line"><span class="cl">    <span class="n">newDexLen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">srcDexArray</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellDexArray</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 加密源文件</span>
</span></span><span class="line"><span class="cl">    <span class="n">encSrcDexArray</span> <span class="o">=</span> <span class="n">encrypto</span><span class="p">(</span><span class="n">srcDexArray</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 新的dex文件内容 = 壳dex + 加密的源dex + 四字节标识加密后源dex大小长度</span>
</span></span><span class="line"><span class="cl">    <span class="n">newDexArray</span> <span class="o">=</span> <span class="n">shellDexArray</span> <span class="o">+</span> <span class="n">encSrcDexArray</span>  <span class="o">+</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">encSrcDexArray</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 修改filesize</span>
</span></span><span class="line"><span class="cl">    <span class="n">fixFileSize</span><span class="p">(</span><span class="n">newDexArray</span><span class="p">,</span> <span class="n">newDexLen</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 修改signature</span>
</span></span><span class="line"><span class="cl">    <span class="n">fixSignature</span><span class="p">(</span><span class="n">newDexArray</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 修改checksum</span>
</span></span><span class="line"><span class="cl">    <span class="n">fixCheckSum</span><span class="p">(</span><span class="n">newDexArray</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 导出文件</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">newApkTempDir</span><span class="o">/</span><span class="s1">&#39;classes.dex&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">newDexArray</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 提取源apk的Manifest文件,修改application为壳application(可能添加meta-data标签),输出新的Manifest文件</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">handleManifest</span><span class="p">(</span> <span class="n">srcApkTempDir</span><span class="p">:</span><span class="n">Path</span><span class="p">,</span><span class="n">shellApkTempDir</span><span class="p">:</span><span class="n">Path</span><span class="p">,</span><span class="n">newApkTempDir</span><span class="p">:</span><span class="n">Path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 从源apk提取AndroidManifest.xml</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">srcApkTempDir</span><span class="o">/</span><span class="s1">&#39;AndroidManifest.xml&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">srcManifestEditor</span><span class="o">=</span><span class="n">ManifestEditor</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">srcApplication</span><span class="o">=</span><span class="n">srcManifestEditor</span><span class="o">.</span><span class="n">getApplication</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">srcExtractNativeLibs</span><span class="o">=</span><span class="n">srcManifestEditor</span><span class="o">.</span><span class="n">getEtractNativeLibs</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SourceApplication:&#39;</span><span class="p">,</span><span class="n">srcApplication</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SourceExtractNativeLibs:&#39;</span><span class="p">,</span><span class="n">srcExtractNativeLibs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 从壳apk提取AndroidManifest.xml</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">shellApkTempDir</span><span class="o">/</span><span class="s1">&#39;AndroidManifest.xml&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">shellManifestEditor</span><span class="o">=</span><span class="n">ManifestEditor</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ShellApplication:&#39;</span><span class="p">,</span><span class="n">shellManifestEditor</span><span class="o">.</span><span class="n">getApplication</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 修改源AndroidManifest.xml的application为壳的代理application</span>
</span></span><span class="line"><span class="cl">    <span class="n">srcManifestEditor</span><span class="o">.</span><span class="n">setApplication</span><span class="p">(</span><span class="n">shellManifestEditor</span><span class="o">.</span><span class="n">getApplication</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 写入meta-data标签 保存源apk的原始application</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">srcApplication</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Source application:&#39;</span><span class="p">,</span><span class="n">srcApplication</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">srcManifestEditor</span><span class="o">.</span><span class="n">addMetaData</span><span class="p">(</span><span class="s1">&#39;APPLICATION_CLASS_NAME&#39;</span><span class="p">,</span><span class="n">srcApplication</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 如果源apk的manifest中默认设置etractNativeLibs=false,则重置为true,确保释放lib文件</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">srcExtractNativeLibs</span><span class="o">==</span><span class="s1">&#39;false&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">srcManifestEditor</span><span class="o">.</span><span class="n">resetExtractNativeLibs</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 输出新的AndroidManifest.xml</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">newApkTempDir</span><span class="o">/</span><span class="s1">&#39;AndroidManifest.xml&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">srcManifestEditor</span><span class="o">.</span><span class="n">getManifestData</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">paths</span><span class="p">:</span><span class="n">Paths</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">apktool</span><span class="o">=</span><span class="n">Apktool</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 1.分别解包源文件和壳文件到临时目录</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Extracting source and shell apk...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">apktool</span><span class="o">.</span><span class="n">extractApk</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">srcApkPath</span><span class="p">,</span><span class="n">paths</span><span class="o">.</span><span class="n">srcApkTempDir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Extract source apk success!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Extracting shell apk...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">apktool</span><span class="o">.</span><span class="n">extractApk</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">shellApkPath</span><span class="p">,</span><span class="n">paths</span><span class="o">.</span><span class="n">shellApkTempDir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Extract shell apk success!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 2.复制源apk所有文件到新apk临时目录中,忽略源dex和manifest文件</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Copying source apk files to new apk temp dir...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">srcApkTempDir</span><span class="p">,</span><span class="n">paths</span><span class="o">.</span><span class="n">newApkTempDir</span><span class="p">,</span><span class="n">ignore</span><span class="o">=</span><span class="n">shutil</span><span class="o">.</span><span class="n">ignore_patterns</span><span class="p">(</span><span class="s1">&#39;AndroidManifest.xml&#39;</span><span class="p">,</span><span class="s1">&#39;classes*.dex&#39;</span><span class="p">))</span> 
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Copy source apk files success!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 3.处理AndroidManifest.xml</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Handling AndroidManifest.xml...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">handleManifest</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">srcApkTempDir</span><span class="p">,</span><span class="n">paths</span><span class="o">.</span><span class="n">shellApkTempDir</span><span class="p">,</span><span class="n">paths</span><span class="o">.</span><span class="n">newApkTempDir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Handle AndroidManifest.xml success!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 4.合并壳dex和源apk并导出文件</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Combining shell dex and source dexs...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">combineShellAndSourceDexs</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">shellApkTempDir</span><span class="p">,</span><span class="n">paths</span><span class="o">.</span><span class="n">srcApkTempDir</span><span class="p">,</span><span class="n">paths</span><span class="o">.</span><span class="n">newApkTempDir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Combine shell dex and source dexs success!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 5.重打包apk</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Repacking apk...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">apktool</span><span class="o">.</span><span class="n">repackApk</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">newApkTempDir</span><span class="p">,</span><span class="n">paths</span><span class="o">.</span><span class="n">newApkPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Repack apk success!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 6.签名apk</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Signing apk...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">apktool</span><span class="o">.</span><span class="n">signApk</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">newApkPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Resign apk success!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 7.删除临时目录</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Deleting temp directories...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">)</span> <span class="c1"># 删除临时目录</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Delete temp directories success!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&#34;Android APK Packer&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-src&#39;</span><span class="p">,</span><span class="s1">&#39;--src-apk&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to source APK file&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-shell&#39;</span><span class="p">,</span><span class="s1">&#39;--shell-apk&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to shell APK file&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-o&#39;</span><span class="p">,</span><span class="s1">&#39;-out&#39;</span><span class="p">,</span><span class="s1">&#39;--output-apk&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Output path for packed APK (Default: ./out/&lt;src-apk&gt;_protected.apk)&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">output_apk</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">args</span><span class="o">.</span><span class="n">output_apk</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;./out&#39;</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">src_apk</span><span class="o">.</span><span class="n">stem</span><span class="o">+</span><span class="s1">&#39;_protected.apk&#39;</span><span class="p">)</span> <span class="c1"># 默认新apk名称及输出路径</span>
</span></span><span class="line"><span class="cl">    <span class="n">paths</span> <span class="o">=</span> <span class="n">Paths</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">src_apk</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">shell_apk</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">output_apk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Source APK:&#39;</span><span class="p">,</span> <span class="n">paths</span><span class="o">.</span><span class="n">srcApkPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Shell APK:&#39;</span><span class="p">,</span> <span class="n">paths</span><span class="o">.</span><span class="n">shellApkPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Output APK:&#39;</span><span class="p">,</span> <span class="n">paths</span><span class="o">.</span><span class="n">newApkPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">start</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="脱壳程序-1">脱壳程序
</h2><p>SecondProxyApplication.java相比FirstProxyApplication.java改动如下:</p>
<ol>
<li>
<p>attachBaseContext</p>
<p>读取壳dex文件后,提取源程序dex文件,之后替换ClassLoader</p>
<p>没有设置私有目录和释放文件等操作</p>
</li>
<li>
<p>extractDexFilesFromShellDex</p>
<p>替代splitSourceApkFromShellDex,从壳dex提取源程序dex文件并存储为ByteBuffer[]</p>
</li>
<li>
<p>replaceClassLoader</p>
<p>一代加固使用DexClassLoader从文件加载,二代加固使用InMemoryDexClassLoader</p>
</li>
</ol>
<p>注意:</p>
<ul>
<li>
<p>在Android 8.0以下不支持InMemoryDexClassLoader,需要手动实现</p>
</li>
<li>
<p>在Android 10.0以下不支持InMemoryDexClassLoader指定lib目录的重载</p>
<p>默认搜索路径为nativeLibraryDirectories=[/system/lib64, /product/lib64]]]</p>
<p>可参考以下文章修复lib目录的问题</p>
<p><a class="link" href="https://blog.csdn.net/q610098308/article/details/105246355"  target="_blank" rel="noopener"
    >https://blog.csdn.net/q610098308/article/details/105246355</a></p>
<p><a class="link" href="http://www.yxhuang.com/2020/03/28/android-so-load/"  target="_blank" rel="noopener"
    >http://www.yxhuang.com/2020/03/28/android-so-load/</a></p>
</li>
<li>
<p>若源程序设置了android:extractNativeLibs=&ldquo;false&rdquo;,则不会释放lib文件到文件系统,而是直接映射apk文件的lib数据</p>
<p>如果遇到这种情况则需要手动处理,模拟映射加载so的操作,背后的逻辑比较复杂,并且需要考虑兼容性</p>
<p>为了简化处理可以将加壳后apk的android:extractNativeLibs属性改为true,强行指定释放lib</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.androidshell</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.app.Application</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.app.Instrumentation</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.content.Context</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.content.pm.ApplicationInfo</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.content.pm.PackageManager</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.os.Build</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.os.Bundle</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.util.ArrayMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.util.Log</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.BufferedInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ByteArrayOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.ref.WeakReference</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.nio.ByteBuffer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.nio.ByteOrder</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.ArrayList</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Iterator</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.zip.ZipEntry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.zip.ZipInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">dalvik.system.InMemoryDexClassLoader</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SecondProxyApplication</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Application</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">TAG</span><span class="o">=</span><span class="s">&#34;glass&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="p">){</span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="n">message</span><span class="p">);}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">attachBaseContext</span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="n">base</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">.</span><span class="na">attachBaseContext</span><span class="p">(</span><span class="n">base</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;SecondProxyApplication.attachBaseContext is running!&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">shellDexData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readDexFromApk</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;成功从源APK中读取classes.dex&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//从中分理出源dex文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ByteBuffer</span><span class="o">[]</span><span class="w"> </span><span class="n">byteBuffers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extractDexFilesFromShellDex</span><span class="p">(</span><span class="n">shellDexData</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;成功分离出源dex集合&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//配置加载源程序的动态环境,即替换mClassLoader</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">replaceClassLoader</span><span class="p">(</span><span class="n">byteBuffers</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">(</span><span class="w"> </span><span class="n">Log</span><span class="p">.</span><span class="na">getStackTraceString</span><span class="p">(</span><span class="n">e</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onCreate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">.</span><span class="na">onCreate</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;SecondProxyApplication.onCreate is running!&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">replaceApplication</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;替换Application成功&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 从壳dex文件中提取源apk的dex并封装为ByteBuffer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ByteBuffer</span><span class="o">[]</span><span class="w"> </span><span class="nf">extractDexFilesFromShellDex</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">shellDexData</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">shellDexlength</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shellDexData</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//开始解析dex文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">sourceDexsSizeByte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="n">4</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//读取源dexs的大小</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">arraycopy</span><span class="p">(</span><span class="n">shellDexData</span><span class="p">,</span><span class="n">shellDexlength</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">4</span><span class="p">,</span><span class="w"> </span><span class="n">sourceDexsSizeByte</span><span class="p">,</span><span class="n">0</span><span class="p">,</span><span class="n">4</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//转成bytebuffer,方便4byte转int</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ByteBuffer</span><span class="w"> </span><span class="n">wrap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ByteBuffer</span><span class="p">.</span><span class="na">wrap</span><span class="p">(</span><span class="n">sourceDexsSizeByte</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//将byte转成int, 加壳时,长度按小端存储</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">sourceDexsSizeInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wrap</span><span class="p">.</span><span class="na">order</span><span class="p">(</span><span class="n">ByteOrder</span><span class="p">.</span><span class="na">LITTLE_ENDIAN</span><span class="p">).</span><span class="na">getInt</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;源dex集合的大小: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sourceDexsSizeInt</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//读取源dexs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">sourceDexsData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="n">sourceDexsSizeInt</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">arraycopy</span><span class="p">(</span><span class="n">shellDexData</span><span class="p">,</span><span class="n">shellDexlength</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sourceDexsSizeInt</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">4</span><span class="p">,</span><span class="w"> </span><span class="n">sourceDexsData</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">sourceDexsSizeInt</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//解密源dexs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">sourceDexsData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decrypt</span><span class="p">(</span><span class="n">sourceDexsData</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//更新部分</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//从源dexs中分离dex</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[]&gt;</span><span class="w"> </span><span class="n">sourceDexList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">while</span><span class="p">(</span><span class="n">pos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">sourceDexsSizeInt</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//先提取四个字节,描述当前dex的大小</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//开始解析dex文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">singleDexSizeByte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="n">4</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//读取源dexs的大小</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">arraycopy</span><span class="p">(</span><span class="n">sourceDexsData</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">singleDexSizeByte</span><span class="p">,</span><span class="n">0</span><span class="p">,</span><span class="n">4</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//转成bytebuffer,方便4byte转int</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ByteBuffer</span><span class="w"> </span><span class="n">singleDexwrap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ByteBuffer</span><span class="p">.</span><span class="na">wrap</span><span class="p">(</span><span class="n">singleDexSizeByte</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">singleDexSizeInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">singleDexwrap</span><span class="p">.</span><span class="na">order</span><span class="p">(</span><span class="n">ByteOrder</span><span class="p">.</span><span class="na">LITTLE_ENDIAN</span><span class="p">).</span><span class="na">getInt</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;当前singleDex的大小: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">singleDexSizeInt</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//读取单独dex</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">singleDexData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="n">singleDexSizeInt</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">arraycopy</span><span class="p">(</span><span class="n">sourceDexsData</span><span class="p">,</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">4</span><span class="p">,</span><span class="w"> </span><span class="n">singleDexData</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">singleDexSizeInt</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//加入到dexlist中</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">sourceDexList</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">singleDexData</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//更新pos</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">pos</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">singleDexSizeInt</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//将dexlist包装成ByteBuffer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">dexNum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sourceDexList</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;源dex的数量: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dexNum</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ByteBuffer</span><span class="o">[]</span><span class="w"> </span><span class="n">dexBuffers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ByteBuffer</span><span class="o">[</span><span class="n">dexNum</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dexNum</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">dexBuffers</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ByteBuffer</span><span class="p">.</span><span class="na">wrap</span><span class="p">(</span><span class="n">sourceDexList</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">dexBuffers</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 从apk读取dex文件并返回dex对应字节数组</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 从当前程序的apk读取dex文件并存储为字节数组</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="nf">readDexFromApk</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//1.获取当前应用程序的源码路径(apk),一般是data/app目录下,该目录用于存放用户安装的软件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">sourceDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">getApplicationInfo</span><span class="p">().</span><span class="na">sourceDir</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;this.getApplicationInfo().sourceDir: &#34;</span><span class="w"> </span><span class="o">+</span><span class="n">sourceDir</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//2.创建相关输入流</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileInputStream</span><span class="w"> </span><span class="n">fileInputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileInputStream</span><span class="p">(</span><span class="n">sourceDir</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">BufferedInputStream</span><span class="w"> </span><span class="n">bufferedInputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BufferedInputStream</span><span class="p">(</span><span class="n">fileInputStream</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ZipInputStream</span><span class="w"> </span><span class="n">zipInputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ZipInputStream</span><span class="p">(</span><span class="n">bufferedInputStream</span><span class="p">);</span><span class="w"> </span><span class="c1">//用于解析apk文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ByteArrayOutputStream</span><span class="w"> </span><span class="n">byteArrayOutputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ByteArrayOutputStream</span><span class="p">();</span><span class="w"> </span><span class="c1">//用于存放dex文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//3.遍历apk的所有文件并提取dex文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ZipEntry</span><span class="w"> </span><span class="n">zipEntry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">while</span><span class="p">((</span><span class="n">zipEntry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zipInputStream</span><span class="p">.</span><span class="na">getNextEntry</span><span class="p">())</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">){</span><span class="w"> </span><span class="c1">//存在下一个文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 将classes.dex文件存储到bytearray中 壳dex和源apk合并后只保留一个dex便于处理</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">zipEntry</span><span class="p">.</span><span class="na">getName</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="s">&#34;classes.dex&#34;</span><span class="p">)){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="n">1024</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">num</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">while</span><span class="p">((</span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zipInputStream</span><span class="p">.</span><span class="na">read</span><span class="p">(</span><span class="n">bytes</span><span class="p">))</span><span class="o">!=-</span><span class="n">1</span><span class="p">){</span><span class="w">      </span><span class="c1">//每次读取1024byte,返回读取到的byte数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">byteArrayOutputStream</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">num</span><span class="p">);</span><span class="w"> </span><span class="c1">//存放到开辟的byteArrayOutputStream中</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">zipInputStream</span><span class="p">.</span><span class="na">closeEntry</span><span class="p">();</span><span class="w"> </span><span class="c1">//关闭当前文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">zipInputStream</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Read dex from apk succeed!&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">byteArrayOutputStream</span><span class="p">.</span><span class="na">toByteArray</span><span class="p">();</span><span class="w"> </span><span class="c1">//将读取到的dex文件以字节数组形式返回</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="nf">decrypt</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">sourceApkdata</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">sourceApkdata</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">sourceApkdata</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="n">0xff</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">sourceApkdata</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//替换壳程序LoadedApk的Application为源程序Application,并调用其onCreate方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">replaceApplication</span><span class="p">(){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Application实例存在于: LoadedApk.mApplication</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 以及ActivityThread的mInitialApplication和mAllApplications和mBoundApplication</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//判断源程序是否使用自定义Application 若使用则需要进行替换,若未使用则直接返回,使用壳的默认Application即可</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">appClassName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"> </span><span class="c1">//源程序的Application类名</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//获取AndroidManifest.xml 文件中的 &lt;meta-data&gt; 元素</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ApplicationInfo</span><span class="w"> </span><span class="n">applicationInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getPackageManager</span><span class="p">().</span><span class="na">getApplicationInfo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">getPackageName</span><span class="p">(),</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">GET_META_DATA</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Bundle</span><span class="w"> </span><span class="n">metaData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applicationInfo</span><span class="p">.</span><span class="na">metaData</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//获取xml文件声明的Application类</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">metaData</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">metaData</span><span class="p">.</span><span class="na">containsKey</span><span class="p">(</span><span class="s">&#34;APPLICATION_CLASS_NAME&#34;</span><span class="p">)){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">appClassName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metaData</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&#34;APPLICATION_CLASS_NAME&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;源程序中没有自定义Application&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="c1">//如果不存在直接返回,使用壳的application即可</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">PackageManager</span><span class="p">.</span><span class="na">NameNotFoundException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">(</span><span class="n">Log</span><span class="p">.</span><span class="na">getStackTraceString</span><span class="p">(</span><span class="n">e</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//源程序存在自定义application类,开始替换</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Try to replace Application&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//1.反射获取ActivityThread实例</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">sCurrentActivityThreadObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">getStaticField</span><span class="p">(</span><span class="s">&#34;android.app.ActivityThread&#34;</span><span class="p">,</span><span class="s">&#34;sCurrentActivityThread&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;ActivityThread: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sCurrentActivityThreadObj</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//2.获取并设置LoadedApk</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//获取mBoundApplication (AppBindData对象)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">mBoundApplicationObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">getField</span><span class="p">(</span><span class="s">&#34;android.app.ActivityThread&#34;</span><span class="p">,</span><span class="n">sCurrentActivityThreadObj</span><span class="p">,</span><span class="s">&#34;mBoundApplication&#34;</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;mBoundApplication: &#34;</span><span class="o">+</span><span class="n">mBoundApplicationObj</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//获取mBoundApplication.info (即LoadedApk)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">infoObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">getField</span><span class="p">(</span><span class="s">&#34;android.app.ActivityThread$AppBindData&#34;</span><span class="p">,</span><span class="n">mBoundApplicationObj</span><span class="p">,</span><span class="s">&#34;info&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="w"> </span><span class="s">&#34;LoadedApk: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">infoObj</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//把LoadedApk的mApplication设置为null,这样后续才能调用makeApplication() 否则由于已存在Application,无法进行替换</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reflection</span><span class="p">.</span><span class="na">setField</span><span class="p">(</span><span class="s">&#34;android.app.LoadedApk&#34;</span><span class="p">,</span><span class="s">&#34;mApplication&#34;</span><span class="p">,</span><span class="n">infoObj</span><span class="p">,</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//3.获取ActivityThread.mInitialApplication 即拿到旧的Application(对于要加载的Application来讲)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">mInitialApplicationObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">getField</span><span class="p">(</span><span class="s">&#34;android.app.ActivityThread&#34;</span><span class="p">,</span><span class="n">sCurrentActivityThreadObj</span><span class="p">,</span><span class="s">&#34;mInitialApplication&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;mInitialApplicationObj: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mInitialApplicationObj</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//4.获取ActivityThread.mAllApplications并删除旧的application</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Application</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mAllApplicationsObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Application</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">getField</span><span class="p">(</span><span class="s">&#34;android.app.ActivityThread&#34;</span><span class="p">,</span><span class="n">sCurrentActivityThreadObj</span><span class="p">,</span><span class="s">&#34;mAllApplications&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">mAllApplicationsObj</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">mInitialApplicationObj</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;mInitialApplication 从 mAllApplications 中移除成功&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//5.重置相关类的Application类名 便于后续创建Application</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//获取LoadedApk.mApplicationInfo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ApplicationInfo</span><span class="w"> </span><span class="n">applicationInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ApplicationInfo</span><span class="p">)</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">getField</span><span class="p">(</span><span class="s">&#34;android.app.LoadedApk&#34;</span><span class="p">,</span><span class="n">infoObj</span><span class="p">,</span><span class="s">&#34;mApplicationInfo&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="w"> </span><span class="s">&#34;LoadedApk.mApplicationInfo: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">applicationInfo</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//获取mBoundApplication.appInfo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ApplicationInfo</span><span class="w"> </span><span class="n">appinfoInAppBindData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ApplicationInfo</span><span class="p">)</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">getField</span><span class="p">(</span><span class="s">&#34;android.app.ActivityThread$AppBindData&#34;</span><span class="p">,</span><span class="n">mBoundApplicationObj</span><span class="p">,</span><span class="s">&#34;appInfo&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;ActivityThread.mBoundApplication.appInfo: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">appinfoInAppBindData</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//此处通过引用修改值,虽然后续没有使用,但是实际上是修改其指向的LoadedApk相关字段的值</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//设置两个appinfo的classname为源程序的application类名,以便后续调用makeApplication()创建源程序的application</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">applicationInfo</span><span class="p">.</span><span class="na">className</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">appClassName</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">appinfoInAppBindData</span><span class="p">.</span><span class="na">className</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">appClassName</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Source Application name: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">appClassName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//6.反射调用makeApplication方法创建源程序的application</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Application</span><span class="w"> </span><span class="n">application</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Application</span><span class="p">)</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">invokeMethod</span><span class="p">(</span><span class="s">&#34;android.app.LoadedApk&#34;</span><span class="p">,</span><span class="s">&#34;makeApplication&#34;</span><span class="p">,</span><span class="n">infoObj</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="kt">boolean</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Instrumentation</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="kc">false</span><span class="p">,</span><span class="kc">null</span><span class="p">});</span><span class="w"> </span><span class="c1">//使用源程序中的application</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//Application app = (Application)ReflectionMethods.invokeMethod(&#34;android.app.LoadedApk&#34;,&#34;makeApplication&#34;,infoObj,new Class[]{boolean.class, Instrumentation.class},new Object[]{true,null}); //使用自定义的application 强制为系统默认</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Create source Application succeed: &#34;</span><span class="o">+</span><span class="n">application</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//7.重置ActivityThread.mInitialApplication为新的Application</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reflection</span><span class="p">.</span><span class="na">setField</span><span class="p">(</span><span class="s">&#34;android.app.ActivityThread&#34;</span><span class="p">,</span><span class="s">&#34;mInitialApplication&#34;</span><span class="p">,</span><span class="n">sCurrentActivityThreadObj</span><span class="p">,</span><span class="n">application</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Reset ActivityThread.mInitialApplication by new Application succeed!&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//8.ContentProvider会持有代理的Application,需要特殊处理一下</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ArrayMap</span><span class="w"> </span><span class="n">mProviderMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ArrayMap</span><span class="p">)</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">getField</span><span class="p">(</span><span class="s">&#34;android.app.ActivityThread&#34;</span><span class="p">,</span><span class="n">sCurrentActivityThreadObj</span><span class="p">,</span><span class="s">&#34;mProviderMap&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;ActivityThread.mProviderMap: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mProviderMap</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//获取所有provider,装进迭代器中遍历</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Iterator</span><span class="w"> </span><span class="n">iterator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mProviderMap</span><span class="p">.</span><span class="na">values</span><span class="p">().</span><span class="na">iterator</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">while</span><span class="p">(</span><span class="n">iterator</span><span class="p">.</span><span class="na">hasNext</span><span class="p">()){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Object</span><span class="w"> </span><span class="n">providerClientRecord</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iterator</span><span class="p">.</span><span class="na">next</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//获取ProviderClientRecord.mLocalProvider,可能为空</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Object</span><span class="w"> </span><span class="n">mLocalProvider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">getField</span><span class="p">(</span><span class="s">&#34;android.app.ActivityThread$ProviderClientRecord&#34;</span><span class="p">,</span><span class="n">providerClientRecord</span><span class="p">,</span><span class="s">&#34;mLocalProvider&#34;</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">mLocalProvider</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;ProviderClientRecord.mLocalProvider: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mLocalProvider</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">//获取ContentProvider中的mContext字段,设置为新的Application</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Reflection</span><span class="p">.</span><span class="na">setField</span><span class="p">(</span><span class="s">&#34;android.content.ContentProvider&#34;</span><span class="p">,</span><span class="s">&#34;mContext&#34;</span><span class="p">,</span><span class="n">mLocalProvider</span><span class="p">,</span><span class="n">application</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="w"> </span><span class="s">&#34;Run Application.onCreate&#34;</span><span class="w"> </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">application</span><span class="p">.</span><span class="na">onCreate</span><span class="p">();</span><span class="w"> </span><span class="c1">//源程序,启动!</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 替换壳App的ClassLoader为源App的ClassLoader</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">replaceClassLoader</span><span class="p">(</span><span class="n">ByteBuffer</span><span class="o">[]</span><span class="w"> </span><span class="n">byteBuffers</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//1.获取当前的classloader</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">classLoader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">getClassLoader</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Current ClassLoader: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">classLoader</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Parent ClassLoader: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">classLoader</span><span class="p">.</span><span class="na">getParent</span><span class="p">().</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//2.反射获取ActivityThread</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">sCurrentActivityThreadObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">getStaticField</span><span class="p">(</span><span class="s">&#34;android.app.ActivityThread&#34;</span><span class="p">,</span><span class="s">&#34;sCurrentActivityThread&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;ActivityThread.sCurrentActivity: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sCurrentActivityThreadObj</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//3.反射获取LoadedApk</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//获取当前ActivityThread实例的mPackages字段 类型为ArrayMap&lt;String, WeakReference&lt;LoadedApk&gt;&gt;, 里面存放了当前应用的LoadedApk对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ArrayMap</span><span class="w"> </span><span class="n">mPackagesObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ArrayMap</span><span class="p">)</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">getField</span><span class="p">(</span><span class="s">&#34;android.app.ActivityThread&#34;</span><span class="p">,</span><span class="n">sCurrentActivityThreadObj</span><span class="p">,</span><span class="s">&#34;mPackages&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="w"> </span><span class="s">&#34;mPackagesObj: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mPackagesObj</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//获取mPackages中的当前应用包名</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">currentPackageName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">getPackageName</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;currentPackageName: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">currentPackageName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 获取loadedApk实例也有好几种,mInitialApplication mAllApplications mPackages</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 通过包名获取当前应用的loadedApk实例</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">WeakReference</span><span class="w"> </span><span class="n">weakReference</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">WeakReference</span><span class="p">)</span><span class="w"> </span><span class="n">mPackagesObj</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">currentPackageName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">loadedApkObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">weakReference</span><span class="p">.</span><span class="na">get</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="w"> </span><span class="s">&#34;LoadedApk: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">loadedApkObj</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//动态加载源程序的dex文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">Build</span><span class="p">.</span><span class="na">VERSION</span><span class="p">.</span><span class="na">SDK_INT</span><span class="o">&gt;=</span><span class="n">29</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="s">&#34;Library path:&#34;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="na">getApplicationInfo</span><span class="p">().</span><span class="na">nativeLibraryDir</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">InMemoryDexClassLoader</span><span class="w"> </span><span class="n">dexClassLoader</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">InMemoryDexClassLoader</span><span class="p">(</span><span class="n">byteBuffers</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="na">getApplicationInfo</span><span class="p">().</span><span class="na">nativeLibraryDir</span><span class="p">,</span><span class="n">classLoader</span><span class="p">.</span><span class="na">getParent</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;New InMemoryDexClassLoader: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dexClassLoader</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//替换当前loadedApk实例中的mClassLoader字段</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Reflection</span><span class="p">.</span><span class="na">setField</span><span class="p">(</span><span class="s">&#34;android.app.LoadedApk&#34;</span><span class="p">,</span><span class="s">&#34;mClassLoader&#34;</span><span class="p">,</span><span class="n">loadedApkObj</span><span class="p">,</span><span class="n">dexClassLoader</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">else</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="s">&#34;不支持Android 8.0以下版本&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="总结-1">总结
</h2><p>二代加固使用不落地加载技术,可在内存中直接加载dex,实际上是对落地加载的更新</p>
<p>第一代和第二代加固统称为整体加固,在部分资料中将他们合称为一代加固,将代码抽取加固称为二代加固</p>
<p>优点: 相对一代加固更加高效,不容易从文件系统获取dex文件从而得到关键代码</p>
<p>缺点: 兼容性问题: 源程序的libso处理起来比较复杂；低版本需要手动实现InMemoryDexClassLoader</p>
<h1 id="九-三代加固-抽取加固">九. 三代加固-抽取加固
</h1><p>基于整体加固遇到的部分问题,引申出了三代加固: 代码抽取加固</p>
<p>思路: 将关键方法的指令抽空,替换为nop指令,运行时动态回填指令执行, 回填的核心是对Android系统核心函数进行hook</p>
<ol>
<li>
<p>Hook点</p>
<p>常用的Hook点有ClassLinker::LoadMethod和ClassLinker::DefineClass,二者都可以获取DexFile对象</p>
<p>LoadMethod: 可获取Method对象,从而获取codeOff,方便回填处理,但兼容性差</p>
<p>DefineClass: 可获取ClassDef对象,需要解析得到codeOff,更复杂但兼容性好,变化不大</p>
</li>
<li>
<p>如何抽取代码(参考前文Dex文件结构和代码抽取部分)</p>
<p>Dex文件结构中DexClassDef结构定义了各个类的信息,其中的DexClassData结构记录了类的字段和方法数据</p>
<p>方法由DexMethod结构保存,其codeOff成员保存了方法的字节码数据在文件中的偏移,根据该偏移可以进行抽取</p>
</li>
</ol>
<p>LoadMethod声明如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">//Android 7及以前
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">void</span> <span class="n">LoadMethod</span><span class="p">(</span><span class="n">Thread</span><span class="o">*</span> <span class="n">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="k">const</span> <span class="n">DexFile</span><span class="o">&amp;</span> <span class="n">dex_file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="k">const</span> <span class="n">ClassDataItemIterator</span><span class="o">&amp;</span> <span class="n">it</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">Handle</span><span class="o">&lt;</span><span class="n">mirror</span><span class="o">::</span><span class="n">Class</span><span class="o">&gt;</span> <span class="n">klass</span><span class="p">,</span> <span class="n">ArtMethod</span><span class="o">*</span> <span class="n">dst</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">//Android 8-9
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">void</span> <span class="n">LoadMethod</span><span class="p">(</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">&amp;</span> <span class="n">dex_file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="k">const</span> <span class="n">ClassDataItemIterator</span><span class="o">&amp;</span> <span class="n">it</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">Handle</span><span class="o">&lt;</span><span class="n">mirror</span><span class="o">::</span><span class="n">Class</span><span class="o">&gt;</span> <span class="n">klass</span><span class="p">,</span> <span class="n">ArtMethod</span><span class="o">*</span> <span class="n">dst</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">//Android 10-14
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">void</span> <span class="n">LoadMethod</span><span class="p">(</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">&amp;</span> <span class="n">dex_file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="k">const</span> <span class="n">ClassAccessor</span><span class="o">::</span><span class="n">Method</span><span class="o">&amp;</span> <span class="n">method</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">Handle</span><span class="o">&lt;</span><span class="n">mirror</span><span class="o">::</span><span class="n">Class</span><span class="o">&gt;</span> <span class="n">klass</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">ArtMethod</span><span class="o">*</span> <span class="n">dst</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="c1">//Android 15
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">void</span> <span class="n">LoadMethod</span><span class="p">(</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">&amp;</span> <span class="n">dex_file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="k">const</span> <span class="n">ClassAccessor</span><span class="o">::</span><span class="n">Method</span><span class="o">&amp;</span> <span class="n">method</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">ObjPtr</span><span class="o">&lt;</span><span class="n">mirror</span><span class="o">::</span><span class="n">Class</span><span class="o">&gt;</span> <span class="n">klass</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="cm">/*inout*/</span> <span class="n">MethodAnnotationsIterator</span><span class="o">*</span> <span class="n">mai</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="cm">/*out*/</span> <span class="n">ArtMethod</span><span class="o">*</span> <span class="n">dst</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>DefineClass声明如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// Android 5.0 Level 21 及之前使用该声明
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">void</span><span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">g_originDefineClassV21</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span> <span class="n">thiz</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">descriptor</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="kt">void</span><span class="o">*</span> <span class="n">class_loader</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">dex_file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">dex_class_def</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">//原始声明
</span></span></span><span class="line"><span class="cl"><span class="cm">mirror::Class* DefineClass(const char* descriptor,
</span></span></span><span class="line"><span class="cl"><span class="cm">                            Handle&lt;mirror::ClassLoader&gt; class_loader,
</span></span></span><span class="line"><span class="cl"><span class="cm">                            const DexFile&amp; dex_file,
</span></span></span><span class="line"><span class="cl"><span class="cm">                            const DexFile::ClassDef&amp; dex_class_def)
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Android 5.1-14 Level22-34使用该声明
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">void</span><span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">g_originDefineClassV22</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span> <span class="n">thiz</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="kt">void</span><span class="o">*</span> <span class="n">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">descriptor</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="n">size_t</span> <span class="n">hash</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="kt">void</span><span class="o">*</span> <span class="n">class_loader</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">dex_file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">dex_class_def</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">//原始声明
</span></span></span><span class="line"><span class="cl"><span class="cm">ObjPtr&lt;mirror::Class&gt; DefineClass(Thread* self,
</span></span></span><span class="line"><span class="cl"><span class="cm">                                  const char* descriptor,
</span></span></span><span class="line"><span class="cl"><span class="cm">                                  size_t hash,
</span></span></span><span class="line"><span class="cl"><span class="cm">                                  Handle&lt;mirror::ClassLoader&gt; class_loader,
</span></span></span><span class="line"><span class="cl"><span class="cm">                                  const DexFile&amp; dex_file,
</span></span></span><span class="line"><span class="cl"><span class="cm">                                  const dex::ClassDef&amp; dex_class_def)
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//Android 15 Level 35 以后使用该声明
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">void</span><span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">g_originDefineClassV35</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span> <span class="n">thiz</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="kt">void</span><span class="o">*</span> <span class="n">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">descriptor</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="n">size_t</span> <span class="n">descriptor_length</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="n">size_t</span> <span class="n">hash</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="kt">void</span><span class="o">*</span> <span class="n">class_loader</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">dex_file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">dex_class_def</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">//原始声明
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">ObjPtr&lt;mirror::Class&gt; DefineClass(Thread* self,
</span></span></span><span class="line"><span class="cl"><span class="cm">                                  const char* descriptor,
</span></span></span><span class="line"><span class="cl"><span class="cm">                                  size_t descriptor_length,
</span></span></span><span class="line"><span class="cl"><span class="cm">                                  size_t hash,
</span></span></span><span class="line"><span class="cl"><span class="cm">                                  Handle&lt;mirror::ClassLoader&gt; class_loader,
</span></span></span><span class="line"><span class="cl"><span class="cm">                                  const DexFile&amp; dex_file,
</span></span></span><span class="line"><span class="cl"><span class="cm">                                  const dex::ClassDef&amp; dex_class_def)
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="原理-2">原理
</h2><h2 id="源程序-2">源程序
</h2><p>主要包括3个技术点(同上):</p>
<ol>
<li>Native层NDK开发</li>
<li>Multidex</li>
<li>自定义Application</li>
</ol>
<h2 id="加壳程序-2">加壳程序
</h2><p>加壳程序主要分为3个模块</p>
<ol>
<li>Apk处理模块: 提供解包Apk,打包Apk,签名Apk的功能</li>
<li>Xml处理模块: 提供读取标签,修改标签,添加标签的功能</li>
<li>Dex处理模块: 提供合并多Dex,加密Dex,代码抽取,文件修复的功能</li>
</ol>
<p><img src="/photos%5c25-%e5%8a%a0%e5%a3%b3%e7%a8%8b%e5%ba%8f.png"
	
	
	
	loading="lazy"
	
		alt="14-加壳程序"
	
	
></p>
<p>加壳程序工作基本流程图如下</p>
<p><img src="/photos%5c26-%e5%8a%a0%e5%a3%b3%e7%a8%8b%e5%ba%8f%e6%b5%81%e7%a8%8b.png"
	
	
	
	loading="lazy"
	
		alt="17-加壳程序流程"
	
	
></p>
<p>加壳程序工作流程总览图如下:</p>
<p><img src="/photos%5c27-Apk%e5%90%88%e5%b9%b6%e5%9b%be.png"
	
	
	
	loading="lazy"
	
		alt="24-Apk合并图"
	
	
></p>
<p>相对于SecondShell.py的改动如下:</p>
<ol>
<li>
<p>start</p>
<p>解包源apk后调用extractAllDexFiles抽取所有dex文件的代码</p>
<p>另外复制了壳apk的lib库到新apk的临时目录（hook和代码回填逻辑在native层）</p>
</li>
<li>
<p>extractAllDexFiles</p>
<p>遍历指定目录的所有dex文件,调用ReadDex抽取代码,得到对应的.patched和.codes文件</p>
<p>修复patch后的dex文件并覆写原dex文件,将codes移动到assets目录下</p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">zlib</span> <span class="kn">import</span> <span class="n">adler32</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha1</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">binascii</span> <span class="kn">import</span> <span class="n">unhexlify</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">subprocess</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">shutil</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">argparse</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Paths类,管理全局用到的路径</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Paths</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">srcApk</span><span class="p">:</span><span class="n">Path</span><span class="p">,</span> <span class="n">shellApk</span><span class="p">:</span><span class="n">Path</span><span class="p">,</span> <span class="n">outputApk</span><span class="p">:</span><span class="n">Path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 相关APK文件路径</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">srcApkPath</span><span class="o">=</span> <span class="n">srcApk</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span> <span class="c1"># 解析为绝对路径</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">shellApkPath</span><span class="o">=</span> <span class="n">shellApk</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">newApkPath</span><span class="o">=</span> <span class="n">outputApk</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 临时目录 以该脚本文件父目录为根目录</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">/</span><span class="s1">&#39;temp&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">srcApkTempDir</span><span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="o">/</span> <span class="s1">&#39;srcApkTemp&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">shellApkTempDir</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="o">/</span><span class="s1">&#39;shellApkTemp&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">newApkTempDir</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="o">/</span> <span class="s1">&#39;newApkTemp&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Apktool类,通过subprocess调用其他工具 提供解包,打包,签名,抽取代码功能</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Apktool</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">apktool_path</span><span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">/</span><span class="s1">&#39;tools/apktool/apktool.bat&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">signer_path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">/</span><span class="s1">&#39;tools/uber-apk-signer-1.3.0.jar&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">readDex_path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">/</span><span class="s1">&#39;tools/ReadDex.exe&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 为apk签名</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">signApk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">unsignedApkPath</span><span class="p">:</span><span class="n">Path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">runCommand</span><span class="p">([</span><span class="s1">&#39;java&#39;</span><span class="p">,</span><span class="s1">&#39;-jar&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">signer_path</span><span class="p">,</span> <span class="s1">&#39;--apk&#39;</span><span class="p">,</span><span class="n">unsignedApkPath</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 使用apktool解包apk 只解包资源得到AndroidManifest.xml 不需要解包dex文件得到smali </span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">unpackApk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">apkPath</span><span class="p">:</span><span class="n">Path</span><span class="p">,</span> <span class="n">outputDir</span><span class="p">:</span><span class="n">Path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">runCommand</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">apktool_path</span><span class="p">,</span> <span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span> <span class="p">,</span> <span class="n">apkPath</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">outputDir</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 重打包apk</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">repackApk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">inputDir</span><span class="p">:</span><span class="n">Path</span><span class="p">,</span> <span class="n">outApk</span><span class="p">:</span><span class="n">Path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">runCommand</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">apktool_path</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span> <span class="p">,</span> <span class="n">inputDir</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">outApk</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 抽取指定dex文件的代码</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">extractDexCodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dexPath</span><span class="p">:</span><span class="n">Path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 调用ReadDex.exe抽取dex文件代码,输出到同级目录 例如classes.dex抽取后生成classes.dex.patched和classes.dex.codes</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">runCommand</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">readDex_path</span><span class="p">,</span><span class="s1">&#39;-file&#39;</span><span class="p">,</span>  <span class="n">dexPath</span><span class="p">,</span> <span class="s1">&#39;-extractCodes&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 执行命令</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">runCommand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">args</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#subprocess.run(args)</span>
</span></span><span class="line"><span class="cl">        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">)</span> <span class="c1">#仅调用工具,不需要额外输出,重定向stdout到os.devnull</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 参数列表 捕获输出 输出转为字符串</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#print(subprocess.run(args,  capture_output=True,text=True).stdout)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># AndroidManifest.xml的editor 用于获取和修改标签属性,以及添加标签</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ManifestEditor</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml_content</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">ns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;android&#39;</span><span class="p">:</span> <span class="s1">&#39;http://schemas.android.com/apk/res/android&#39;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">xml_content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 获取指定标签的android属性值 examples: get_attr(&#39;application&#39;, &#39;name&#39;) get_attr(&#39;activity&#39;, &#39;name&#39;)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">getTagAttribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">tag_name</span> <span class="o">==</span> <span class="s1">&#39;manifest&#39;</span><span class="p">:</span>  <span class="c1"># 根标签特殊处理</span>
</span></span><span class="line"><span class="cl">            <span class="n">elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">elem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">elem</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attr_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># 寻找标签的属性</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;.//</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">elem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">elem</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">[</span><span class="s2">&#34;android&#34;</span><span class="p">]</span><span class="si">}</span><span class="se">}}</span><span class="si">{</span><span class="n">attr_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># 根标签之外的属性位于android命名空间下</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 设置指定标签的属性值 example:s et_attr(&#39;application&#39;,&#39;name&#39;,&#34;com.example.ProxyApplication&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">setTagAttribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_value</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">tag_name</span> <span class="o">==</span> <span class="s1">&#39;manifest&#39;</span><span class="p">:</span>  <span class="c1"># 根标签特殊处理</span>
</span></span><span class="line"><span class="cl">            <span class="n">elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">elem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">elem</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attr_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">new_value</span><span class="p">)</span>  <span class="c1"># 设置属性值</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;.//</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">elem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">elem</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">[</span><span class="s2">&#34;android&#34;</span><span class="p">]</span><span class="si">}</span><span class="se">}}</span><span class="si">{</span><span class="n">attr_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">new_value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 在指定父标签下添加新子标签 example: add_tag(&#39;application&#39;,&#34;meta-data&#34;,{&#39;name&#39;: &#39;android.permission.CAMERA&#39;,&#39;value&#39;:&#39;hello&#39;})</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">addTagWithAttributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">attrs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">parent_tag</span> <span class="o">==</span> <span class="s1">&#39;manifest&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">new_elem</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">new_tag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  <span class="c1"># 支持一次给添加的标签设置多个属性</span>
</span></span><span class="line"><span class="cl">                    <span class="n">new_elem</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;.//</span><span class="si">{</span><span class="n">parent_tag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">new_elem</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">new_tag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                    <span class="n">new_elem</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">[</span><span class="s2">&#34;android&#34;</span><span class="p">]</span><span class="si">}</span><span class="se">}}</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 不以壳manifest为基准操作则用不到该函数,以源apk的manifest为基准自带,无需额外设置</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">getMainActivity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">activities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.//activity&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">activity</span> <span class="ow">in</span> <span class="n">activities</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">intent_filters</span> <span class="o">=</span> <span class="n">activity</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.//intent-filter&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">intent_filter</span> <span class="ow">in</span> <span class="n">intent_filters</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">action</span> <span class="o">=</span> <span class="n">intent_filter</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//action[@android:name=&#34;android.intent.action.MAIN&#34;]&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">category</span> <span class="o">=</span> <span class="n">intent_filter</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//category[@android:name=&#34;android.intent.category.LAUNCHER&#34;]&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                              <span class="n">namespaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">category</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="n">activity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">[</span><span class="s2">&#34;android&#34;</span><span class="p">]</span><span class="si">}</span><span class="se">}}</span><span class="s1">name&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 获取application标签的name属性值</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">getApplicationName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTagAttribute</span><span class="p">(</span><span class="s1">&#39;application&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 设置application标签的name属性值</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">setApplicationName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">application</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">setTagAttribute</span><span class="p">(</span><span class="s1">&#39;application&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">application</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 添加meta-data标签,并设置name和value属性值</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">addMetaData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">addTagWithAttributes</span><span class="p">(</span><span class="s1">&#39;application&#39;</span><span class="p">,</span> <span class="s1">&#39;meta-data&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 获取AndroidManifest.xml的字符串</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">getManifestData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;返回XML字符串&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="p">,</span> <span class="n">pretty_print</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">xml_declaration</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 获取application标签的extractNativeLibs属性值</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">getEtractNativeLibs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTagAttribute</span><span class="p">(</span><span class="s1">&#39;application&#39;</span><span class="p">,</span> <span class="s1">&#39;extractNativeLibs&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 设置application标签的extractNativeLibs属性值为true</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">resetExtractNativeLibs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">setTagAttribute</span><span class="p">(</span><span class="s1">&#39;application&#39;</span><span class="p">,</span> <span class="s1">&#39;extractNativeLibs&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 工具函数,注意修复时顺序为: fileSize-&gt;signature-&gt;checksum</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 修复dex文件的checksum</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">fixCheckSum</span><span class="p">(</span><span class="n">dexBytes</span><span class="p">:</span><span class="nb">bytearray</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># dexfile[8:12] 小端序4字节</span>
</span></span><span class="line"><span class="cl">    <span class="n">value</span> <span class="o">=</span> <span class="n">adler32</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">dexBytes</span><span class="p">[</span><span class="mi">12</span><span class="p">:]))</span>
</span></span><span class="line"><span class="cl">    <span class="n">valueArray</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">valueArray</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="n">dexBytes</span><span class="p">[</span><span class="mi">8</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">valueArray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 修复dex文件的signature</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">fixSignature</span><span class="p">(</span><span class="n">dexBytes</span><span class="p">:</span><span class="nb">bytearray</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># dexfile[12:32] 小端序20字节</span>
</span></span><span class="line"><span class="cl">    <span class="n">sha_1</span> <span class="o">=</span> <span class="n">sha1</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">sha_1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">dexBytes</span><span class="p">[</span><span class="mi">32</span><span class="p">:]))</span>
</span></span><span class="line"><span class="cl">    <span class="n">value</span> <span class="o">=</span> <span class="n">sha_1</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">valueArray</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">valueArray</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="n">dexBytes</span><span class="p">[</span><span class="mi">12</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">valueArray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 修复dex文件的filesize</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">fixFileSize</span><span class="p">(</span><span class="n">dexBytes</span><span class="p">:</span><span class="nb">bytearray</span><span class="p">,</span> <span class="n">fileSize</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># dexfile[32:36] 小端存储</span>
</span></span><span class="line"><span class="cl">    <span class="n">fileSizeArray</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">fileSize</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s2">&#34;little&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fileSizeArray</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="n">dexBytes</span><span class="p">[</span><span class="mi">32</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fileSizeArray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 加密函数,使用异或</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">data</span><span class="p">:</span><span class="nb">bytearray</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># todo:使用aes/sm4等加密算法替代</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^=</span> <span class="mh">0xff</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 抽取指定目录下的所有dex文件的代码 patch所有dex文件并修复,将codes文件移动到assets目录下</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">extractAllDexFiles</span><span class="p">(</span><span class="n">directory</span><span class="p">:</span><span class="n">Path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">apktool</span><span class="o">=</span><span class="n">Apktool</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 1.遍历目录下的所有dex文件,并抽取对应代码</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">dex</span> <span class="ow">in</span> <span class="n">directory</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;classes*.dex&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">apktool</span><span class="o">.</span><span class="n">extractDexCodes</span><span class="p">(</span><span class="n">dex</span><span class="p">)</span> <span class="c1"># 抽取dex文件代码 得到classes*.dex.patched和classes*.dex.codes</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 2.修复抽取后的文件并覆写原dex文件</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">patchedDex</span> <span class="ow">in</span> <span class="n">directory</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;classes*.dex.patched&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">newDexName</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">patchedDex</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.patched&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="c1"># 重命名</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 读取文件内容</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">patchedDex</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 修复signature和checksum,注意先后顺序</span>
</span></span><span class="line"><span class="cl">            <span class="n">fixSignature</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">fixCheckSum</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 修复后的文件覆写原dex文件</span>
</span></span><span class="line"><span class="cl">            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">newDexName</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">newf</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">newf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 3.删除patched文件</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">patchedDex</span> <span class="ow">in</span> <span class="n">directory</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;classes*.dex.patched&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">patchedDex</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 4.移动.codes文件到assets目录下</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 如果没有assets目录则创建</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">directory</span><span class="o">/</span><span class="s1">&#39;assets&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">directory</span><span class="o">/</span><span class="s1">&#39;assets&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">codes</span> <span class="ow">in</span> <span class="n">directory</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;classes*.dex.codes&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">codes</span><span class="p">,</span><span class="n">directory</span><span class="o">/</span><span class="s1">&#39;assets&#39;</span><span class="o">/</span><span class="n">codes</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="c1"># 移动到assets目录下</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 合并壳dex和源apk的dex,支持多dex文件,合并为一个dex</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">combineShellAndSourceDexs</span><span class="p">(</span><span class="n">shellApkTempDir</span><span class="p">:</span><span class="n">Path</span><span class="p">,</span><span class="n">srcApkTempDir</span><span class="p">:</span><span class="n">Path</span><span class="p">,</span><span class="n">newApkTempDir</span><span class="p">:</span><span class="n">Path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 读取解包后的apk的所有dex文件,并合并为一个dex文件</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">readAndCombineDexs</span><span class="p">(</span><span class="n">unpackedApkDir</span><span class="p">:</span><span class="n">Path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">combinedDex</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">         <span class="c1"># glob方法返回包含所有匹配文件的生成器</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">dex</span> <span class="ow">in</span> <span class="n">unpackedApkDir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;classes*.dex&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Source Apk Dex file:&#39;</span><span class="p">,</span> <span class="n">dex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dex</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                <span class="n">combinedDex</span><span class="o">+=</span><span class="nb">bytearray</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">))</span>  <span class="c1"># dex文件的长度,小端序</span>
</span></span><span class="line"><span class="cl">                <span class="n">combinedDex</span><span class="o">+=</span><span class="n">data</span> <span class="c1"># dex文件内容</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">combinedDex</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 获取shelldex</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">shellApkTempDir</span><span class="o">/</span><span class="s1">&#39;classes.dex&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">shellDexArray</span><span class="o">=</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 获取源apk的dex文件</span>
</span></span><span class="line"><span class="cl">    <span class="n">srcDexArray</span> <span class="o">=</span> <span class="n">readAndCombineDexs</span><span class="p">(</span><span class="n">srcApkTempDir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 新的dex文件长度</span>
</span></span><span class="line"><span class="cl">    <span class="n">newDexLen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">srcDexArray</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellDexArray</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 加密源文件</span>
</span></span><span class="line"><span class="cl">    <span class="n">encSrcDexArray</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">srcDexArray</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 新的dex文件内容 = 壳dex + 加密的源dex + 四字节标识加密后源dex大小长度</span>
</span></span><span class="line"><span class="cl">    <span class="n">newDexArray</span> <span class="o">=</span> <span class="n">shellDexArray</span> <span class="o">+</span> <span class="n">encSrcDexArray</span>  <span class="o">+</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">encSrcDexArray</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 修改filesize</span>
</span></span><span class="line"><span class="cl">    <span class="n">fixFileSize</span><span class="p">(</span><span class="n">newDexArray</span><span class="p">,</span> <span class="n">newDexLen</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 修改signature</span>
</span></span><span class="line"><span class="cl">    <span class="n">fixSignature</span><span class="p">(</span><span class="n">newDexArray</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 修改checksum</span>
</span></span><span class="line"><span class="cl">    <span class="n">fixCheckSum</span><span class="p">(</span><span class="n">newDexArray</span><span class="p">)</span> <span class="c1"># 注意先后顺序,先修改signature,再修改checksum</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 导出文件</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">newApkTempDir</span><span class="o">/</span><span class="s1">&#39;classes.dex&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">newDexArray</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 提取源apk的Manifest文件,修改application为壳application(可能添加meta-data标签),输出新的Manifest文件</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">handleManifest</span><span class="p">(</span><span class="n">srcApkTempDir</span><span class="p">:</span><span class="n">Path</span><span class="p">,</span><span class="n">shellApkTempDir</span><span class="p">:</span><span class="n">Path</span><span class="p">,</span><span class="n">newApkTempDir</span><span class="p">:</span><span class="n">Path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 从源apk提取AndroidManifest.xml</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">srcApkTempDir</span><span class="o">/</span><span class="s1">&#39;AndroidManifest.xml&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">srcManifestEditor</span><span class="o">=</span><span class="n">ManifestEditor</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">srcApplication</span><span class="o">=</span><span class="n">srcManifestEditor</span><span class="o">.</span><span class="n">getApplicationName</span><span class="p">()</span>           <span class="c1"># 获取application:name,确定是否存在自定义Application类</span>
</span></span><span class="line"><span class="cl">    <span class="n">srcExtractNativeLibs</span><span class="o">=</span><span class="n">srcManifestEditor</span><span class="o">.</span><span class="n">getEtractNativeLibs</span><span class="p">()</span>    <span class="c1"># 获取application:extractNativeLibs,判断是否释放lib文件</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SourceApplication:&#39;</span><span class="p">,</span><span class="n">srcApplication</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SourceExtractNativeLibs:&#39;</span><span class="p">,</span><span class="n">srcExtractNativeLibs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 从壳apk提取AndroidManifest.xml</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">shellApkTempDir</span><span class="o">/</span><span class="s1">&#39;AndroidManifest.xml&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">shellManifestEditor</span><span class="o">=</span><span class="n">ManifestEditor</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ShellApplication:&#39;</span><span class="p">,</span><span class="n">shellManifestEditor</span><span class="o">.</span><span class="n">getApplicationName</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 修改源AndroidManifest.xml的application为壳的代理application</span>
</span></span><span class="line"><span class="cl">    <span class="n">srcManifestEditor</span><span class="o">.</span><span class="n">setApplicationName</span><span class="p">(</span><span class="n">shellManifestEditor</span><span class="o">.</span><span class="n">getApplicationName</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 写入meta-data标签 保存源apk的原始application</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">srcApplication</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Source application:&#39;</span><span class="p">,</span><span class="n">srcApplication</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">srcManifestEditor</span><span class="o">.</span><span class="n">addMetaData</span><span class="p">(</span><span class="s1">&#39;APPLICATION_CLASS_NAME&#39;</span><span class="p">,</span><span class="n">srcApplication</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 如果源apk的manifest中默认设置etractNativeLibs=false,则重置为true,确保释放lib文件</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">srcExtractNativeLibs</span><span class="o">==</span><span class="s1">&#39;false&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">srcManifestEditor</span><span class="o">.</span><span class="n">resetExtractNativeLibs</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 输出新的AndroidManifest.xml</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">newApkTempDir</span><span class="o">/</span><span class="s1">&#39;AndroidManifest.xml&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">srcManifestEditor</span><span class="o">.</span><span class="n">getManifestData</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 执行加固流程</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">paths</span><span class="p">:</span><span class="n">Paths</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">apktool</span><span class="o">=</span><span class="n">Apktool</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 1.分别解包源文件和壳文件到临时目录</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Extracting source and shell apk...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">apktool</span><span class="o">.</span><span class="n">unpackApk</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">srcApkPath</span><span class="p">,</span><span class="n">paths</span><span class="o">.</span><span class="n">srcApkTempDir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Extract source apk success!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Extracting shell apk...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">apktool</span><span class="o">.</span><span class="n">unpackApk</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">shellApkPath</span><span class="p">,</span><span class="n">paths</span><span class="o">.</span><span class="n">shellApkTempDir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Extract shell apk success!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 2.抽取源dex文件代码</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exrtracting dex files codes...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">extractAllDexFiles</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">srcApkTempDir</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Extract dex files codes success!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 3.复制源apk所有文件到新apk临时目录中 忽略源dex和manifest文件</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Copying source apk files to new apk temp dir...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">srcApkTempDir</span><span class="p">,</span><span class="n">paths</span><span class="o">.</span><span class="n">newApkTempDir</span><span class="p">,</span><span class="n">ignore</span><span class="o">=</span><span class="n">shutil</span><span class="o">.</span><span class="n">ignore_patterns</span><span class="p">(</span><span class="s1">&#39;AndroidManifest.xml&#39;</span><span class="p">,</span><span class="s1">&#39;classes*.dex&#39;</span><span class="p">))</span> 
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Copy source apk files success!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 4.复制壳apk的lib库文件到新apk临时目录中 （壳的代码回填逻辑在lib中实现）</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Copying shell apk lib files to new apk temp dir...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">shellApkTempDir</span><span class="o">/</span><span class="s1">&#39;lib&#39;</span><span class="p">,</span><span class="n">paths</span><span class="o">.</span><span class="n">newApkTempDir</span><span class="o">/</span><span class="s1">&#39;lib&#39;</span><span class="p">,</span><span class="n">dirs_exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># dirs_exist_ok=True 如果目标目录已存在,则覆盖</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Copy shell apk lib files success!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 5.处理AndroidManifest.xml</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Handling AndroidManifest.xml...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">handleManifest</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">srcApkTempDir</span><span class="p">,</span><span class="n">paths</span><span class="o">.</span><span class="n">shellApkTempDir</span><span class="p">,</span><span class="n">paths</span><span class="o">.</span><span class="n">newApkTempDir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Handle AndroidManifest.xml success!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 6.合并壳dex和源apk的dex并导出文件</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Combining shell dex and source dexs...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">combineShellAndSourceDexs</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">shellApkTempDir</span><span class="p">,</span><span class="n">paths</span><span class="o">.</span><span class="n">srcApkTempDir</span><span class="p">,</span><span class="n">paths</span><span class="o">.</span><span class="n">newApkTempDir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Combine shell dex and source dexs success!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 7.重打包apk</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Repacking apk...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">apktool</span><span class="o">.</span><span class="n">repackApk</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">newApkTempDir</span><span class="p">,</span><span class="n">paths</span><span class="o">.</span><span class="n">newApkPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Repack apk success!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 8.签名apk</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Signing apk...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">apktool</span><span class="o">.</span><span class="n">signApk</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">newApkPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Resign apk success!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 9.删除临时目录</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Deleting temp directories...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Delete temp directories success!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&#34;Android APK Packer&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-src&#39;</span><span class="p">,</span><span class="s1">&#39;--src-apk&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to source APK file&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-shell&#39;</span><span class="p">,</span><span class="s1">&#39;--shell-apk&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to shell APK file&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-o&#39;</span><span class="p">,</span><span class="s1">&#39;-out&#39;</span><span class="p">,</span><span class="s1">&#39;--output-apk&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Output path for packed APK (Default: ./out/&lt;src-apk&gt;_protected.apk)&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">output_apk</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">args</span><span class="o">.</span><span class="n">output_apk</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;./out&#39;</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">src_apk</span><span class="o">.</span><span class="n">stem</span><span class="o">+</span><span class="s1">&#39;_protected.apk&#39;</span><span class="p">)</span> <span class="c1"># 默认新apk名称及输出路径</span>
</span></span><span class="line"><span class="cl">    <span class="n">paths</span> <span class="o">=</span> <span class="n">Paths</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">src_apk</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">shell_apk</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">output_apk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Source APK:&#39;</span><span class="p">,</span> <span class="n">paths</span><span class="o">.</span><span class="n">srcApkPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Shell APK:&#39;</span><span class="p">,</span> <span class="n">paths</span><span class="o">.</span><span class="n">shellApkPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Output APK:&#39;</span><span class="p">,</span> <span class="n">paths</span><span class="o">.</span><span class="n">newApkPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">start</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="脱壳程序-2">脱壳程序
</h2><p>脱壳程序主要分为2个模块:</p>
<ol>
<li>Java层: 提供环境初始化,替换ClassLoader,替换Application的功能</li>
<li>Native层: 提供禁用Dex2Oat,设置Dex文件可写,代码回填,代码文件解析的功能</li>
</ol>
<p><img src="/photos%5c28-%e5%a3%b3%e7%a8%8b%e5%ba%8f.png"
	
	
	
	loading="lazy"
	
		alt="15-壳程序"
	
	
></p>
<p>经过前文加壳程序的处理后,源程序AndroidManifest.xml文件的application标签的name属性指定壳的Application,由于Application是安卓应用程序真正的入口类,所以启动加壳后的程序时控制权在壳的代理Application中.</p>
<p>在壳的代理Application中主要执行以下操作:</p>
<ol>
<li>
<p>初始化操作</p>
<p>设置相关文件路径,解析相关文件用于后续处理.</p>
</li>
<li>
<p>替换ClassLoader</p>
<p>替换壳程序的ClassLoader为被保护程序的ClassLoader.</p>
</li>
<li>
<p>替换Application</p>
<p>若被保护程序存在自定义Application则创建实例并替换.</p>
</li>
<li>
<p>加载壳so</p>
<p>调用System.loadLibrary()主动加载即可,后续在Native层执行代码回填.</p>
</li>
</ol>
<p>示意图如下</p>
<p><img src="/photos%5c29-%e5%a3%b3Application%e6%b5%81%e7%a8%8b.png"
	
	
	
	loading="lazy"
	
		alt="22-壳Application流程"
	
	
></p>
<h3 id="环境初始化">环境初始化
</h3><p>主要执行以下操作:</p>
<ol>
<li>
<p>设置相关私有目录,供后续释放文件以及设置DexClassLoader</p>
</li>
<li>
<p>从壳apk文件提取并解析被保护程序的dex文件,写入私有目录</p>
<p>调用 readDexFromApk从当前Apk文件中提取classes.dex,再调用extractDexFilesFromShellDex从中提取并分离源程序Dex文件,最后调用writeByteBuffersToDirectory将多个Dex文件依次写入私有目录.</p>
</li>
<li>
<p>从assets目录提取codes文件写入私有目录</p>
<p>调用copyClassesCodesFiles执行该操作.</p>
</li>
<li>
<p>拼接源程序所有dex文件的路径</p>
<p>用“:”分隔,拼接源程序所有dex文件路径,供后续DexClassLoader加载使用.</p>
</li>
</ol>
<p>示意图如下</p>
<p><img src="/photos%5c30-%e8%84%b1%e5%a3%b3%e7%a8%8b%e5%ba%8f%e7%8e%af%e5%a2%83%e5%88%9d%e5%a7%8b%e5%8c%96%e6%b5%81%e7%a8%8b%e5%9b%be.png"
	
	
	
	loading="lazy"
	
	
></p>
<h3 id="替换classloader">替换ClassLoader
</h3><p>主要执行以下操作:</p>
<ol>
<li>
<p>获取当前ClassLoader</p>
<p>调用this.getClassLoader()获取.</p>
</li>
<li>
<p>反射获取ActivityThread实例</p>
<p>通过反射直接获取ActivityThread.sCurrentActivityThread字段,即当前程序对应的ActivityThread实例.</p>
</li>
<li>
<p>反射获取LoadedApk实例</p>
<p>首先反射获取ActivityThread.mPackages字段,再根据当前程序的包名从中查找获取对应LoadedApk实例.</p>
</li>
<li>
<p>创建并替换ClassLoader</p>
<p>将环境初始化工作中创建的lib和dex文件的私有目录路径以及当前ClassLoader作为参数,新建DexClassLoader,该ClassLoader可用于加载之前释放的源程序Dex文件和libso文件.</p>
</li>
</ol>
<p>最后通过反射修改LoadedApk.mClassLoader实例完成替换.</p>
<p><img src="/photos%5c31-%e6%9b%bf%e6%8d%a2ClassLoader%e6%b5%81%e7%a8%8b%e5%9b%be.png"
	
	
	
	loading="lazy"
	
	
></p>
<h3 id="替换application">替换Application
</h3><p>主要执行以下操作:</p>
<ol>
<li>获取自定义Application完整类名</li>
</ol>
<p>访问3.2.2节中加壳程序为AndroidManifest.xml添加的meta-data标签,其中保存了源程序自定义的Application类名.</p>
<ol start="2">
<li>反射获取ActivityThread实例（同3.3.2）</li>
<li>反射获取LoadedApk实例,并设置mApplication为空</li>
</ol>
<p>获取LoadedApk实例同3.3.2,设置mApplication为空的原因是调用LoadedApk.makeApplication时,如果mApplication不为空,则直接返回当前的Application实例.所以想要替换Application必须先置空再创建.</p>
<ol start="4">
<li>获取ActivityThread.mInitialApplication并删除壳Application</li>
<li>反射调用LoadedApk.makeApplication创建源Application</li>
<li>重置ActivityThread.mInitialApplication为源Application</li>
<li>处理ContentProvider持有的代理Application</li>
<li>调用Application.onCreate 源程序,启动！</li>
</ol>
<p>流程图如下</p>
<p><img src="/photos%5c32-%e6%9b%bf%e6%8d%a2Application%e6%b5%81%e7%a8%8b%e5%9b%be.png"
	
	
	
	loading="lazy"
	
	
></p>
<h3 id="native层">Native层
</h3><p>调用System.loadLibrary主动加载了壳的SO文件,首先调用init函数,其中依次执行以下Hook操作（劫持对应函数）:</p>
<ol>
<li>
<p>Hook execve</p>
<p>在hook后添加判断逻辑,匹配到调用dex2oat系统调用时直接返回.</p>
<p>dex2oat是ART将所有Dex文件优化为一个OAT文件（本质为ELF文件）的操作,目的是加快指令执行速度,但这会影响加固工具执行指令回填.</p>
</li>
<li>
<p>Hook mmap</p>
<p>在mmap映射内存时添加写权限,保证可修改DexFile进行指令回填.</p>
</li>
<li>
<p>Hook LoadMethod</p>
<p>LoadMethod有两个关键参数: DexFile* dexFile和Method* method.</p>
<p>通过dexFile获取方法所在的Dex文件路径,从而判断是否为源程序被抽取了代码的Dex文件,如果是则判断是否进行过文件解析.</p>
<p>若没有解析过则调用parseExtractedCodeFiles函数解析Dex文件对应的codes文件后,便成功创建了一组CodeMap（保存codeOff和CodeItem映射）.</p>
<p>之后调用目标方法时,根据Method.codeOff从CodeMap中提取对应CodeItem并执行指令回填,dexFile.begin+Method.codeOff即为insns[]指令字节数组的位置.</p>
</li>
</ol>
<p>其中Hook主要使用Bhook和Dobby</p>
<ol>
<li>
<p>Dobby</p>
<p>参考https://github.com/luoyesiqiu/dpt-shell/blob/main/shell/src/main/cpp/CMakeLists.txt和https://www.52pojie.cn/thread-1779984-1-1.html</p>
<p>源码编译似乎有点麻烦,静态导入dobby</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">include_directories(
</span></span><span class="line"><span class="cl">        dobby
</span></span><span class="line"><span class="cl">)
</span></span><span class="line"><span class="cl">add_library(local_dobby STATIC IMPORTED)
</span></span><span class="line"><span class="cl">set_target_properties(local_dobby PROPERTIES IMPORTED_LOCATION ${CMAKE_CURRENT_SOURCE_DIR}/../../../libs/${ANDROID_ABI}/libdobby.a)
</span></span><span class="line"><span class="cl">target_link_libraries(dpt
</span></span><span class="line"><span class="cl">            ${log-lib}
</span></span><span class="line"><span class="cl">        MINIZIP::minizip
</span></span><span class="line"><span class="cl">        local_dobby
</span></span><span class="line"><span class="cl">        bytehook
</span></span><span class="line"><span class="cl">        ${android-lib}
</span></span><span class="line"><span class="cl">        )
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Bhook</p>
<p>参考https://github.com/bytedance/bhook/blob/main/README.zh-CN.md</p>
<p>build.gradle添加bhook依赖</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">android {
</span></span><span class="line"><span class="cl">    buildFeatures {
</span></span><span class="line"><span class="cl">        prefab true
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">dependencies {
</span></span><span class="line"><span class="cl">    implementation &#39;com.bytedance:bytehook:1.1.1&#39;
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>CMakeLists.txt添加如下设置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">//其中mylib 表示需要使用bhook的模块名,也就是将这些模块和bytehook链接
</span></span><span class="line"><span class="cl">find_package(bytehook REQUIRED CONFIG)  // 获取bytehook包
</span></span><span class="line"><span class="cl">add_library(mylib SHARED mylib.c)		//用户模块
</span></span><span class="line"><span class="cl">target_link_libraries(mylib bytehook::bytehook)	//链接用户模块和bytehook
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<p>Hook后的LoadMethod主要工作如下</p>
<p><img src="/photos%5c33-HookLoadMethod.png"
	
	
	
	loading="lazy"
	
		alt="25-HookLoadMethod"
	
	
></p>
<h3 id="thirdproxyapplicationjava">ThirdProxyApplication.java
</h3><p>相对FirstProxyApplication.java改动如下:</p>
<ol>
<li>
<p>System.loadLibrary(&ldquo;androidshell&rdquo;)</p>
<p>主动加载壳程序的so,设置hook</p>
</li>
<li>
<p>writeByteBuffersToDirectory</p>
<p>用于将壳dex中提取的源dex字节数组写为文件</p>
</li>
<li>
<p>copyClassesCodesFiles</p>
<p>用于将dex文件对应的codes文件复制到和dex相同的私有目录</p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.androidshell</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.app.Application</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.app.Instrumentation</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.content.Context</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.content.pm.ApplicationInfo</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.content.pm.PackageManager</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.content.res.AssetManager</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.os.Bundle</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.util.ArrayMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.util.Log</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.BufferedInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.BufferedOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ByteArrayOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.File</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.InputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.ref.WeakReference</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.nio.ByteBuffer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.nio.ByteOrder</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.ArrayList</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Iterator</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.zip.ZipEntry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.zip.ZipInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">dalvik.system.DexClassLoader</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ThirdProxyApplication</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Application</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">TAG</span><span class="o">=</span><span class="s">&#34;glass&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">dexPath</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">odexPath</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">libPath</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="p">){</span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="n">message</span><span class="p">);}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">attachBaseContext</span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="n">base</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">.</span><span class="na">attachBaseContext</span><span class="p">(</span><span class="n">base</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;ThirdProxyApplication.attachBaseContext is running!&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">loadLibrary</span><span class="p">(</span><span class="s">&#34;androidshell&#34;</span><span class="p">);</span><span class="w">     </span><span class="c1">//主动加载so,设置hook,进行指令回填</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Load libandroidshell.so succeed!&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//初始化相关环境</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">initEnvironments</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//配置加载源程序的动态环境,即替换mClassLoader</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">replaceClassLoader</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">(</span><span class="w"> </span><span class="n">Log</span><span class="p">.</span><span class="na">getStackTraceString</span><span class="p">(</span><span class="n">e</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onCreate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">.</span><span class="na">onCreate</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;ThirdProxyApplication.onCreate is running!&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">replaceApplication</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Replace Application succeed!&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initEnvironments</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//1.设置相关目录和路径</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">File</span><span class="w"> </span><span class="n">dex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getDir</span><span class="p">(</span><span class="s">&#34;tmp_dex&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">MODE_PRIVATE</span><span class="p">);</span><span class="w">     </span><span class="c1">// 私有目录,存放dex文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//File lib = getDir(&#34;tmp_lib&#34;, MODE_PRIVATE);       // lib可使用默认目录</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//libPath = lib.getAbsolutePath();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">odexPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dex</span><span class="p">.</span><span class="na">getAbsolutePath</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">libPath</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="na">getApplicationInfo</span><span class="p">().</span><span class="na">nativeLibraryDir</span><span class="p">;</span><span class="w"> </span><span class="c1">//默认lib路径</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">dexPath</span><span class="w"> </span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="na">getApplicationInfo</span><span class="p">().</span><span class="na">sourceDir</span><span class="p">;</span><span class="w">   </span><span class="c1">//当前base.apk路径</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//2.从当前base.apk读取classes.dex并读取为字节数组</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">shellDexData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readDexFromApk</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Get classes.dex from base.apk succeed!&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//3.从壳dex文件中分离出源dex文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ByteBuffer</span><span class="o">[]</span><span class="w"> </span><span class="n">byteBuffers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extractDexFilesFromShellDex</span><span class="p">(</span><span class="n">shellDexData</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//4.将源dex文件依次写入私有目录</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">writeByteBuffersToDirectory</span><span class="p">(</span><span class="n">byteBuffers</span><span class="p">,</span><span class="w"> </span><span class="n">odexPath</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//5.将codes文件依次写入私有目录</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">copyClassesCodesFiles</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">odexPath</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//6.拼接dex目录字符串,设置dex文件路径 DexClassLoader支持传递多个dex文件路径以加载多个dex文件,通过&#39;:&#39;分隔路径</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">StringBuffer</span><span class="w"> </span><span class="n">dexFiles</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">StringBuffer</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">File</span><span class="w"> </span><span class="n">file</span><span class="p">:</span><span class="n">dex</span><span class="p">.</span><span class="na">listFiles</span><span class="p">()){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="na">getName</span><span class="p">().</span><span class="na">contains</span><span class="p">(</span><span class="s">&#34;.codes&#34;</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">continue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">dexFiles</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="na">getAbsolutePath</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">dexFiles</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="s">&#34;:&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">dexPath</span><span class="o">=</span><span class="n">dexFiles</span><span class="p">.</span><span class="na">toString</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">writeByteBuffersToDirectory</span><span class="p">(</span><span class="n">ByteBuffer</span><span class="o">[]</span><span class="w"> </span><span class="n">byteBuffers</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">directoryPath</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 创建目录对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">File</span><span class="w"> </span><span class="n">directory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">directoryPath</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 检查目录是否存在,不存在则创建</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">directory</span><span class="p">.</span><span class="na">exists</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">directory</span><span class="p">.</span><span class="na">mkdirs</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IOException</span><span class="p">(</span><span class="s">&#34;无法创建目录: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">directoryPath</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 遍历 ByteBuffer 数组</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">byteBuffers</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 生成文件名</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">fileName</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">fileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;classes.dex&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">fileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;classes&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;.dex&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 构建文件对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">File</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span><span class="w"> </span><span class="n">fileName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 创建文件输出流</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">(</span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">fos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="n">file</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// 获取 ByteBuffer 中的字节数组</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">ByteBuffer</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">byteBuffers</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="n">buffer</span><span class="p">.</span><span class="na">remaining</span><span class="p">()</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">buffer</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">bytes</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// 将字节数组写入文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">fos</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">bytes</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">copyClassesCodesFiles</span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">targetDirectoryPath</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">AssetManager</span><span class="w"> </span><span class="n">assetManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getAssets</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 获取 assets 目录下的所有文件和文件夹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">assetManager</span><span class="p">.</span><span class="na">list</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">files</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// 创建目标目录</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">File</span><span class="w"> </span><span class="n">targetDirectory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">targetDirectoryPath</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">targetDirectory</span><span class="p">.</span><span class="na">exists</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">targetDirectory</span><span class="p">.</span><span class="na">mkdirs</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IOException</span><span class="p">(</span><span class="s">&#34;无法创建目标目录: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">targetDirectoryPath</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">fileName</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">files</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">// 筛选以 classes 开头且以 .codes 结尾的文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fileName</span><span class="p">.</span><span class="na">startsWith</span><span class="p">(</span><span class="s">&#34;classes&#34;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">fileName</span><span class="p">.</span><span class="na">endsWith</span><span class="p">(</span><span class="s">&#34;.codes&#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">try</span><span class="w"> </span><span class="p">(</span><span class="n">InputStream</span><span class="w"> </span><span class="n">inputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">assetManager</span><span class="p">.</span><span class="na">open</span><span class="p">(</span><span class="n">fileName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                             </span><span class="n">BufferedInputStream</span><span class="w"> </span><span class="n">bis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BufferedInputStream</span><span class="p">(</span><span class="n">inputStream</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                             </span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">fos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">targetDirectory</span><span class="p">,</span><span class="w"> </span><span class="n">fileName</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                             </span><span class="n">BufferedOutputStream</span><span class="w"> </span><span class="n">bos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BufferedOutputStream</span><span class="p">(</span><span class="n">fos</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="n">1024</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="kt">int</span><span class="w"> </span><span class="n">bytesRead</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">bytesRead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bis</span><span class="p">.</span><span class="na">read</span><span class="p">(</span><span class="n">buffer</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">-</span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                </span><span class="n">bos</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">bytesRead</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 从壳dex文件中提取源apk的dex并封装为ByteBuffer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ByteBuffer</span><span class="o">[]</span><span class="w"> </span><span class="nf">extractDexFilesFromShellDex</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">shellDexData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">shellDexlength</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shellDexData</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//开始解析dex文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">sourceDexsSizeByte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="n">4</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//读取源dexs的大小</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">arraycopy</span><span class="p">(</span><span class="n">shellDexData</span><span class="p">,</span><span class="n">shellDexlength</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">4</span><span class="p">,</span><span class="w"> </span><span class="n">sourceDexsSizeByte</span><span class="p">,</span><span class="n">0</span><span class="p">,</span><span class="n">4</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//转成bytebuffer,方便4byte转int</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ByteBuffer</span><span class="w"> </span><span class="n">wrap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ByteBuffer</span><span class="p">.</span><span class="na">wrap</span><span class="p">(</span><span class="n">sourceDexsSizeByte</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//将byte转成int, 加壳时,长度按小端存储</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">sourceDexsSizeInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wrap</span><span class="p">.</span><span class="na">order</span><span class="p">(</span><span class="n">ByteOrder</span><span class="p">.</span><span class="na">LITTLE_ENDIAN</span><span class="p">).</span><span class="na">getInt</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;源dex集合的大小: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sourceDexsSizeInt</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//读取源dexs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">sourceDexsData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="n">sourceDexsSizeInt</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">arraycopy</span><span class="p">(</span><span class="n">shellDexData</span><span class="p">,</span><span class="n">shellDexlength</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sourceDexsSizeInt</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">4</span><span class="p">,</span><span class="w"> </span><span class="n">sourceDexsData</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">sourceDexsSizeInt</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//解密源dexs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">sourceDexsData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decrypt</span><span class="p">(</span><span class="n">sourceDexsData</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//更新部分</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//从源dexs中分离dex</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[]&gt;</span><span class="w"> </span><span class="n">sourceDexList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">while</span><span class="p">(</span><span class="n">pos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">sourceDexsSizeInt</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//先提取四个字节,描述当前dex的大小</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//开始解析dex文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">singleDexSizeByte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="n">4</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//读取源dexs的大小</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">arraycopy</span><span class="p">(</span><span class="n">sourceDexsData</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">singleDexSizeByte</span><span class="p">,</span><span class="n">0</span><span class="p">,</span><span class="n">4</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//转成bytebuffer,方便4byte转int</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ByteBuffer</span><span class="w"> </span><span class="n">singleDexwrap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ByteBuffer</span><span class="p">.</span><span class="na">wrap</span><span class="p">(</span><span class="n">singleDexSizeByte</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">singleDexSizeInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">singleDexwrap</span><span class="p">.</span><span class="na">order</span><span class="p">(</span><span class="n">ByteOrder</span><span class="p">.</span><span class="na">LITTLE_ENDIAN</span><span class="p">).</span><span class="na">getInt</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;当前Dex的大小: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">singleDexSizeInt</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//读取单独dex</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">singleDexData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="n">singleDexSizeInt</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">arraycopy</span><span class="p">(</span><span class="n">sourceDexsData</span><span class="p">,</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">4</span><span class="p">,</span><span class="w"> </span><span class="n">singleDexData</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">singleDexSizeInt</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//加入到dexlist中</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">sourceDexList</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">singleDexData</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//更新pos</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">pos</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">singleDexSizeInt</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//将dexlist包装成ByteBuffer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">dexNum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sourceDexList</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;源dex的数量: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dexNum</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ByteBuffer</span><span class="o">[]</span><span class="w"> </span><span class="n">dexBuffers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ByteBuffer</span><span class="o">[</span><span class="n">dexNum</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dexNum</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">dexBuffers</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ByteBuffer</span><span class="p">.</span><span class="na">wrap</span><span class="p">(</span><span class="n">sourceDexList</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">dexBuffers</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 从当前程序的apk读取dex文件并存储为字节数组</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="nf">readDexFromApk</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//1.获取当前应用程序的源码路径(apk),一般是data/app目录下,该目录用于存放用户安装的软件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">sourceDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">getApplicationInfo</span><span class="p">().</span><span class="na">sourceDir</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;this.getApplicationInfo().sourceDir: &#34;</span><span class="w"> </span><span class="o">+</span><span class="n">sourceDir</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//2.创建相关输入流</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileInputStream</span><span class="w"> </span><span class="n">fileInputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileInputStream</span><span class="p">(</span><span class="n">sourceDir</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">BufferedInputStream</span><span class="w"> </span><span class="n">bufferedInputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BufferedInputStream</span><span class="p">(</span><span class="n">fileInputStream</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ZipInputStream</span><span class="w"> </span><span class="n">zipInputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ZipInputStream</span><span class="p">(</span><span class="n">bufferedInputStream</span><span class="p">);</span><span class="w"> </span><span class="c1">//用于解析apk文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ByteArrayOutputStream</span><span class="w"> </span><span class="n">byteArrayOutputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ByteArrayOutputStream</span><span class="p">();</span><span class="w"> </span><span class="c1">//用于存放dex文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//3.遍历apk的所有文件并提取dex文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ZipEntry</span><span class="w"> </span><span class="n">zipEntry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">while</span><span class="p">((</span><span class="n">zipEntry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zipInputStream</span><span class="p">.</span><span class="na">getNextEntry</span><span class="p">())</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">){</span><span class="w"> </span><span class="c1">//存在下一个文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 将classes.dex文件存储到bytearray中 壳dex和源apk合并后只保留一个dex便于处理</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">zipEntry</span><span class="p">.</span><span class="na">getName</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="s">&#34;classes.dex&#34;</span><span class="p">)){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="n">1024</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">num</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">while</span><span class="p">((</span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zipInputStream</span><span class="p">.</span><span class="na">read</span><span class="p">(</span><span class="n">bytes</span><span class="p">))</span><span class="o">!=-</span><span class="n">1</span><span class="p">){</span><span class="w">      </span><span class="c1">//每次读取1024byte,返回读取到的byte数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">byteArrayOutputStream</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">num</span><span class="p">);</span><span class="w"> </span><span class="c1">//存放到开辟的byteArrayOutputStream中</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">zipInputStream</span><span class="p">.</span><span class="na">closeEntry</span><span class="p">();</span><span class="w"> </span><span class="c1">//关闭当前文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">zipInputStream</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Read dex from apk succeed!&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">byteArrayOutputStream</span><span class="p">.</span><span class="na">toByteArray</span><span class="p">();</span><span class="w"> </span><span class="c1">//将读取到的dex文件以字节数组形式返回</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 解密</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="nf">decrypt</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">data</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="n">0xff</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">data</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//替换壳程序LoadedApk的Application为源程序Application,并调用其onCreate方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">replaceApplication</span><span class="p">(){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Application实例存在于: LoadedApk.mApplication</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 以及ActivityThread的mInitialApplication和mAllApplications和mBoundApplication</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//判断源程序是否使用自定义Application 若使用则需要进行替换,若未使用则直接返回,使用壳的默认Application即可</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">appClassName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"> </span><span class="c1">//源程序的Application类名</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//获取AndroidManifest.xml 文件中的 &lt;meta-data&gt; 元素</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ApplicationInfo</span><span class="w"> </span><span class="n">applicationInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getPackageManager</span><span class="p">().</span><span class="na">getApplicationInfo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">getPackageName</span><span class="p">(),</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">GET_META_DATA</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Bundle</span><span class="w"> </span><span class="n">metaData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applicationInfo</span><span class="p">.</span><span class="na">metaData</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//获取xml文件声明的Application类</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">metaData</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">metaData</span><span class="p">.</span><span class="na">containsKey</span><span class="p">(</span><span class="s">&#34;APPLICATION_CLASS_NAME&#34;</span><span class="p">)){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">appClassName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metaData</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&#34;APPLICATION_CLASS_NAME&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;源程序中没有自定义Application&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="c1">//如果不存在直接返回,使用壳的application即可</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">PackageManager</span><span class="p">.</span><span class="na">NameNotFoundException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">(</span><span class="n">Log</span><span class="p">.</span><span class="na">getStackTraceString</span><span class="p">(</span><span class="n">e</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//源程序存在自定义application类,开始替换</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Try to replace Application&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//1.反射获取ActivityThread实例</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">sCurrentActivityThreadObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">getStaticField</span><span class="p">(</span><span class="s">&#34;android.app.ActivityThread&#34;</span><span class="p">,</span><span class="s">&#34;sCurrentActivityThread&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;ActivityThread: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sCurrentActivityThreadObj</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//2.获取并设置LoadedApk</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//获取mBoundApplication (AppBindData对象)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">mBoundApplicationObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">getField</span><span class="p">(</span><span class="s">&#34;android.app.ActivityThread&#34;</span><span class="p">,</span><span class="n">sCurrentActivityThreadObj</span><span class="p">,</span><span class="s">&#34;mBoundApplication&#34;</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;mBoundApplication: &#34;</span><span class="o">+</span><span class="n">mBoundApplicationObj</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//获取mBoundApplication.info (即LoadedApk)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">infoObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">getField</span><span class="p">(</span><span class="s">&#34;android.app.ActivityThread$AppBindData&#34;</span><span class="p">,</span><span class="n">mBoundApplicationObj</span><span class="p">,</span><span class="s">&#34;info&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="w"> </span><span class="s">&#34;LoadedApk: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">infoObj</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//把LoadedApk的mApplication设置为null,这样后续才能调用makeApplication() 否则由于已存在Application,无法进行替换</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reflection</span><span class="p">.</span><span class="na">setField</span><span class="p">(</span><span class="s">&#34;android.app.LoadedApk&#34;</span><span class="p">,</span><span class="s">&#34;mApplication&#34;</span><span class="p">,</span><span class="n">infoObj</span><span class="p">,</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//3.获取ActivityThread.mInitialApplication 即拿到旧的Application(对于要加载的Application来讲)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">mInitialApplicationObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">getField</span><span class="p">(</span><span class="s">&#34;android.app.ActivityThread&#34;</span><span class="p">,</span><span class="n">sCurrentActivityThreadObj</span><span class="p">,</span><span class="s">&#34;mInitialApplication&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;mInitialApplicationObj: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mInitialApplicationObj</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//4.获取ActivityThread.mAllApplications并删除旧的application</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Application</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mAllApplicationsObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Application</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">getField</span><span class="p">(</span><span class="s">&#34;android.app.ActivityThread&#34;</span><span class="p">,</span><span class="n">sCurrentActivityThreadObj</span><span class="p">,</span><span class="s">&#34;mAllApplications&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">mAllApplicationsObj</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">mInitialApplicationObj</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;mInitialApplication 从 mAllApplications 中移除成功&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//5.重置相关类的Application类名 便于后续创建Application</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//获取LoadedApk.mApplicationInfo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ApplicationInfo</span><span class="w"> </span><span class="n">applicationInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ApplicationInfo</span><span class="p">)</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">getField</span><span class="p">(</span><span class="s">&#34;android.app.LoadedApk&#34;</span><span class="p">,</span><span class="n">infoObj</span><span class="p">,</span><span class="s">&#34;mApplicationInfo&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="w"> </span><span class="s">&#34;LoadedApk.mApplicationInfo: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">applicationInfo</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//获取mBoundApplication.appInfo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ApplicationInfo</span><span class="w"> </span><span class="n">appinfoInAppBindData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ApplicationInfo</span><span class="p">)</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">getField</span><span class="p">(</span><span class="s">&#34;android.app.ActivityThread$AppBindData&#34;</span><span class="p">,</span><span class="n">mBoundApplicationObj</span><span class="p">,</span><span class="s">&#34;appInfo&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;ActivityThread.mBoundApplication.appInfo: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">appinfoInAppBindData</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//此处通过引用修改值,虽然后续没有使用,但是实际上是修改其指向的LoadedApk相关字段的值</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//设置两个appinfo的classname为源程序的application类名,以便后续调用makeApplication()创建源程序的application</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">applicationInfo</span><span class="p">.</span><span class="na">className</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">appClassName</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">appinfoInAppBindData</span><span class="p">.</span><span class="na">className</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">appClassName</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Source Application name: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">appClassName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//6.反射调用makeApplication方法创建源程序的application</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Application</span><span class="w"> </span><span class="n">application</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Application</span><span class="p">)</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">invokeMethod</span><span class="p">(</span><span class="s">&#34;android.app.LoadedApk&#34;</span><span class="p">,</span><span class="s">&#34;makeApplication&#34;</span><span class="p">,</span><span class="n">infoObj</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="kt">boolean</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Instrumentation</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="kc">false</span><span class="p">,</span><span class="kc">null</span><span class="p">});</span><span class="w"> </span><span class="c1">//使用源程序中的application</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//Application app = (Application)ReflectionMethods.invokeMethod(&#34;android.app.LoadedApk&#34;,&#34;makeApplication&#34;,infoObj,new Class[]{boolean.class, Instrumentation.class},new Object[]{true,null}); //使用自定义的application 强制为系统默认</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Create source Application succeed: &#34;</span><span class="o">+</span><span class="n">application</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//7.重置ActivityThread.mInitialApplication为新的Application</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reflection</span><span class="p">.</span><span class="na">setField</span><span class="p">(</span><span class="s">&#34;android.app.ActivityThread&#34;</span><span class="p">,</span><span class="s">&#34;mInitialApplication&#34;</span><span class="p">,</span><span class="n">sCurrentActivityThreadObj</span><span class="p">,</span><span class="n">application</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Reset ActivityThread.mInitialApplication by new Application succeed!&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//8.ContentProvider会持有代理的Application,需要特殊处理一下</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ArrayMap</span><span class="w"> </span><span class="n">mProviderMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ArrayMap</span><span class="p">)</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">getField</span><span class="p">(</span><span class="s">&#34;android.app.ActivityThread&#34;</span><span class="p">,</span><span class="n">sCurrentActivityThreadObj</span><span class="p">,</span><span class="s">&#34;mProviderMap&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;ActivityThread.mProviderMap: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mProviderMap</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//获取所有provider,装进迭代器中遍历</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Iterator</span><span class="w"> </span><span class="n">iterator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mProviderMap</span><span class="p">.</span><span class="na">values</span><span class="p">().</span><span class="na">iterator</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">while</span><span class="p">(</span><span class="n">iterator</span><span class="p">.</span><span class="na">hasNext</span><span class="p">()){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Object</span><span class="w"> </span><span class="n">providerClientRecord</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iterator</span><span class="p">.</span><span class="na">next</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//获取ProviderClientRecord.mLocalProvider,可能为空</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Object</span><span class="w"> </span><span class="n">mLocalProvider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">getField</span><span class="p">(</span><span class="s">&#34;android.app.ActivityThread$ProviderClientRecord&#34;</span><span class="p">,</span><span class="n">providerClientRecord</span><span class="p">,</span><span class="s">&#34;mLocalProvider&#34;</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">mLocalProvider</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;ProviderClientRecord.mLocalProvider: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mLocalProvider</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">//获取ContentProvider中的mContext字段,设置为新的Application</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Reflection</span><span class="p">.</span><span class="na">setField</span><span class="p">(</span><span class="s">&#34;android.content.ContentProvider&#34;</span><span class="p">,</span><span class="s">&#34;mContext&#34;</span><span class="p">,</span><span class="n">mLocalProvider</span><span class="p">,</span><span class="n">application</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="w"> </span><span class="s">&#34;Run Application.onCreate&#34;</span><span class="w"> </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">application</span><span class="p">.</span><span class="na">onCreate</span><span class="p">();</span><span class="w"> </span><span class="c1">//源程序,启动!</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 替换壳App的ClassLoader为源App的ClassLoader</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">replaceClassLoader</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//1.获取当前的classloader</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">classLoader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">getClassLoader</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Current ClassLoader: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">classLoader</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Parent ClassLoader: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">classLoader</span><span class="p">.</span><span class="na">getParent</span><span class="p">().</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//2.反射获取ActivityThread</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">sCurrentActivityThreadObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">getStaticField</span><span class="p">(</span><span class="s">&#34;android.app.ActivityThread&#34;</span><span class="p">,</span><span class="s">&#34;sCurrentActivityThread&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;ActivityThread.sCurrentActivityThread: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sCurrentActivityThreadObj</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//3.反射获取LoadedApk</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//获取当前ActivityThread实例的mPackages字段 类型为ArrayMap&lt;String, WeakReference&lt;LoadedApk&gt;&gt;, 里面存放了当前应用的LoadedApk对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ArrayMap</span><span class="w"> </span><span class="n">mPackagesObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ArrayMap</span><span class="p">)</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">getField</span><span class="p">(</span><span class="s">&#34;android.app.ActivityThread&#34;</span><span class="p">,</span><span class="n">sCurrentActivityThreadObj</span><span class="p">,</span><span class="s">&#34;mPackages&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="w"> </span><span class="s">&#34;mPackagesObj: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mPackagesObj</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//获取mPackages中的当前应用包名</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">currentPackageName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">getPackageName</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;currentPackageName: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">currentPackageName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 获取loadedApk实例也有好几种,mInitialApplication mAllApplications mPackages</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 通过包名获取当前应用的loadedApk实例</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">WeakReference</span><span class="w"> </span><span class="n">weakReference</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">WeakReference</span><span class="p">)</span><span class="w"> </span><span class="n">mPackagesObj</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">currentPackageName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">loadedApkObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">weakReference</span><span class="p">.</span><span class="na">get</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="w"> </span><span class="s">&#34;LoadedApk: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">loadedApkObj</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//4.替换ClassLoader</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">DexClassLoader</span><span class="w"> </span><span class="n">dexClassLoader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DexClassLoader</span><span class="p">(</span><span class="n">dexPath</span><span class="p">,</span><span class="w"> </span><span class="n">odexPath</span><span class="p">,</span><span class="n">libPath</span><span class="p">,</span><span class="w"> </span><span class="n">classLoader</span><span class="p">.</span><span class="na">getParent</span><span class="p">());</span><span class="w"> </span><span class="c1">//动态加载源程序的dex文件,以当前classloader的父加载器作为parent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reflection</span><span class="p">.</span><span class="na">setField</span><span class="p">(</span><span class="s">&#34;android.app.LoadedApk&#34;</span><span class="p">,</span><span class="s">&#34;mClassLoader&#34;</span><span class="p">,</span><span class="n">loadedApkObj</span><span class="p">,</span><span class="n">dexClassLoader</span><span class="p">);</span><span class="w"> </span><span class="c1">//替换当前loadedApk实例中的mClassLoader字段</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;New DexClassLoader: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dexClassLoader</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="shellcpp">shell.cpp
</h3><p>主要提供以下功能:</p>
<ol>
<li>
<p>hook execve</p>
<p>主要目的是禁止dex2oat,防止dex文件被优化</p>
</li>
<li>
<p>hook mmap</p>
<p>使dex文件可写,用于后续指令回填</p>
</li>
<li>
<p>hook LoadMethod</p>
<p>loadmethod用于加载dex文件的方法,可获取dex文件引用和codeoff</p>
<p>hook劫持后执行codes文件解析和指令回填</p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;jni.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;map&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fstream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;elf.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;dlfcn.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;android/log.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;sys/mman.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;bytehook.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;dobby/dobby.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;dex/DexFile.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;dex/CodeItem.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;dex/class_accessor.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define TAG &#34;glass&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define logd(...) __android_log_print(ANDROID_LOG_DEBUG, TAG, __VA_ARGS__);
</span></span></span><span class="line"><span class="cl"><span class="cp">#define logi(...) __android_log_print(ANDROID_LOG_INFO , TAG, __VA_ARGS__);
</span></span></span><span class="line"><span class="cl"><span class="cp">#define loge(...) __android_log_print(ANDROID_LOG_ERROR, TAG, __VA_ARGS__);
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// sdk版本,用于兼容适配
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="n">APILevel</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 函数声明
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">hook</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">hookExecve</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">hookMmap</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">hook_LoadMethod</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 抽取代码文件,与源.dex在同一私有目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">codeFilePostfix</span> <span class="o">=</span> <span class="s">&#34;.codes&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//dex文件名-&gt;codeOff-&gt;CodeItem 每个dex文件对应一个map,每个map内的codeoff对应一个CodeItem
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="p">,</span> <span class="n">CodeItem</span><span class="o">&gt;&gt;</span> <span class="n">codeMapList</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//art/runtime/class_linker.h
</span></span></span><span class="line"><span class="cl"><span class="c1">// 函数声明
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="nf">void</span> <span class="p">(</span><span class="o">*</span><span class="n">g_originLoadMethod</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span> <span class="n">thiz</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="k">const</span> <span class="n">DexFile</span><span class="o">*</span> <span class="n">dex_file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">ClassAccessor</span><span class="o">::</span><span class="n">Method</span><span class="o">*</span> <span class="n">method</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="kt">void</span><span class="o">*</span> <span class="n">klass</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="kt">void</span><span class="o">*</span> <span class="n">dst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*//Android 10-14 原型如下
</span></span></span><span class="line"><span class="cl"><span class="cm">void LoadMethod(const DexFile&amp; dex_file,
</span></span></span><span class="line"><span class="cl"><span class="cm">                const ClassAccessor::Method&amp; method,
</span></span></span><span class="line"><span class="cl"><span class="cm">                Handle&lt;mirror::Class&gt; klass,
</span></span></span><span class="line"><span class="cl"><span class="cm">                ArtMethod* dst);
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Tool functions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// 以二进制形式读取整个文件,返回字节数组并返回文件长度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">uint8_t</span><span class="o">*</span> <span class="nf">readFileToBytes</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">fileName</span><span class="p">,</span><span class="n">size_t</span><span class="o">*</span> <span class="n">readSize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">FILE</span> <span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">fileName</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">file</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">logd</span><span class="p">(</span><span class="s">&#34;Error opening file&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">fclose</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">fseek</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="n">SEEK_END</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">size_t</span> <span class="n">fileSize</span> <span class="o">=</span> <span class="n">ftell</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">fseek</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="n">SEEK_SET</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="n">fileSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">logd</span><span class="p">(</span><span class="s">&#34;Error allocating memory</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">fclose</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">size_t</span> <span class="n">bytesRead</span> <span class="o">=</span> <span class="n">fread</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fileSize</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">bytesRead</span><span class="o">!=</span><span class="n">fileSize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">logd</span><span class="p">(</span><span class="s">&#34;Read bytes not equal file size!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">free</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">fclose</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">fclose</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">readSize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">readSize</span><span class="o">=</span><span class="n">bytesRead</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 4字节数组转uint32_t
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">uint32_t</span> <span class="nf">bytes2uint32</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">bytes</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">retnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span><span class="n">i</span> <span class="o">&gt;=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">--</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">retnum</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">retnum</span> <span class="o">|=</span> <span class="n">bytes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">retnum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="nf">getArtLibPath</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">APILevel</span> <span class="o">&lt;</span> <span class="mi">29</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;/system/lib64/libart.so&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">APILevel</span> <span class="o">==</span> <span class="mi">29</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;/apex/com.android.runtime/lib64/libart.so&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;/apex/com.android.art/lib64/libart.so&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="nf">getArtBaseLibPath</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">APILevel</span> <span class="o">==</span> <span class="mi">29</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;/apex/com.android.runtime/lib64/libartbase.so&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;/apex/com.android.art/lib64/libartbase.so&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="nf">find_symbol_in_elf_file</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">elf_file</span><span class="p">,</span><span class="kt">int</span> <span class="n">keyword_count</span><span class="p">,...)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">FILE</span> <span class="o">*</span><span class="n">elf_fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">elf_file</span><span class="p">,</span> <span class="s">&#34;r&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">elf_fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 获取elf文件大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">fseek</span><span class="p">(</span><span class="n">elf_fp</span><span class="p">,</span> <span class="mi">0L</span><span class="p">,</span> <span class="n">SEEK_END</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">size_t</span> <span class="n">lib_size</span> <span class="o">=</span> <span class="n">ftell</span><span class="p">(</span><span class="n">elf_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">fseek</span><span class="p">(</span><span class="n">elf_fp</span><span class="p">,</span> <span class="mi">0L</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 读取elf文件数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">calloc</span><span class="p">(</span><span class="n">lib_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">fread</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lib_size</span><span class="p">,</span> <span class="n">elf_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">char</span> <span class="o">*</span><span class="n">elf_bytes_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// elf头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Elf64_Ehdr</span> <span class="o">*</span><span class="n">ehdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">Elf64_Ehdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">elf_bytes_data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 节头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Elf64_Shdr</span> <span class="o">*</span><span class="n">shdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">Elf64_Shdr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">elf_bytes_data</span><span class="p">)</span> <span class="o">+</span> <span class="n">ehdr</span><span class="o">-&gt;</span><span class="n">e_shoff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">va_list</span> <span class="n">kw_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 遍历节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ehdr</span><span class="o">-&gt;</span><span class="n">e_shnum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 字符串表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">shdr</span><span class="o">-&gt;</span><span class="n">sh_type</span> <span class="o">==</span> <span class="n">SHT_STRTAB</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">elf_bytes_data</span> <span class="o">+</span> <span class="n">shdr</span><span class="o">-&gt;</span><span class="n">sh_offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">str_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 遍历字符串表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ptr</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">str_base</span> <span class="o">+</span> <span class="n">shdr</span><span class="o">-&gt;</span><span class="n">sh_size</span><span class="p">);</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">item_value</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">size_t</span> <span class="n">item_len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">item_value</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ptr</span> <span class="o">+=</span> <span class="p">(</span><span class="n">item_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="n">item_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="kt">int</span> <span class="n">match_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">va_start</span><span class="p">(</span><span class="n">kw_list</span><span class="p">,</span> <span class="n">keyword_count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">keyword_count</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">keyword</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">kw_list</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">item_value</span><span class="p">,</span> <span class="n">keyword</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">match_count</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="n">va_end</span><span class="p">(</span><span class="n">kw_list</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="n">match_count</span> <span class="o">==</span> <span class="n">keyword_count</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="n">item_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">shdr</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">fclose</span><span class="p">(</span><span class="n">elf_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">free</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="nf">getClassLinkerDefineClassLibPath</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">getArtLibPath</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="nf">getClassLinkerDefineClassSymbol</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">sym</span> <span class="o">=</span> <span class="n">find_symbol_in_elf_file</span><span class="p">(</span><span class="n">getClassLinkerDefineClassLibPath</span><span class="p">(),</span><span class="mi">2</span><span class="p">,</span><span class="s">&#34;ClassLinker&#34;</span><span class="p">,</span><span class="s">&#34;DefineClass&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">sym</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="nf">getClassLinkerLoadMethodLibPath</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">getArtLibPath</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//获取ClassLinker::LoadMethod真实符号名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="nf">getClassLinkerLoadMethodSymbol</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">sym</span> <span class="o">=</span> <span class="n">find_symbol_in_elf_file</span><span class="p">(</span><span class="n">getClassLinkerLoadMethodLibPath</span><span class="p">(),</span><span class="mi">2</span><span class="p">,</span><span class="s">&#34;ClassLinker&#34;</span><span class="p">,</span><span class="s">&#34;LoadMethod&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">sym</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//获取libart真实名称
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="nf">getArtLibName</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//Android 10及以后变为libartbase.so
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">APILevel</span> <span class="o">&gt;=</span> <span class="mi">29</span> <span class="o">?</span> <span class="s">&#34;libartbase.so&#34;</span> <span class="o">:</span> <span class="s">&#34;libart.so&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 禁用dex2oat
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">fakeExecve</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pathname</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">argv</span><span class="p">[],</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">envp</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">BYTEHOOK_STACK_SCOPE</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 禁用dex2oat
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">pathname</span><span class="p">,</span> <span class="s">&#34;dex2oat&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">errno</span> <span class="o">=</span> <span class="n">EACCES</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">BYTEHOOK_CALL_PREV</span><span class="p">(</span><span class="n">fakeExecve</span><span class="p">,</span> <span class="n">pathname</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">envp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">hookExecve</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="n">bytehook_stub_t</span> <span class="n">stub</span> <span class="o">=</span> <span class="n">bytehook_hook_single</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">getArtLibName</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;libc.so&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;execve&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">fakeExecve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="k">nullptr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">stub</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">logd</span><span class="p">(</span><span class="s">&#34;hook execve done&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//为dex文件添加可写权限
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span><span class="o">*</span> <span class="nf">fakeMmap</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">__addr</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">__size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__prot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__fd</span><span class="p">,</span> <span class="n">off_t</span> <span class="n">__offset</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">BYTEHOOK_STACK_SCOPE</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">prot</span> <span class="o">=</span> <span class="n">__prot</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">hasRead</span> <span class="o">=</span> <span class="p">(</span><span class="n">__prot</span> <span class="o">&amp;</span> <span class="n">PROT_READ</span><span class="p">)</span> <span class="o">==</span> <span class="n">PROT_READ</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">hasWrite</span> <span class="o">=</span> <span class="p">(</span><span class="n">__prot</span> <span class="o">&amp;</span> <span class="n">PROT_WRITE</span><span class="p">)</span> <span class="o">==</span> <span class="n">PROT_WRITE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 添加写权限
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">hasRead</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hasWrite</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">prot</span> <span class="o">|=</span> <span class="n">PROT_WRITE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="o">*</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">BYTEHOOK_CALL_PREV</span><span class="p">(</span><span class="n">fakeMmap</span><span class="p">,</span> <span class="n">__addr</span><span class="p">,</span> <span class="n">__size</span><span class="p">,</span> <span class="n">prot</span><span class="p">,</span> <span class="n">__flags</span><span class="p">,</span> <span class="n">__fd</span><span class="p">,</span> <span class="n">__offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">hookMmap</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="n">bytehook_stub_t</span> <span class="n">stub</span> <span class="o">=</span> <span class="n">bytehook_hook_single</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">getArtLibName</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;libc.so&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;mmap&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">fakeMmap</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="k">nullptr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">stub</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">logd</span><span class="p">(</span><span class="s">&#34;hook mmap done&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 解析抽取代码文件,每个dex.codes只解析一次
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">parseExtractedCodeFiles</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">dexPath</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//1.读取代码文件为字节数组
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">codeFilePath</span><span class="o">=</span><span class="n">dexPath</span><span class="o">+</span><span class="n">codeFilePostfix</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">logd</span><span class="p">(</span><span class="s">&#34;Code File Path: %s&#34;</span><span class="p">,</span><span class="n">codeFilePath</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">size_t</span> <span class="n">codeBytesLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">codeBytes</span> <span class="o">=</span> <span class="n">readFileToBytes</span><span class="p">(</span><span class="n">codeFilePath</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">codeBytesLen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">codeBytes</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">||</span> <span class="n">codeBytesLen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">logd</span><span class="p">(</span><span class="s">&#34;Code file not found!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">logd</span><span class="p">(</span><span class="s">&#34;CodeFile: %s Len:%#llx&#34;</span><span class="p">,</span> <span class="n">codeFilePath</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="n">codeBytesLen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 2.解析代码字节数组
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">size_t</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span><span class="n">offset</span><span class="o">&lt;</span><span class="n">codeBytesLen</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">pointer</span> <span class="o">=</span> <span class="n">codeBytes</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>  <span class="c1">//每个结构的起点指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">uint32_t</span> <span class="n">codeOff</span> <span class="o">=</span> <span class="n">bytes2uint32</span><span class="p">(</span><span class="n">pointer</span><span class="p">);</span> <span class="c1">// 4字节CodeOff和4字节InsnSize
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">uint32_t</span> <span class="n">insnSize</span> <span class="o">=</span> <span class="n">bytes2uint32</span><span class="p">(</span><span class="n">pointer</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">codeOff</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">insnSize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">logd</span><span class="p">(</span><span class="s">&#34;CodeOff or InsnSize equals 0!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">logd</span><span class="p">(</span><span class="s">&#34;CodeOff: %#x InsnSize: %#x&#34;</span><span class="p">,</span> <span class="n">codeOff</span><span class="p">,</span> <span class="n">insnSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 创建抽取代码对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">CodeItem</span> <span class="n">codeItem</span> <span class="o">=</span> <span class="n">CodeItem</span><span class="p">(</span><span class="n">insnSize</span><span class="p">,</span> <span class="n">pointer</span><span class="o">+</span><span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 添加一组CodeOff:CodeItem映射
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">codeMapList</span><span class="p">[</span><span class="n">dexPath</span><span class="p">].</span><span class="n">insert</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="p">,</span> <span class="n">CodeItem</span><span class="o">&gt;</span><span class="p">(</span><span class="n">codeOff</span><span class="p">,</span> <span class="n">codeItem</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">logd</span><span class="p">(</span><span class="s">&#34;CodeItem codeOff: %#x insnSize: %#x has created!&#34;</span><span class="p">,</span> <span class="n">codeOff</span><span class="p">,</span> <span class="n">insnSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">offset</span> <span class="o">+=</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">insnSize</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span> <span class="c1">//跳过CodeOff,InsnSize和Insn[]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 回填dex的方法代码,每次只回填一个Method
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">innerLoadMethod</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">thiz</span><span class="p">,</span> <span class="k">const</span> <span class="n">DexFile</span><span class="o">*</span> <span class="n">dexFile</span><span class="p">,</span> <span class="n">ClassAccessor</span><span class="o">::</span><span class="n">Method</span><span class="o">*</span> <span class="n">method</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">klass</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">dest</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// dex文件路径
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">location</span> <span class="o">=</span> <span class="n">dexFile</span><span class="o">-&gt;</span><span class="n">location_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//logd(&#34;Load Dex File Location: %s&#34;,location.c_str())
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 判断是否为解密释放的dex文件,位于私有目录内
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">location</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#34;app_tmp_dex&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">::</span><span class="n">npos</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 如果未解析过dexCodes文件则进行解析,每个dex文件只解析一次,创建对应的map&lt;CodeOff,CodeItem&gt;映射
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">codeMapList</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">location</span><span class="p">)</span><span class="o">==</span><span class="n">codeMapList</span><span class="p">.</span><span class="n">end</span><span class="p">()){</span>
</span></span><span class="line"><span class="cl">        <span class="n">logd</span><span class="p">(</span><span class="s">&#34;Parse dex file %s codes&#34;</span><span class="p">,</span><span class="n">location</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">codeMapList</span><span class="p">[</span><span class="n">location</span><span class="p">]</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="p">,</span><span class="n">CodeItem</span><span class="o">&gt;</span><span class="p">();</span> <span class="c1">//创建新的codeMap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">parseExtractedCodeFiles</span><span class="p">(</span><span class="n">location</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 不存在DexCode 直接跳过
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">method</span><span class="o">-&gt;</span><span class="n">code_off_</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 指令地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">codeAddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)(</span><span class="n">dexFile</span><span class="o">-&gt;</span><span class="n">begin_</span> <span class="o">+</span> <span class="n">method</span><span class="o">-&gt;</span><span class="n">code_off_</span> <span class="o">+</span> <span class="mi">16</span><span class="p">);</span> <span class="c1">//insn结构前面有16字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">//logd(&#34;MethodCodeOff: %d&#34;,method-&gt;code_off_);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 回填指令
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="p">,</span><span class="n">CodeItem</span><span class="o">&gt;</span> <span class="n">codeMap</span><span class="o">=</span><span class="n">codeMapList</span><span class="p">[</span><span class="n">location</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 似乎没有走到回填指令处 (注意c++浅拷贝问题,不能随意delete)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">codeMap</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">method</span><span class="o">-&gt;</span><span class="n">code_off_</span><span class="p">)</span> <span class="o">!=</span> <span class="n">codeMap</span><span class="p">.</span><span class="n">end</span><span class="p">()){</span>
</span></span><span class="line"><span class="cl">        <span class="n">CodeItem</span> <span class="n">codeItem</span> <span class="o">=</span> <span class="n">codeMap</span><span class="p">[</span><span class="n">method</span><span class="o">-&gt;</span><span class="n">code_off_</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">memcpy</span><span class="p">(</span><span class="n">codeAddr</span><span class="p">,</span><span class="n">codeItem</span><span class="p">.</span><span class="n">getInsns</span><span class="p">(),</span><span class="n">codeItem</span><span class="p">.</span><span class="n">getInsnsSize</span><span class="p">()</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span> <span class="c1">//注意指令为u2类型,长度需要*2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">newLoadMethod</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">thiz</span><span class="p">,</span> <span class="k">const</span> <span class="n">DexFile</span><span class="o">*</span> <span class="n">dex_file</span><span class="p">,</span> <span class="n">ClassAccessor</span><span class="o">::</span><span class="n">Method</span><span class="o">*</span> <span class="n">method</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">klass</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">dest</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">g_originLoadMethod</span><span class="o">!=</span> <span class="k">nullptr</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 先回填指令,再调用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">innerLoadMethod</span><span class="p">(</span><span class="n">thiz</span><span class="p">,</span><span class="n">dex_file</span><span class="p">,</span><span class="n">method</span><span class="p">,</span><span class="n">klass</span><span class="p">,</span><span class="n">dest</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">g_originLoadMethod</span><span class="p">(</span><span class="n">thiz</span><span class="p">,</span><span class="n">dex_file</span><span class="p">,</span><span class="n">method</span><span class="p">,</span> <span class="n">klass</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">hook_LoadMethod</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="o">*</span> <span class="n">loadMethodAddress</span> <span class="o">=</span>  <span class="n">DobbySymbolResolver</span><span class="p">(</span><span class="n">getClassLinkerLoadMethodLibPath</span><span class="p">(),</span><span class="n">getClassLinkerLoadMethodSymbol</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">DobbyHook</span><span class="p">(</span><span class="n">loadMethodAddress</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">newLoadMethod</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">g_originLoadMethod</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">logd</span><span class="p">(</span><span class="s">&#34;hook LoadMethod done&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 初始函数,实现hook
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">extern</span> <span class="s">&#34;C&#34;</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">_init</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="n">APILevel</span> <span class="o">=</span> <span class="n">android_get_device_api_level</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">logd</span><span class="p">(</span><span class="s">&#34;Android API Level: %d&#34;</span><span class="p">,</span> <span class="n">APILevel</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">logd</span><span class="p">(</span><span class="s">&#34;Setting hook...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">hook</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// hook
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">hook</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="n">bytehook_init</span><span class="p">(</span><span class="n">BYTEHOOK_MODE_AUTOMATIC</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">hookExecve</span><span class="p">();</span>   <span class="c1">// 禁用dex2oat
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">hookMmap</span><span class="p">();</span>     <span class="c1">// 使dex文件可写
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//hook_DefineClass(); //需手动解析ClassDef
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">hook_LoadMethod</span><span class="p">();</span>  <span class="c1">// 加载方法时回填指令
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="十-加固工具测试">十. 加固工具测试
</h1><p>主要测试第三代加固,其中包括了动态加载和代码抽取与回填</p>
<p>使用frida-dexdump和blackdex尝试脱壳</p>
<p>加壳程序代码文件: ThirdAndroidShell.py</p>
<p>参数:</p>
<ul>
<li>
<p>-src &ndash;src-apk   源程序Apk路径</p>
</li>
<li>
<p>-shell &ndash;shell-apk 壳程序Apk路径</p>
</li>
<li>
<p>-out &ndash;out-apk   输出的Apk路径</p>
</li>
</ul>
<p>执行命令后,自动执行相关操作,成功时输出如下,加壳合并测试程序NativeDemo.apk和壳程序ThirdShell.apk为NewApk.apk:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">python ThirdAndroidShell.py -src <span class="p">&lt;</span>源程序Apk路径<span class="p">&gt;</span> -shell <span class="p">&lt;</span>壳程序Apk路径<span class="p">&gt;</span> -out <span class="p">&lt;</span>加壳后的Apk路径&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/photos%5c34-%e5%8a%a0%e5%a3%b3%e7%a8%8b%e5%ba%8f%e8%be%93%e5%87%ba%e5%9b%be.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>安装并运行输出的NewApk.apk,查看logcat日志结果如下:</p>
<ol>
<li>
<p>运行到壳代理类ThirdProxyApplication的attachBaseContext中时,由于主动调用了System.loadLibrary加载壳so,所以先执行了so的init函数并进行hook,此时由于没有执行源程序相关Java层代码所以没有触发Dex指令回填</p>
<p><img src="/photos%5c35-%e6%96%b0%e7%a8%8b%e5%ba%8f%e8%bf%90%e8%a1%8c%e5%9b%be1.png"
	
	
	
	loading="lazy"
	
		alt="新程序运行图1"
	
	
></p>
</li>
<li>
<p>首先从base.apk提取壳Dex进而提取源Dex,最后替换ClassLoader<img src="/photos%5c36-%e6%96%b0%e7%a8%8b%e5%ba%8f%e8%bf%90%e8%a1%8c%e5%9b%be2.png"
	
	
	
	loading="lazy"
	
		alt="新程序运行图2"
	
	
></p>
</li>
<li>
<p>之后需要进行替换Application等操作,由于执行源程序的Java层代码所以触发了Dex指令回填,进行codes文件解析并创建CodeItem对象</p>
<p><img src="/photos%5c37-%e6%96%b0%e7%a8%8b%e5%ba%8f%e8%bf%90%e8%a1%8c%e5%9b%be3.png"
	
	
	
	loading="lazy"
	
		alt="新程序运行图3"
	
	
></p>
</li>
<li>
<p>代码回填和替换Application结束后,成功运行源程序Application的attachBaseContext和onCreate方法,最终运行MainActivity.onCreate进入源程序生命周期</p>
<p><img src="/photos%5c38-%e6%96%b0%e7%a8%8b%e5%ba%8f%e8%bf%90%e8%a1%8c%e5%9b%be4.png"
	
	
	
	loading="lazy"
	
		alt="新程序运行图4"
	
	
></p>
</li>
</ol>
<p>Jadx分析被保护程序结果如下:</p>
<ol>
<li>由于动态加载Dex,无法直接查看关键类</li>
</ol>
<p><img src="/photos%5c39-%e6%96%b0%e7%a8%8b%e5%ba%8fJadx%e5%8f%8d%e6%b1%87%e7%bc%96%e5%9b%be1.png"
	
	
	
	loading="lazy"
	
	
></p>
<ol start="2">
<li>代码抽取效果如下,方法体为空</li>
</ol>
<p><img src="/photos%5c40-%e6%96%b0%e7%a8%8b%e5%ba%8fJadx%e5%8f%8d%e6%b1%87%e7%bc%96%e5%9b%be2.png"
	
	
	
	loading="lazy"
	
	
></p>
<ol start="3">
<li>方法体smali代码全部置为nop指令</li>
</ol>
<p><img src="/photos%5c41-%e6%96%b0%e7%a8%8b%e5%ba%8fJadx%e5%8f%8d%e6%b1%87%e7%bc%96%e5%9b%be3.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>另外经测试frida-dexdump和blackdex得到的是被抽空的Dex文件,暂不清楚为什么没有进行内存搜索,也可能脱壳姿势不对</p>
<h1 id="十一-classloader加载dex流程详解">十一. ClassLoader加载Dex流程详解
</h1><p>Dex文件的加载依赖于Android的ClassLoader,共有3个相关的ClassLoader:</p>
<ul>
<li>
<p>InMemoryDexClassLoader</p>
<p>Android 8.0 新增的类加载器,用于<strong>加载内存中的dex文件</strong></p>
</li>
<li>
<p>PathClassLoader</p>
<p>用于加载系统中已经安装过的apk的dex文件</p>
</li>
<li>
<p>DexClassLoader</p>
<p>用于加载已安装的jar、apk、dex以及从SD卡中加载未安装的apk</p>
</li>
</ul>
<p><img src="/photos%5c42-ClassLoader-AndroidClassLoader%e7%bb%a7%e6%89%bf%e5%85%b3%e7%b3%bb.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>完整流程图如下</p>
<p><img src="/photos%5c43-ClassLoader%e5%8a%a0%e8%bd%bdDex%e6%96%87%e4%bb%b6%e6%b5%81%e7%a8%8b.jpg"
	
	
	
	loading="lazy"
	
		alt="ClassLoader加载Dex文件流程"
	
	
></p>
<p><strong>以下分析基于<a class="link" href="https://cs.android.com/android/platform/superproject/&#43;/android-10.0.0_r47"  target="_blank" rel="noopener"
    >Android 10.0.0_r47</a></strong></p>
<h2 id="pathdexclassloader-java层">Path/DexClassLoader Java层
</h2><p>调用链如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">BaseDexClassLoader</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"> <span class="err">├─</span> <span class="n">new</span> <span class="n">DexPathList</span>
</span></span><span class="line"><span class="cl"> <span class="err">│</span>  <span class="err">└─</span> <span class="n">DexPathList</span><span class="o">.</span><span class="n">makeDexElements</span>
</span></span><span class="line"><span class="cl"> <span class="err">│</span>      <span class="err">└─</span> <span class="n">DexPathList</span><span class="o">.</span><span class="n">loadDexFile</span>
</span></span><span class="line"><span class="cl"> <span class="err">│</span>          <span class="err">└─</span> <span class="n">new</span> <span class="n">DexFile</span>
</span></span><span class="line"><span class="cl"> <span class="err">│</span> 			<span class="err">└─</span> <span class="n">DexFile</span><span class="p">::</span><span class="n">loadDex</span>
</span></span><span class="line"><span class="cl"> <span class="err">│</span>              <span class="err">└─</span> <span class="n">DexFile</span><span class="o">.</span><span class="n">openDexFile</span>
</span></span><span class="line"><span class="cl"> <span class="err">└─────────────────└─</span> <span class="n">DexFile</span><span class="o">.</span><span class="n">openDexFileNative</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="basedexclassloader">BaseDexClassLoader
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//libcore/dalvik/src/main/java/dalvik/system/DexClassLoader.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DexClassLoader</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">BaseDexClassLoader</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">DexClassLoader</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">dexPath</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">optimizedDirectory</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">librarySearchPath</span><span class="p">,</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">parent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">(</span><span class="n">dexPath</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">librarySearchPath</span><span class="p">,</span><span class="w"> </span><span class="n">parent</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//libcore/dalvik/src/main/java/dalvik/system/PathClassLoader.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PathClassLoader</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">BaseDexClassLoader</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">PathClassLoader</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">dexPath</span><span class="p">,</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">parent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">(</span><span class="n">dexPath</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">parent</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">PathClassLoader</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">dexPath</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">librarySearchPath</span><span class="p">,</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">parent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">(</span><span class="n">dexPath</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">librarySearchPath</span><span class="p">,</span><span class="w"> </span><span class="n">parent</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@libcore.api.CorePlatformApi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">PathClassLoader</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">dexPath</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">librarySearchPath</span><span class="p">,</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">parent</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ClassLoader</span><span class="o">[]</span><span class="w"> </span><span class="n">sharedLibraryLoaders</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">(</span><span class="n">dexPath</span><span class="p">,</span><span class="w"> </span><span class="n">librarySearchPath</span><span class="p">,</span><span class="w"> </span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="n">sharedLibraryLoaders</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>DexClassLoader和PathClassLoader都继承自BaseDexClassLoader,并且都调用这个4参数的构造方法重载</p>
<p>该构造方法内部主要是创建了DexPathList类</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//libcore/dalvik/src/main/java/dalvik/system/BaseDexClassLoader.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="nf">BaseDexClassLoader</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">dexPath</span><span class="p">,</span><span class="w"> </span><span class="n">File</span><span class="w"> </span><span class="n">optimizedDirectory</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                          </span><span class="n">String</span><span class="w"> </span><span class="n">librarySearchPath</span><span class="p">,</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">parent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">super</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">pathList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DexPathList</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">dexPath</span><span class="p">,</span><span class="w"> </span><span class="n">librarySearchPath</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reporter</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">reporter</span><span class="p">.</span><span class="na">report</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">pathList</span><span class="p">.</span><span class="na">getDexPaths</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="dexpathlistdexpathlist">DexPathList::DexPathList
</h3><p>DexPathList构造方法代码如下,可以发现这条调用链中,optimizedDirectory=null,isTrusted=false</p>
<p>调用makeDexElements</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//libcore/dalvik/src/main/java/dalvik/system/DexPathList.java  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nd">@UnsupportedAppUsage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">DexPathList</span><span class="p">(</span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">definingContext</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">dexPath</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">librarySearchPath</span><span class="p">,</span><span class="w"> </span><span class="n">File</span><span class="w"> </span><span class="n">optimizedDirectory</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">(</span><span class="n">definingContext</span><span class="p">,</span><span class="w"> </span><span class="n">dexPath</span><span class="p">,</span><span class="w"> </span><span class="n">librarySearchPath</span><span class="p">,</span><span class="w"> </span><span class="n">optimizedDirectory</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">DexPathList</span><span class="p">(</span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">definingContext</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">dexPath</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">librarySearchPath</span><span class="p">,</span><span class="w"> </span><span class="n">File</span><span class="w"> </span><span class="n">optimizedDirectory</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isTrusted</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="c1">// 部分检测逻辑</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="p">......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">definingContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">definingContext</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">IOException</span><span class="o">&gt;</span><span class="w"> </span><span class="n">suppressedExceptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">IOException</span><span class="o">&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// save dexPath for BaseDexClassLoader</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">dexElements</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">makeDexElements</span><span class="p">(</span><span class="n">splitDexPath</span><span class="p">(</span><span class="n">dexPath</span><span class="p">),</span><span class="w"> </span><span class="n">optimizedDirectory</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                           </span><span class="n">suppressedExceptions</span><span class="p">,</span><span class="w"> </span><span class="n">definingContext</span><span class="p">,</span><span class="w"> </span><span class="n">isTrusted</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Native libraries may exist in both the system and</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// application library paths, and we use this search order:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//   1. This class loader&#39;s library path for application libraries (librarySearchPath):</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//   1.1. Native library directories</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//   1.2. Path to libraries in apk-files</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//   2. The VM&#39;s library path from the system property for system libraries</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//      also known as java.library.path</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// This order was reversed prior to Gingerbread; see http://b/2933456.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">nativeLibraryDirectories</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">splitPaths</span><span class="p">(</span><span class="n">librarySearchPath</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">systemNativeLibraryDirectories</span><span class="w"> </span><span class="o">=</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">splitPaths</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="s">&#34;java.library.path&#34;</span><span class="p">),</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">nativeLibraryPathElements</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">makePathElements</span><span class="p">(</span><span class="n">getAllNativeLibraryDirectories</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">suppressedExceptions</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">dexElementsSuppressedExceptions</span><span class="w"> </span><span class="o">=</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">suppressedExceptions</span><span class="p">.</span><span class="na">toArray</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">IOException</span><span class="o">[</span><span class="n">suppressedExceptions</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="o">]</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">dexElementsSuppressedExceptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="dexpathlistmakedexelements">DexPathList::makeDexElements
</h3><p>遍历所有文件,寻找dex文件并调用loadDexFile加载dex文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//libcore/dalvik/src/main/java/dalvik/system/DexPathList.java      </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nd">@UnsupportedAppUsage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Element</span><span class="o">[]</span><span class="w"> </span><span class="nf">makeDexElements</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span><span class="w"> </span><span class="n">files</span><span class="p">,</span><span class="w"> </span><span class="n">File</span><span class="w"> </span><span class="n">optimizedDirectory</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">List</span><span class="o">&lt;</span><span class="n">IOException</span><span class="o">&gt;</span><span class="w"> </span><span class="n">suppressedExceptions</span><span class="p">,</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">loader</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">makeDexElements</span><span class="p">(</span><span class="n">files</span><span class="p">,</span><span class="w"> </span><span class="n">optimizedDirectory</span><span class="p">,</span><span class="w"> </span><span class="n">suppressedExceptions</span><span class="p">,</span><span class="w"> </span><span class="n">loader</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Element</span><span class="o">[]</span><span class="w"> </span><span class="nf">makeDexElements</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span><span class="w"> </span><span class="n">files</span><span class="p">,</span><span class="w"> </span><span class="n">File</span><span class="w"> </span><span class="n">optimizedDirectory</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">List</span><span class="o">&lt;</span><span class="n">IOException</span><span class="o">&gt;</span><span class="w"> </span><span class="n">suppressedExceptions</span><span class="p">,</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">loader</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isTrusted</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">Element</span><span class="o">[]</span><span class="w"> </span><span class="n">elements</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Element</span><span class="o">[</span><span class="n">files</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">elementsPos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">       * Open all files and load the (direct or contained) dex files up front.
</span></span></span><span class="line"><span class="cl"><span class="cm">       */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="c1">// 遍历传入的所有文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">File</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">files</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="na">isDirectory</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="c1">//文件夹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="c1">// We support directories for looking up resources. Looking up resources in</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="c1">// directories is useful for running libcore tests.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">elements</span><span class="o">[</span><span class="n">elementsPos</span><span class="o">++]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Element</span><span class="p">(</span><span class="n">file</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="na">isFile</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="c1">//文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file</span><span class="p">.</span><span class="na">getName</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">DexFile</span><span class="w"> </span><span class="n">dex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="na">endsWith</span><span class="p">(</span><span class="n">DEX_SUFFIX</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="c1">//通过后缀DEX_SUFFIX=&#34;.dex&#34;判断dex文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="c1">// Raw dex file (not inside a zip/jar).</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="c1">// 调用loadDexFile直接加载dex文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="n">dex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loadDexFile</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">optimizedDirectory</span><span class="p">,</span><span class="w"> </span><span class="n">loader</span><span class="p">,</span><span class="w"> </span><span class="n">elements</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dex</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                          </span><span class="n">elements</span><span class="o">[</span><span class="n">elementsPos</span><span class="o">++]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Element</span><span class="p">(</span><span class="n">dex</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">suppressed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="n">System</span><span class="p">.</span><span class="na">logE</span><span class="p">(</span><span class="s">&#34;Unable to load dex file: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">suppressed</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="n">suppressedExceptions</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">suppressed</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="c1">//尝试调用loadDexFile加载zip文件中的dex</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="n">dex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loadDexFile</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">optimizedDirectory</span><span class="p">,</span><span class="w"> </span><span class="n">loader</span><span class="p">,</span><span class="w"> </span><span class="n">elements</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">suppressed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="c1">// zip文件中没有dex文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">                       * IOException might get thrown &#34;legitimately&#34; by the DexFile constructor if
</span></span></span><span class="line"><span class="cl"><span class="cm">                       * the zip file turns out to be resource-only (that is, no classes.dex file
</span></span></span><span class="line"><span class="cl"><span class="cm">                       * in it).
</span></span></span><span class="line"><span class="cl"><span class="cm">                       * Let dex == null and hang on to the exception to add to the tea-leaves for
</span></span></span><span class="line"><span class="cl"><span class="cm">                       * when findClass returns null.
</span></span></span><span class="line"><span class="cl"><span class="cm">                       */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="n">suppressedExceptions</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">suppressed</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="c1">// 将文件添加至elements数组</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="n">elements</span><span class="o">[</span><span class="n">elementsPos</span><span class="o">++]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Element</span><span class="p">(</span><span class="n">file</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="n">elements</span><span class="o">[</span><span class="n">elementsPos</span><span class="o">++]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Element</span><span class="p">(</span><span class="n">dex</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dex</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">isTrusted</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">dex</span><span class="p">.</span><span class="na">setTrusted</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">System</span><span class="p">.</span><span class="na">logW</span><span class="p">(</span><span class="s">&#34;ClassLoader referenced unknown path: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">file</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">elementsPos</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">elements</span><span class="p">.</span><span class="na">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">elements</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arrays</span><span class="p">.</span><span class="na">copyOf</span><span class="p">(</span><span class="n">elements</span><span class="p">,</span><span class="w"> </span><span class="n">elementsPos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">elements</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="dexfileloaddexfile">DexFile::loadDexFile
</h3><p>Android系统中,如果应用程序是首次启动,则对dex文件优化,并在cache/dalvik-cache目录下生成缓存文件,加快应用启动速度</p>
<p>optimizedDirectory即缓存文件所在路径,默认为cache/dalvik-cache目录</p>
<p>如果没有对应缓存文件,则调用DexFile解析dex文件(并进行优化)</p>
<p>如果有缓存文件,则调用DexFile.loadDex解析缓存文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//libcore/dalvik/src/main/java/dalvik/system/DexPathList.java   </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nd">@UnsupportedAppUsage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">DexFile</span><span class="w"> </span><span class="nf">loadDexFile</span><span class="p">(</span><span class="n">File</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">File</span><span class="w"> </span><span class="n">optimizedDirectory</span><span class="p">,</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">loader</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                       </span><span class="n">Element</span><span class="o">[]</span><span class="w"> </span><span class="n">elements</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">optimizedDirectory</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 没有优化后的缓存文件,调用DexFile进行解析并优化dex</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DexFile</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">loader</span><span class="p">,</span><span class="w"> </span><span class="n">elements</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 存在优化后的缓存文件,调用DexFile.loadDex解析并加载缓存文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">optimizedPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">optimizedPathFor</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">optimizedDirectory</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">DexFile</span><span class="p">.</span><span class="na">loadDex</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="na">getPath</span><span class="p">(),</span><span class="w"> </span><span class="n">optimizedPath</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">loader</span><span class="p">,</span><span class="w"> </span><span class="n">elements</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="dexfiledexfile">DexFile::DexFile
</h3><p>内部调用openDexFile方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//libcore/dalvik/src/main/java/dalvik/system/DexFile.java   </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 	</span><span class="n">DexFile</span><span class="p">(</span><span class="n">File</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">loader</span><span class="p">,</span><span class="w"> </span><span class="n">DexPathList</span><span class="p">.</span><span class="na">Element</span><span class="o">[]</span><span class="w"> </span><span class="n">elements</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="na">getPath</span><span class="p">(),</span><span class="w"> </span><span class="n">loader</span><span class="p">,</span><span class="w"> </span><span class="n">elements</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">	 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">DexFile</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">fileName</span><span class="p">,</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">loader</span><span class="p">,</span><span class="w"> </span><span class="n">DexPathList</span><span class="p">.</span><span class="na">Element</span><span class="o">[]</span><span class="w"> </span><span class="n">elements</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">mCookie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">openDexFile</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">loader</span><span class="p">,</span><span class="w"> </span><span class="n">elements</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">mInternalCookie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mCookie</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">mFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fileName</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//System.out.println(&#34;DEX FILE cookie is &#34; + mCookie + &#34; fileName=&#34; + fileName);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>另外存在一个接收ByteBuffer[]的重载,内部调用openInMemoryDexFiles,应是用于InMemoryDexClassLoader加载dex</p>
<p>以及一个5参数的重载,内部也是调用openDexFile</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">    </span><span class="n">DexFile</span><span class="p">(</span><span class="n">ByteBuffer</span><span class="o">[]</span><span class="w"> </span><span class="n">bufs</span><span class="p">,</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">loader</span><span class="p">,</span><span class="w"> </span><span class="n">DexPathList</span><span class="p">.</span><span class="na">Element</span><span class="o">[]</span><span class="w"> </span><span class="n">elements</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">mCookie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">openInMemoryDexFiles</span><span class="p">(</span><span class="n">bufs</span><span class="p">,</span><span class="w"> </span><span class="n">loader</span><span class="p">,</span><span class="w"> </span><span class="n">elements</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">mInternalCookie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mCookie</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">mFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="kd">private</span><span class="w"> </span><span class="nf">DexFile</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">sourceName</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">outputName</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">loader</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">DexPathList</span><span class="p">.</span><span class="na">Element</span><span class="o">[]</span><span class="w"> </span><span class="n">elements</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">outputName</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="p">......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">mCookie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">openDexFile</span><span class="p">(</span><span class="n">sourceName</span><span class="p">,</span><span class="w"> </span><span class="n">outputName</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">loader</span><span class="p">,</span><span class="w"> </span><span class="n">elements</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">mInternalCookie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mCookie</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">mFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sourceName</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//System.out.println(&#34;DEX FILE cookie is &#34; + mCookie + &#34; sourceName=&#34; + sourceName + &#34; outputName=&#34; + outputName);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="dexfileloaddex">DexFile::loadDex
</h3><p>内部调用了DexFile,之后的流程同上,最终调用openDexFile</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//libcore/dalvik/src/main/java/dalvik/system/DexFile.java      </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nd">@Deprecated</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="kd">public</span><span class="w"> </span><span class="n">DexFile</span><span class="w"> </span><span class="nf">loadDex</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">sourcePathName</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">outputPathName</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">loadDex</span><span class="p">(</span><span class="n">sourcePathName</span><span class="p">,</span><span class="w"> </span><span class="n">outputPathName</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@UnsupportedAppUsage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="n">DexFile</span><span class="w"> </span><span class="nf">loadDex</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">sourcePathName</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">outputPathName</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">loader</span><span class="p">,</span><span class="w"> </span><span class="n">DexPathList</span><span class="p">.</span><span class="na">Element</span><span class="o">[]</span><span class="w"> </span><span class="n">elements</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DexFile</span><span class="p">(</span><span class="n">sourcePathName</span><span class="p">,</span><span class="w"> </span><span class="n">outputPathName</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">loader</span><span class="p">,</span><span class="w"> </span><span class="n">elements</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="dexfileopendexfile">DexFile::openDexFile
</h3><p>最终调用openDexFileNative这个Native方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@UnsupportedAppUsage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">openDexFile</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">sourceName</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">outputName</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">loader</span><span class="p">,</span><span class="w"> </span><span class="n">DexPathList</span><span class="p">.</span><span class="na">Element</span><span class="o">[]</span><span class="w"> </span><span class="n">elements</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Use absolute paths to enable the use of relative paths when testing on host.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">openDexFileNative</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">sourceName</span><span class="p">).</span><span class="na">getAbsolutePath</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                 </span><span class="p">(</span><span class="n">outputName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                     </span><span class="o">?</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                     </span><span class="p">:</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">outputName</span><span class="p">).</span><span class="na">getAbsolutePath</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                 </span><span class="n">flags</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                 </span><span class="n">loader</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                 </span><span class="n">elements</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>另外有openInMemoryDexFiles和openInMemoryDexFilesNative代码如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">openInMemoryDexFiles</span><span class="p">(</span><span class="n">ByteBuffer</span><span class="o">[]</span><span class="w"> </span><span class="n">bufs</span><span class="p">,</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">loader</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">DexPathList</span><span class="p">.</span><span class="na">Element</span><span class="o">[]</span><span class="w"> </span><span class="n">elements</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Preprocess the ByteBuffers for openInMemoryDexFilesNative. We extract</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// the backing array (non-direct buffers only) and start/end positions</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// so that the native method does not have to call Java methods anymore.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[][]</span><span class="w"> </span><span class="n">arrays</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="n">bufs</span><span class="p">.</span><span class="na">length</span><span class="o">][]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[</span><span class="n">bufs</span><span class="p">.</span><span class="na">length</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">ends</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[</span><span class="n">bufs</span><span class="p">.</span><span class="na">length</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">bufs</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">arrays</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bufs</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="na">isDirect</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">bufs</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="na">array</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">starts</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bufs</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="na">position</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ends</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bufs</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="na">limit</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">openInMemoryDexFilesNative</span><span class="p">(</span><span class="n">bufs</span><span class="p">,</span><span class="w"> </span><span class="n">arrays</span><span class="p">,</span><span class="w"> </span><span class="n">starts</span><span class="p">,</span><span class="w"> </span><span class="n">ends</span><span class="p">,</span><span class="w"> </span><span class="n">loader</span><span class="p">,</span><span class="w"> </span><span class="n">elements</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">native</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">openInMemoryDexFilesNative</span><span class="p">(</span><span class="n">ByteBuffer</span><span class="o">[]</span><span class="w"> </span><span class="n">bufs</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[][]</span><span class="w"> </span><span class="n">arrays</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">starts</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">ends</span><span class="p">,</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">loader</span><span class="p">,</span><span class="w"> </span><span class="n">DexPathList</span><span class="p">.</span><span class="na">Element</span><span class="o">[]</span><span class="w"> </span><span class="n">elements</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="pathdexclassloader-native层">Path/DexClassLoader Native层
</h2><p>无论是PathClassLoader还是DexClassLoader,最终调用JNI函数DexFile::openDexFileNative</p>
<p>Native层对应函数为art/runtime/native/dalvik_system_DexFile.cc的<strong>DexFile_openDexFileNative</strong></p>
<p>调用链如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">DexFile_openDexFileNative()
</span></span><span class="line"><span class="cl"> ├─ OpenDexFilesFromOat
</span></span><span class="line"><span class="cl"> │  └─ ArtDexFileLoader::Open
</span></span><span class="line"><span class="cl"> │      └─ OpenAndReadMagic
</span></span><span class="line"><span class="cl"> │         OpenWithMagic
</span></span><span class="line"><span class="cl"> │          └─ ArtDexFileLoader::OpenFile
</span></span><span class="line"><span class="cl"> │              └─ ArtDexFileLoader::OpenCommon
</span></span><span class="line"><span class="cl"> │                  └─ DexFileLoader::OpenCommon
</span></span><span class="line"><span class="cl"> │                       magic == &#34;dex\n&#34; new StandardDexFile
</span></span><span class="line"><span class="cl"> │                       magic == &#34;cdex&#34;  new CompactDexFile
</span></span><span class="line"><span class="cl"> └———————————————————————└─ DexFile::DexFile()
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="dexfile_opendexfilenative">DexFile_openDexFileNative
</h3><p>关键为调用OatFileManager.OpenDexFilesFromOat(),打开OAT文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">//art/runtime/native/dalvik_system_DexFile.cc
</span></span></span><span class="line"><span class="cl"><span class="c1">// TODO(calin): clean up the unused parameters (here and in libcore).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="n">jobject</span> <span class="nf">DexFile_openDexFileNative</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                         <span class="n">jclass</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                         <span class="n">jstring</span> <span class="n">javaSourceName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                         <span class="n">jstring</span> <span class="n">javaOutputName</span> <span class="n">ATTRIBUTE_UNUSED</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                         <span class="n">jint</span> <span class="n">flags</span> <span class="n">ATTRIBUTE_UNUSED</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                         <span class="n">jobject</span> <span class="n">class_loader</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                         <span class="n">jobjectArray</span> <span class="n">dex_elements</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">ScopedUtfChars</span> <span class="n">sourceName</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">javaSourceName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">sourceName</span><span class="p">.</span><span class="n">c_str</span><span class="p">()</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">error_msgs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="n">OatFile</span><span class="o">*</span> <span class="n">oat_file</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 打开oat文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">&gt;&gt;</span> <span class="n">dex_files</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="n">Runtime</span><span class="o">::</span><span class="n">Current</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetOatFileManager</span><span class="p">().</span><span class="n">OpenDexFilesFromOat</span><span class="p">(</span><span class="n">sourceName</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                                                                  <span class="n">class_loader</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                                  <span class="n">dex_elements</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                                  <span class="cm">/*out*/</span> <span class="o">&amp;</span><span class="n">oat_file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                                  <span class="cm">/*out*/</span> <span class="o">&amp;</span><span class="n">error_msgs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">CreateCookieFromOatFileManagerResult</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">dex_files</span><span class="p">,</span> <span class="n">oat_file</span><span class="p">,</span> <span class="n">error_msgs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="oatfilemanageropendexfilesfromoat">OatFileManager::OpenDexFilesFromOat
</h3><p>以上代码大致流程如下(Android 8.0的流程和此处有部分区别,使用DexFile::Open加载dex文件):</p>
<ol>
<li>通过oat_file_assistant()获取oat_file_assistant对象</li>
<li>通过oat_file_assistant.GetBestOatFile()获取oat文件</li>
<li>调用oat_file_assistant.LoadDexFiles()从oat文件中加载dex文件</li>
<li>如果从oat文件中加载dex文件失败,则调用ArtDexFileLoader::Open()加载dex文件</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span><span class="lnt">98
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">//art/runtime/oat_file_manager.cc#447
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">&gt;&gt;</span> <span class="n">OatFileManager</span><span class="o">::</span><span class="n">OpenDexFilesFromOat</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">dex_location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">jobject</span> <span class="n">class_loader</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">jobjectArray</span> <span class="n">dex_elements</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">OatFile</span><span class="o">**</span> <span class="n">out_oat_file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;*</span> <span class="n">error_msgs</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">......</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 1.获取OatFileAssistant
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">OatFileAssistant</span> <span class="n">oat_file_assistant</span><span class="p">(</span><span class="n">dex_location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                      <span class="n">kRuntimeISA</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                      <span class="o">!</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">IsAotCompiler</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                                      <span class="n">only_use_system_oat_files_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 2.通过oat_file_assistant.GetBestOatFile获取oat文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Get the oat file on disk.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">OatFile</span><span class="o">&gt;</span> <span class="n">oat_file</span><span class="p">(</span><span class="n">oat_file_assistant</span><span class="p">.</span><span class="n">GetBestOatFile</span><span class="p">().</span><span class="n">release</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="n">VLOG</span><span class="p">(</span><span class="n">oat</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;OatFileAssistant(&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">dex_location</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;).GetBestOatFile()=&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="o">&lt;&lt;</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">uintptr_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oat_file</span><span class="p">.</span><span class="n">get</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="o">&lt;&lt;</span> <span class="s">&#34; (executable=&#34;</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">oat_file</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="o">?</span> <span class="n">oat_file</span><span class="o">-&gt;</span><span class="n">IsExecutable</span><span class="p">()</span> <span class="o">:</span> <span class="nb">false</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;)&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="n">OatFile</span><span class="o">*</span> <span class="n">source_oat_file</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">CheckCollisionResult</span> <span class="n">check_collision_result</span> <span class="o">=</span> <span class="n">CheckCollisionResult</span><span class="o">::</span><span class="n">kPerformedHasCollisions</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">error_msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">((</span><span class="n">class_loader</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="o">||</span> <span class="n">dex_elements</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">oat_file</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">check_collision_result</span> <span class="o">=</span> <span class="n">CheckCollision</span><span class="p">(</span><span class="n">oat_file</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">context</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="cm">/*out*/</span> <span class="o">&amp;</span><span class="n">error_msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">accept_oat_file</span> <span class="o">=</span> <span class="n">AcceptOatFile</span><span class="p">(</span><span class="n">check_collision_result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">......</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//冲突检测
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">&gt;&gt;</span> <span class="n">dex_files</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 从oat文件加载dex文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Load the dex files from the oat file.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">source_oat_file</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">added_image_space</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">source_oat_file</span><span class="o">-&gt;</span><span class="n">IsExecutable</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">......</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// oat镜像处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">added_image_space</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">DCHECK</span><span class="p">(</span><span class="n">dex_files</span><span class="p">.</span><span class="n">empty</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 3.调用LoadDexFiles从oat文件加载dex文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">dex_files</span> <span class="o">=</span> <span class="n">oat_file_assistant</span><span class="p">.</span><span class="n">LoadDexFiles</span><span class="p">(</span><span class="o">*</span><span class="n">source_oat_file</span><span class="p">,</span> <span class="n">dex_location</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// Register for tracking.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// 注册跟踪
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">dex_file</span> <span class="p">:</span> <span class="n">dex_files</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">dex</span><span class="o">::</span><span class="n">tracking</span><span class="o">::</span><span class="n">RegisterDexFile</span><span class="p">(</span><span class="n">dex_file</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 从oat加载dex文件失败
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">dex_files</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">error_msgs</span><span class="o">-&gt;</span><span class="n">push_back</span><span class="p">(</span><span class="s">&#34;Failed to open dex files from &#34;</span> <span class="o">+</span> <span class="n">source_oat_file</span><span class="o">-&gt;</span><span class="n">GetLocation</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Opened dex files from an oat file, madvise them to their loaded state.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">&gt;&amp;</span> <span class="nl">dex_file</span> <span class="p">:</span> <span class="n">dex_files</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">OatDexFile</span><span class="o">::</span><span class="n">MadviseDexFile</span><span class="p">(</span><span class="o">*</span><span class="n">dex_file</span><span class="p">,</span> <span class="n">MadviseState</span><span class="o">::</span><span class="n">kMadviseStateAtLoad</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">       <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Fall back to running out of the original dex file if we couldn&#39;t load any
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// dex_files from the oat file.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">dex_files</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">oat_file_assistant</span><span class="p">.</span><span class="n">HasOriginalDexFiles</span><span class="p">())</span> <span class="p">{</span><span class="c1">//判断是否存在原始dex文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">Runtime</span><span class="o">::</span><span class="n">Current</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">IsDexFileFallbackEnabled</span><span class="p">())</span> <span class="p">{</span><span class="c1">//是否启用了dex文件的回退机制
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">static</span> <span class="k">constexpr</span> <span class="kt">bool</span> <span class="n">kVerifyChecksum</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="n">ArtDexFileLoader</span> <span class="n">dex_file_loader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 4.调用ArtDexFileLoader::Open打开dex文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dex_file_loader</span><span class="p">.</span><span class="n">Open</span><span class="p">(</span><span class="n">dex_location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">dex_location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">Runtime</span><span class="o">::</span><span class="n">Current</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">IsVerificationEnabled</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">kVerifyChecksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="cm">/*out*/</span> <span class="o">&amp;</span><span class="n">error_msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="o">&amp;</span><span class="n">dex_files</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">LOG</span><span class="p">(</span><span class="n">WARNING</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">error_msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="n">error_msgs</span><span class="o">-&gt;</span><span class="n">push_back</span><span class="p">(</span><span class="s">&#34;Failed to open dex files from &#34;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">dex_location</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                <span class="o">+</span> <span class="s">&#34; because: &#34;</span> <span class="o">+</span> <span class="n">error_msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">error_msgs</span><span class="o">-&gt;</span><span class="n">push_back</span><span class="p">(</span><span class="s">&#34;Fallback mode disabled, skipping dex files.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">error_msgs</span><span class="o">-&gt;</span><span class="n">push_back</span><span class="p">(</span><span class="s">&#34;No original dex files found for dex location &#34;</span>
</span></span><span class="line"><span class="cl">          <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">dex_location</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">Runtime</span><span class="o">::</span><span class="n">Current</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetJit</span><span class="p">()</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ScopedObjectAccess</span> <span class="nf">soa</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Runtime</span><span class="o">::</span><span class="n">Current</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetJit</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">RegisterDexFiles</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">dex_files</span><span class="p">,</span> <span class="n">soa</span><span class="p">.</span><span class="n">Decode</span><span class="o">&lt;</span><span class="n">mirror</span><span class="o">::</span><span class="n">ClassLoader</span><span class="o">&gt;</span><span class="p">(</span><span class="n">class_loader</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">dex_files</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="oatfileassistantgetbestoatfile">OatFileAssistant::GetBestOatFile
</h3><p>首先调用GetBestInfo()获取最佳的oat文件信息</p>
<p>然后调用ReleaseFileForUse()方法根据oat文件的状态释放文件以供使用(默认使用最新状态的oat文件)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">//art/runtime/oat_file_assistant.cc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">OatFile</span><span class="o">&gt;</span> <span class="n">OatFileAssistant</span><span class="o">::</span><span class="n">GetBestOatFile</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">GetBestInfo</span><span class="p">().</span><span class="n">ReleaseFileForUse</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">OatFileAssistant</span><span class="o">::</span><span class="n">OatFileInfo</span><span class="o">&amp;</span> <span class="n">OatFileAssistant</span><span class="o">::</span><span class="n">GetBestInfo</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">dex_parent_writable_</span> <span class="o">||</span> <span class="n">UseFdToReadFiles</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 父目录可写,选择odex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">odex_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 父目录不可写,说明是系统app,如果oat文件可用则选择oat文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">oat_</span><span class="p">.</span><span class="n">IsUseable</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">oat_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// oat文件不可用,如果odex文件为最新则使用odex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">odex_</span><span class="p">.</span><span class="n">Status</span><span class="p">()</span> <span class="o">==</span> <span class="n">kOatUpToDate</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">odex_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// oat文件不可用,odex部不为最新,若存在原始oat则使用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">HasOriginalDexFiles</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">oat_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 最糟糕的情况,有什么选什么
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// We got into the worst situation here:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// - the oat location is not usable
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// - the prebuild odex location is not up to date
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// - and we don&#39;t have the original dex file anymore (stripped).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Pick the odex if it exists, or the oat if not.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="p">(</span><span class="n">odex_</span><span class="p">.</span><span class="n">Status</span><span class="p">()</span> <span class="o">==</span> <span class="n">kOatCannotOpen</span><span class="p">)</span> <span class="o">?</span> <span class="nl">oat_</span> <span class="p">:</span> <span class="n">odex_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">OatFile</span><span class="o">&gt;</span> <span class="n">OatFileAssistant</span><span class="o">::</span><span class="n">OatFileInfo</span><span class="o">::</span><span class="n">ReleaseFileForUse</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 若oat文件为最新,则释放文件直接使用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">Status</span><span class="p">()</span> <span class="o">==</span> <span class="n">kOatUpToDate</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">ReleaseFile</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">VLOG</span><span class="p">(</span><span class="n">oat</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Oat File Assistant: No relocated oat file found,&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;&lt;</span> <span class="s">&#34; attempting to fall back to interpreting oat file instead.&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">switch</span> <span class="p">(</span><span class="n">Status</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">kOatBootImageOutOfDate</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// OutOfDate may be either a mismatched image, or a missing image.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">oat_file_assistant_</span><span class="o">-&gt;</span><span class="n">HasOriginalDexFiles</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// If there are original dex files, it is better to use them (to avoid a potential
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// quickening mismatch because the boot image changed).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// If we do not accept the oat file, we may not have access to dex bytecode at all. Grudgingly
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// go forward.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">FALLTHROUGH_INTENDED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">kOatUpToDate</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">kOatCannotOpen</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">kOatDexOutOfDate</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">OatFile</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>OatFileAssistant::OatFileInfo::Status方法如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">OatFileAssistant</span><span class="o">::</span><span class="n">OatStatus</span> <span class="n">OatFileAssistant</span><span class="o">::</span><span class="n">OatFileInfo</span><span class="o">::</span><span class="n">Status</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status_attempted_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">status_attempted_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//打开oat文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">const</span> <span class="n">OatFile</span><span class="o">*</span> <span class="n">file</span> <span class="o">=</span> <span class="n">GetFile</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">file</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Check to see if there is a vdex file we can make use of.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">error_msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">vdex_filename</span> <span class="o">=</span> <span class="n">GetVdexFilename</span><span class="p">(</span><span class="n">filename_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">VdexFile</span><span class="o">&gt;</span> <span class="n">vdex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">use_fd_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">vdex_fd_</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">struct</span> <span class="nc">stat</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">TEMP_FAILURE_RETRY</span><span class="p">(</span><span class="n">fstat</span><span class="p">(</span><span class="n">vdex_fd_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">error_msg</span> <span class="o">=</span> <span class="n">StringPrintf</span><span class="p">(</span><span class="s">&#34;Failed getting length of the vdex file %s.&#34;</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="c1">//打开vdex文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">vdex</span> <span class="o">=</span> <span class="n">VdexFile</span><span class="o">::</span><span class="n">Open</span><span class="p">(</span><span class="n">vdex_fd_</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">s</span><span class="p">.</span><span class="n">st_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">vdex_filename</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="cm">/*writable=*/</span> <span class="nb">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="cm">/*low_4gb=*/</span> <span class="nb">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="cm">/*unquicken=*/</span> <span class="nb">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="o">&amp;</span><span class="n">error_msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">vdex</span> <span class="o">=</span> <span class="n">VdexFile</span><span class="o">::</span><span class="n">Open</span><span class="p">(</span><span class="n">vdex_filename</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="cm">/*writable=*/</span> <span class="nb">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="cm">/*low_4gb=*/</span> <span class="nb">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="cm">/*unquicken=*/</span> <span class="nb">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="o">&amp;</span><span class="n">error_msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">vdex</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">status_</span> <span class="o">=</span> <span class="n">kOatCannotOpen</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">VLOG</span><span class="p">(</span><span class="n">oat</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;unable to open vdex file &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">vdex_filename</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">error_msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">oat_file_assistant_</span><span class="o">-&gt;</span><span class="n">DexChecksumUpToDate</span><span class="p">(</span><span class="o">*</span><span class="n">vdex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error_msg</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// The vdex file does not contain enough information to determine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="c1">// whether it is up to date with respect to the boot image, so we
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="c1">// assume it is out of date.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="n">VLOG</span><span class="p">(</span><span class="n">oat</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">error_msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="n">status_</span> <span class="o">=</span> <span class="n">kOatBootImageOutOfDate</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">status_</span> <span class="o">=</span> <span class="n">kOatDexOutOfDate</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">status_</span> <span class="o">=</span> <span class="n">oat_file_assistant_</span><span class="o">-&gt;</span><span class="n">GivenOatFileStatus</span><span class="p">(</span><span class="o">*</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">VLOG</span><span class="p">(</span><span class="n">oat</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">GetLocation</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; is &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">status_</span>
</span></span><span class="line"><span class="cl">          <span class="o">&lt;&lt;</span> <span class="s">&#34; with filter &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">GetCompilerFilter</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">status_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="oatfileassistantloaddexfiles">OatFileAssistant::LoadDexFiles
</h3><ol>
<li>通过OatFile::GetOatDexFile获取OatDexFile对象</li>
<li>通过OatDexFile::OpenDexFile打开dex文件并添加到DexFile数组中</li>
<li>遍历Oat文件,如果存在multidex则依次打开这些dex并添加到DexFile数组中</li>
</ol>
<p>总而言之,该函数的作用是从Oat文件中打开dex文件并添加到DexFile数组</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">//art/runtime/oat_file_assistant.cc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">&gt;&gt;</span> <span class="n">OatFileAssistant</span><span class="o">::</span><span class="n">LoadDexFiles</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">OatFile</span> <span class="o">&amp;</span><span class="n">oat_file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dex_location</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">&gt;&gt;</span> <span class="n">dex_files</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 调用3参数LoadDexFiles重载
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">LoadDexFiles</span><span class="p">(</span><span class="n">oat_file</span><span class="p">,</span> <span class="n">dex_location</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dex_files</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">dex_files</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">&gt;&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">OatFileAssistant</span><span class="o">::</span><span class="n">LoadDexFiles</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">OatFile</span> <span class="o">&amp;</span><span class="n">oat_file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">dex_location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">&gt;&gt;*</span> <span class="n">out_dex_files</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Load the main dex file.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">error_msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//1.通过oat_file.GetOatDexFile获取OatDexFile对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">const</span> <span class="n">OatDexFile</span><span class="o">*</span> <span class="n">oat_dex_file</span> <span class="o">=</span> <span class="n">oat_file</span><span class="p">.</span><span class="n">GetOatDexFile</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">dex_location</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="k">nullptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error_msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">oat_dex_file</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">LOG</span><span class="p">(</span><span class="n">WARNING</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">error_msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">//2.通过OatDexFile::OpenDexFile打开dex文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">&gt;</span> <span class="n">dex_file</span> <span class="o">=</span> <span class="n">oat_dex_file</span><span class="o">-&gt;</span><span class="n">OpenDexFile</span><span class="p">(</span><span class="o">&amp;</span><span class="n">error_msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">dex_file</span><span class="p">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">LOG</span><span class="p">(</span><span class="n">WARNING</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Failed to open dex file from oat dex file: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">error_msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//3.添加dex文件到dex_files数组中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">out_dex_files</span><span class="o">-&gt;</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">dex_file</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Load the rest of the multidex entries
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//4.查看是否存在多个dex文件(multidex支持)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//从oat文件扫描并获取第i个dex文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">multidex_dex_location</span> <span class="o">=</span> <span class="n">DexFileLoader</span><span class="o">::</span><span class="n">GetMultiDexLocation</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dex_location</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">oat_dex_file</span> <span class="o">=</span> <span class="n">oat_file</span><span class="p">.</span><span class="n">GetOatDexFile</span><span class="p">(</span><span class="n">multidex_dex_location</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">oat_dex_file</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// There are no more multidex entries to load.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//打开第i个dex文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">dex_file</span> <span class="o">=</span> <span class="n">oat_dex_file</span><span class="o">-&gt;</span><span class="n">OpenDexFile</span><span class="p">(</span><span class="o">&amp;</span><span class="n">error_msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">dex_file</span><span class="p">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">LOG</span><span class="p">(</span><span class="n">WARNING</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Failed to open dex file from oat dex file: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">error_msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//添加dex文件到dex_files数组中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">out_dex_files</span><span class="o">-&gt;</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">dex_file</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="oatfilegetoatdexfile">OatFile::GetOatDexFile
</h4><p>以dex_location作为key,在oat_dex_files_ map中查找oat_dex文件位置,经过校验后返回</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">//art/runtime/oat_file.cc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">const</span> <span class="n">OatDexFile</span><span class="o">*</span> <span class="n">OatFile</span><span class="o">::</span><span class="n">GetOatDexFile</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">dex_location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                         <span class="k">const</span> <span class="kt">uint32_t</span><span class="o">*</span> <span class="n">dex_location_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                         <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">error_msg</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="n">OatDexFile</span><span class="o">*</span> <span class="n">oat_dex_file</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">string_view</span> <span class="n">key</span><span class="p">(</span><span class="n">dex_location</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Try to find the key cheaply in the oat_dex_files_ map which holds dex locations
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// directly mentioned in the oat file and doesn&#39;t require locking.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//通过key在oat_dex_files_ map中查找oat_dex文件的位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">auto</span> <span class="n">primary_it</span> <span class="o">=</span> <span class="n">oat_dex_files_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">primary_it</span> <span class="o">!=</span> <span class="n">oat_dex_files_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span><span class="c1">//dex文件不唯一
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">oat_dex_file</span> <span class="o">=</span> <span class="n">primary_it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DCHECK</span><span class="p">(</span><span class="n">oat_dex_file</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// This dex_location is not one of the dex locations directly mentioned in the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// oat file. The correct lookup is via the canonical location but first see in
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// the secondary_oat_dex_files_ whether we&#39;ve looked up this location before.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">MutexLock</span> <span class="nf">mu</span><span class="p">(</span><span class="n">Thread</span><span class="o">::</span><span class="n">Current</span><span class="p">(),</span> <span class="n">secondary_lookup_lock_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">secondary_lb</span> <span class="o">=</span> <span class="n">secondary_oat_dex_files_</span><span class="p">.</span><span class="n">lower_bound</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">secondary_lb</span> <span class="o">!=</span> <span class="n">secondary_oat_dex_files_</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">key</span> <span class="o">==</span> <span class="n">secondary_lb</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">oat_dex_file</span> <span class="o">=</span> <span class="n">secondary_lb</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>  <span class="c1">// May be null.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// We haven&#39;t seen this dex_location before, we must check the canonical location.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">dex_canonical_location</span> <span class="o">=</span> <span class="n">DexFileLoader</span><span class="o">::</span><span class="n">GetDexCanonicalLocation</span><span class="p">(</span><span class="n">dex_location</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">dex_canonical_location</span> <span class="o">!=</span> <span class="n">dex_location</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">string_view</span> <span class="n">canonical_key</span><span class="p">(</span><span class="n">dex_canonical_location</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">canonical_it</span> <span class="o">=</span> <span class="n">oat_dex_files_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">canonical_key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">canonical_it</span> <span class="o">!=</span> <span class="n">oat_dex_files_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">oat_dex_file</span> <span class="o">=</span> <span class="n">canonical_it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  <span class="c1">// else keep null.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">}</span>  <span class="c1">// else keep null.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Copy the key to the string_cache_ and store the result in secondary map.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">string_cache_</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">key</span><span class="p">.</span><span class="n">length</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="n">std</span><span class="o">::</span><span class="n">string_view</span> <span class="n">key_copy</span><span class="p">(</span><span class="n">string_cache_</span><span class="p">.</span><span class="n">back</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="n">secondary_oat_dex_files_</span><span class="p">.</span><span class="n">PutBefore</span><span class="p">(</span><span class="n">secondary_lb</span><span class="p">,</span> <span class="n">key_copy</span><span class="p">,</span> <span class="n">oat_dex_file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">//获取oat_dex_file文件失败
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">oat_dex_file</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">error_msg</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">dex_canonical_location</span> <span class="o">=</span> <span class="n">DexFileLoader</span><span class="o">::</span><span class="n">GetDexCanonicalLocation</span><span class="p">(</span><span class="n">dex_location</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="n">error_msg</span> <span class="o">=</span> <span class="s">&#34;Failed to find OatDexFile for DexFile &#34;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">dex_location</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="o">+</span> <span class="s">&#34; (canonical path &#34;</span> <span class="o">+</span> <span class="n">dex_canonical_location</span> <span class="o">+</span> <span class="s">&#34;) in OatFile &#34;</span> <span class="o">+</span> <span class="n">GetLocation</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 验证oat_dex_file文件的校验码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">dex_location_checksum</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">      <span class="n">oat_dex_file</span><span class="o">-&gt;</span><span class="n">GetDexFileLocationChecksum</span><span class="p">()</span> <span class="o">!=</span> <span class="o">*</span><span class="n">dex_location_checksum</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">error_msg</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">dex_canonical_location</span> <span class="o">=</span> <span class="n">DexFileLoader</span><span class="o">::</span><span class="n">GetDexCanonicalLocation</span><span class="p">(</span><span class="n">dex_location</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">checksum</span> <span class="o">=</span> <span class="n">StringPrintf</span><span class="p">(</span><span class="s">&#34;0x%08x&#34;</span><span class="p">,</span> <span class="n">oat_dex_file</span><span class="o">-&gt;</span><span class="n">GetDexFileLocationChecksum</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">required_checksum</span> <span class="o">=</span> <span class="n">StringPrintf</span><span class="p">(</span><span class="s">&#34;0x%08x&#34;</span><span class="p">,</span> <span class="o">*</span><span class="n">dex_location_checksum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="n">error_msg</span> <span class="o">=</span> <span class="s">&#34;OatDexFile for DexFile &#34;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">dex_location</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="o">+</span> <span class="s">&#34; (canonical path &#34;</span> <span class="o">+</span> <span class="n">dex_canonical_location</span> <span class="o">+</span> <span class="s">&#34;) in OatFile &#34;</span> <span class="o">+</span> <span class="n">GetLocation</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">          <span class="o">+</span> <span class="s">&#34; has checksum &#34;</span> <span class="o">+</span> <span class="n">checksum</span> <span class="o">+</span> <span class="s">&#34; but &#34;</span> <span class="o">+</span> <span class="n">required_checksum</span> <span class="o">+</span> <span class="s">&#34; was required&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">oat_dex_file</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="oatdexfileopendexfile">OatDexFile::OpenDexFile
</h4><p>内部调用ArtDexFileLoader::Open</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">//art/runtime/oat_file.cc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">&gt;</span> <span class="n">OatDexFile</span><span class="o">::</span><span class="n">OpenDexFile</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">error_msg</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">ScopedTrace</span> <span class="nf">trace</span><span class="p">(</span><span class="n">__PRETTY_FUNCTION__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">static</span> <span class="k">constexpr</span> <span class="kt">bool</span> <span class="n">kVerify</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">static</span> <span class="k">constexpr</span> <span class="kt">bool</span> <span class="n">kVerifyChecksum</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="n">ArtDexFileLoader</span> <span class="n">dex_file_loader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">dex_file_loader</span><span class="p">.</span><span class="n">Open</span><span class="p">(</span><span class="n">dex_file_pointer_</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">FileSize</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                              <span class="n">dex_file_location_</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">dex_file_location_checksum_</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="k">this</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">kVerify</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">kVerifyChecksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">error_msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="artdexfileloaderopen">ArtDexFileLoader::Open
</h2><p>通过上述分析可以得知,在OatFileManager::OpenDexFilesFromOat中</p>
<p>OatFileAssistant::LoadDexFiles最终也调用ArtDexFileLoader::Open,参数个数有所区别</p>
<p>OatFileAssistant::LoadDexFiles内调用9参数的Open(比较奇怪,调用时只传递了8个参数,第9个container没传)</p>
<p>参数解释</p>
<ul>
<li>base: 指向dex文件的内存地址</li>
<li>size: dex文件的大小</li>
<li>location: dex文件的位置</li>
<li>location_checksum: dex文件位置的校验和</li>
<li>oat_dex_file: 指向OatDexFile对象的指针</li>
<li>verify: 表示是否要对dex文件进行验证</li>
<li>verify_checksum: 表示是否要验证dex文件的校验和</li>
<li>error_msg: 指向错误信息字符串的指针</li>
</ul>
<p>直接调用了ArtDexFileLoader::OpenCommon</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">//art/libdexfile/dex/art_dex_file_loader.cc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">&gt;</span> <span class="n">ArtDexFileLoader</span><span class="o">::</span><span class="n">Open</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">base</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">size_t</span> <span class="n">size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">location_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">OatDexFile</span><span class="o">*</span> <span class="n">oat_dex_file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">verify</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">verify_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">error_msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">DexFileContainer</span><span class="o">&gt;</span> <span class="n">container</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">ScopedTrace</span> <span class="nf">trace</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&#34;Open dex file from RAM &#34;</span><span class="p">)</span> <span class="o">+</span> <span class="n">location</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">OpenCommon</span><span class="p">(</span><span class="n">base</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="cm">/*data_base=*/</span> <span class="k">nullptr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="cm">/*data_size=*/</span> <span class="mi">0u</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">location_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">oat_dex_file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">verify</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">verify_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">error_msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">container</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                    <span class="cm">/*verify_result=*/</span> <span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>OatFileManager::OpenDexFilesFromOat内部调用的6参数ArtDexFileLoader::Open,参数解释如下</p>
<ul>
<li>filename: dex文件名</li>
<li>location: dex文件的位置</li>
<li>verify_checksum: 表示是否要验证dex文件的校验和</li>
<li>error_msg: 指向错误信息字符串的指针</li>
<li>dex_files: 存储dex file的DexFile数组</li>
</ul>
<p>内部调用了ArtDexFileLoader::OpenWithMagic,判断文件头,如果是zip则通过OpenZip打开,如果是dex则通过OpenFile打开</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">//art/libdexfile/dex/art_dex_file_loader.cc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">bool</span> <span class="n">ArtDexFileLoader</span><span class="o">::</span><span class="n">Open</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filename</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="kt">bool</span> <span class="n">verify</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="kt">bool</span> <span class="n">verify_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">error_msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">&gt;&gt;*</span> <span class="n">dex_files</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint32_t</span> <span class="n">magic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//打开文件并读取magic[8],OpenAndReadMagic可作为一个常用脱壳点,但此时dex还没加载到内存中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">File</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">OpenAndReadMagic</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">magic</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">fd</span><span class="p">.</span><span class="n">Fd</span><span class="p">()</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DCHECK</span><span class="p">(</span><span class="o">!</span><span class="n">error_msg</span><span class="o">-&gt;</span><span class="n">empty</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">OpenWithMagic</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">magic</span><span class="p">,</span> <span class="n">fd</span><span class="p">.</span><span class="n">Release</span><span class="p">(),</span> <span class="n">location</span><span class="p">,</span> <span class="n">verify</span><span class="p">,</span> <span class="n">verify_checksum</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">,</span> <span class="n">dex_files</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">ArtDexFileLoader</span><span class="o">::</span><span class="n">OpenWithMagic</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">magic</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                     <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                     <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                     <span class="kt">bool</span> <span class="n">verify</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                     <span class="kt">bool</span> <span class="n">verify_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                     <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">error_msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                     <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">&gt;&gt;*</span> <span class="n">dex_files</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">ScopedTrace</span> <span class="nf">trace</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&#34;Open dex file &#34;</span><span class="p">)</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">location</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">DCHECK</span><span class="p">(</span><span class="n">dex_files</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;DexFile::Open: out-param is nullptr&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 如果是zip文件头,通过OpenZip打开zip文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">IsZipMagic</span><span class="p">(</span><span class="n">magic</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">OpenZip</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">verify</span><span class="p">,</span> <span class="n">verify_checksum</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">,</span> <span class="n">dex_files</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 如果是dex文件头,通过ArtDexFileLoader::OpenFile打开并创建DexFile对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">IsMagicValid</span><span class="p">(</span><span class="n">magic</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">&gt;</span> <span class="n">dex_file</span><span class="p">(</span><span class="n">OpenFile</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                     <span class="n">location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                     <span class="n">verify</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                     <span class="n">verify_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                     <span class="cm">/* mmap_shared= */</span> <span class="nb">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                     <span class="n">error_msg</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">dex_file</span><span class="p">.</span><span class="n">get</span><span class="p">()</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//打开dex文件成功,添加到DexFile数组中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">dex_files</span><span class="o">-&gt;</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">dex_file</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">error_msg</span> <span class="o">=</span> <span class="n">StringPrintf</span><span class="p">(</span><span class="s">&#34;Expected valid zip or dex file: &#39;%s&#39;&#34;</span><span class="p">,</span> <span class="n">location</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="artdexfileloaderopenzip">ArtDexFileLoader::OpenZip
</h3><p>内部调用OpenAllDexFilesFromZip</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">ArtDexFileLoader</span><span class="o">::</span><span class="n">OpenZip</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="kt">bool</span> <span class="n">verify</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="kt">bool</span> <span class="n">verify_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">error_msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">&gt;&gt;*</span> <span class="n">dex_files</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">ScopedTrace</span> <span class="nf">trace</span><span class="p">(</span><span class="s">&#34;Dex file open Zip &#34;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">location</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">DCHECK</span><span class="p">(</span><span class="n">dex_files</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;DexFile::OpenZip: out-param is nullptr&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">ZipArchive</span><span class="o">&gt;</span> <span class="n">zip_archive</span><span class="p">(</span><span class="n">ZipArchive</span><span class="o">::</span><span class="n">OpenFromFd</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">location</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">error_msg</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">zip_archive</span><span class="p">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DCHECK</span><span class="p">(</span><span class="o">!</span><span class="n">error_msg</span><span class="o">-&gt;</span><span class="n">empty</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">OpenAllDexFilesFromZip</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="n">zip_archive</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">verify</span><span class="p">,</span> <span class="n">verify_checksum</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">,</span> <span class="n">dex_files</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="artdexfileloaderopenalldexfilesfromzip">ArtDexFileLoader::OpenAllDexFilesFromZip
</h4><p>OpenAllDexFilesFromZip内部调用OpenOneDexFileFromZip打开dex文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">ArtDexFileLoader</span><span class="o">::</span><span class="n">OpenAllDexFilesFromZip</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">ZipArchive</span><span class="o">&amp;</span> <span class="n">zip_archive</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">verify</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">verify_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">error_msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">&gt;&gt;*</span> <span class="n">dex_files</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">ScopedTrace</span> <span class="nf">trace</span><span class="p">(</span><span class="s">&#34;Dex file open from Zip &#34;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">location</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">DCHECK</span><span class="p">(</span><span class="n">dex_files</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;DexFile::OpenFromZip: out-param is nullptr&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">DexFileLoaderErrorCode</span> <span class="n">error_code</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">&gt;</span> <span class="n">dex_file</span><span class="p">(</span><span class="n">OpenOneDexFileFromZip</span><span class="p">(</span><span class="n">zip_archive</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                                <span class="n">kClassesDex</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                                <span class="n">location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                                <span class="n">verify</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                                <span class="n">verify_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                                <span class="n">error_msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                                <span class="o">&amp;</span><span class="n">error_code</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">dex_file</span><span class="p">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Had at least classes.dex.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">dex_files</span><span class="o">-&gt;</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">dex_file</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Now try some more.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// We could try to avoid std::string allocations by working on a char array directly. As we
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// do not expect a lot of iterations, this seems too involved and brittle.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span> <span class="o">=</span> <span class="n">GetMultiDexClassesDexName</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">fake_location</span> <span class="o">=</span> <span class="n">GetMultiDexLocation</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">location</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">&gt;</span> <span class="n">next_dex_file</span><span class="p">(</span><span class="n">OpenOneDexFileFromZip</span><span class="p">(</span><span class="n">zip_archive</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                                         <span class="n">name</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                                                                         <span class="n">fake_location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                                         <span class="n">verify</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                                         <span class="n">verify_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                                         <span class="n">error_msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                                         <span class="o">&amp;</span><span class="n">error_code</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">next_dex_file</span><span class="p">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">error_code</span> <span class="o">!=</span> <span class="n">DexFileLoaderErrorCode</span><span class="o">::</span><span class="n">kEntryNotFound</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">LOG</span><span class="p">(</span><span class="n">WARNING</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Zip open failed: &#34;</span> <span class="o">&lt;&lt;</span> <span class="o">*</span><span class="n">error_msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">dex_files</span><span class="o">-&gt;</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">next_dex_file</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">kWarnOnManyDexFilesThreshold</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOG</span><span class="p">(</span><span class="n">WARNING</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">location</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; has in excess of &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">kWarnOnManyDexFilesThreshold</span>
</span></span><span class="line"><span class="cl">                     <span class="o">&lt;&lt;</span> <span class="s">&#34; dex files. Please consider coalescing and shrinking the number to &#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="s">&#34; avoid runtime overhead.&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">size_t</span><span class="o">&gt;::</span><span class="n">max</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Overflow in number of dex files!&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="artdexfileloaderopenonedexfilefromzip">ArtDexFileLoader::OpenOneDexFileFromZip
</h4><p>OpenOneDexFileFromZip内部调用OpenCommon打开dex文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">&gt;</span> <span class="n">ArtDexFileLoader</span><span class="o">::</span><span class="n">OpenOneDexFileFromZip</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">ZipArchive</span><span class="o">&amp;</span> <span class="n">zip_archive</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">entry_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">verify</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">verify_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">error_msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">DexFileLoaderErrorCode</span><span class="o">*</span> <span class="n">error_code</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">ScopedTrace</span> <span class="nf">trace</span><span class="p">(</span><span class="s">&#34;Dex file open from Zip Archive &#34;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">location</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">CHECK</span><span class="p">(</span><span class="o">!</span><span class="n">location</span><span class="p">.</span><span class="n">empty</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//1.通过zip_archive.Find找到给定的dex文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">ZipEntry</span><span class="o">&gt;</span> <span class="n">zip_entry</span><span class="p">(</span><span class="n">zip_archive</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">entry_name</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">zip_entry</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">DexFileLoaderErrorCode</span><span class="o">::</span><span class="n">kEntryNotFound</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">zip_entry</span><span class="o">-&gt;</span><span class="n">GetUncompressedLength</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">error_msg</span> <span class="o">=</span> <span class="n">StringPrintf</span><span class="p">(</span><span class="s">&#34;Dex file &#39;%s&#39; has zero length&#34;</span><span class="p">,</span> <span class="n">location</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">DexFileLoaderErrorCode</span><span class="o">::</span><span class="n">kDexFileError</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">MemMap</span> <span class="n">map</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">zip_entry</span><span class="o">-&gt;</span><span class="n">IsUncompressed</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//判断文件对齐
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zip_entry</span><span class="o">-&gt;</span><span class="n">IsAlignedTo</span><span class="p">(</span><span class="k">alignof</span><span class="p">(</span><span class="n">DexFile</span><span class="o">::</span><span class="n">Header</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Do not mmap unaligned ZIP entries because
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// doing so would fail dex verification which requires 4 byte alignment.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">LOG</span><span class="p">(</span><span class="n">WARNING</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Can&#39;t mmap dex file &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">location</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;!&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">entry_name</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; directly; &#34;</span>
</span></span><span class="line"><span class="cl">                   <span class="o">&lt;&lt;</span> <span class="s">&#34;please zipalign to &#34;</span> <span class="o">&lt;&lt;</span> <span class="k">alignof</span><span class="p">(</span><span class="n">DexFile</span><span class="o">::</span><span class="n">Header</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; bytes. &#34;</span>
</span></span><span class="line"><span class="cl">                   <span class="o">&lt;&lt;</span> <span class="s">&#34;Falling back to extracting file.&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//2.映射未压缩的文件,避免脏拷贝,例如lib库文件,arsc文件等
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// Map uncompressed files within zip as file-backed to avoid a dirty copy.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">map</span> <span class="o">=</span> <span class="n">zip_entry</span><span class="o">-&gt;</span><span class="n">MapDirectlyFromFile</span><span class="p">(</span><span class="n">location</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="cm">/*out*/</span><span class="n">error_msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map</span><span class="p">.</span><span class="n">IsValid</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOG</span><span class="p">(</span><span class="n">WARNING</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Can&#39;t mmap dex file &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">location</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;!&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">entry_name</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; directly; &#34;</span>
</span></span><span class="line"><span class="cl">                     <span class="o">&lt;&lt;</span> <span class="s">&#34;is your ZIP file corrupted? Falling back to extraction.&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Try again with Extraction which still has a chance of recovery.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//...... MemMap检测
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//3.调用OpenCommon打开dex文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">DexFile</span><span class="o">&gt;</span> <span class="n">dex_file</span> <span class="o">=</span> <span class="n">OpenCommon</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                 <span class="n">size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                 <span class="cm">/*data_base=*/</span> <span class="k">nullptr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                 <span class="cm">/*data_size=*/</span> <span class="mi">0u</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                 <span class="n">location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                 <span class="n">zip_entry</span><span class="o">-&gt;</span><span class="n">GetCrc32</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                                                 <span class="n">kNoOatDexFile</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                 <span class="n">verify</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                 <span class="n">verify_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                 <span class="n">error_msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                 <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">MemMapContainer</span><span class="o">&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">map</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">                                                 <span class="o">&amp;</span><span class="n">verify_result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 合法性检测
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">......</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">dex_file</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="artdexfileloaderopenfile">ArtDexFileLoader::OpenFile
</h3><p>内部调用ArtDexFileLoader::OpenCommon打开dex文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">&gt;</span> <span class="n">ArtDexFileLoader</span><span class="o">::</span><span class="n">OpenFile</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                          <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                          <span class="kt">bool</span> <span class="n">verify</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                          <span class="kt">bool</span> <span class="n">verify_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                          <span class="kt">bool</span> <span class="n">mmap_shared</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                          <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">error_msg</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">ScopedTrace</span> <span class="nf">trace</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&#34;Open dex file &#34;</span><span class="p">)</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">location</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">CHECK</span><span class="p">(</span><span class="o">!</span><span class="n">location</span><span class="p">.</span><span class="n">empty</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="n">MemMap</span> <span class="n">map</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">File</span> <span class="nf">delayed_close</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="cm">/* check_usage= */</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="nc">stat</span> <span class="n">sbuf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sbuf</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">fstat</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sbuf</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="n">error_msg</span> <span class="o">=</span> <span class="n">StringPrintf</span><span class="p">(</span><span class="s">&#34;DexFile: fstat &#39;%s&#39; failed: %s&#34;</span><span class="p">,</span> <span class="n">location</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                                <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">sbuf</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="n">error_msg</span> <span class="o">=</span> <span class="n">StringPrintf</span><span class="p">(</span><span class="s">&#34;Attempt to mmap directory &#39;%s&#39;&#34;</span><span class="p">,</span> <span class="n">location</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">size_t</span> <span class="n">length</span> <span class="o">=</span> <span class="n">sbuf</span><span class="p">.</span><span class="n">st_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//1.将dex文件映射到内存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">map</span> <span class="o">=</span> <span class="n">MemMap</span><span class="o">::</span><span class="n">MapFile</span><span class="p">(</span><span class="n">length</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">PROT_READ</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">mmap_shared</span> <span class="o">?</span> <span class="nl">MAP_SHARED</span> <span class="p">:</span> <span class="n">MAP_PRIVATE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">fd</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="cm">/*low_4gb=*/</span><span class="nb">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">location</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                          <span class="n">error_msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map</span><span class="p">.</span><span class="n">IsValid</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">DCHECK</span><span class="p">(</span><span class="o">!</span><span class="n">error_msg</span><span class="o">-&gt;</span><span class="n">empty</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">begin</span> <span class="o">=</span> <span class="n">map</span><span class="p">.</span><span class="n">Begin</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">map</span><span class="p">.</span><span class="n">Size</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DexFile</span><span class="o">::</span><span class="n">Header</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">error_msg</span> <span class="o">=</span> <span class="n">StringPrintf</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;DexFile: failed to open dex file &#39;%s&#39; that is too short to have a header&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">location</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">Header</span><span class="o">*</span> <span class="n">dex_header</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">Header</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">begin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">//2.调用OpenCommon打开dex文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">DexFile</span><span class="o">&gt;</span> <span class="n">dex_file</span> <span class="o">=</span> <span class="n">OpenCommon</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                 <span class="n">size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                 <span class="cm">/*data_base=*/</span> <span class="k">nullptr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                 <span class="cm">/*data_size=*/</span> <span class="mi">0u</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                 <span class="n">location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                 <span class="n">dex_header</span><span class="o">-&gt;</span><span class="n">checksum_</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                 <span class="n">kNoOatDexFile</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                 <span class="n">verify</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                 <span class="n">verify_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                 <span class="n">error_msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                 <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">MemMapContainer</span><span class="o">&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">map</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">                                                 <span class="cm">/*verify_result=*/</span> <span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Opening CompactDex is only supported from vdex files.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">dex_file</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="o">&amp;&amp;</span> <span class="n">dex_file</span><span class="o">-&gt;</span><span class="n">IsCompactDexFile</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">error_msg</span> <span class="o">=</span> <span class="n">StringPrintf</span><span class="p">(</span><span class="s">&#34;Opening CompactDex file &#39;%s&#39; is only supported from vdex files&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">location</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">dex_file</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="artdexfileloaderopencommon">ArtDexFileLoader::OpenCommon
</h3><p>无论是ArtDexFileLoader::OpenZip还是ArtDexFileLoader::OpenFile,最终都调用OpenCommon打开dex文件(Android 7对应函数为OpenMemory)</p>
<p>内部调用了DexFileLoader::OpenCommon</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">//art/libdexfile/dex/art_dex_file_loader.cc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">DexFile</span><span class="o">&gt;</span> <span class="n">ArtDexFileLoader</span><span class="o">::</span><span class="n">OpenCommon</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">base</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                      <span class="n">size_t</span> <span class="n">size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                      <span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">data_base</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                      <span class="n">size_t</span> <span class="n">data_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                      <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                      <span class="kt">uint32_t</span> <span class="n">location_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                      <span class="k">const</span> <span class="n">OatDexFile</span><span class="o">*</span> <span class="n">oat_dex_file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                      <span class="kt">bool</span> <span class="n">verify</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                      <span class="kt">bool</span> <span class="n">verify_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                      <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">error_msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                      <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">DexFileContainer</span><span class="o">&gt;</span> <span class="n">container</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                      <span class="n">VerifyResult</span><span class="o">*</span> <span class="n">verify_result</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">DexFileLoader</span><span class="o">::</span><span class="n">OpenCommon</span><span class="p">(</span><span class="n">base</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">data_base</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">data_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">location_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">oat_dex_file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">verify</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">verify_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">error_msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">container</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">verify_result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="dexfileloaderopencommon">DexFileLoader::OpenCommon
</h3><ol>
<li>根据不同情况,调用StandardDexFile或CompactDexFile的构造函数创建DexFile对象
<ul>
<li>如果magic == “dex\n”则证明dex文件是标准型的,调用new StandardDexFile()</li>
<li>如果magic == “cdex” 则证明dex文件是紧凑型的,调用new CompactDexFile()</li>
<li>StandardDexFile与CompactDexFile都继承与DexFile,所以都会去调用DexFile::DexFile()构造函数</li>
</ul>
</li>
<li>调用DexFile.Init方法进行初始化</li>
<li>调用DexFileVerifier::Verify对DexFile进行验证</li>
<li>返回DexFile</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">//art/libdexfile/dex/dex_file_loader.cc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">DexFile</span><span class="o">&gt;</span> <span class="n">DexFileLoader</span><span class="o">::</span><span class="n">OpenCommon</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">base</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                   <span class="n">size_t</span> <span class="n">size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                   <span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">data_base</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                   <span class="n">size_t</span> <span class="n">data_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                   <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                   <span class="kt">uint32_t</span> <span class="n">location_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                   <span class="k">const</span> <span class="n">OatDexFile</span><span class="o">*</span> <span class="n">oat_dex_file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                   <span class="kt">bool</span> <span class="n">verify</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                   <span class="kt">bool</span> <span class="n">verify_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                   <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">error_msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                   <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">DexFileContainer</span><span class="o">&gt;</span> <span class="n">container</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                   <span class="n">VerifyResult</span><span class="o">*</span> <span class="n">verify_result</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">verify_result</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">verify_result</span> <span class="o">=</span> <span class="n">VerifyResult</span><span class="o">::</span><span class="n">kVerifyNotAttempted</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//1.创建DexFile对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">DexFile</span><span class="o">&gt;</span> <span class="n">dex_file</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">StandardDexFile</span><span class="o">::</span><span class="n">Header</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">StandardDexFile</span><span class="o">::</span><span class="n">IsMagicValid</span><span class="p">(</span><span class="n">base</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">CHECK_EQ</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">data_base</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Unsupported for standard dex&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//调用StandardDexFile构造函数进行创建,定义在art/libdexfile/dex/standard_dex_file.h,继承自DexFile
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">dex_file</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">StandardDexFile</span><span class="p">(</span><span class="n">base</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="n">size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="n">location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="n">location_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="n">oat_dex_file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">container</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CompactDexFile</span><span class="o">::</span><span class="n">Header</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">CompactDexFile</span><span class="o">::</span><span class="n">IsMagicValid</span><span class="p">(</span><span class="n">base</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">data_base</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// TODO: Is there a clean way to support both an explicit data section and reading the one
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// from the header.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">CHECK_EQ</span><span class="p">(</span><span class="n">data_size</span><span class="p">,</span> <span class="mi">0u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="n">CompactDexFile</span><span class="o">::</span><span class="n">Header</span><span class="o">*</span> <span class="k">const</span> <span class="n">header</span> <span class="o">=</span> <span class="n">CompactDexFile</span><span class="o">::</span><span class="n">Header</span><span class="o">::</span><span class="n">At</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">data_base</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">data_off_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">data_size</span> <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">data_size_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 调用CompactDexFile构造函数进行创建,定义在art/libdexfile/dex/compact_dex_file.h,继承自DexFile
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">dex_file</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">CompactDexFile</span><span class="p">(</span><span class="n">base</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                      <span class="n">size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                      <span class="n">data_base</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                      <span class="n">data_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                      <span class="n">location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                      <span class="n">location_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                      <span class="n">oat_dex_file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                      <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">container</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Disable verification for CompactDex input.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">verify</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">error_msg</span> <span class="o">=</span> <span class="s">&#34;Invalid or truncated dex file&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">dex_file</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">error_msg</span> <span class="o">=</span> <span class="n">StringPrintf</span><span class="p">(</span><span class="s">&#34;Failed to open dex file &#39;%s&#39; from memory: %s&#34;</span><span class="p">,</span> <span class="n">location</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                              <span class="n">error_msg</span><span class="o">-&gt;</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//2.init初始化dexfile
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dex_file</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">(</span><span class="n">error_msg</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">dex_file</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//3.对dexfile进行验证
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">verify</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">DexFileVerifier</span><span class="o">::</span><span class="n">Verify</span><span class="p">(</span><span class="n">dex_file</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                                         <span class="n">dex_file</span><span class="o">-&gt;</span><span class="n">Begin</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                                         <span class="n">dex_file</span><span class="o">-&gt;</span><span class="n">Size</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                                         <span class="n">location</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                                         <span class="n">verify_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                         <span class="n">error_msg</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">verify_result</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="n">verify_result</span> <span class="o">=</span> <span class="n">VerifyResult</span><span class="o">::</span><span class="n">kVerifyFailed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">verify_result</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">verify_result</span> <span class="o">=</span> <span class="n">VerifyResult</span><span class="o">::</span><span class="n">kVerifySucceeded</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">dex_file</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="dexfileinit">DexFile::Init
</h4><p>检查dex文件头和版本号</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">//art/libdexfile/dex/dex_file.cc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">bool</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">Init</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">error_msg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CheckMagicAndVersion</span><span class="p">(</span><span class="n">error_msg</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">CheckMagicAndVersion</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">error_msg</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IsMagicValid</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">ostringstream</span> <span class="n">oss</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">oss</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Unrecognized magic number in &#34;</span>  <span class="o">&lt;&lt;</span> <span class="n">GetLocation</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;:&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="o">&lt;&lt;</span> <span class="s">&#34; &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">header_</span><span class="o">-&gt;</span><span class="n">magic_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="o">&lt;&lt;</span> <span class="s">&#34; &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">header_</span><span class="o">-&gt;</span><span class="n">magic_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="o">&lt;&lt;</span> <span class="s">&#34; &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">header_</span><span class="o">-&gt;</span><span class="n">magic_</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="o">&lt;&lt;</span> <span class="s">&#34; &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">header_</span><span class="o">-&gt;</span><span class="n">magic_</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">error_msg</span> <span class="o">=</span> <span class="n">oss</span><span class="p">.</span><span class="n">str</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IsVersionValid</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">ostringstream</span> <span class="n">oss</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">oss</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Unrecognized version number in &#34;</span>  <span class="o">&lt;&lt;</span> <span class="n">GetLocation</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;:&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="o">&lt;&lt;</span> <span class="s">&#34; &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">header_</span><span class="o">-&gt;</span><span class="n">magic_</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="o">&lt;&lt;</span> <span class="s">&#34; &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">header_</span><span class="o">-&gt;</span><span class="n">magic_</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="o">&lt;&lt;</span> <span class="s">&#34; &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">header_</span><span class="o">-&gt;</span><span class="n">magic_</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="o">&lt;&lt;</span> <span class="s">&#34; &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">header_</span><span class="o">-&gt;</span><span class="n">magic_</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">error_msg</span> <span class="o">=</span> <span class="n">oss</span><span class="p">.</span><span class="n">str</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="dexfileverifierverify">DexFileVerifier::Verify
</h4><p>检查dex文件头,maplist以及其他部分</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">//art/libdexfile/dex/dex_file_verifier.cc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">bool</span> <span class="n">DexFileVerifier</span><span class="o">::</span><span class="n">Verify</span><span class="p">(</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">*</span> <span class="n">dex_file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">begin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">size_t</span> <span class="n">size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="kt">bool</span> <span class="n">verify_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">error_msg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">DexFileVerifier</span><span class="o">&gt;</span> <span class="n">verifier</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="k">new</span> <span class="n">DexFileVerifier</span><span class="p">(</span><span class="n">dex_file</span><span class="p">,</span> <span class="n">begin</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">verify_checksum</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">verifier</span><span class="o">-&gt;</span><span class="n">Verify</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">error_msg</span> <span class="o">=</span> <span class="n">verifier</span><span class="o">-&gt;</span><span class="n">FailureReason</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">DexFileVerifier</span><span class="o">::</span><span class="n">Verify</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Check the header.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CheckHeader</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Check the map section.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CheckMap</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Check structure within remaining sections.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CheckIntraSection</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Check references from one section to another.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CheckInterSection</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="dexfiledexfile-1">DexFile::DexFile
</h3><p>StandardDexFile或CompactDexFile都继承自DexFile</p>
<p>构造函数DexFile():后的意思是赋值,将()中的变量依次赋值给()前的变量</p>
<p>该方法带有dex文件的base和size参数,所以可以作为一个脱壳点</p>
<p>内部调用了InitializeSectionsFromMapList</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">//art/libdexfile/dex/dex_file.cc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">DexFile</span><span class="o">::</span><span class="n">DexFile</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">base</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="n">size_t</span> <span class="n">size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">data_begin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="n">size_t</span> <span class="n">data_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="kt">uint32_t</span> <span class="n">location_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="k">const</span> <span class="n">OatDexFile</span><span class="o">*</span> <span class="n">oat_dex_file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">DexFileContainer</span><span class="o">&gt;</span> <span class="n">container</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="kt">bool</span> <span class="n">is_compact_dex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">:</span> <span class="n">begin_</span><span class="p">(</span><span class="n">base</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="n">size_</span><span class="p">(</span><span class="n">size</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="n">data_begin_</span><span class="p">(</span><span class="n">data_begin</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="n">data_size_</span><span class="p">(</span><span class="n">data_size</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="n">location_</span><span class="p">(</span><span class="n">location</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="n">location_checksum_</span><span class="p">(</span><span class="n">location_checksum</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="n">header_</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">Header</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">base</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">      <span class="n">string_ids_</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">StringId</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">header_</span><span class="o">-&gt;</span><span class="n">string_ids_off_</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">      <span class="n">type_ids_</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">TypeId</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">header_</span><span class="o">-&gt;</span><span class="n">type_ids_off_</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">      <span class="n">field_ids_</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">FieldId</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">header_</span><span class="o">-&gt;</span><span class="n">field_ids_off_</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">      <span class="n">method_ids_</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">MethodId</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">header_</span><span class="o">-&gt;</span><span class="n">method_ids_off_</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">      <span class="n">proto_ids_</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">ProtoId</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">header_</span><span class="o">-&gt;</span><span class="n">proto_ids_off_</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">      <span class="n">class_defs_</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">ClassDef</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">header_</span><span class="o">-&gt;</span><span class="n">class_defs_off_</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">      <span class="n">method_handles_</span><span class="p">(</span><span class="k">nullptr</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="n">num_method_handles_</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="n">call_site_ids_</span><span class="p">(</span><span class="k">nullptr</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="n">num_call_site_ids_</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="n">hiddenapi_class_data_</span><span class="p">(</span><span class="k">nullptr</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="n">oat_dex_file_</span><span class="p">(</span><span class="n">oat_dex_file</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="n">container_</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">container</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">      <span class="n">is_compact_dex_</span><span class="p">(</span><span class="n">is_compact_dex</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="n">hiddenapi_domain_</span><span class="p">(</span><span class="n">hiddenapi</span><span class="o">::</span><span class="n">Domain</span><span class="o">::</span><span class="n">kApplication</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">CHECK</span><span class="p">(</span><span class="n">begin_</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">GetLocation</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">CHECK_GT</span><span class="p">(</span><span class="n">size_</span><span class="p">,</span> <span class="mi">0U</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">GetLocation</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Check base (=header) alignment.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Must be 4-byte aligned to avoid undefined behavior when accessing
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// any of the sections via a pointer.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">CHECK_ALIGNED</span><span class="p">(</span><span class="n">begin_</span><span class="p">,</span> <span class="k">alignof</span><span class="p">(</span><span class="n">Header</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">InitializeSectionsFromMapList</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="dexfileinitializesectionsfrommaplist">DexFile::InitializeSectionsFromMapList
</h4><p>通过dex文件中的map_list结构解析dex文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">//art/libdexfile/dex/dex_file.cc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">InitializeSectionsFromMapList</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="n">MapList</span><span class="o">*</span> <span class="n">map_list</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">MapList</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">DataBegin</span><span class="p">()</span> <span class="o">+</span> <span class="n">header_</span><span class="o">-&gt;</span><span class="n">map_off_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">header_</span><span class="o">-&gt;</span><span class="n">map_off_</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">header_</span><span class="o">-&gt;</span><span class="n">map_off_</span> <span class="o">&gt;</span> <span class="n">DataSize</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Bad offset. The dex file verifier runs after this method and will reject the file.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="n">size_t</span> <span class="n">count</span> <span class="o">=</span> <span class="n">map_list</span><span class="o">-&gt;</span><span class="n">size_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">size_t</span> <span class="n">map_limit</span> <span class="o">=</span> <span class="n">header_</span><span class="o">-&gt;</span><span class="n">map_off_</span> <span class="o">+</span> <span class="n">count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MapItem</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">header_</span><span class="o">-&gt;</span><span class="n">map_off_</span> <span class="o">&gt;=</span> <span class="n">map_limit</span> <span class="o">||</span> <span class="n">map_limit</span> <span class="o">&gt;</span> <span class="n">DataSize</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Overflow or out out of bounds. The dex file verifier runs after
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// this method and will reject the file as it is malformed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">MapItem</span><span class="o">&amp;</span> <span class="n">map_item</span> <span class="o">=</span> <span class="n">map_list</span><span class="o">-&gt;</span><span class="n">list_</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">map_item</span><span class="p">.</span><span class="n">type_</span> <span class="o">==</span> <span class="n">kDexTypeMethodHandleItem</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">method_handles_</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">MethodHandleItem</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">Begin</span><span class="p">()</span> <span class="o">+</span> <span class="n">map_item</span><span class="p">.</span><span class="n">offset_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">num_method_handles_</span> <span class="o">=</span> <span class="n">map_item</span><span class="p">.</span><span class="n">size_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">map_item</span><span class="p">.</span><span class="n">type_</span> <span class="o">==</span> <span class="n">kDexTypeCallSiteIdItem</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">call_site_ids_</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">CallSiteIdItem</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">Begin</span><span class="p">()</span> <span class="o">+</span> <span class="n">map_item</span><span class="p">.</span><span class="n">offset_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">num_call_site_ids_</span> <span class="o">=</span> <span class="n">map_item</span><span class="p">.</span><span class="n">size_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">map_item</span><span class="p">.</span><span class="n">type_</span> <span class="o">==</span> <span class="n">kDexTypeHiddenapiClassData</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">hiddenapi_class_data_</span> <span class="o">=</span> <span class="n">GetHiddenapiClassDataAtOffset</span><span class="p">(</span><span class="n">map_item</span><span class="p">.</span><span class="n">offset_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Pointers to other sections are not necessary to retain in the DexFile struct.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// Other items have pointers directly into their data.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="inmemorydexclassloader">InMemoryDexClassLoader
</h2><p>以下代码分析基于Android 10.0_r47 <a class="link" href="https://cs.android.com/android/platform/superproject/&#43;/android-10.0.0_r47"  target="_blank" rel="noopener"
    >https://cs.android.com/android/platform/superproject/+/android-10.0.0_r47</a></p>
<p>Android 8.0中新增了InMemoryDexClassLoader,包含以下2个重载</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//libcore/dalvik/src/main/java/dalvik/system/InMemoryDexClassLoader.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">InMemoryDexClassLoader</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">BaseDexClassLoader</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">InMemoryDexClassLoader</span><span class="p">(</span><span class="n">ByteBuffer</span><span class="o">[]</span><span class="w"> </span><span class="n">dexBuffers</span><span class="p">,</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">parent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">(</span><span class="n">dexBuffers</span><span class="p">,</span><span class="w"> </span><span class="n">parent</span><span class="p">);</span><span class="c1">//调用父类BaseDexClassLoader构造函数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">InMemoryDexClassLoader</span><span class="p">(</span><span class="n">ByteBuffer</span><span class="w"> </span><span class="n">dexBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">parent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ByteBuffer</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">dexBuffer</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">parent</span><span class="p">);</span><span class="c1">//调用另一个重载</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//libcore/dalvik/src/main/java/dalvik/system/BaseDexClassLoader.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="nf">BaseDexClassLoader</span><span class="p">(</span><span class="n">ByteBuffer</span><span class="o">[]</span><span class="w"> </span><span class="n">dexFiles</span><span class="p">,</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">parent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">super</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">pathList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DexPathList</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">dexFiles</span><span class="p">);</span><span class="c1">//通过DexPathList进行处理</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>但执行壳代码进行替换classloader时,容易出现找不到lib库的情况,可参考以下文章解决so找不到的问题:</p>
<p><a class="link" href="https://blog.csdn.net/q610098308/article/details/105246355"  target="_blank" rel="noopener"
    >https://blog.csdn.net/q610098308/article/details/105246355</a></p>
<p><a class="link" href="http://www.yxhuang.com/2020/03/28/android-so-load/"  target="_blank" rel="noopener"
    >http://www.yxhuang.com/2020/03/28/android-so-load/</a></p>
<p>Android 10.0中新增了一个重载,支持传递lib库路径</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//libcore/dalvik/src/main/java/dalvik/system/InMemoryDexClassLoader.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">InMemoryDexClassLoader</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">BaseDexClassLoader</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">InMemoryDexClassLoader</span><span class="p">(</span><span class="nd">@NonNull</span><span class="w"> </span><span class="n">ByteBuffer</span><span class="w"> </span><span class="nd">@NonNull</span><span class="w"> </span><span class="o">[]</span><span class="w"> </span><span class="n">dexBuffers</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nd">@Nullable</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">librarySearchPath</span><span class="p">,</span><span class="w"> </span><span class="nd">@Nullable</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">parent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">(</span><span class="n">dexBuffers</span><span class="p">,</span><span class="w"> </span><span class="n">librarySearchPath</span><span class="p">,</span><span class="w"> </span><span class="n">parent</span><span class="p">);</span><span class="c1">//调用父类BaseDexClassLoader构造函数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">InMemoryDexClassLoader</span><span class="p">(</span><span class="nd">@NonNull</span><span class="w"> </span><span class="n">ByteBuffer</span><span class="w"> </span><span class="nd">@NonNull</span><span class="w"> </span><span class="o">[]</span><span class="w"> </span><span class="n">dexBuffers</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nd">@Nullable</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">parent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">(</span><span class="n">dexBuffers</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">parent</span><span class="p">);</span><span class="c1">//调用第1个重载</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">InMemoryDexClassLoader</span><span class="p">(</span><span class="nd">@NonNull</span><span class="w"> </span><span class="n">ByteBuffer</span><span class="w"> </span><span class="n">dexBuffer</span><span class="p">,</span><span class="w"> </span><span class="nd">@Nullable</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">parent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ByteBuffer</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">dexBuffer</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">parent</span><span class="p">);</span><span class="c1">//调用第2个重载</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="basedexclassloader-1">BaseDexClassLoader
</h3><p>InMemoryDexClassLoader继承自BaseDexClassLoader,对应方法在父类中实现,内部创建了DexPathList对象</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//libcore/dalvik/src/main/java/dalvik/system/BaseDexClassLoader.java    </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">public</span><span class="w"> </span><span class="nf">BaseDexClassLoader</span><span class="p">(</span><span class="n">ByteBuffer</span><span class="o">[]</span><span class="w"> </span><span class="n">dexFiles</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">librarySearchPath</span><span class="p">,</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">parent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">sharedLibraryLoaders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">pathList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DexPathList</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">librarySearchPath</span><span class="p">);</span><span class="c1">//创建对象并设置lib库目录</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">pathList</span><span class="p">.</span><span class="na">initByteBufferDexPath</span><span class="p">(</span><span class="n">dexFiles</span><span class="p">);</span><span class="c1">//根据字节流创建dex文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="dexpathlistdexpathlist-1">DexPathList::DexPathList
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//libcore/dalvik/src/main/java/dalvik/system/DexPathList.java    </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">public</span><span class="w"> </span><span class="nf">DexPathList</span><span class="p">(</span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">definingContext</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">librarySearchPath</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">definingContext</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">NullPointerException</span><span class="p">(</span><span class="s">&#34;definingContext == null&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">definingContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">definingContext</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//分割传入的lib库目录(支持通过一个String传递多个)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">nativeLibraryDirectories</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">splitPaths</span><span class="p">(</span><span class="n">librarySearchPath</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//系统lib库目录</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">systemNativeLibraryDirectories</span><span class="w"> </span><span class="o">=</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">splitPaths</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="s">&#34;java.library.path&#34;</span><span class="p">),</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//将所有lib库目录封装为NativeLibraryElement对象并添加到elements数组</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">nativeLibraryPathElements</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">makePathElements</span><span class="p">(</span><span class="n">getAllNativeLibraryDirectories</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>getAllNativeLibraryDirectories代码如下,将传入的lib库和系统lib库目录添加到一起并返回</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getAllNativeLibraryDirectories</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span><span class="w"> </span><span class="n">allNativeLibraryDirectories</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">nativeLibraryDirectories</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">allNativeLibraryDirectories</span><span class="p">.</span><span class="na">addAll</span><span class="p">(</span><span class="n">systemNativeLibraryDirectories</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">allNativeLibraryDirectories</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="dexpathlistmakepathelements">DexPathList::makePathElements
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//libcore/dalvik/src/main/java/dalvik/system/DexPathList.java    </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nd">@UnsupportedAppUsage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">NativeLibraryElement</span><span class="o">[]</span><span class="w"> </span><span class="nf">makePathElements</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span><span class="w"> </span><span class="n">files</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">NativeLibraryElement</span><span class="o">[]</span><span class="w"> </span><span class="n">elements</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">NativeLibraryElement</span><span class="o">[</span><span class="n">files</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">elementsPos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//遍历files,将存在的lib库封装为NativeLibraryElement对象,并添加到elements中</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">File</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">files</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file</span><span class="p">.</span><span class="na">getPath</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">path</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">zipSeparator</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">String</span><span class="w"> </span><span class="n">split</span><span class="o">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="n">zipSeparator</span><span class="p">,</span><span class="w"> </span><span class="n">2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">File</span><span class="w"> </span><span class="n">zip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">split</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">String</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">elements</span><span class="o">[</span><span class="n">elementsPos</span><span class="o">++]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">NativeLibraryElement</span><span class="p">(</span><span class="n">zip</span><span class="p">,</span><span class="w"> </span><span class="n">dir</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="na">isDirectory</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// We support directories for looking up native libraries.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">elements</span><span class="o">[</span><span class="n">elementsPos</span><span class="o">++]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">NativeLibraryElement</span><span class="p">(</span><span class="n">file</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">elementsPos</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">elements</span><span class="p">.</span><span class="na">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">elements</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arrays</span><span class="p">.</span><span class="na">copyOf</span><span class="p">(</span><span class="n">elements</span><span class="p">,</span><span class="w"> </span><span class="n">elementsPos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">elements</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="dexpathlistinitbytebufferdexpath">DexPathList::initByteBufferDexPath
</h3><p>调用DexFile创建了dex文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//libcore/dalvik/src/main/java/dalvik/system/DexPathList.java	</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kt">void</span><span class="w"> </span><span class="nf">initByteBufferDexPath</span><span class="p">(</span><span class="n">ByteBuffer</span><span class="o">[]</span><span class="w"> </span><span class="n">dexFiles</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="c1">//......合法性检查</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">IOException</span><span class="o">&gt;</span><span class="w"> </span><span class="n">suppressedExceptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">IOException</span><span class="o">&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Element</span><span class="o">[]</span><span class="w"> </span><span class="n">null_elements</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//1.创建dexfile</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">DexFile</span><span class="w"> </span><span class="n">dex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DexFile</span><span class="p">(</span><span class="n">dexFiles</span><span class="p">,</span><span class="w"> </span><span class="n">definingContext</span><span class="p">,</span><span class="w"> </span><span class="n">null_elements</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// Capture class loader context from *before* `dexElements` is set (see comment below).</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">classLoaderContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dex</span><span class="p">.</span><span class="na">isBackedByOatFile</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="o">?</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">DexFile</span><span class="p">.</span><span class="na">getClassLoaderContext</span><span class="p">(</span><span class="n">definingContext</span><span class="p">,</span><span class="w"> </span><span class="n">null_elements</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//2.创建dexElements</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">dexElements</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Element</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Element</span><span class="p">(</span><span class="n">dex</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// Spawn background thread to verify all classes and cache verification results.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// Must be called *after* `dexElements` has been initialized for ART to find</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// its classes (the field is hardcoded in ART and dex files iterated over in</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// the order of the array), but with class loader context from *before*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// `dexElements` was set because that is what it will be compared against next</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// time the same bytecode is loaded.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// We only spawn the background thread if the bytecode is not backed by an oat</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// file, i.e. this is the first time this bytecode is being loaded and/or</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// verification results have not been cached yet. Skip spawning the thread on</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// all subsequent loads of the same bytecode in the same class loader context.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">classLoaderContext</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">dex</span><span class="p">.</span><span class="na">verifyInBackground</span><span class="p">(</span><span class="n">definingContext</span><span class="p">,</span><span class="w"> </span><span class="n">classLoaderContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">suppressed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">logE</span><span class="p">(</span><span class="s">&#34;Unable to load dex files&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">suppressed</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">suppressedExceptions</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">suppressed</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">dexElements</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Element</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">suppressedExceptions</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">dexElementsSuppressedExceptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">suppressedExceptions</span><span class="p">.</span><span class="na">toArray</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">new</span><span class="w"> </span><span class="n">IOException</span><span class="o">[</span><span class="n">suppressedExceptions</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="o">]</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="dexfiledexfile-2">DexFile::DexFile
</h3><p>调用openInMemoryDexFiles</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//libcore/dalvik/src/main/java/dalvik/system/DexFile.java    </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">DexFile</span><span class="p">(</span><span class="n">ByteBuffer</span><span class="o">[]</span><span class="w"> </span><span class="n">bufs</span><span class="p">,</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">loader</span><span class="p">,</span><span class="w"> </span><span class="n">DexPathList</span><span class="p">.</span><span class="na">Element</span><span class="o">[]</span><span class="w"> </span><span class="n">elements</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">mCookie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">openInMemoryDexFiles</span><span class="p">(</span><span class="n">bufs</span><span class="p">,</span><span class="w"> </span><span class="n">loader</span><span class="p">,</span><span class="w"> </span><span class="n">elements</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">mInternalCookie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mCookie</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">mFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="dexfileopeninmemorydexfiles">DexFile::openInMemoryDexFiles
</h3><p>调用openInMemoryDexFilesNative</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">openInMemoryDexFiles</span><span class="p">(</span><span class="n">ByteBuffer</span><span class="o">[]</span><span class="w"> </span><span class="n">bufs</span><span class="p">,</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">loader</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">DexPathList</span><span class="p">.</span><span class="na">Element</span><span class="o">[]</span><span class="w"> </span><span class="n">elements</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Preprocess the ByteBuffers for openInMemoryDexFilesNative. We extract</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// the backing array (non-direct buffers only) and start/end positions</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// so that the native method does not have to call Java methods anymore.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[][]</span><span class="w"> </span><span class="n">arrays</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="n">bufs</span><span class="p">.</span><span class="na">length</span><span class="o">][]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[</span><span class="n">bufs</span><span class="p">.</span><span class="na">length</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">ends</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[</span><span class="n">bufs</span><span class="p">.</span><span class="na">length</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">bufs</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">arrays</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bufs</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="na">isDirect</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">bufs</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="na">array</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">starts</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bufs</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="na">position</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ends</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bufs</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="na">limit</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">openInMemoryDexFilesNative</span><span class="p">(</span><span class="n">bufs</span><span class="p">,</span><span class="w"> </span><span class="n">arrays</span><span class="p">,</span><span class="w"> </span><span class="n">starts</span><span class="p">,</span><span class="w"> </span><span class="n">ends</span><span class="p">,</span><span class="w"> </span><span class="n">loader</span><span class="p">,</span><span class="w"> </span><span class="n">elements</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">native</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">openInMemoryDexFilesNative</span><span class="p">(</span><span class="n">ByteBuffer</span><span class="o">[]</span><span class="w"> </span><span class="n">bufs</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[][]</span><span class="w"> </span><span class="n">arrays</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">starts</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">ends</span><span class="p">,</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">loader</span><span class="p">,</span><span class="w"> </span><span class="n">DexPathList</span><span class="p">.</span><span class="na">Element</span><span class="o">[]</span><span class="w"> </span><span class="n">elements</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="dexfile_openinmemorydexfilesnative">DexFile_openInMemoryDexFilesNative
</h3><p>openInMemoryDexFilesNative对应实现方法为DexFile_openInMemoryDexFilesNative</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">//art/runtime/native/dalvik_system_DexFile.cc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="n">jobject</span> <span class="nf">DexFile_openInMemoryDexFilesNative</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                  <span class="n">jclass</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                  <span class="n">jobjectArray</span> <span class="n">buffers</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                  <span class="n">jobjectArray</span> <span class="n">arrays</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                  <span class="n">jintArray</span> <span class="n">jstarts</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                  <span class="n">jintArray</span> <span class="n">jends</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                  <span class="n">jobject</span> <span class="n">class_loader</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                  <span class="n">jobjectArray</span> <span class="n">dex_elements</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">jsize</span> <span class="n">buffers_length</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetArrayLength</span><span class="p">(</span><span class="n">buffers</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">CHECK_EQ</span><span class="p">(</span><span class="n">buffers_length</span><span class="p">,</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetArrayLength</span><span class="p">(</span><span class="n">arrays</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">CHECK_EQ</span><span class="p">(</span><span class="n">buffers_length</span><span class="p">,</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetArrayLength</span><span class="p">(</span><span class="n">jstarts</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">CHECK_EQ</span><span class="p">(</span><span class="n">buffers_length</span><span class="p">,</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetArrayLength</span><span class="p">(</span><span class="n">jends</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">ScopedIntArrayAccessor</span> <span class="n">starts</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">jstarts</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">ScopedIntArrayAccessor</span> <span class="n">ends</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">jends</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Allocate memory for dex files and copy data from ByteBuffers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MemMap</span><span class="o">&gt;</span> <span class="n">dex_mem_maps</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">dex_mem_maps</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">buffers_length</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">jsize</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">buffers_length</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">jobject</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetObjectArrayElement</span><span class="p">(</span><span class="n">buffers</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">jbyteArray</span> <span class="n">array</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">jbyteArray</span><span class="o">&gt;</span><span class="p">(</span><span class="n">env</span><span class="o">-&gt;</span><span class="n">GetObjectArrayElement</span><span class="p">(</span><span class="n">arrays</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">jint</span> <span class="n">start</span> <span class="o">=</span> <span class="n">starts</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">jint</span> <span class="n">end</span> <span class="o">=</span> <span class="n">ends</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//1.分配dex内存映射空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">MemMap</span> <span class="n">dex_data</span> <span class="o">=</span> <span class="n">AllocateDexMemoryMap</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dex_data</span><span class="p">.</span><span class="n">IsValid</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">DCHECK</span><span class="p">(</span><span class="n">Thread</span><span class="o">::</span><span class="n">Current</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">IsExceptionPending</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">array</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Direct ByteBuffer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">base_address</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">env</span><span class="o">-&gt;</span><span class="n">GetDirectBufferAddress</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">base_address</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ScopedObjectAccess</span> <span class="n">soa</span><span class="p">(</span><span class="n">env</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ThrowWrappedIOException</span><span class="p">(</span><span class="s">&#34;dexFileBuffer not direct&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">size_t</span> <span class="n">length</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//2.复制dex文件到内存中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">memcpy</span><span class="p">(</span><span class="n">dex_data</span><span class="p">.</span><span class="n">Begin</span><span class="p">(),</span> <span class="n">base_address</span> <span class="o">+</span> <span class="n">start</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// ByteBuffer backed by a byte array
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">jbyte</span><span class="o">*</span> <span class="n">destination</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">jbyte</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">dex_data</span><span class="p">.</span><span class="n">Begin</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetByteArrayRegion</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">destination</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">dex_mem_maps</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">dex_data</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Hand MemMaps over to OatFileManager to open the dex files and potentially
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// create a backing OatFile instance from an anonymous vdex.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">error_msgs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="n">OatFile</span><span class="o">*</span> <span class="n">oat_file</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//通过OpenDexFilesFromOat打开oat文件获取dex文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">&gt;&gt;</span> <span class="n">dex_files</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="n">Runtime</span><span class="o">::</span><span class="n">Current</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetOatFileManager</span><span class="p">().</span><span class="n">OpenDexFilesFromOat</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">dex_mem_maps</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                                                  <span class="n">class_loader</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                                  <span class="n">dex_elements</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                                  <span class="cm">/*out*/</span> <span class="o">&amp;</span><span class="n">oat_file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                                  <span class="cm">/*out*/</span> <span class="o">&amp;</span><span class="n">error_msgs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//创建dex文件的cookie并返回
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="n">CreateCookieFromOatFileManagerResult</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">dex_files</span><span class="p">,</span> <span class="n">oat_file</span><span class="p">,</span> <span class="n">error_msgs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="oatfilemanageropendexfilesfromoat-1">OatFileManager::OpenDexFilesFromOat
</h3><p>该函数是一个不同的重载,内部调用了OpenDexFilesFromOat_Impl创建dexfile</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">//art/runtime/oat_file_manager.cc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">&gt;&gt;</span> <span class="n">OatFileManager</span><span class="o">::</span><span class="n">OpenDexFilesFromOat</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MemMap</span><span class="o">&gt;&amp;&amp;</span> <span class="n">dex_mem_maps</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">jobject</span> <span class="n">class_loader</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">jobjectArray</span> <span class="n">dex_elements</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">OatFile</span><span class="o">**</span> <span class="n">out_oat_file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;*</span> <span class="n">error_msgs</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">&gt;&gt;</span> <span class="n">dex_files</span> <span class="o">=</span> <span class="n">OpenDexFilesFromOat_Impl</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">dex_mem_maps</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="n">class_loader</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">dex_elements</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">out_oat_file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">error_msgs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">error_msgs</span><span class="o">-&gt;</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Remove write permission from DexFile pages. We do this at the end because
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// OatFile assigns OatDexFile pointer in the DexFile objects.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">&gt;&amp;</span> <span class="nl">dex_file</span> <span class="p">:</span> <span class="n">dex_files</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dex_file</span><span class="o">-&gt;</span><span class="n">DisableWrite</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">error_msgs</span><span class="o">-&gt;</span><span class="n">push_back</span><span class="p">(</span><span class="s">&#34;Failed to make dex file &#34;</span> <span class="o">+</span> <span class="n">dex_file</span><span class="o">-&gt;</span><span class="n">GetLocation</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34; read-only&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error_msgs</span><span class="o">-&gt;</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">&gt;&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">dex_files</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="oatfilemanageropendexfilesfromoat_impl">OatFileManager::OpenDexFilesFromOat_Impl
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">&gt;&gt;</span> <span class="n">OatFileManager</span><span class="o">::</span><span class="n">OpenDexFilesFromOat_Impl</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MemMap</span><span class="o">&gt;&amp;&amp;</span> <span class="n">dex_mem_maps</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">jobject</span> <span class="n">class_loader</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">jobjectArray</span> <span class="n">dex_elements</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">OatFile</span><span class="o">**</span> <span class="n">out_oat_file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;*</span> <span class="n">error_msgs</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">ScopedTrace</span> <span class="nf">trace</span><span class="p">(</span><span class="n">__FUNCTION__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">error_msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">DCHECK</span><span class="p">(</span><span class="n">error_msgs</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Extract dex file headers from `dex_mem_maps`.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 1.从dex内存映射中提取dex文件头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">Header</span><span class="o">*&gt;</span> <span class="n">dex_headers</span> <span class="o">=</span> <span class="n">GetDexFileHeaders</span><span class="p">(</span><span class="n">dex_mem_maps</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Determine dex/vdex locations and the combined location checksum.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">uint32_t</span> <span class="n">location_checksum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">dex_location</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">vdex_path</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//检测是否存在vdex文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">bool</span> <span class="n">has_vdex</span> <span class="o">=</span> <span class="n">OatFileAssistant</span><span class="o">::</span><span class="n">AnonymousDexVdexLocation</span><span class="p">(</span><span class="n">dex_headers</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                             <span class="n">kRuntimeISA</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                             <span class="o">&amp;</span><span class="n">location_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                             <span class="o">&amp;</span><span class="n">dex_location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                             <span class="o">&amp;</span><span class="n">vdex_path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Attempt to open an existing vdex and check dex file checksums match.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">VdexFile</span><span class="o">&gt;</span> <span class="n">vdex_file</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">has_vdex</span> <span class="o">&amp;&amp;</span> <span class="n">OS</span><span class="o">::</span><span class="n">FileExists</span><span class="p">(</span><span class="n">vdex_path</span><span class="p">.</span><span class="n">c_str</span><span class="p">()))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//打开vdex文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">vdex_file</span> <span class="o">=</span> <span class="n">VdexFile</span><span class="o">::</span><span class="n">Open</span><span class="p">(</span><span class="n">vdex_path</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="cm">/* writable= */</span> <span class="nb">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="cm">/* low_4gb= */</span> <span class="nb">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="cm">/* unquicken= */</span> <span class="nb">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="o">&amp;</span><span class="n">error_msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">vdex_file</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">LOG</span><span class="p">(</span><span class="n">WARNING</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Failed to open vdex &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">vdex_path</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">error_msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vdex_file</span><span class="o">-&gt;</span><span class="n">MatchesDexFileChecksums</span><span class="p">(</span><span class="n">dex_headers</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">LOG</span><span class="p">(</span><span class="n">WARNING</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Failed to open vdex &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">vdex_path</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;: dex file checksum mismatch&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">vdex_file</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Load dex files. Skip structural dex file verification if vdex was found
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// and dex checksums matched.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//不存在vdex文件,并且dex的校验码符合
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">&gt;&gt;</span> <span class="n">dex_files</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dex_mem_maps</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="k">constexpr</span> <span class="kt">bool</span> <span class="n">kVerifyChecksum</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">ArtDexFileLoader</span> <span class="n">dex_file_loader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//通过ArtDexFileLoader.Open方法打开DexFile
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">&gt;</span> <span class="n">dex_file</span><span class="p">(</span><span class="n">dex_file_loader</span><span class="p">.</span><span class="n">Open</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">DexFileLoader</span><span class="o">::</span><span class="n">GetMultiDexLocation</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dex_location</span><span class="p">.</span><span class="n">c_str</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">        <span class="n">location_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">dex_mem_maps</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* verify= */</span> <span class="p">(</span><span class="n">vdex_file</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">Runtime</span><span class="o">::</span><span class="n">Current</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">IsVerificationEnabled</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="n">kVerifyChecksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="o">&amp;</span><span class="n">error_msg</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">dex_file</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">dex</span><span class="o">::</span><span class="n">tracking</span><span class="o">::</span><span class="n">RegisterDexFile</span><span class="p">(</span><span class="n">dex_file</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>  <span class="c1">// Register for tracking.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">dex_files</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">dex_file</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">error_msgs</span><span class="o">-&gt;</span><span class="n">push_back</span><span class="p">(</span><span class="s">&#34;Failed to open dex files from memory: &#34;</span> <span class="o">+</span> <span class="n">error_msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Check if we should proceed to creating an OatFile instance backed by the vdex.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// We need: (a) an existing vdex, (b) class loader (can be null if invoked via reflection),
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// and (c) no errors during dex file loading.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">vdex_file</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">||</span> <span class="n">class_loader</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">||</span> <span class="o">!</span><span class="n">error_msgs</span><span class="o">-&gt;</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">dex_files</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Attempt to create a class loader context, check OpenDexFiles succeeds (prerequisite
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// for using the context later).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">ClassLoaderContext</span><span class="o">&gt;</span> <span class="n">context</span> <span class="o">=</span> <span class="n">ClassLoaderContext</span><span class="o">::</span><span class="n">CreateContextForClassLoader</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">class_loader</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">dex_elements</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">context</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Could not create class loader context for &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">vdex_path</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">dex_files</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">DCHECK</span><span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">OpenDexFiles</span><span class="p">(</span><span class="n">kRuntimeISA</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;&lt;</span> <span class="s">&#34;Context created from already opened dex files should not attempt to open again&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Check that we can use the vdex against this boot class path and in this class loader context.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Note 1: We do not need a class loader collision check because there is no compiled code.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Note 2: If these checks fail, we cannot fast-verify because the vdex does not contain
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//         full VerifierDeps.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vdex_file</span><span class="o">-&gt;</span><span class="n">MatchesBootClassPathChecksums</span><span class="p">()</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="o">!</span><span class="n">vdex_file</span><span class="o">-&gt;</span><span class="n">MatchesClassLoaderContext</span><span class="p">(</span><span class="o">*</span><span class="n">context</span><span class="p">.</span><span class="n">get</span><span class="p">()))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">dex_files</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Initialize an OatFile instance backed by the loaded vdex.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">OatFile</span><span class="o">&gt;</span> <span class="n">oat_file</span><span class="p">(</span><span class="n">OatFile</span><span class="o">::</span><span class="n">OpenFromVdex</span><span class="p">(</span><span class="n">MakeNonOwningPointerVector</span><span class="p">(</span><span class="n">dex_files</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                                          <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">vdex_file</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                                          <span class="n">dex_location</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">DCHECK</span><span class="p">(</span><span class="n">oat_file</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">VLOG</span><span class="p">(</span><span class="n">class_linker</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Registering &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">oat_file</span><span class="o">-&gt;</span><span class="n">GetLocation</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">out_oat_file</span> <span class="o">=</span> <span class="n">RegisterOatFile</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">oat_file</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">dex_files</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="artdexfileloaderopen-1">ArtDexFileLoader::Open
</h3><p>虽然和之前类似,调用了ArtDexFileLoader::Open,但是参数略有不同</p>
<p>不过内部依然通过调用OpenCommon打开dex文件,之后的流程类似</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">&gt;</span> <span class="n">ArtDexFileLoader</span><span class="o">::</span><span class="n">Open</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                      <span class="kt">uint32_t</span> <span class="n">location_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                      <span class="n">MemMap</span><span class="o">&amp;&amp;</span> <span class="n">map</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                      <span class="kt">bool</span> <span class="n">verify</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                      <span class="kt">bool</span> <span class="n">verify_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                      <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">error_msg</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">ScopedTrace</span> <span class="nf">trace</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&#34;Open dex file from mapped-memory &#34;</span><span class="p">)</span> <span class="o">+</span> <span class="n">location</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">CHECK</span><span class="p">(</span><span class="n">map</span><span class="p">.</span><span class="n">IsValid</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">map</span><span class="p">.</span><span class="n">Size</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DexFile</span><span class="o">::</span><span class="n">Header</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">error_msg</span> <span class="o">=</span> <span class="n">StringPrintf</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;DexFile: failed to open dex file &#39;%s&#39; that is too short to have a header&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">location</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">begin</span> <span class="o">=</span> <span class="n">map</span><span class="p">.</span><span class="n">Begin</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//调用OpenCommon打开dexfile
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">DexFile</span><span class="o">&gt;</span> <span class="n">dex_file</span> <span class="o">=</span> <span class="n">OpenCommon</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                 <span class="n">size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                 <span class="cm">/*data_base=*/</span> <span class="k">nullptr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                 <span class="cm">/*data_size=*/</span> <span class="mi">0u</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                 <span class="n">location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                 <span class="n">location_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                 <span class="n">kNoOatDexFile</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                 <span class="n">verify</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                 <span class="n">verify_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                 <span class="n">error_msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                 <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">MemMapContainer</span><span class="o">&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">map</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">                                                 <span class="cm">/*verify_result=*/</span> <span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Opening CompactDex is only supported from vdex files.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">dex_file</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="o">&amp;&amp;</span> <span class="n">dex_file</span><span class="o">-&gt;</span><span class="n">IsCompactDexFile</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">error_msg</span> <span class="o">=</span> <span class="n">StringPrintf</span><span class="p">(</span><span class="s">&#34;Opening CompactDex file &#39;%s&#39; is only supported from vdex files&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">location</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">dex_file</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="artdexfileloaderopencommon-1">ArtDexFileLoader::OpenCommon
</h3><p>调用了DexFileLoader::OpenCommon,之后的流程同上</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">DexFile</span><span class="o">&gt;</span> <span class="n">ArtDexFileLoader</span><span class="o">::</span><span class="n">OpenCommon</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">base</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                      <span class="n">size_t</span> <span class="n">size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                      <span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">data_base</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                      <span class="n">size_t</span> <span class="n">data_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                      <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                      <span class="kt">uint32_t</span> <span class="n">location_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                      <span class="k">const</span> <span class="n">OatDexFile</span><span class="o">*</span> <span class="n">oat_dex_file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                      <span class="kt">bool</span> <span class="n">verify</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                      <span class="kt">bool</span> <span class="n">verify_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                      <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">error_msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                      <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">DexFileContainer</span><span class="o">&gt;</span> <span class="n">container</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                      <span class="n">VerifyResult</span><span class="o">*</span> <span class="n">verify_result</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">DexFileLoader</span><span class="o">::</span><span class="n">OpenCommon</span><span class="p">(</span><span class="n">base</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">data_base</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">data_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">location_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">oat_dex_file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">verify</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">verify_checksum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">error_msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">container</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">verify_result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="十二-classloader加载class流程详解">十二. ClassLoader加载Class流程详解
</h1><p>参考<a class="link" href="https://www.cnblogs.com/revercc/p/16808386.html"  target="_blank" rel="noopener"
    >android类加载源码分析</a>和<a class="link" href="https://www.cnblogs.com/luoyesiqiu/p/classload.html"  target="_blank" rel="noopener"
    >Android类加载流程</a></p>
<p>在类被加载之前,其对应的dex文件已经在内存中</p>
<p><img src="/photos%5c44-Android%e7%b1%bb%e5%8a%a0%e8%bd%bd%e6%b5%81%e7%a8%8b%e7%99%bd%e5%ba%95.png"
	
	
	
	loading="lazy"
	
	
></p>
<h2 id="classloaderloadclass">ClassLoader::LoadClass
</h2><p>ClassLoader类是所有类加载器的虚基类,在静态/动态加载一个类时会首先调用此虚基类的LoadClass函数,执行以下步骤</p>
<ol>
<li>查找该类是否加载,已经加载则直接获取对应Class类对象</li>
<li>尝试调用父加载器loadClass进行加载</li>
<li>若该类未加载且父加载器未加载,则调用自身的findClass加载</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//libcore/ojluni/src/main/java/java/lang/ClassLoader.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="kd">protected</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">loadClass</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">resolve</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">throws</span><span class="w"> </span><span class="n">ClassNotFoundException</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// First, check if the class has already been loaded</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//1.查找此类是否已经加载</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findLoadedClass</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">parent</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="c1">//2.父加载器不为空,调用父加载器.loadClass加载此类</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parent</span><span class="p">.</span><span class="na">loadClass</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="c1">//父加载器为空,说明此加载器为根加载器BootClassLoader,让根加载器去加载</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findBootstrapClassOrNull</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">// ClassNotFoundException thrown if class not found</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">// from the non-null parent class loader</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">// If still not found, then invoke findClass in order</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">// to find the class.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">//3.如果父加载器都加载不了就让当前类加载器调用findclass去加载.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findClass</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="basedexclassloaderfindclass">BaseDexClassLoader::findClass
</h2><p>BaseDexClassLoader继承自ClassLoader虚类,Android常用的加载器基本都继承于BaseDexClassLoader类</p>
<p>所以会先调用BaseDexClassLoader.findClass方法,内部调用了DexPathList.findClass</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//libcore/dalvik/src/main/java/dalvik/system/BaseDexClassLoader.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">findClass</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Check whether the class in question is present in the dexPath that</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// this classloader operates on.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Throwable</span><span class="o">&gt;</span><span class="w"> </span><span class="n">suppressedExceptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Throwable</span><span class="o">&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pathList</span><span class="p">.</span><span class="na">findClass</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">suppressedExceptions</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>DexPathList.findClass方法内部调用Element.findClass方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//libcore/dalvik/src/main/java/dalvik/system/DexPathList.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">findClass</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Throwable</span><span class="o">&gt;</span><span class="w"> </span><span class="n">suppressed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Element</span><span class="w"> </span><span class="n">element</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">dexElements</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element</span><span class="p">.</span><span class="na">findClass</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">definingContext</span><span class="p">,</span><span class="w"> </span><span class="n">suppressed</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clazz</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">clazz</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dexElementsSuppressedExceptions</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">suppressed</span><span class="p">.</span><span class="na">addAll</span><span class="p">(</span><span class="n">Arrays</span><span class="p">.</span><span class="na">asList</span><span class="p">(</span><span class="n">dexElementsSuppressedExceptions</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Element.findClass方法调用DexFile.loadClassBinaryName</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//libcore/dalvik/src/main/java/dalvik/system/DexPathList.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">findClass</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">definingContext</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Throwable</span><span class="o">&gt;</span><span class="w"> </span><span class="n">suppressed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">dexFile</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">dexFile</span><span class="p">.</span><span class="na">loadClassBinaryName</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">definingContext</span><span class="p">,</span><span class="w"> </span><span class="n">suppressed</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="defineclassnative-jni">defineClassNative (JNI)
</h2><p>Element.findClass方法内部调用loadClassBinaryName函数</p>
<p>loadClassBinaryName函数接着会调用defineClass-&gt;defineClassNative,该函数是一个native函数在art虚拟机中实现</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//libcore/dalvik/src/main/java/dalvik/system/DexFile.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Class</span><span class="w"> </span><span class="nf">loadClassBinaryName</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">loader</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Throwable</span><span class="o">&gt;</span><span class="w"> </span><span class="n">suppressed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">defineClass</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">loader</span><span class="p">,</span><span class="w"> </span><span class="n">mCookie</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">suppressed</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Class</span><span class="w"> </span><span class="nf">defineClass</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">loader</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">cookie</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                     </span><span class="n">DexFile</span><span class="w"> </span><span class="n">dexFile</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Throwable</span><span class="o">&gt;</span><span class="w"> </span><span class="n">suppressed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">defineClassNative</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">loader</span><span class="p">,</span><span class="w"> </span><span class="n">cookie</span><span class="p">,</span><span class="w"> </span><span class="n">dexFile</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">NoClassDefFoundError</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">suppressed</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">suppressed</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">suppressed</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">suppressed</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="dexfile_defineclassnative">DexFile_defineClassNative
</h2><p>defineClassNative对应的art中的native函数为DexFile_defineClassNative,在art中进行类的字段,方法的加载</p>
<p>DexFile_defineClassNative的函数调用链如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">DexFile_defineClassNative()
</span></span><span class="line"><span class="cl"> ├─ FindClassDef
</span></span><span class="line"><span class="cl"> │  ClassLinker::DefineClass
</span></span><span class="line"><span class="cl"> │  └─ ClassLinker::LoadClass
</span></span><span class="line"><span class="cl"> │      └─ LoadField
</span></span><span class="line"><span class="cl"> │         LoadMethod
</span></span><span class="line"><span class="cl"> │         LinkCode
</span></span><span class="line"><span class="cl"> └─ InsertDexFileInToClassLoader  
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>FindClassDef枚举此类加载器的所有dex文件,并在这些dex文件中寻找Class_def看是否等于当前加载类,如果找不到则返回失败</li>
<li>ClassLinker::DefineClass加载对应类的字段和方法</li>
<li>将对应的DexFile添加到类加载器对应的ClassTable中</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//art/runtime/native/dalvik_system_DexFile.cc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">static</span><span class="w"> </span><span class="n">jclass</span><span class="w"> </span><span class="nf">DexFile_defineClassNative</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                        </span><span class="n">jclass</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                        </span><span class="n">jstring</span><span class="w"> </span><span class="n">javaName</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                        </span><span class="n">jobject</span><span class="w"> </span><span class="n">javaLoader</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                        </span><span class="n">jobject</span><span class="w"> </span><span class="n">cookie</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                        </span><span class="n">jobject</span><span class="w"> </span><span class="n">dexFile</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">std</span><span class="p">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kd">const</span><span class="w"> </span><span class="n">DexFile</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">dex_files</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">string</span><span class="w"> </span><span class="nf">descriptor</span><span class="p">(</span><span class="n">DotToDescriptor</span><span class="p">(</span><span class="n">class_name</span><span class="p">.</span><span class="na">c_str</span><span class="p">()));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="n">size_t</span><span class="w"> </span><span class="nf">hash</span><span class="p">(</span><span class="n">ComputeModifiedUtf8Hash</span><span class="p">(</span><span class="n">descriptor</span><span class="p">.</span><span class="na">c_str</span><span class="p">()));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">//枚举此类加载器的所有dex文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">dex_file</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">dex_files</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//1.找到dex中的ClassDef</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="n">dex</span><span class="p">::</span><span class="n">ClassDef</span><span class="o">*</span><span class="w"> </span><span class="n">dex_class_def</span><span class="w"> </span><span class="o">=</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">OatDexFile</span><span class="p">::</span><span class="n">FindClassDef</span><span class="p">(</span><span class="o">*</span><span class="n">dex_file</span><span class="p">,</span><span class="w"> </span><span class="n">descriptor</span><span class="p">.</span><span class="na">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">hash</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dex_class_def</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">ScopedObjectAccess</span><span class="w"> </span><span class="nf">soa</span><span class="p">(</span><span class="n">env</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">ClassLinker</span><span class="o">*</span><span class="w"> </span><span class="n">class_linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Runtime</span><span class="p">::</span><span class="n">Current</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetClassLinker</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">StackHandleScope</span><span class="o">&lt;</span><span class="n">1</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">hs</span><span class="p">(</span><span class="n">soa</span><span class="p">.</span><span class="na">Self</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">Handle</span><span class="o">&lt;</span><span class="n">mirror</span><span class="p">::</span><span class="n">ClassLoader</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">class_loader</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">hs</span><span class="p">.</span><span class="na">NewHandle</span><span class="p">(</span><span class="n">soa</span><span class="p">.</span><span class="na">Decode</span><span class="o">&lt;</span><span class="n">mirror</span><span class="p">::</span><span class="n">ClassLoader</span><span class="o">&gt;</span><span class="p">(</span><span class="n">javaLoader</span><span class="p">)));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">ObjPtr</span><span class="o">&lt;</span><span class="n">mirror</span><span class="p">::</span><span class="n">DexCache</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dex_cache</span><span class="w"> </span><span class="o">=</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">class_linker</span><span class="o">-&gt;</span><span class="n">RegisterDexFile</span><span class="p">(</span><span class="o">*</span><span class="n">dex_file</span><span class="p">,</span><span class="w"> </span><span class="n">class_loader</span><span class="p">.</span><span class="na">Get</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dex_cache</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// OOME or InternalError (dexFile already registered with a different class loader).</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">soa</span><span class="p">.</span><span class="na">Self</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">AssertPendingException</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">nullptr</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">//2.完成目标类的加载</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">ObjPtr</span><span class="o">&lt;</span><span class="n">mirror</span><span class="p">::</span><span class="n">Class</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">class_linker</span><span class="o">-&gt;</span><span class="n">DefineClass</span><span class="p">(</span><span class="n">soa</span><span class="p">.</span><span class="na">Self</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                               </span><span class="n">descriptor</span><span class="p">.</span><span class="na">c_str</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                               </span><span class="n">hash</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                               </span><span class="n">class_loader</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                               </span><span class="o">*</span><span class="n">dex_file</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                               </span><span class="o">*</span><span class="n">dex_class_def</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">//3.将对应的DexFile添加到类加载器对应的ClassTable中</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// Add the used dex file. This only required for the DexFile.loadClass API since normal</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// class loaders already keep their dex files live.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">class_linker</span><span class="o">-&gt;</span><span class="n">InsertDexFileInToClassLoader</span><span class="p">(</span><span class="n">soa</span><span class="p">.</span><span class="na">Decode</span><span class="o">&lt;</span><span class="n">mirror</span><span class="p">::</span><span class="n">Object</span><span class="o">&gt;</span><span class="p">(</span><span class="n">dexFile</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                 </span><span class="n">class_loader</span><span class="p">.</span><span class="na">Get</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="classlinkerdefineclass">ClassLinker::DefineClass
</h2><p>DefineClass主要就是调用ClassLinker::LoadClass加载对应类的字段和方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">//art/runtime/class_linker.cc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">ObjPtr</span><span class="o">&lt;</span><span class="n">mirror</span><span class="o">::</span><span class="n">Class</span><span class="o">&gt;</span> <span class="n">ClassLinker</span><span class="o">::</span><span class="n">DefineClass</span><span class="p">(</span><span class="n">Thread</span><span class="o">*</span> <span class="n">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                               <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">descriptor</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                               <span class="n">size_t</span> <span class="n">hash</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                               <span class="n">Handle</span><span class="o">&lt;</span><span class="n">mirror</span><span class="o">::</span><span class="n">ClassLoader</span><span class="o">&gt;</span> <span class="n">class_loader</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                               <span class="k">const</span> <span class="n">DexFile</span><span class="o">&amp;</span> <span class="n">dex_file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                               <span class="k">const</span> <span class="n">dex</span><span class="o">::</span><span class="n">ClassDef</span><span class="o">&amp;</span> <span class="n">dex_class_def</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//从DexFile dex文件中（内存中的）加载所有的field和method
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Load the fields and other things after we are inserted in the table. This is so that we don&#39;t
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// end up allocating unfree-able linear alloc resources and then lose the race condition. The
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// other reason is that the field roots are only visited from the class table. So we need to be
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// inserted before we allocate / fill in these fields.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">LoadClass</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="n">new_dex_file</span><span class="p">,</span> <span class="o">*</span><span class="n">new_class_def</span><span class="p">,</span> <span class="n">klass</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="classlinkerloadclass">ClassLinker::LoadClass
</h2><p>ClassLinker::LoadClass调用LoadField加载所有的字段,调用<strong>LoadMethod</strong>加载所有的方法.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">//art/runtime/class_linker.cc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">ClassLinker</span><span class="o">::</span><span class="n">LoadClass</span><span class="p">(</span><span class="n">Thread</span><span class="o">*</span> <span class="n">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="k">const</span> <span class="n">DexFile</span><span class="o">&amp;</span> <span class="n">dex_file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="k">const</span> <span class="n">dex</span><span class="o">::</span><span class="n">ClassDef</span><span class="o">&amp;</span> <span class="n">dex_class_def</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">Handle</span><span class="o">&lt;</span><span class="n">mirror</span><span class="o">::</span><span class="n">Class</span><span class="o">&gt;</span> <span class="n">klass</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">uint16_t</span> <span class="n">hotness_threshold</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">GetJITOptions</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetWarmupThreshold</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Use the visitor since the ranged based loops are bit slower from seeking. Seeking to the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// methods needs to decode all of the fields.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">accessor</span><span class="p">.</span><span class="n">VisitFieldsAndMethods</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//加载所有的静态field
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">const</span> <span class="n">ClassAccessor</span><span class="o">::</span><span class="n">Field</span><span class="o">&amp;</span> <span class="n">field</span><span class="p">)</span> <span class="n">REQUIRES_SHARED</span><span class="p">(</span><span class="n">Locks</span><span class="o">::</span><span class="n">mutator_lock_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="kt">uint32_t</span> <span class="n">field_idx</span> <span class="o">=</span> <span class="n">field</span><span class="p">.</span><span class="n">GetIndex</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">          <span class="n">DCHECK_GE</span><span class="p">(</span><span class="n">field_idx</span><span class="p">,</span> <span class="n">last_static_field_idx</span><span class="p">);</span>  <span class="c1">// Ordering enforced by DexFileVerifier.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="k">if</span> <span class="p">(</span><span class="n">num_sfields</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">LIKELY</span><span class="p">(</span><span class="n">field_idx</span> <span class="o">&gt;</span> <span class="n">last_static_field_idx</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">LoadField</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">klass</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sfields</span><span class="o">-&gt;</span><span class="n">At</span><span class="p">(</span><span class="n">num_sfields</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="o">++</span><span class="n">num_sfields</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">last_static_field_idx</span> <span class="o">=</span> <span class="n">field_idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="k">const</span> <span class="n">ClassAccessor</span><span class="o">::</span><span class="n">Field</span><span class="o">&amp;</span> <span class="n">field</span><span class="p">)</span> <span class="n">REQUIRES_SHARED</span><span class="p">(</span><span class="n">Locks</span><span class="o">::</span><span class="n">mutator_lock_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="c1">//加载所有的field
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="kt">uint32_t</span> <span class="n">field_idx</span> <span class="o">=</span> <span class="n">field</span><span class="p">.</span><span class="n">GetIndex</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">          <span class="n">DCHECK_GE</span><span class="p">(</span><span class="n">field_idx</span><span class="p">,</span> <span class="n">last_instance_field_idx</span><span class="p">);</span>  <span class="c1">// Ordering enforced by DexFileVerifier.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="k">if</span> <span class="p">(</span><span class="n">num_ifields</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">LIKELY</span><span class="p">(</span><span class="n">field_idx</span> <span class="o">&gt;</span> <span class="n">last_instance_field_idx</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">LoadField</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">klass</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifields</span><span class="o">-&gt;</span><span class="n">At</span><span class="p">(</span><span class="n">num_ifields</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="o">++</span><span class="n">num_ifields</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">last_instance_field_idx</span> <span class="o">=</span> <span class="n">field_idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="k">const</span> <span class="n">ClassAccessor</span><span class="o">::</span><span class="n">Method</span><span class="o">&amp;</span> <span class="n">method</span><span class="p">)</span> <span class="n">REQUIRES_SHARED</span><span class="p">(</span><span class="n">Locks</span><span class="o">::</span><span class="n">mutator_lock_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="c1">//加载所有的对象方法（direct method）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="n">ArtMethod</span><span class="o">*</span> <span class="n">art_method</span> <span class="o">=</span> <span class="n">klass</span><span class="o">-&gt;</span><span class="n">GetDirectMethodUnchecked</span><span class="p">(</span><span class="n">class_def_method_index</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="n">image_pointer_size_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="n">LoadMethod</span><span class="p">(</span><span class="n">dex_file</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">klass</span><span class="p">.</span><span class="n">Get</span><span class="p">(),</span> <span class="n">art_method</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="n">LinkCode</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">art_method</span><span class="p">,</span> <span class="n">oat_class_ptr</span><span class="p">,</span> <span class="n">class_def_method_index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="kt">uint32_t</span> <span class="n">it_method_index</span> <span class="o">=</span> <span class="n">method</span><span class="p">.</span><span class="n">GetIndex</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="n">last_dex_method_index</span> <span class="o">==</span> <span class="n">it_method_index</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// duplicate case
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">art_method</span><span class="o">-&gt;</span><span class="n">SetMethodIndex</span><span class="p">(</span><span class="n">last_class_def_method_index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">art_method</span><span class="o">-&gt;</span><span class="n">SetMethodIndex</span><span class="p">(</span><span class="n">class_def_method_index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">last_dex_method_index</span> <span class="o">=</span> <span class="n">it_method_index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">last_class_def_method_index</span> <span class="o">=</span> <span class="n">class_def_method_index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="n">art_method</span><span class="o">-&gt;</span><span class="n">ResetCounter</span><span class="p">(</span><span class="n">hotness_threshold</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="o">++</span><span class="n">class_def_method_index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="k">const</span> <span class="n">ClassAccessor</span><span class="o">::</span><span class="n">Method</span><span class="o">&amp;</span> <span class="n">method</span><span class="p">)</span> <span class="n">REQUIRES_SHARED</span><span class="p">(</span><span class="n">Locks</span><span class="o">::</span><span class="n">mutator_lock_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="c1">//加载所有的抽象方法（virtual method）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="n">ArtMethod</span><span class="o">*</span> <span class="n">art_method</span> <span class="o">=</span> <span class="n">klass</span><span class="o">-&gt;</span><span class="n">GetVirtualMethodUnchecked</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">              <span class="n">class_def_method_index</span> <span class="o">-</span> <span class="n">accessor</span><span class="p">.</span><span class="n">NumDirectMethods</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">              <span class="n">image_pointer_size_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="n">art_method</span><span class="o">-&gt;</span><span class="n">ResetCounter</span><span class="p">(</span><span class="n">hotness_threshold</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="n">LoadMethod</span><span class="p">(</span><span class="n">dex_file</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">klass</span><span class="p">.</span><span class="n">Get</span><span class="p">(),</span> <span class="n">art_method</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="n">LinkCode</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">art_method</span><span class="p">,</span> <span class="n">oat_class_ptr</span><span class="p">,</span> <span class="n">class_def_method_index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="o">++</span><span class="n">class_def_method_index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="十三-创建应用程序进程详解">十三. 创建应用程序进程详解
</h1><p>创建应用程序进程主要分为2部分:</p>
<ul>
<li>AMS向Zygote发送启动应用程序进程请求</li>
<li>Zygote接收AMS请求并创建应用程序进程</li>
</ul>
<h2 id="ams发送启动应用程序进程请求">AMS发送启动应用程序进程请求
</h2><p>时序图如下</p>
<p><img src="/photos%5c45-AMS%e5%8f%91%e9%80%81%e5%90%af%e5%8a%a8%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f%e8%bf%9b%e7%a8%8b%e8%af%b7%e6%b1%82%e6%97%b6%e5%ba%8f%e5%9b%be.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>假设此时启动应用程序所需的进程不存在,则AMS通过startProcessLocked方法向Zygote发送请求</p>
<p>startProcessLocked内部调用了Process.start启动进程,另外entryPoint是android.app.ActivityThread</p>
<ul>
<li>
<p>注释1处 获取创建应用程序进程的用户ID</p>
</li>
<li>
<p>注释2处 对用户组ID (gids)进行创建和赋值</p>
</li>
<li>
<p>注释3处 如果entryPoint=null,则赋值为&quot;android.app.ActivityThread&quot; 即<strong>应用程序进程主线程的类名</strong></p>
</li>
<li>
<p>注释4处 调用Process.start启动应用程序进程</p>
<p>传递了应用程序进程用户id,用户组gids,以及entryPoint</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java    </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">startProcessLocked</span><span class="p">(</span><span class="n">ProcessRecord</span><span class="w"> </span><span class="n">app</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">hostingType</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">hostingNameStr</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">abiOverride</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">entryPoint</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">entryPointArgs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="c1">//...... check time</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="na">uid</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">AppGlobals</span><span class="p">.</span><span class="na">getPackageManager</span><span class="p">().</span><span class="na">checkPackageStartable</span><span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="na">info</span><span class="p">.</span><span class="na">packageName</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">rethrowAsRuntimeException</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//1.获取要创建的应用程序进程的用户ID</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">uid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">app</span><span class="p">.</span><span class="na">uid</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">gids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">mountExternal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Zygote</span><span class="p">.</span><span class="na">MOUNT_EXTERNAL_NONE</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">app</span><span class="p">.</span><span class="na">isolated</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="c1">//...... check</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">                 * Add shared application and profile GIDs so applications can share some
</span></span></span><span class="line"><span class="cl"><span class="cm">                 * resources like shared libraries and access user-wide resources
</span></span></span><span class="line"><span class="cl"><span class="cm">                 */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">//2.对gids进行创建和赋值</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ArrayUtils</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">(</span><span class="n">permGids</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">gids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[</span><span class="n">3</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">gids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[</span><span class="n">permGids</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">3</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">System</span><span class="p">.</span><span class="na">arraycopy</span><span class="p">(</span><span class="n">permGids</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">gids</span><span class="p">,</span><span class="w"> </span><span class="n">3</span><span class="p">,</span><span class="w"> </span><span class="n">permGids</span><span class="p">.</span><span class="na">length</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">gids</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">getSharedAppGid</span><span class="p">(</span><span class="n">UserHandle</span><span class="p">.</span><span class="na">getAppId</span><span class="p">(</span><span class="n">uid</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">gids</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">getCacheAppGid</span><span class="p">(</span><span class="n">UserHandle</span><span class="p">.</span><span class="na">getAppId</span><span class="p">(</span><span class="n">uid</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">gids</span><span class="o">[</span><span class="n">2</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">getUserGid</span><span class="p">(</span><span class="n">UserHandle</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(</span><span class="n">uid</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           	</span><span class="c1">// check time and others .......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// Start the process.  It will either succeed and return a result containing</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// the PID of the new process, or else throw a RuntimeException.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//3.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isActivityProcess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">entryPoint</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">entryPoint</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="n">entryPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;android.app.ActivityThread&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Trace</span><span class="p">.</span><span class="na">traceBegin</span><span class="p">(</span><span class="n">Trace</span><span class="p">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;Start proc: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">app</span><span class="p">.</span><span class="na">processName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">checkTime</span><span class="p">(</span><span class="n">startTime</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;startProcess: asking zygote to start proc&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ProcessStartResult</span><span class="w"> </span><span class="n">startResult</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//判断是否为webview服务</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hostingType</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&#34;webview_service&#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">//启动webview</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">startResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">startWebView</span><span class="p">(</span><span class="n">entryPoint</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">app</span><span class="p">.</span><span class="na">processName</span><span class="p">,</span><span class="w"> </span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="n">gids</span><span class="p">,</span><span class="w"> </span><span class="n">debugFlags</span><span class="p">,</span><span class="w"> </span><span class="n">mountExternal</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">app</span><span class="p">.</span><span class="na">info</span><span class="p">.</span><span class="na">targetSdkVersion</span><span class="p">,</span><span class="w"> </span><span class="n">seInfo</span><span class="p">,</span><span class="w"> </span><span class="n">requiredAbi</span><span class="p">,</span><span class="w"> </span><span class="n">instructionSet</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">app</span><span class="p">.</span><span class="na">info</span><span class="p">.</span><span class="na">dataDir</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">entryPointArgs</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">//4.调用Process.start启动应用程序进程</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">startResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Process</span><span class="p">.</span><span class="na">start</span><span class="p">(</span><span class="n">entryPoint</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">app</span><span class="p">.</span><span class="na">processName</span><span class="p">,</span><span class="w"> </span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="n">gids</span><span class="p">,</span><span class="w"> </span><span class="n">debugFlags</span><span class="p">,</span><span class="w"> </span><span class="n">mountExternal</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">app</span><span class="p">.</span><span class="na">info</span><span class="p">.</span><span class="na">targetSdkVersion</span><span class="p">,</span><span class="w"> </span><span class="n">seInfo</span><span class="p">,</span><span class="w"> </span><span class="n">requiredAbi</span><span class="p">,</span><span class="w"> </span><span class="n">instructionSet</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">app</span><span class="p">.</span><span class="na">info</span><span class="p">.</span><span class="na">dataDir</span><span class="p">,</span><span class="w"> </span><span class="n">invokeWith</span><span class="p">,</span><span class="w"> </span><span class="n">entryPointArgs</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="c1">//......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RuntimeException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="c1">//......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Process.start内部调用了zygoteProcess.start</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//frameworks/base/core/java/android/os/Process.java    </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ProcessStartResult</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">processClass</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                  </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">niceName</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                  </span><span class="kt">int</span><span class="w"> </span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">gids</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                  </span><span class="kt">int</span><span class="w"> </span><span class="n">debugFlags</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mountExternal</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                  </span><span class="kt">int</span><span class="w"> </span><span class="n">targetSdkVersion</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                  </span><span class="n">String</span><span class="w"> </span><span class="n">seInfo</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                  </span><span class="n">String</span><span class="w"> </span><span class="n">abi</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                  </span><span class="n">String</span><span class="w"> </span><span class="n">instructionSet</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                  </span><span class="n">String</span><span class="w"> </span><span class="n">appDataDir</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                  </span><span class="n">String</span><span class="w"> </span><span class="n">invokeWith</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                  </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">zygoteArgs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">zygoteProcess</span><span class="p">.</span><span class="na">start</span><span class="p">(</span><span class="n">processClass</span><span class="p">,</span><span class="w"> </span><span class="n">niceName</span><span class="p">,</span><span class="w"> </span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="n">gid</span><span class="p">,</span><span class="w"> </span><span class="n">gids</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">debugFlags</span><span class="p">,</span><span class="w"> </span><span class="n">mountExternal</span><span class="p">,</span><span class="w"> </span><span class="n">targetSdkVersion</span><span class="p">,</span><span class="w"> </span><span class="n">seInfo</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">abi</span><span class="p">,</span><span class="w"> </span><span class="n">instructionSet</span><span class="p">,</span><span class="w"> </span><span class="n">appDataDir</span><span class="p">,</span><span class="w"> </span><span class="n">invokeWith</span><span class="p">,</span><span class="w"> </span><span class="n">zygoteArgs</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ZygoteProcess.start调用了startViaZygote</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//frameworks/base/core/java/android/os/ZygoteProcess.java    </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Process</span><span class="p">.</span><span class="na">ProcessStartResult</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">processClass</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                  </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">niceName</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                  </span><span class="kt">int</span><span class="w"> </span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">gids</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                  </span><span class="kt">int</span><span class="w"> </span><span class="n">debugFlags</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mountExternal</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                  </span><span class="kt">int</span><span class="w"> </span><span class="n">targetSdkVersion</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                  </span><span class="n">String</span><span class="w"> </span><span class="n">seInfo</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                  </span><span class="n">String</span><span class="w"> </span><span class="n">abi</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                  </span><span class="n">String</span><span class="w"> </span><span class="n">instructionSet</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                  </span><span class="n">String</span><span class="w"> </span><span class="n">appDataDir</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                  </span><span class="n">String</span><span class="w"> </span><span class="n">invokeWith</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                  </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">zygoteArgs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">startViaZygote</span><span class="p">(</span><span class="n">processClass</span><span class="p">,</span><span class="w"> </span><span class="n">niceName</span><span class="p">,</span><span class="w"> </span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="n">gid</span><span class="p">,</span><span class="w"> </span><span class="n">gids</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">debugFlags</span><span class="p">,</span><span class="w"> </span><span class="n">mountExternal</span><span class="p">,</span><span class="w"> </span><span class="n">targetSdkVersion</span><span class="p">,</span><span class="w"> </span><span class="n">seInfo</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">abi</span><span class="p">,</span><span class="w"> </span><span class="n">instructionSet</span><span class="p">,</span><span class="w"> </span><span class="n">appDataDir</span><span class="p">,</span><span class="w"> </span><span class="n">invokeWith</span><span class="p">,</span><span class="w"> </span><span class="n">zygoteArgs</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ZygoteStartFailedEx</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="n">LOG_TAG</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="s">&#34;Starting VM process through Zygote failed&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="s">&#34;Starting VM process through Zygote failed&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">ex</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ZygoteProcess.startViaZygote保存应用进程的启动参数后,调用zygoteSendArgsAndGetResult</p>
<p>首先调用了openZygoteSocketIfNeeded</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//frameworks/base/core/java/android/os/ZygoteProcess.java    </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">private</span><span class="w"> </span><span class="n">Process</span><span class="p">.</span><span class="na">ProcessStartResult</span><span class="w"> </span><span class="nf">startViaZygote</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">processClass</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                      </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">niceName</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                      </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gid</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                      </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">gids</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                      </span><span class="kt">int</span><span class="w"> </span><span class="n">debugFlags</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mountExternal</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                      </span><span class="kt">int</span><span class="w"> </span><span class="n">targetSdkVersion</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                      </span><span class="n">String</span><span class="w"> </span><span class="n">seInfo</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                      </span><span class="n">String</span><span class="w"> </span><span class="n">abi</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                      </span><span class="n">String</span><span class="w"> </span><span class="n">instructionSet</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                      </span><span class="n">String</span><span class="w"> </span><span class="n">appDataDir</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                      </span><span class="n">String</span><span class="w"> </span><span class="n">invokeWith</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                      </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">extraArgs</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                      </span><span class="kd">throws</span><span class="w"> </span><span class="n">ZygoteStartFailedEx</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//1.创建字符串列表,用于保存应用进程的启动参数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">argsForZygote</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// --runtime-args, --setuid=, --setgid=,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// and --setgroups= must go first</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">argsForZygote</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&#34;--runtime-args&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">argsForZygote</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&#34;--setuid=&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">uid</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">argsForZygote</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&#34;--setgid=&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gid</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">debugFlags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Zygote</span><span class="p">.</span><span class="na">DEBUG_ENABLE_JNI_LOGGING</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">argsForZygote</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&#34;--enable-jni-logging&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="c1">//......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">synchronized</span><span class="p">(</span><span class="n">mLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">zygoteSendArgsAndGetResult</span><span class="p">(</span><span class="n">openZygoteSocketIfNeeded</span><span class="p">(</span><span class="n">abi</span><span class="p">),</span><span class="w"> </span><span class="n">argsForZygote</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ZygoteProcess.openZygoteSocketIfNeeded如下,主要是和Zygote进程通过Socket建立连接,并返回Zygote进程的状态</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//frameworks/base/core/java/android/os/ZygoteProcess.java    </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Tries to open socket to Zygote process if not already open. If
</span></span></span><span class="line"><span class="cl"><span class="cm">     * already open, does nothing.  May block and retry.  Requires that mLock be held.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@GuardedBy</span><span class="p">(</span><span class="s">&#34;mLock&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ZygoteState</span><span class="w"> </span><span class="nf">openZygoteSocketIfNeeded</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">abi</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">ZygoteStartFailedEx</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//检查当前线程是否持有mLock锁,没有则抛出异常</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Preconditions</span><span class="p">.</span><span class="na">checkState</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="na">holdsLock</span><span class="p">(</span><span class="n">mLock</span><span class="p">),</span><span class="w"> </span><span class="s">&#34;ZygoteProcess lock not held&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">primaryZygoteState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">primaryZygoteState</span><span class="p">.</span><span class="na">isClosed</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">//通过Socket与主Zygote进程建立连接</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">primaryZygoteState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ZygoteState</span><span class="p">.</span><span class="na">connect</span><span class="p">(</span><span class="n">mSocket</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">ioe</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ZygoteStartFailedEx</span><span class="p">(</span><span class="s">&#34;Error connecting to primary zygote&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">ioe</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//检查主Zygote进程和目标进程abi是否匹配,匹配则返回主Zygote进程状态</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">primaryZygoteState</span><span class="p">.</span><span class="na">matches</span><span class="p">(</span><span class="n">abi</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">primaryZygoteState</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// The primary zygote didn&#39;t match. Try the secondary.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// abi不匹配,尝试与辅Zygote进程建立连接</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">secondaryZygoteState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">secondaryZygoteState</span><span class="p">.</span><span class="na">isClosed</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">//通过Socket与辅Zygote进程建立连接</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">secondaryZygoteState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ZygoteState</span><span class="p">.</span><span class="na">connect</span><span class="p">(</span><span class="n">mSecondarySocket</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">ioe</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ZygoteStartFailedEx</span><span class="p">(</span><span class="s">&#34;Error connecting to secondary zygote&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">ioe</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//返回辅zygote进程状态</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">secondaryZygoteState</span><span class="p">.</span><span class="na">matches</span><span class="p">(</span><span class="n">abi</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">secondaryZygoteState</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ZygoteStartFailedEx</span><span class="p">(</span><span class="s">&#34;Unsupported zygote ABI: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">abi</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>zygoteSendArgsAndGetResult代码如下</p>
<p>主要功能为将应用进程启动参数写入zygoteState(ZygoteProcess的静态内部类,用于表示与Zygote进程的通信状态)</p>
<p>然后与Zygote进程通信,等待发送新创建的进程pid和usingWrapper; 如果pid&gt;=0则进程创建成功</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//frameworks/base/core/java/android/os/ZygoteProcess.java    </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nd">@GuardedBy</span><span class="p">(</span><span class="s">&#34;mLock&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Process</span><span class="p">.</span><span class="na">ProcessStartResult</span><span class="w"> </span><span class="nf">zygoteSendArgsAndGetResult</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ZygoteState</span><span class="w"> </span><span class="n">zygoteState</span><span class="p">,</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">ZygoteStartFailedEx</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// Throw early if any of the arguments are malformed. This means we can</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// avoid writing a partial response to the zygote.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//1.检查args数组的参数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">sz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">sz</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="na">indexOf</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ZygoteStartFailedEx</span><span class="p">(</span><span class="s">&#34;embedded newlines not allowed&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">             * See com.android.internal.os.SystemZygoteInit.readArgumentList()
</span></span></span><span class="line"><span class="cl"><span class="cm">             * Presently the wire format to the zygote process is:
</span></span></span><span class="line"><span class="cl"><span class="cm">             * a) a count of arguments (argc, in essence)
</span></span></span><span class="line"><span class="cl"><span class="cm">             * b) a number of newline-separated argument strings equal to count
</span></span></span><span class="line"><span class="cl"><span class="cm">             *
</span></span></span><span class="line"><span class="cl"><span class="cm">             * After the zygote process reads these it will write the pid of
</span></span></span><span class="line"><span class="cl"><span class="cm">             * the child or -1 on failure, followed by boolean to
</span></span></span><span class="line"><span class="cl"><span class="cm">             * indicate whether a wrapper process was used.
</span></span></span><span class="line"><span class="cl"><span class="cm">             */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//2.将参数写入ZygoteState中</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">BufferedWriter</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zygoteState</span><span class="p">.</span><span class="na">writer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">DataInputStream</span><span class="w"> </span><span class="n">inputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zygoteState</span><span class="p">.</span><span class="na">inputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">writer</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">Integer</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="na">size</span><span class="p">()));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">writer</span><span class="p">.</span><span class="na">newLine</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">sz</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">String</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">writer</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">writer</span><span class="p">.</span><span class="na">newLine</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">writer</span><span class="p">.</span><span class="na">flush</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// Should there be a timeout on this?</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Process</span><span class="p">.</span><span class="na">ProcessStartResult</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Process</span><span class="p">.</span><span class="na">ProcessStartResult</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// Always read the entire result from the input stream to avoid leaving</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// bytes in the stream for future process starts to accidentally stumble</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// upon.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//3.等待socket服务端(即Zygote) 返回新创建的进程pid,usingWrapper</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">result</span><span class="p">.</span><span class="na">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inputStream</span><span class="p">.</span><span class="na">readInt</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">result</span><span class="p">.</span><span class="na">usingWrapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inputStream</span><span class="p">.</span><span class="na">readBoolean</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">pid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ZygoteStartFailedEx</span><span class="p">(</span><span class="s">&#34;fork() failed&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">zygoteState</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ZygoteStartFailedEx</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="zygote接收请求并创建应用程序进程">Zygote接收请求并创建应用程序进程
</h2><p>时序图如下</p>
<p><img src="/photos%5c46-Zygote%e6%8e%a5%e5%8f%97%e8%af%b7%e6%b1%82%e5%b9%b6%e5%88%9b%e5%bb%ba%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f%e8%bf%9b%e7%a8%8b.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>socket连接成功并匹配abi后返回ZygoteState对象,之后zygoteSendArgsAndGetResult将应用进程启动参数写入ZygoteState</p>
<p>这样Zygote进程便可以接收创建新应用进程的请求,回到ZygoteInit.main方法中</p>
<p>Zygote创建Socket服务端后,会通过runSelectLoop方法等待AMS的请求来创建新的应用程序进程</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">argv</span><span class="o">[]</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ZygoteServer</span><span class="w"> </span><span class="n">zygoteServer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ZygoteServer</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="c1">//......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="c1">//......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="c1">//1.创建Server端的Socket,socketName=&#34;zygote&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">zygoteServer</span><span class="p">.</span><span class="na">registerServerSocket</span><span class="p">(</span><span class="n">socketName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// In some configurations, we avoid preloading resources and classes eagerly.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// In such cases, we will preload things prior to our first fork.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">enableLazyPreload</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">bootTimingsTraceLog</span><span class="p">.</span><span class="na">traceBegin</span><span class="p">(</span><span class="s">&#34;ZygotePreload&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">EventLog</span><span class="p">.</span><span class="na">writeEvent</span><span class="p">(</span><span class="n">LOG_BOOT_PROGRESS_PRELOAD_START</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">SystemClock</span><span class="p">.</span><span class="na">uptimeMillis</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">//2.预加载类和资源</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">preload</span><span class="p">(</span><span class="n">bootTimingsTraceLog</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">EventLog</span><span class="p">.</span><span class="na">writeEvent</span><span class="p">(</span><span class="n">LOG_BOOT_PROGRESS_PRELOAD_END</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">SystemClock</span><span class="p">.</span><span class="na">uptimeMillis</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">bootTimingsTraceLog</span><span class="p">.</span><span class="na">traceEnd</span><span class="p">();</span><span class="w"> </span><span class="c1">// ZygotePreload</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Zygote</span><span class="p">.</span><span class="na">resetNicePriority</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//3.启动SystemServer进程</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">startSystemServer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">startSystemServer</span><span class="p">(</span><span class="n">abiList</span><span class="p">,</span><span class="w"> </span><span class="n">socketName</span><span class="p">,</span><span class="w"> </span><span class="n">zygoteServer</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;Accepting command socket connections&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//4.等待AMS请求</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">zygoteServer</span><span class="p">.</span><span class="na">runSelectLoop</span><span class="p">(</span><span class="n">abiList</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">zygoteServer</span><span class="p">.</span><span class="na">closeServerSocket</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Zygote</span><span class="p">.</span><span class="na">MethodAndArgsCaller</span><span class="w"> </span><span class="n">caller</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">caller</span><span class="p">.</span><span class="na">run</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Throwable</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;System zygote died with exception&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">ex</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">zygoteServer</span><span class="p">.</span><span class="na">closeServerSocket</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="n">ex</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>runSelectLoop方法代码如下,通过注释2处的ZygoteConnection.runOnce处理请求数据</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//frameworks/base/core/java/com/android/internal/os/ZygoteServer.java    </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kt">void</span><span class="w"> </span><span class="nf">runSelectLoop</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">abiList</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Zygote</span><span class="p">.</span><span class="na">MethodAndArgsCaller</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//创建文件描述符数组和</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">FileDescriptor</span><span class="o">&gt;</span><span class="w"> </span><span class="n">fds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">FileDescriptor</span><span class="o">&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//1.创建zygoteConnection对象数组</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">ZygoteConnection</span><span class="o">&gt;</span><span class="w"> </span><span class="n">peers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">ZygoteConnection</span><span class="o">&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//mServerSocket是zygote进程的Socket,保存到fds[0]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">fds</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">mServerSocket</span><span class="p">.</span><span class="na">getFileDescriptor</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">peers</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//创建一个 StructPollfd 数组 pollFds,用于存储待轮询的文件描述符</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">StructPollfd</span><span class="o">[]</span><span class="w"> </span><span class="n">pollFds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StructPollfd</span><span class="o">[</span><span class="n">fds</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">pollFds</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">pollFds</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StructPollfd</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">pollFds</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="na">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fds</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">pollFds</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="na">events</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">short</span><span class="p">)</span><span class="w"> </span><span class="n">POLLIN</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">//使用 Os.poll() 方法对文件描述符进行轮询,等待有数据可读的文件描述符.该方法会阻塞直到有事件发生</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Os</span><span class="p">.</span><span class="na">poll</span><span class="p">(</span><span class="n">pollFds</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ErrnoException</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&#34;poll failed&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">ex</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//遍历 pollFds 数组,判断每个文件描述符是否有可读事件发生</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pollFds</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="o">--</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">pollFds</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="na">revents</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">POLLIN</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">continue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">//如果文件描述符索引为 0,表示有新的连接请求到达</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">//调用 acceptCommandPeer接受连接,并将新的连接对象添加到 peers 和对应的文件描述符添加到 fds</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">ZygoteConnection</span><span class="w"> </span><span class="n">newPeer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">acceptCommandPeer</span><span class="p">(</span><span class="n">abiList</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">peers</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">newPeer</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">fds</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">newPeer</span><span class="p">.</span><span class="na">getFileDesciptor</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">//2.如果文件描述符索引不为 0,则表示已有连接的数据可读,调用对应连接对象的 runOnce方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">done</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">peers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="na">runOnce</span><span class="p">(</span><span class="k">this</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">//处理完后移除该文件描述符和连接对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">done</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">peers</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">fds</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>runOnce代码如下</p>
<p>获取应用程序进程的启动参数和文件描述符后,对参数进行解析并调用Zygote.forkAndSpecialize创建应用程序进程</p>
<p>再通过pid判断代码在哪个进程,pid=0为子进程时,调用handleChildProc方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java    </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kt">boolean</span><span class="w"> </span><span class="nf">runOnce</span><span class="p">(</span><span class="n">ZygoteServer</span><span class="w"> </span><span class="n">zygoteServer</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Zygote</span><span class="p">.</span><span class="na">MethodAndArgsCaller</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">args</span><span class="o">[]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Arguments</span><span class="w"> </span><span class="n">parsedArgs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileDescriptor</span><span class="o">[]</span><span class="w"> </span><span class="n">descriptors</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//1.获取应用进程启动参数和文件描述符</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readArgumentList</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">descriptors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mSocket</span><span class="p">.</span><span class="na">getAncillaryFileDescriptors</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;IOException on command socket &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ex</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">closeSocket</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="c1">//......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//2.将Binder客户端传递来的参数解析为Arguments对象格式</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">parsedArgs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Arguments</span><span class="p">(</span><span class="n">args</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="c1">//...... 参数处理</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//3.创建应用程序进程</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Zygote</span><span class="p">.</span><span class="na">forkAndSpecialize</span><span class="p">(</span><span class="n">parsedArgs</span><span class="p">.</span><span class="na">uid</span><span class="p">,</span><span class="w"> </span><span class="n">parsedArgs</span><span class="p">.</span><span class="na">gid</span><span class="p">,</span><span class="w"> </span><span class="n">parsedArgs</span><span class="p">.</span><span class="na">gids</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">parsedArgs</span><span class="p">.</span><span class="na">debugFlags</span><span class="p">,</span><span class="w"> </span><span class="n">rlimits</span><span class="p">,</span><span class="w"> </span><span class="n">parsedArgs</span><span class="p">.</span><span class="na">mountExternal</span><span class="p">,</span><span class="w"> </span><span class="n">parsedArgs</span><span class="p">.</span><span class="na">seInfo</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">parsedArgs</span><span class="p">.</span><span class="na">niceName</span><span class="p">,</span><span class="w"> </span><span class="n">fdsToClose</span><span class="p">,</span><span class="w"> </span><span class="n">fdsToIgnore</span><span class="p">,</span><span class="w"> </span><span class="n">parsedArgs</span><span class="p">.</span><span class="na">instructionSet</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">parsedArgs</span><span class="p">.</span><span class="na">appDataDir</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ErrnoException</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">logAndPrintError</span><span class="p">(</span><span class="n">newStderr</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;Exception creating pipe&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">ex</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IllegalArgumentException</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">logAndPrintError</span><span class="p">(</span><span class="n">newStderr</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;Invalid zygote arguments&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">ex</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ZygoteSecurityException</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">logAndPrintError</span><span class="p">(</span><span class="n">newStderr</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="s">&#34;Zygote security policy prevents request: &#34;</span><span class="p">,</span><span class="w"> </span><span class="n">ex</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">//当前代码运行在子进程中</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">zygoteServer</span><span class="p">.</span><span class="na">closeServerSocket</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">IoUtils</span><span class="p">.</span><span class="na">closeQuietly</span><span class="p">(</span><span class="n">serverPipeFd</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">serverPipeFd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">//处理应用程序进程</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">handleChildProc</span><span class="p">(</span><span class="n">parsedArgs</span><span class="p">,</span><span class="w"> </span><span class="n">descriptors</span><span class="p">,</span><span class="w"> </span><span class="n">childPipeFd</span><span class="p">,</span><span class="w"> </span><span class="n">newStderr</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// should never get here, the child is expected to either</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// throw Zygote.MethodAndArgsCaller or exec().</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">//父进程中</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// in parent...pid of &lt; 0 means failure</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">IoUtils</span><span class="p">.</span><span class="na">closeQuietly</span><span class="p">(</span><span class="n">childPipeFd</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">childPipeFd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">handleParentProc</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">descriptors</span><span class="p">,</span><span class="w"> </span><span class="n">serverPipeFd</span><span class="p">,</span><span class="w"> </span><span class="n">parsedArgs</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">IoUtils</span><span class="p">.</span><span class="na">closeQuietly</span><span class="p">(</span><span class="n">childPipeFd</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">IoUtils</span><span class="p">.</span><span class="na">closeQuietly</span><span class="p">(</span><span class="n">serverPipeFd</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ZygoteConnection.handleChildProc代码如下</p>
<p>主要用于配置子进程的初始环境,包括关闭父进程(Zygote)的socket管道,重定向标准输入输出和错误输出,设置子进程名称等</p>
<p>之后调用ZygoteInit.zygoteInit方法初始化应用程序进程</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java    </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleChildProc</span><span class="p">(</span><span class="n">Arguments</span><span class="w"> </span><span class="n">parsedArgs</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">FileDescriptor</span><span class="o">[]</span><span class="w"> </span><span class="n">descriptors</span><span class="p">,</span><span class="w"> </span><span class="n">FileDescriptor</span><span class="w"> </span><span class="n">pipeFd</span><span class="p">,</span><span class="w"> </span><span class="n">PrintStream</span><span class="w"> </span><span class="n">newStderr</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">Zygote</span><span class="p">.</span><span class="na">MethodAndArgsCaller</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * By the time we get here, the native code has closed the two actual Zygote
</span></span></span><span class="line"><span class="cl"><span class="cm">         * socket connections, and substituted /dev/null in their place.  The LocalSocket
</span></span></span><span class="line"><span class="cl"><span class="cm">         * objects still need to be closed properly.
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//关闭从zygote进程来的Socket通信</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">closeSocket</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//重定向std_xxx到descriptors数组中对应的文件描述符,然后关闭descriptors数组中的文件描述符</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">descriptors</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Os</span><span class="p">.</span><span class="na">dup2</span><span class="p">(</span><span class="n">descriptors</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">STDIN_FILENO</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Os</span><span class="p">.</span><span class="na">dup2</span><span class="p">(</span><span class="n">descriptors</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">STDOUT_FILENO</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Os</span><span class="p">.</span><span class="na">dup2</span><span class="p">(</span><span class="n">descriptors</span><span class="o">[</span><span class="n">2</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">STDERR_FILENO</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">FileDescriptor</span><span class="w"> </span><span class="n">fd</span><span class="p">:</span><span class="w"> </span><span class="n">descriptors</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">IoUtils</span><span class="p">.</span><span class="na">closeQuietly</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">newStderr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">err</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ErrnoException</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Log</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;Error reopening stdio&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">ex</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//设置进程的命令行参数argv0为parsedArgs.niceName</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">parsedArgs</span><span class="p">.</span><span class="na">niceName</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Process</span><span class="p">.</span><span class="na">setArgV0</span><span class="p">(</span><span class="n">parsedArgs</span><span class="p">.</span><span class="na">niceName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//关闭Trace事件,表示不再跟踪当前的活动管理器事件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Trace</span><span class="p">.</span><span class="na">traceEnd</span><span class="p">(</span><span class="n">Trace</span><span class="p">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">parsedArgs</span><span class="p">.</span><span class="na">invokeWith</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">WrapperInit</span><span class="p">.</span><span class="na">execApplication</span><span class="p">(</span><span class="n">parsedArgs</span><span class="p">.</span><span class="na">invokeWith</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">parsedArgs</span><span class="p">.</span><span class="na">niceName</span><span class="p">,</span><span class="w"> </span><span class="n">parsedArgs</span><span class="p">.</span><span class="na">targetSdkVersion</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">VMRuntime</span><span class="p">.</span><span class="na">getCurrentInstructionSet</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">pipeFd</span><span class="p">,</span><span class="w"> </span><span class="n">parsedArgs</span><span class="p">.</span><span class="na">remainingArgs</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//调用zygoteInit初始化进程,classloader设置为null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ZygoteInit</span><span class="p">.</span><span class="na">zygoteInit</span><span class="p">(</span><span class="n">parsedArgs</span><span class="p">.</span><span class="na">targetSdkVersion</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">parsedArgs</span><span class="p">.</span><span class="na">remainingArgs</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="cm">/* classLoader */</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ZygoteInit.zygoteInit代码如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">zygoteInit</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">targetSdkVersion</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">argv</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">classLoader</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Zygote</span><span class="p">.</span><span class="na">MethodAndArgsCaller</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">RuntimeInit</span><span class="p">.</span><span class="na">DEBUG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">RuntimeInit</span><span class="p">.</span><span class="na">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;RuntimeInit: Starting application from zygote&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 添加名为&#34;ZygoteInit&#34;的systrace tag以标识进程初始化流程</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Trace</span><span class="p">.</span><span class="na">traceBegin</span><span class="p">(</span><span class="n">Trace</span><span class="p">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;ZygoteInit&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">RuntimeInit</span><span class="p">.</span><span class="na">redirectLogStreams</span><span class="p">();</span><span class="c1">//重定向log输出</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">RuntimeInit</span><span class="p">.</span><span class="na">commonInit</span><span class="p">();</span><span class="c1">//通用初始化</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ZygoteInit</span><span class="p">.</span><span class="na">nativeZygoteInit</span><span class="p">();</span><span class="c1">//nativeZygoteInit函数中JNI调用启动进程的binder线程池</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">RuntimeInit</span><span class="p">.</span><span class="na">applicationInit</span><span class="p">(</span><span class="n">targetSdkVersion</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="n">classLoader</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">native</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">nativeZygoteInit</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>RuntimeInit.applicationInit代码如下,内部调用invokeStaticMain方法</p>
<ul>
<li>args.startClass 前文的entryPoint,即&quot;android.app.ActivityThread&quot;</li>
<li>args.startArgs 应用进程启动参数</li>
<li>classLoader null</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//frameworks/base/core/java/com/android/internal/os/RuntimeInit.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">protected</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">applicationInit</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">targetSdkVersion</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">classLoader</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">Zygote</span><span class="p">.</span><span class="na">MethodAndArgsCaller</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//true代表应用程序退出时不调用AppRuntime.onExit,否则会在退出前调用</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">nativeSetExitWithoutCleanup</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="c1">//设置虚拟机的内存利用率参数值为0.75和SDK版本</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">VMRuntime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">setTargetHeapUtilization</span><span class="p">(</span><span class="n">0</span><span class="p">.</span><span class="na">75f</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">VMRuntime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">setTargetSdkVersion</span><span class="p">(</span><span class="n">targetSdkVersion</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">Arguments</span><span class="w"> </span><span class="n">args</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Arguments</span><span class="p">(</span><span class="n">argv</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IllegalArgumentException</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="n">ex</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// let the process exit</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// The end of of the RuntimeInit event (see #zygoteInit).</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Trace</span><span class="p">.</span><span class="na">traceEnd</span><span class="p">(</span><span class="n">Trace</span><span class="p">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Remaining arguments are passed to the start class&#39;s static main</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">invokeStaticMain</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="na">startClass</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">.</span><span class="na">startArgs</span><span class="p">,</span><span class="w"> </span><span class="n">classLoader</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>invokeStaticMain</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//frameworks/base/core/java/com/android/internal/os/RuntimeInit.java    </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">invokeStaticMain</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">className</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">classLoader</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">Zygote</span><span class="p">.</span><span class="na">MethodAndArgsCaller</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">cl</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//1.获取android.app.ActivityThread的类</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">cl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="n">className</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">classLoader</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="s">&#34;Missing class when invoking static main &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">className</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">ex</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Method</span><span class="w"> </span><span class="n">m</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//2.获取ActivityThread的main方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cl</span><span class="p">.</span><span class="na">getMethod</span><span class="p">(</span><span class="s">&#34;main&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="w"> </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">NoSuchMethodException</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="s">&#34;Missing static main on &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">className</span><span class="p">,</span><span class="w"> </span><span class="n">ex</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">SecurityException</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="s">&#34;Problem getting static main on &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">className</span><span class="p">,</span><span class="w"> </span><span class="n">ex</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">modifiers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">getModifiers</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="w"> </span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="na">isStatic</span><span class="p">(</span><span class="n">modifiers</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">isPublic</span><span class="p">(</span><span class="n">modifiers</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="s">&#34;Main method is not public and static on &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">className</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//3.通过抛出异常启动ActivityThread.main方法,同前文</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Zygote</span><span class="p">.</span><span class="na">MethodAndArgsCaller</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>回到ZygoteInit.main,此处捕获到Zygote.MethodAndArgsCaller异常后,调用caller.run方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//frameworks/base/core/java/com/android/internal/os/ZygoteInit.java    </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">argv</span><span class="o">[]</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="p">......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="p">......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">zygoteServer</span><span class="p">.</span><span class="na">closeServerSocket</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Zygote</span><span class="p">.</span><span class="na">MethodAndArgsCaller</span><span class="w"> </span><span class="n">caller</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">caller</span><span class="p">.</span><span class="na">run</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Throwable</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;System zygote died with exception&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">ex</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">zygoteServer</span><span class="p">.</span><span class="na">closeServerSocket</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="n">ex</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>MethodAndArgsCaller是zygote的静态内部类</p>
<p>捕获到异常后通过反射获取方法,再通过invoke调用ActivityThread.main方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//frameworks/base/core/java/com/android/internal/os/Zygote.java    </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MethodAndArgsCaller</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Exception</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">implements</span><span class="w"> </span><span class="n">Runnable</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="cm">/** method to call */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Method</span><span class="w"> </span><span class="n">mMethod</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="cm">/** argument array */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">mArgs</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="nf">MethodAndArgsCaller</span><span class="p">(</span><span class="n">Method</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">mMethod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">method</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">mArgs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">//通过反射调用</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">mMethod</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">mArgs</span><span class="w"> </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IllegalAccessException</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InvocationTargetException</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Throwable</span><span class="w"> </span><span class="n">cause</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ex</span><span class="p">.</span><span class="na">getCause</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cause</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="p">(</span><span class="n">RuntimeException</span><span class="p">)</span><span class="w"> </span><span class="n">cause</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cause</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">Error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="p">(</span><span class="n">Error</span><span class="p">)</span><span class="w"> </span><span class="n">cause</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>至此为止,应用程序进程就成功创建,并运行了主线程的管理类ActivityThread</p>
<h1 id="十四-创建application详解">十四. 创建Application详解
</h1><p>参考<a class="link" href="https://gal2xy.github.io/2023/11/27/Android%E5%AE%89%E5%85%A8/Android%E4%B8%ADApplication%E7%9A%84%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B"  target="_blank" rel="noopener"
    >Android中Application的创建流程</a></p>
<p>在学习Android进程启动时我们知道,AMS会向目标应用程序进程的ApplicationThread发起启动Activity的请求</p>
<p>之后ApplicationThread调用scheduleLaunchActivity方法向ActivityThread请求启动Activity</p>
<p>那么在此之前ApplicationThread对应的Application是何时被创建的呢？</p>
<p>实际上,Android系统中,系统进程和一般App进程的Application创建流程有所不同,我们主要关注一般的用户App进程</p>
<p>我们知道,应用程序进程创建后,通过Zygote.MethodAndArgsCaller回调ActivityThread.main方法</p>
<h2 id="activitythreadmain">ActivityThread.main
</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//frameworks/base/core/java/android/app/ActivityThread.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//开始跟踪,标记为&#34;ActivityThreadMain&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Trace</span><span class="p">.</span><span class="na">traceBegin</span><span class="p">(</span><span class="n">Trace</span><span class="p">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;ActivityThreadMain&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//启动采样分析器集成,用于性能分析</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">SamplingProfilerIntegration</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//关闭CloseGuard,默认情况下它是启用的,但在此处将其禁用.CloseGuard用于检测资源没有正确关闭的情况</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">CloseGuard</span><span class="p">.</span><span class="na">setEnabled</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="c1">//初始化当前用户的环境变量</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Environment</span><span class="p">.</span><span class="na">initForCurrentUser</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//设置事件日志的报告器,用于在libcore中记录事件日志</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">EventLogger</span><span class="p">.</span><span class="na">setReporter</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">EventLoggingReporter</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//寻找CA证书的存储位置并设置为默认的CA证书存储位置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">File</span><span class="w"> </span><span class="n">configDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Environment</span><span class="p">.</span><span class="na">getUserConfigDirectory</span><span class="p">(</span><span class="n">UserHandle</span><span class="p">.</span><span class="na">myUserId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">TrustedCertificateStore</span><span class="p">.</span><span class="na">setDefaultUserDirectory</span><span class="p">(</span><span class="n">configDir</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="c1">//设置当前进程的argv[0]值为&#34;&lt;pre-initialized&gt;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Process</span><span class="p">.</span><span class="na">setArgV0</span><span class="p">(</span><span class="s">&#34;&lt;pre-initialized&gt;&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="c1">//1.创建主线程的looper</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Looper</span><span class="p">.</span><span class="na">prepareMainLooper</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="c1">//2.创建线程并将当前线程附加到ActivityThread,参数false表示不使用新线程</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ActivityThread</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ActivityThread</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">thread</span><span class="p">.</span><span class="na">attach</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="c1">//3.如果sMainThreadHandler为空,则将其设置为ActivityThread的Handler.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sMainThreadHandler</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">sMainThreadHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thread</span><span class="p">.</span><span class="na">getHandler</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="c1">//永假,可忽略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Looper</span><span class="p">.</span><span class="na">myLooper</span><span class="p">().</span><span class="na">setMessageLogging</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">LogPrinter</span><span class="p">(</span><span class="n">Log</span><span class="p">.</span><span class="na">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;ActivityThread&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//结束跟踪</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Trace</span><span class="p">.</span><span class="na">traceEnd</span><span class="p">(</span><span class="n">Trace</span><span class="p">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//4.开始主线程的消息循环</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Looper</span><span class="p">.</span><span class="na">loop</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&#34;Main thread loop unexpectedly exited&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>我们主要关注以下两行代码</p>
<p>创建ActivityThread线程并将当前线程附加到ActivityThread,参数false表示不使用新线程</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">    </span><span class="n">ActivityThread</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ActivityThread</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">thread</span><span class="p">.</span><span class="na">attach</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="activitythreadattach">ActivityThread.attach
</h2><p>调用的ActivityThread.attach方法代码如下,内部调用了AMS的attachApplication</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//frameworks/base/core/java/android/app/ActivityThread.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">attach</span><span class="p">(</span><span class="kt">boolean</span><span class="w"> </span><span class="n">system</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">sCurrentActivityThread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">mSystemThread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">system</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//应用程序进程进入该分支</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">system</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ViewRootImpl</span><span class="p">.</span><span class="na">addFirstDrawHandler</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Runnable</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">ensureJitEnabled</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">android</span><span class="p">.</span><span class="na">ddm</span><span class="p">.</span><span class="na">DdmHandleAppName</span><span class="p">.</span><span class="na">setAppName</span><span class="p">(</span><span class="s">&#34;&lt;pre-initialized&gt;&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                    </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">myUserId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//初始化RuntimeInit.mApplicationObject</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">RuntimeInit</span><span class="p">.</span><span class="na">setApplicationObject</span><span class="p">(</span><span class="n">mAppThread</span><span class="p">.</span><span class="na">asBinder</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">IActivityManager</span><span class="w"> </span><span class="n">mgr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">getService</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">//通过AMS附加目标应用程序进程ApplicationThread</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">mgr</span><span class="p">.</span><span class="na">attachApplication</span><span class="p">(</span><span class="n">mAppThread</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="n">ex</span><span class="p">.</span><span class="na">rethrowFromSystemServer</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// Watch for getting close to heap limit.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="c1">//......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// Don&#39;t set application object here -- if the system crashes,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// we can&#39;t display an alert, we just want to die die die.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">android</span><span class="p">.</span><span class="na">ddm</span><span class="p">.</span><span class="na">DdmHandleAppName</span><span class="p">.</span><span class="na">setAppName</span><span class="p">(</span><span class="s">&#34;system_process&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">myUserId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">mInstrumentation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Instrumentation</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">ContextImpl</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ContextImpl</span><span class="p">.</span><span class="na">createAppContext</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">getSystemContext</span><span class="p">().</span><span class="na">mPackageInfo</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">mInitialApplication</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">mPackageInfo</span><span class="p">.</span><span class="na">makeApplication</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">mInitialApplication</span><span class="p">.</span><span class="na">onCreate</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;Unable to instantiate Application():&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">toString</span><span class="p">(),</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="c1">//......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="activitymanagerserviceattachapplication">ActivityManagerService.attachApplication
</h2><p>attachApplication内部通过attachApplicationLocked为应用程序进程附加Application</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">attachApplication</span><span class="p">(</span><span class="n">IApplicationThread</span><span class="w"> </span><span class="n">thread</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">callingPid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Binder</span><span class="p">.</span><span class="na">getCallingPid</span><span class="p">();</span><span class="w">	</span><span class="c1">//获取调用者的pid</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//临时清除调用者的身份信息,返回唯一标识符以便后续恢复调用者身份</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">origId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Binder</span><span class="p">.</span><span class="na">clearCallingIdentity</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//给调用进程附加Application</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">attachApplicationLocked</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span><span class="w"> </span><span class="n">callingPid</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//恢复之前清除的调用者身份</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Binder</span><span class="p">.</span><span class="na">restoreCallingIdentity</span><span class="p">(</span><span class="n">origId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="activitymanagerserviceattachapplicationlocked">ActivityManagerService.attachApplicationLocked
</h2><p>attachApplicationLocked内部主要调用IApplicationThread.bindApplication</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">attachApplicationLocked</span><span class="p">(</span><span class="n">IApplicationThread</span><span class="w"> </span><span class="n">thread</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ProcessRecord</span><span class="w"> </span><span class="n">app</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">startTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SystemClock</span><span class="p">.</span><span class="na">uptimeMillis</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">MY_PID</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mPidsSelfLocked</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mPidsSelfLocked</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span><span class="c1">//根据pid获取ProcessRecord应用程序进程描述类</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ApplicationInfo</span><span class="w"> </span><span class="n">appInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">app</span><span class="p">.</span><span class="na">instr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">app</span><span class="p">.</span><span class="na">instr</span><span class="p">.</span><span class="na">mTargetInfo</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">app</span><span class="p">.</span><span class="na">info</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="na">instr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">thread</span><span class="p">.</span><span class="na">bindApplication</span><span class="p">(</span><span class="n">processName</span><span class="p">,</span><span class="w"> </span><span class="n">appInfo</span><span class="p">,</span><span class="w"> </span><span class="n">providers</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                   </span><span class="n">app</span><span class="p">.</span><span class="na">instr</span><span class="p">.</span><span class="na">mClass</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                   </span><span class="n">profilerInfo</span><span class="p">,</span><span class="w"> </span><span class="n">app</span><span class="p">.</span><span class="na">instr</span><span class="p">.</span><span class="na">mArguments</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                   </span><span class="n">app</span><span class="p">.</span><span class="na">instr</span><span class="p">.</span><span class="na">mWatcher</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                   </span><span class="n">app</span><span class="p">.</span><span class="na">instr</span><span class="p">.</span><span class="na">mUiAutomationConnection</span><span class="p">,</span><span class="w"> </span><span class="n">testMode</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                   </span><span class="n">mBinderTransactionTrackingEnabled</span><span class="p">,</span><span class="w"> </span><span class="n">enableTrackAllocation</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                   </span><span class="n">isRestrictedBackupMode</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">normalMode</span><span class="p">,</span><span class="w"> </span><span class="n">app</span><span class="p">.</span><span class="na">persistent</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                   </span><span class="k">new</span><span class="w"> </span><span class="n">Configuration</span><span class="p">(</span><span class="n">getGlobalConfiguration</span><span class="p">()),</span><span class="w"> </span><span class="n">app</span><span class="p">.</span><span class="na">compat</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                   </span><span class="n">getCommonServicesLocked</span><span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="na">isolated</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                   </span><span class="n">mCoreSettingsObserver</span><span class="p">.</span><span class="na">getCoreSettingsLocked</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                   </span><span class="n">buildSerial</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//调用thread.bindApplication不同参数的重载</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="iapplicationthreadbindapplication">IApplicationThread.bindApplication
</h2><p>bindApplication内部创建AppBindData实例并赋值,之后调用sendMessage将BIND_APPLICATION消息发送至应用程序消息队列</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">bindApplication</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">processName</span><span class="p">,</span><span class="w"> </span><span class="n">ApplicationInfo</span><span class="w"> </span><span class="n">appInfo</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">List</span><span class="o">&lt;</span><span class="n">ProviderInfo</span><span class="o">&gt;</span><span class="w"> </span><span class="n">providers</span><span class="p">,</span><span class="w"> </span><span class="n">ComponentName</span><span class="w"> </span><span class="n">instrumentationName</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">ProfilerInfo</span><span class="w"> </span><span class="n">profilerInfo</span><span class="p">,</span><span class="w"> </span><span class="n">Bundle</span><span class="w"> </span><span class="n">instrumentationArgs</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">IInstrumentationWatcher</span><span class="w"> </span><span class="n">instrumentationWatcher</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">IUiAutomationConnection</span><span class="w"> </span><span class="n">instrumentationUiConnection</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">debugMode</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">boolean</span><span class="w"> </span><span class="n">enableBinderTracking</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">trackAllocation</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isRestrictedBackupMode</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">persistent</span><span class="p">,</span><span class="w"> </span><span class="n">Configuration</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">CompatibilityInfo</span><span class="w"> </span><span class="n">compatInfo</span><span class="p">,</span><span class="w"> </span><span class="n">Map</span><span class="w"> </span><span class="n">services</span><span class="p">,</span><span class="w"> </span><span class="n">Bundle</span><span class="w"> </span><span class="n">coreSettings</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">String</span><span class="w"> </span><span class="n">buildSerial</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">services</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// Setup the service cache in the ServiceManager</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">ServiceManager</span><span class="p">.</span><span class="na">initServiceCache</span><span class="p">(</span><span class="n">services</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">setCoreSettings</span><span class="p">(</span><span class="n">coreSettings</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//创建AppBindData实例并赋值</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">AppBindData</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppBindData</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">data</span><span class="p">.</span><span class="na">processName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">processName</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">data</span><span class="p">.</span><span class="na">appInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">appInfo</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">data</span><span class="p">.</span><span class="na">providers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">providers</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">data</span><span class="p">.</span><span class="na">instrumentationName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instrumentationName</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">data</span><span class="p">.</span><span class="na">instrumentationArgs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instrumentationArgs</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">data</span><span class="p">.</span><span class="na">instrumentationWatcher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instrumentationWatcher</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">data</span><span class="p">.</span><span class="na">instrumentationUiAutomationConnection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instrumentationUiConnection</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">data</span><span class="p">.</span><span class="na">debugMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">debugMode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">data</span><span class="p">.</span><span class="na">enableBinderTracking</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">enableBinderTracking</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">data</span><span class="p">.</span><span class="na">trackAllocation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trackAllocation</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">data</span><span class="p">.</span><span class="na">restrictedBackupMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isRestrictedBackupMode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">data</span><span class="p">.</span><span class="na">persistent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">persistent</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">data</span><span class="p">.</span><span class="na">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">data</span><span class="p">.</span><span class="na">compatInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compatInfo</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">data</span><span class="p">.</span><span class="na">initProfilerInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">profilerInfo</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">data</span><span class="p">.</span><span class="na">buildSerial</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buildSerial</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//调用sendMessage方法将BIND_APPLICATION消息添加至消息队列</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">sendMessage</span><span class="p">(</span><span class="n">H</span><span class="p">.</span><span class="na">BIND_APPLICATION</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="activitythreadhandlemessage">ActivityThread.handleMessage
</h2><p>ActivityThread.main中通过Looper.loop启动了主线程消息循环,并通过handleMessage处理消息,内部调用handleBindApplication</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//frameworks/base/core/java/android/app/ActivityThread.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleMessage</span><span class="p">(</span><span class="n">Message</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="na">what</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">BIND_APPLICATION</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="n">AppBindData</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">AppBindData</span><span class="p">)</span><span class="n">msg</span><span class="p">.</span><span class="na">obj</span><span class="p">;</span><span class="w">	</span><span class="c1">//转换消息传递来的参数为AppBindData类型</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">handleBindApplication</span><span class="p">(</span><span class="n">data</span><span class="p">);</span><span class="w">	</span><span class="c1">//</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="activitythreadhandlebindapplication">ActivityThread.handleBindApplication
</h2><p>handleBindApplication代码如下,主要执行以下步骤</p>
<p>注释1处 获取LoadedApk对象,设置到AppBindData.info字段,用于创建appContext</p>
<p>注释2处 创建ContextImpl对象即appContext</p>
<p>注释3处 反射调用LoadedApk.makeApplication方法创建Application对象</p>
<p>注释4处 调用Application.onCreate方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//frameworks/base/core/java/android/app/ActivityThread.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleBindApplication</span><span class="p">(</span><span class="n">AppBindData</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mBoundApplication</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//1.获取LoadedApk对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">data</span><span class="p">.</span><span class="na">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getPackageInfoNoCheck</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="na">appInfo</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="na">compatInfo</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="c1">//......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//2.创建appContext</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">ContextImpl</span><span class="w"> </span><span class="n">appContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ContextImpl</span><span class="p">.</span><span class="na">createAppContext</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="na">info</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//3.通过反射创建目标应用Application对象,此处data.info指LoadedApk</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Application</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="na">info</span><span class="p">.</span><span class="na">makeApplication</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="na">restrictedBackupMode</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">mInitialApplication</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">app</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//调用空方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">mInstrumentation</span><span class="p">.</span><span class="na">onCreate</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="na">instrumentationArgs</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//4.调用Application.onCreate方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">mInstrumentation</span><span class="p">.</span><span class="na">callApplicationOnCreate</span><span class="p">(</span><span class="n">app</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">StrictMode</span><span class="p">.</span><span class="na">setThreadPolicy</span><span class="p">(</span><span class="n">savedPolicy</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Preload fonts resources</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//...d...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>依次查看涉及到的方法</p>
<h3 id="activitythreadgetpackageinfonocheck">ActivityThread.getPackageInfoNoCheck
</h3><p>getPackageInfoNoCheck 创建LoadedApk对象,并加入到mPackages中,之后为LoadedApk设置ApplicationInfo和ClassLoader</p>
<p>每个app会创建唯一的LoadedApk对象</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//路径: /frameworks/base/core/java/android/app/ActivityThread.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">LoadedApk</span><span class="w"> </span><span class="nf">getPackageInfoNoCheck</span><span class="p">(</span><span class="n">ApplicationInfo</span><span class="w"> </span><span class="n">ai</span><span class="p">,</span><span class="w"> </span><span class="n">CompatibilityInfo</span><span class="w"> </span><span class="n">compatInfo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">getPackageInfo</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span><span class="w"> </span><span class="n">compatInfo</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="n">LoadedApk</span><span class="w"> </span><span class="nf">getPackageInfo</span><span class="p">(</span><span class="n">ApplicationInfo</span><span class="w"> </span><span class="n">aInfo</span><span class="p">,</span><span class="w"> </span><span class="n">CompatibilityInfo</span><span class="w"> </span><span class="n">compatInfo</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                 </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">baseLoader</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">securityViolation</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">includeCode</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                 </span><span class="kt">boolean</span><span class="w"> </span><span class="n">registerPackage</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">differentUser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">UserHandle</span><span class="p">.</span><span class="na">myUserId</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(</span><span class="n">aInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mResourcesManager</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">LoadedApk</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ref</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 根据不同的情况获取缓存的LoadedApk对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">differentUser</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// Caching not supported across users</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">includeCode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mPackages</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">aInfo</span><span class="p">.</span><span class="na">packageName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mResourcePackages</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">aInfo</span><span class="p">.</span><span class="na">packageName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">LoadedApk</span><span class="w"> </span><span class="n">packageInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ref</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">ref</span><span class="p">.</span><span class="na">get</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">packageInfo</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">packageInfo</span><span class="p">.</span><span class="na">mResources</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                    </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">packageInfo</span><span class="p">.</span><span class="na">mResources</span><span class="p">.</span><span class="na">getAssets</span><span class="p">().</span><span class="na">isUpToDate</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//创建LoadedApk对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">packageInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LoadedApk</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">aInfo</span><span class="p">,</span><span class="w"> </span><span class="n">compatInfo</span><span class="p">,</span><span class="w"> </span><span class="n">baseLoader</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                              </span><span class="n">securityViolation</span><span class="p">,</span><span class="w"> </span><span class="n">includeCode</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                              </span><span class="p">(</span><span class="n">aInfo</span><span class="p">.</span><span class="na">flags</span><span class="o">&amp;</span><span class="n">ApplicationInfo</span><span class="p">.</span><span class="na">FLAG_HAS_CODE</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">registerPackage</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mSystemThread</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&#34;android&#34;</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">aInfo</span><span class="p">.</span><span class="na">packageName</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">               	</span><span class="c1">//设置ApplicationInfo和ClassLoader</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">packageInfo</span><span class="p">.</span><span class="na">installSystemApplicationInfo</span><span class="p">(</span><span class="n">aInfo</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                         </span><span class="n">getSystemContext</span><span class="p">().</span><span class="na">mPackageInfo</span><span class="p">.</span><span class="na">getClassLoader</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">differentUser</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// Caching not supported across users</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">includeCode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">//更新mPackages,即将刚创建的packageInfo加入</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">mPackages</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">aInfo</span><span class="p">.</span><span class="na">packageName</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                              </span><span class="k">new</span><span class="w"> </span><span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">LoadedApk</span><span class="o">&gt;</span><span class="p">(</span><span class="n">packageInfo</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">mResourcePackages</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">aInfo</span><span class="p">.</span><span class="na">packageName</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                      </span><span class="k">new</span><span class="w"> </span><span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">LoadedApk</span><span class="o">&gt;</span><span class="p">(</span><span class="n">packageInfo</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">packageInfo</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>LoadedApk.installSystemApplicationInfo</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//frameworks/base/core/java/android/app/LoadedApk.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kt">void</span><span class="w"> </span><span class="nf">installSystemApplicationInfo</span><span class="p">(</span><span class="n">ApplicationInfo</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">classLoader</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">assert</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">packageName</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&#34;android&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mApplicationInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mClassLoader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">classLoader</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="contextimplcreateappcontext">ContextImpl.createAppContext
</h3><p>创建ContextImpl实例并为其设置资源</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//frameworks/base/core/java/android/app/ContextImpl.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">static</span><span class="w"> </span><span class="n">ContextImpl</span><span class="w"> </span><span class="nf">createAppContext</span><span class="p">(</span><span class="n">ActivityThread</span><span class="w"> </span><span class="n">mainThread</span><span class="p">,</span><span class="w"> </span><span class="n">LoadedApk</span><span class="w"> </span><span class="n">packageInfo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">packageInfo</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span><span class="s">&#34;packageInfo&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="c1">//创建实例,传入当前应用程序的主线程管理类ActivityThread和应用程序包描述类LoadedApk</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ContextImpl</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ContextImpl</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">mainThread</span><span class="p">,</span><span class="w"> </span><span class="n">packageInfo</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">context</span><span class="p">.</span><span class="na">setResources</span><span class="p">(</span><span class="n">packageInfo</span><span class="p">.</span><span class="na">getResources</span><span class="p">());</span><span class="c1">//设置app资源</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">context</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="contextimplcontextimpl">ContextImpl.ContextImpl
</h4><p>构造函数中执行以下操作,完成之后便成功创建了AppContext</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//frameworks/base/core/java/android/app/ContextImpl.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="nf">ContextImpl</span><span class="p">(</span><span class="nd">@Nullable</span><span class="w"> </span><span class="n">ContextImpl</span><span class="w"> </span><span class="n">container</span><span class="p">,</span><span class="w"> </span><span class="nd">@NonNull</span><span class="w"> </span><span class="n">ActivityThread</span><span class="w"> </span><span class="n">mainThread</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="nd">@NonNull</span><span class="w"> </span><span class="n">LoadedApk</span><span class="w"> </span><span class="n">packageInfo</span><span class="p">,</span><span class="w"> </span><span class="nd">@Nullable</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">splitName</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="nd">@Nullable</span><span class="w"> </span><span class="n">IBinder</span><span class="w"> </span><span class="n">activityToken</span><span class="p">,</span><span class="w"> </span><span class="nd">@Nullable</span><span class="w"> </span><span class="n">UserHandle</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="nd">@Nullable</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">classLoader</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mOuterContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">CONTEXT_CREDENTIAL_PROTECTED_STORAGE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="o">|</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="na">CONTEXT_DEVICE_PROTECTED_STORAGE</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">File</span><span class="w"> </span><span class="n">dataDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packageInfo</span><span class="p">.</span><span class="na">getDataDirFile</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Objects</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">dataDir</span><span class="p">,</span><span class="w"> </span><span class="n">packageInfo</span><span class="p">.</span><span class="na">getCredentialProtectedDataDirFile</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="na">CONTEXT_CREDENTIAL_PROTECTED_STORAGE</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Objects</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">dataDir</span><span class="p">,</span><span class="w"> </span><span class="n">packageInfo</span><span class="p">.</span><span class="na">getDeviceProtectedDataDirFile</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="na">CONTEXT_DEVICE_PROTECTED_STORAGE</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mMainThread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mainThread</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mActivityToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activityToken</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mFlags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="c1">//1.设置当前进程的用户</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">user</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Process</span><span class="p">.</span><span class="na">myUserHandle</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mUser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">user</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="c1">//2.将LoadedApk实例赋给mPackageInfo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mPackageInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packageInfo</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mSplitName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">splitName</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mClassLoader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">classLoader</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mResourcesManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ResourcesManager</span><span class="p">.</span><span class="na">getInstance</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="c1">//根据传入的上下文对象container是否为空来进行不同操作</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">container</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">mBasePackageName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">container</span><span class="p">.</span><span class="na">mBasePackageName</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">mOpPackageName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">container</span><span class="p">.</span><span class="na">mOpPackageName</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setResources</span><span class="p">(</span><span class="n">container</span><span class="p">.</span><span class="na">mResources</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">mDisplay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">container</span><span class="p">.</span><span class="na">mDisplay</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="c1">//将刚刚创建的LoadedApk实例的信息赋值某些字段</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">mBasePackageName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packageInfo</span><span class="p">.</span><span class="na">mPackageName</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ApplicationInfo</span><span class="w"> </span><span class="n">ainfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packageInfo</span><span class="p">.</span><span class="na">getApplicationInfo</span><span class="p">();</span><span class="c1">//实际上是空的对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ainfo</span><span class="p">.</span><span class="na">uid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Process</span><span class="p">.</span><span class="na">SYSTEM_UID</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ainfo</span><span class="p">.</span><span class="na">uid</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">Process</span><span class="p">.</span><span class="na">myUid</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">mOpPackageName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ActivityThread</span><span class="p">.</span><span class="na">currentPackageName</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">mOpPackageName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mBasePackageName</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mContentResolver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ApplicationContentResolver</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">mainThread</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="loadedapkmakeapplication">LoadedApk.makeApplication
</h3><p>注释1处 判断是否创建过Application,保证一个LoadedApk对象只创建一个对应的Application对象</p>
<p>注释2处 获取类加载器</p>
<p>注释3处 创建Application对象,内部调用Application.attachBaseContext方法</p>
<p>注释4处 调用Application.onCreate</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Application</span><span class="w"> </span><span class="nf">makeApplication</span><span class="p">(</span><span class="kt">boolean</span><span class="w"> </span><span class="n">forceDefaultAppClass</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                   </span><span class="n">Instrumentation</span><span class="w"> </span><span class="n">instrumentation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//1.判断是否已经创建Application </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mApplication</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">mApplication</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="c1">//......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Application</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">appClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mApplicationInfo</span><span class="p">.</span><span class="na">className</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">forceDefaultAppClass</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">appClass</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="c1">//传入的参数为true,进入该分支</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">appClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;android.app.Application&#34;</span><span class="p">;</span><span class="c1">//system_server进程进入该分支</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//2.获取类加载器</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">ClassLoader</span><span class="w"> </span><span class="n">cl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getClassLoader</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mPackageName</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&#34;android&#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="c1">//在之前流程可知默认android,显然不进入此分支</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">initializeJavaContextClassLoader</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ContextImpl</span><span class="w"> </span><span class="n">appContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ContextImpl</span><span class="p">.</span><span class="na">createAppContext</span><span class="p">(</span><span class="n">mActivityThread</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//3.通过类名创建Application对象,内部调用了Application.attachBaseContext</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mActivityThread</span><span class="p">.</span><span class="na">mInstrumentation</span><span class="p">.</span><span class="na">newApplication</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span><span class="w"> </span><span class="n">appClass</span><span class="p">,</span><span class="w"> </span><span class="n">appContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">appContext</span><span class="p">.</span><span class="na">setOuterContext</span><span class="p">(</span><span class="n">app</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mActivityThread</span><span class="p">.</span><span class="na">mAllApplications</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">app</span><span class="p">);</span><span class="c1">//加入到Application列表中,一个进程可以有多个application</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mApplication</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">app</span><span class="p">;</span><span class="c1">//将刚刚创建的Application对象app赋值给mApplication</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">instrumentation</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="c1">//传入的instrumentation为null,不进入此分支</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//4.调用Application.onCreate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">instrumentation</span><span class="p">.</span><span class="na">callApplicationOnCreate</span><span class="p">(</span><span class="n">app</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//.......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">app</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="instrumentationnewapplication">Instrumentation.newApplication
</h4><p>使用指定的类加载器,通过类名创建Application实例,并调用Application.atach方法,内部调用attachBaseContext</p>
<p>这也是为什么壳程序要先替换ClassLoader再创建Application</p>
<p>因为创建Application实例依赖到指定的ClassLoader,如果没有通过ClassLoader获取到被保护程序的dex文件,则无法成功创建</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//frameworks/base/core/java/android/app/Instrumentation.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Application</span><span class="w"> </span><span class="nf">newApplication</span><span class="p">(</span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">cl</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">className</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InstantiationException</span><span class="p">,</span><span class="w"> </span><span class="n">IllegalAccessException</span><span class="p">,</span><span class="w"> </span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">newApplication</span><span class="p">(</span><span class="n">cl</span><span class="p">.</span><span class="na">loadClass</span><span class="p">(</span><span class="n">className</span><span class="p">),</span><span class="w"> </span><span class="n">context</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">static</span><span class="w"> </span><span class="kd">public</span><span class="w"> </span><span class="n">Application</span><span class="w"> </span><span class="nf">newApplication</span><span class="p">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InstantiationException</span><span class="p">,</span><span class="w"> </span><span class="n">IllegalAccessException</span><span class="p">,</span><span class="w"> </span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Application</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Application</span><span class="p">)</span><span class="n">clazz</span><span class="p">.</span><span class="na">newInstance</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">app</span><span class="p">.</span><span class="na">attach</span><span class="p">(</span><span class="n">context</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">app</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="applicationattach">Application.attach
</h4><p>调用父类的attachBaseContext并设置LoadedApk</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//frameworks/base/core/java/android/app/Application.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/* package */</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">attach</span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">attachBaseContext</span><span class="p">(</span><span class="n">context</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">mLoadedApk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ContextImpl</span><span class="p">.</span><span class="na">getImpl</span><span class="p">(</span><span class="n">context</span><span class="p">).</span><span class="na">mPackageInfo</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在壳Application的attachBaseContext中,替换ClassLoader</p>
<p>在壳Application的onCreate中,替换Application</p>
<p>因为在执行attachBaseContext时,已经创建好LoadedApk,ClassLoader,Application</p>
<p>其中LoadedApk用于描述apk文件本身,并不影响类的加载,类的加载主要通过ClassLoader进行</p>
<p>替换ClassLoader后,便可以正确加载源程序相关类,包括创建源程序的Application</p>
<p>在此之后,需要在Application.onCreate替换Application</p>
<p>因为LoadedApk.makeApplication中调用的是壳Application的实例方法,并且必定会执行onCreate</p>
<p>如果在attachBaseContext中替换了Application并执行可能会导致冲突: 壳Application.attachBaseContext创建并调用源Application相关方法后又调用壳Application.onCreate</p>
<h3 id="instrumentationcallapplicationoncreate">Instrumentation.callApplicationOnCreate
</h3><p>调用Application.onCreate</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//frameworks/base/core/java/android/app/Instrumentation.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">callApplicationOnCreate</span><span class="p">(</span><span class="n">Application</span><span class="w"> </span><span class="n">app</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">app</span><span class="p">.</span><span class="na">onCreate</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onCreate</span><span class="p">(</span><span class="n">Bundle</span><span class="w"> </span><span class="n">arguments</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h1 id="十五-启动根activity详解">十五. 启动根Activity详解
</h1><p>当应用程序进程启动后就该启动应用程序了,即启动根Activity</p>
<p>Activity启动分为两种:</p>
<ul>
<li>根Activity启动: 也称为APP冷启动,App还没有启动,一般从Launcher界面启动</li>
<li>普通Activity启动: APP已经启动,一般在APP内从一个Activity启动另一个Activity</li>
</ul>
<p>两者主流程基本一致,区别在于根Activity启动流程还包含<strong>启动APP进程和实例化Application</strong>的流程</p>
<h3 id="activitythread启动activity的过程">ActivityThread启动Activity的过程
</h3><p>经过以上流程之后,代码逻辑运行在应用程序进程中,ActivityThread启动Activity的时序图如下</p>
<p><img src="/photos%5c47-ActivityThread%e5%88%b0Activity%e7%9a%84%e8%bf%87%e7%a8%8b.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>ApplicationThread是ActivityThread的内部类,应用程序进程创建后会运行代表<strong>主线程的实例ActivityThread</strong>用于管理主线程</p>
<p>接着查看ApplicationThread.scheduleLaunchActivity方法:</p>
<ul>
<li>使用updateProcessState更新进程状态</li>
<li>将要启动的Activity的参数封装成ActivityClientRecord</li>
<li>通过sendMessage向H类发送类型为LAUNCH_ACTIVITY的消息</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//frameworks/base/core/java/android/app/ActivityThread.java        </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">scheduleLaunchActivity</span><span class="p">(</span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">IBinder</span><span class="w"> </span><span class="n">token</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ident</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">ActivityInfo</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">Configuration</span><span class="w"> </span><span class="n">curConfig</span><span class="p">,</span><span class="w"> </span><span class="n">Configuration</span><span class="w"> </span><span class="n">overrideConfig</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">CompatibilityInfo</span><span class="w"> </span><span class="n">compatInfo</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">referrer</span><span class="p">,</span><span class="w"> </span><span class="n">IVoiceInteractor</span><span class="w"> </span><span class="n">voiceInteractor</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">procState</span><span class="p">,</span><span class="w"> </span><span class="n">Bundle</span><span class="w"> </span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">PersistableBundle</span><span class="w"> </span><span class="n">persistentState</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">List</span><span class="o">&lt;</span><span class="n">ResultInfo</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pendingResults</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">ReferrerIntent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pendingNewIntents</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">boolean</span><span class="w"> </span><span class="n">notResumed</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isForward</span><span class="p">,</span><span class="w"> </span><span class="n">ProfilerInfo</span><span class="w"> </span><span class="n">profilerInfo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//更新进程状态</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">updateProcessState</span><span class="p">(</span><span class="n">procState</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//将要启动的Activity的参数封装成ActivityClientRecord</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ActivityClientRecord</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ActivityClientRecord</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">token</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">ident</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ident</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">referrer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">referrer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">voiceInteractor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">voiceInteractor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">activityInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">compatInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compatInfo</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">persistentState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">persistentState</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">pendingResults</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pendingResults</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">pendingIntents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pendingNewIntents</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">startsNotResumed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">notResumed</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">isForward</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isForward</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">profilerInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">profilerInfo</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">overrideConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">overrideConfig</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//更新要要启动Activity的配置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">updatePendingConfiguration</span><span class="p">(</span><span class="n">curConfig</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//向H类发送类型为LAUNCH_ACTIVITY的消息</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">sendMessage</span><span class="p">(</span><span class="n">H</span><span class="p">.</span><span class="na">LAUNCH_ACTIVITY</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>sendMessage有多个重载,调用到的如下所示</p>
<p>mH指的是H类,他是ActivityThread的内部类并继承自Handler,是应用程序进程中主线程的消息管理类</p>
<p>由于ApplicationThread是一个Binder,它的调用逻辑在Binder线程池中,此处需要使用H将代码逻辑切换回主线程</p>
<p>sendMessage方法将消息添加到消息队列中,消息处理程序会自动从消息队列取出消息并调用对应的handleMessage方法处理</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//frameworks/base/core/java/android/app/ActivityThread.java    </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendMessage</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">what</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">obj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">sendMessage</span><span class="p">(</span><span class="n">what</span><span class="p">,</span><span class="w"> </span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendMessage</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">what</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">arg1</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">arg2</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">async</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_MESSAGES</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;SCHEDULE &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">what</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mH</span><span class="p">.</span><span class="na">codeToString</span><span class="p">(</span><span class="n">what</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">arg1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; / &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">obj</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//获取消息实例</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Message</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Message</span><span class="p">.</span><span class="na">obtain</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">msg</span><span class="p">.</span><span class="na">what</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">what</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">msg</span><span class="p">.</span><span class="na">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obj</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">msg</span><span class="p">.</span><span class="na">arg1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">msg</span><span class="p">.</span><span class="na">arg2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg2</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//是否是异步消息</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">async</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">msg</span><span class="p">.</span><span class="na">setAsynchronous</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//调用消息处理程序 mH.sendMessage将消息发送出去</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">mH</span><span class="p">.</span><span class="na">sendMessage</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>handleMessage方定义在H类中,代码如下</p>
<ul>
<li>
<p>注释1处 将msg的obj成员转换为ActivityClientRecord</p>
</li>
<li>
<p>注释2处 通过getPackageInfoNoCheck获取LoadedApk对象,并赋值给ActivityClientRecord.packageInfo</p>
<p>应用程序进程要启动Activity时,需要将该Activity所属的APK加载进进程</p>
<p>而LoadedApk就是用于描述已加载的APK文件的</p>
</li>
<li>
<p>注释3处 调用handleLaunchActivity启动Activity</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//frameworks/base/core/java/android/app/ActivityThread.java    </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kd">class</span> <span class="nc">H</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Handler</span><span class="w"> </span><span class="p">{</span><span class="w">     
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">LAUNCH_ACTIVITY</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="n">100</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">PAUSE_ACTIVITY</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">101</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleMessage</span><span class="p">(</span><span class="n">Message</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_MESSAGES</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;&gt;&gt;&gt; handling: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">codeToString</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="na">what</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="na">what</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="n">LAUNCH_ACTIVITY</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">Trace</span><span class="p">.</span><span class="na">traceBegin</span><span class="p">(</span><span class="n">Trace</span><span class="p">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;activityStart&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">//1.将msg的obj成员转换为ActivityClientRecord</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="kd">final</span><span class="w"> </span><span class="n">ActivityClientRecord</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ActivityClientRecord</span><span class="p">)</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="na">obj</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">//2.通过getPackageInfoNoCheck获取LoadedApk类型的对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">//并赋值给ActivityClientRecord的成员packageInfo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">r</span><span class="p">.</span><span class="na">packageInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getPackageInfoNoCheck</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">r</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">compatInfo</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">//3.调用handleLaunchActivity启动Activity</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">handleLaunchActivity</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;LAUNCH_ACTIVITY&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">Trace</span><span class="p">.</span><span class="na">traceEnd</span><span class="p">(</span><span class="n">Trace</span><span class="p">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">//......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Object</span><span class="w"> </span><span class="n">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="na">obj</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obj</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">SomeArgs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">((</span><span class="n">SomeArgs</span><span class="p">)</span><span class="w"> </span><span class="n">obj</span><span class="p">).</span><span class="na">recycle</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_MESSAGES</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;&lt;&lt;&lt; done: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">codeToString</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="na">what</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="c1">//......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>handleLaunchActivity代码如下</p>
<p>执行完部分初始化操作后,在注释1处调用performLaunchActivity启动Activity</p>
<p>若得到的Activity!=null则设置为Resume状态,否则通知AMS停止启动Activity</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//frameworks/base/core/java/android/app/ActivityThread.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleLaunchActivity</span><span class="p">(</span><span class="n">ActivityClientRecord</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">Intent</span><span class="w"> </span><span class="n">customIntent</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">reason</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// If we are getting ready to gc after going to the background, well</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// we are back active so skip it.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//取消之前计划的GC(垃圾回收机制)操作,因为应用程序正在重新变为活动状态</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">unscheduleGcIdler</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">mSomeActivitiesChanged</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//如果ActivityClientRecord对象中包含了profilerInfo（性能分析器相关信息）,则将其设置到mProfiler中,并启动性能分析器</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">profilerInfo</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">mProfiler</span><span class="p">.</span><span class="na">setProfiler</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">profilerInfo</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">mProfiler</span><span class="p">.</span><span class="na">startProfiling</span><span class="p">();</span><span class="c1">//启动性能分析器</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Make sure we are running with the most recent config.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//处理配置变更,确保当前运行时使用的是最新的配置信息</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">handleConfigurationChanged</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">localLOGV</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;Handling launch of &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Initialize before creating the activity</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//初始化窗口管理器</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">WindowManagerGlobal</span><span class="p">.</span><span class="na">initialize</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//1.启动Activity</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Activity</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">performLaunchActivity</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">customIntent</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">createdConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Configuration</span><span class="p">(</span><span class="n">mConfiguration</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">reportSizeConfigurations</span><span class="p">(</span><span class="n">r</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Bundle</span><span class="w"> </span><span class="n">oldState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">state</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//2.将Activity的状态设置为Resume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">handleResumeActivity</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">token</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">isForward</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="o">!</span><span class="n">r</span><span class="p">.</span><span class="na">activity</span><span class="p">.</span><span class="na">mFinished</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">r</span><span class="p">.</span><span class="na">startsNotResumed</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">lastProcessedSeq</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">.</span><span class="na">activity</span><span class="p">.</span><span class="na">mFinished</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">startsNotResumed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// The activity manager actually wants this one to start out paused, because it</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// needs to be visible but isn&#39;t in the foreground. We accomplish this by going</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// through the normal startup (because activities expect to go through onResume()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// the first time they run, before their window is displayed), and then pausing it.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// However, in this case we do -not- need to do the full pause cycle (of freezing</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// and such) because the activity manager assumes it can just retain the current</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// state it has.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">performPauseActivityIfNeeded</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// We need to keep around the original state, in case we need to be created again.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// But we only do this for pre-Honeycomb apps, which always save their state when</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// pausing, so we can not have them save their state when restarting from a paused</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// state. For HC and later, we want to (and can) let the state be saved as the</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// normal part of stopping the activity.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">isPreHoneycomb</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">r</span><span class="p">.</span><span class="na">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oldState</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// If there was an error, for any reason, tell the activity manager to stop us.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">//3.如果a==null则通知AMS停止启动Activity</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">getService</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">.</span><span class="na">finishActivity</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">token</span><span class="p">,</span><span class="w"> </span><span class="n">Activity</span><span class="p">.</span><span class="na">RESULT_CANCELED</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">Activity</span><span class="p">.</span><span class="na">DONT_FINISH_TASK_WITH_ACTIVITY</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="n">ex</span><span class="p">.</span><span class="na">rethrowFromSystemServer</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>performLaunchActivity代码如下:</p>
<ul>
<li>
<p>注释1处 获取ActivityInfo,用于存储代码以及AndroidManifest设置的Activity和Receiver结点信息,例如Activity的theme和launchMode</p>
</li>
<li>
<p>注释2处 获取APK文件的描述类LoadedApk</p>
</li>
<li>
<p>注释3处 获取要启动的Activity的ComponentName,该类保存该Activity的包名和类名</p>
</li>
<li>
<p>注释4处 为Activity创建上下文环境</p>
</li>
<li>
<p>注释5处 根据ComponentName存储的Activity类名,通过类加载器创建Activity的实例</p>
</li>
<li>
<p>注释6处 创建应用程序对象Application,makeApplication内部会调用Application.attachBaseContext和onCreate</p>
<p>注意: ActivityThread.main中会创建LoadedApk对象并调用makeApplication方法,创建主进程的application</p>
<p>此处调用主要是处理activity可能位于子进程,也需要application(一个进程对应一个application)</p>
</li>
<li>
<p>注释7处 调用Activity.attach方法初始化Activity,内部会创建Window对象PhoneWindow,并与Activity自身进行关联</p>
</li>
<li>
<p>注释8处 调用Instrumentation.callActivityOnCreate启动Activity</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//frameworks/base/core/java/android/app/ActivityThread.java   </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">private</span><span class="w"> </span><span class="n">Activity</span><span class="w"> </span><span class="nf">performLaunchActivity</span><span class="p">(</span><span class="n">ActivityClientRecord</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">Intent</span><span class="w"> </span><span class="n">customIntent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// System.out.println(&#34;##### [&#34; + System.currentTimeMillis() + &#34;] ActivityThread.performLaunchActivity(&#34; + r + &#34;)&#34;);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//1.通过ActivityClientRecord获取ActivityInfo类</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ActivityInfo</span><span class="w"> </span><span class="n">aInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">packageInfo</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//2.获取APK文件的描述类LoadedApk</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">packageInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getPackageInfo</span><span class="p">(</span><span class="n">aInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">compatInfo</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">Context</span><span class="p">.</span><span class="na">CONTEXT_INCLUDE_CODE</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//3.获取componentName,即Activity的全限定类名(包名和类名)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ComponentName</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getComponent</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//4.创建要启动的Activity的上下文环境</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ContextImpl</span><span class="w"> </span><span class="n">appContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createBaseContextForActivity</span><span class="p">(</span><span class="n">r</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Activity</span><span class="w"> </span><span class="n">activity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//5.创建类加载器并通过类加载器创建Activity实例</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">ClassLoader</span><span class="w"> </span><span class="n">cl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">appContext</span><span class="p">.</span><span class="na">getClassLoader</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">activity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mInstrumentation</span><span class="p">.</span><span class="na">newActivity</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">cl</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">.</span><span class="na">getClassName</span><span class="p">(),</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="c1">//......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//6.创建应用程序对象Application实例</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Application</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">packageInfo</span><span class="p">.</span><span class="na">makeApplication</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">mInstrumentation</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="c1">//......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">activity</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">//7.初始化Activity</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="c1">//......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">//对 Activity 进行初始化和连接关键组件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">activity</span><span class="p">.</span><span class="na">attach</span><span class="p">(</span><span class="n">appContext</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">getInstrumentation</span><span class="p">(),</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">token</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">r</span><span class="p">.</span><span class="na">ident</span><span class="p">,</span><span class="w"> </span><span class="n">app</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">,</span><span class="w"> </span><span class="n">title</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">parent</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">r</span><span class="p">.</span><span class="na">embeddedID</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">lastNonConfigurationInstances</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">r</span><span class="p">.</span><span class="na">referrer</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">voiceInteractor</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">configCallback</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="c1">//......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">//8.启动Activity</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">isPersistable</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">mInstrumentation</span><span class="p">.</span><span class="na">callActivityOnCreate</span><span class="p">(</span><span class="n">activity</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">state</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">persistentState</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">mInstrumentation</span><span class="p">.</span><span class="na">callActivityOnCreate</span><span class="p">(</span><span class="n">activity</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">state</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">//......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">paused</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">mActivities</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">token</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">SuperNotCalledException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mInstrumentation</span><span class="p">.</span><span class="na">onException</span><span class="p">(</span><span class="n">activity</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="s">&#34;Unable to start activity &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">component</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">toString</span><span class="p">(),</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">activity</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Instrumentation.callActivityOnCreate代码如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//frameworks/base/core/java/android/app/Instrumentation.java   </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">callActivityOnCreate</span><span class="p">(</span><span class="n">Activity</span><span class="w"> </span><span class="n">activity</span><span class="p">,</span><span class="w"> </span><span class="n">Bundle</span><span class="w"> </span><span class="n">icicle</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    	</span><span class="c1">//执行预处理操作,例如设定主题样式、初始化资源等</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">prePerformCreate</span><span class="p">(</span><span class="n">activity</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="c1">//执行Activity的创建操作</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    	</span><span class="n">activity</span><span class="p">.</span><span class="na">performCreate</span><span class="p">(</span><span class="n">icicle</span><span class="p">,</span><span class="w"> </span><span class="n">persistentState</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    	</span><span class="c1">//执行后处理操作,例如注册广播接收器、初始化数据等</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    	</span><span class="n">postPerformCreate</span><span class="p">(</span><span class="n">activity</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>调用的Activity.performCreate代码如下,主要是调用了Activity.onCreate方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//frameworks/base/core/java/android/app/Activity.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">final</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">performCreate</span><span class="p">(</span><span class="n">Bundle</span><span class="w"> </span><span class="n">icicle</span><span class="p">,</span><span class="w"> </span><span class="n">PersistableBundle</span><span class="w"> </span><span class="n">persistentState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//在Android 6.0及以上版本中,应用需要动态请求某些权限,该方法用于恢复之前的权限请求状态</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">restoreHasCurrentPermissionRequest</span><span class="p">(</span><span class="n">icicle</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//调用Activity的实际的onCreate方法,执行开发者在Activity中重写的onCreate方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">onCreate</span><span class="p">(</span><span class="n">icicle</span><span class="p">,</span><span class="w"> </span><span class="n">persistentState</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//读取Activity的转场状态,即过渡动画的状态.这个方法将之前保存的转场状态恢复到当前Activity中</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mActivityTransitionState</span><span class="p">.</span><span class="na">readState</span><span class="p">(</span><span class="n">icicle</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//执行一些通用的初始化操作</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">performCreateCommon</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="根activity启动过程中涉及的进程">根Activity启动过程中涉及的进程
</h3><p>根Activity启动过程中涉及四个进程: Zygote进程, Launcher进程, AMS所在进程(SystemServer进程), 应用程序进程</p>
<p>如果是普通Activity启动,只涉及到AMS所在进程和应用程序进程</p>
<p>它们之间的关系如图所示, 启动根Activity的流程: Launcher-&gt;AMS-&gt;Zygote-&gt;AMS-&gt;Application-&gt;Activity</p>
<p><img src="/photos%5c48-%e6%a0%b9Activity%e5%90%af%e5%8a%a8%e8%bf%87%e7%a8%8b%e6%b6%89%e5%8f%8a%e7%9a%84%e8%bf%9b%e7%a8%8b.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>时序图如下</p>
<p><img src="/photos%5c49-%e6%a0%b9Activity%e5%90%af%e5%8a%a8%e6%97%b6%e5%ba%8f%e5%9b%be.png"
	
	
	
	loading="lazy"
	
	
></p>
<h1 id="十六-references">十六. References
</h1><p>主要参考资料如下,部分资料可能有所遗漏:</p>
<p>Android系统源码 aospxref.com和cs.android.com</p>
<p>Android进阶解密 刘望舒著</p>
<p>Android应用安全防护和逆向分析 姜维编著</p>
<p><a class="link" href="https://gal2xy.github.io/2023/12/01/Android%E5%8A%A0%E5%9B%BA%E5%A3%B3/Android%E7%AC%AC%E4%B8%80%E4%BB%A3%E5%8A%A0%E5%9B%BA%E5%A3%B3%E7%9A%84%E5%8E%9F%E7%90%86%E5%8F%8A%E5%AE%9E%E7%8E%B0/"  target="_blank" rel="noopener"
    >Android第一代加固壳的原理及实现 —— 落地加载</a></p>
<p><a class="link" href="https://gal2xy.github.io/2023/12/10/Android%E5%8A%A0%E5%9B%BA%E5%A3%B3/Android%E7%AC%AC%E4%BA%8C%E4%BB%A3%E5%8A%A0%E5%9B%BA%E5%A3%B3%E7%9A%84%E5%8E%9F%E7%90%86%E5%8F%8A%E5%AE%9E%E7%8E%B0/"  target="_blank" rel="noopener"
    >Android第二代加固壳的原理及实现 —— 不落地加载 </a></p>
<p><a class="link" href="https://blog.csdn.net/weixin_45582916/article/details/143052711?spm=1001.2014.3001.5501"  target="_blank" rel="noopener"
    >Android一代整体壳简易实现和踩坑记录</a></p>
<p><a class="link" href="https://blog.csdn.net/weixin_45582916/article/details/143055285?spm=1001.2014.3001.5501"  target="_blank" rel="noopener"
    >Android二代抽取壳简易实现和踩坑记录</a></p>
<p><a class="link" href="https://xialuohun.top/posts/android/android%E5%A3%B3%E4%B8%96%E7%95%8C/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/"  target="_blank" rel="noopener"
    >App加壳和脱壳</a></p>
<p><a class="link" href="https://bbs.kanxue.com/thread-266831.htm#msg_header_h3_2"  target="_blank" rel="noopener"
    >[原创]dex壳简单分析与实现过程</a></p>
<p><a class="link" href="https://github.com/jeanboydev/Android-ReadTheFuckingSourceCode/blob/master/article/android/framework/Android-Activity%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B.md"  target="_blank" rel="noopener"
    >Android-Activity启动过程</a></p>
<p><a class="link" href="https://github.com/luoyesiqiu/dpt-shell"  target="_blank" rel="noopener"
    >dpt-shell</a></p>
<p><a class="link" href="https://tttang.com/archive/1728/"  target="_blank" rel="noopener"
    >dpt-shell抽取壳项目源码及其逆向分析</a></p>
<p><a class="link" href="https://bbs.kanxue.com/thread-284744.htm"  target="_blank" rel="noopener"
    >[原创]dpt-shell源码详细解析（v1.11.3）</a></p>
<p><a class="link" href="https://bbs.kanxue.com/thread-277298.htm"  target="_blank" rel="noopener"
    >[原创]Android加壳与脱壳（11）——不落地加载壳的对抗研究 </a></p>
<p>脱壳工具:</p>
<p><a class="link" href="https://github.com/CodingGay/BlackDex"  target="_blank" rel="noopener"
    >BlackDex</a></p>
<p><a class="link" href="https://github.com/hluwa/frida-dexdump"  target="_blank" rel="noopener"
    >frida-dexdump</a></p>
<p><a class="link" href="https://github.com/hanbinglengyue/FART"  target="_blank" rel="noopener"
    >FART</a></p>
<p><a class="link" href="https://github.com/Youlor/Youpk"  target="_blank" rel="noopener"
    >Youpk</a></p>
<p><a class="link" href="https://nop.gs"  target="_blank" rel="noopener"
    >https://nop.gs</a></p>
<p>Dex2C和Dex VMP相关项目:</p>
<p><a class="link" href="https://github.com/codehasan/dex2c"  target="_blank" rel="noopener"
    >dex2c</a></p>
<p><a class="link" href="https://github.com/amimo/dcc"  target="_blank" rel="noopener"
    >dcc</a></p>
<p><a class="link" href="https://github.com/maoabc/nmmp"  target="_blank" rel="noopener"
    >nmmp</a></p>

</section>


    <footer class="article-footer">
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI&#43;WdtXRGWt2kTvGFasHpSy3SV"crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG&#43;vnGctmUb0ZY0l8"crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"integrity="sha384-&#43;VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4&#43;/RRE05"crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.body, {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist"]
        });})
</script>
    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">相关文章</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/">
        
        
            <div class="article-image">
                <img src="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/1-dex%E6%96%87%E4%BB%B6%E6%95%B4%E4%BD%93%E7%BB%93%E6%9E%84.578be309c60b9810690dcc195717c187_hu_a4b169926d45edd6.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Dex文件结构解析 ReadDex解析器实现"
                        
                        data-hash="md5-V4vjCcYLmBBpDcwZVxfBhw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Dex文件结构解析 ReadDex解析器实现</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/">
        
        
            <div class="article-image">
                <img src="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/1-%E7%9B%AE%E6%A0%87%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F.fe2213b576eef45317998ee1c132656c_hu_fbc5ad0c4a06e52a.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post ELF文件结构浅析-解析器和加载器实现"
                        
                        data-hash="md5-/iITtXbu9FMXmY7hwTJlbA==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">ELF文件结构浅析-解析器和加载器实现</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/fridastudy/">
        
        

        <div class="article-details">
            <h2 class="article-title">FridaStudy</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/androidbasicstudy/">
        
        
            <div class="article-image">
                <img src="/p/androidbasicstudy/8_%E6%B4%BB%E5%8A%A8%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.b6d9e6ef6be71ee1bd6ad48f04fc0eb5_hu_b0bc600821d22529.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post AndroidBasicStudy"
                        
                        data-hash="md5-ttnm72vnHuG9atSPBPwOtQ==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">AndroidBasicStudy</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/ndkstudy/">
        
        

        <div class="article-details">
            <h2 class="article-title">NDKStudy</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script src="https://utteranc.es/client.js" 
        repo="OrientalGlass/utterances-comments"
        issue-term="pathname"
        
        crossorigin="anonymous"
        async
        >
</script>

<style>
    .utterances {
        max-width: unset;
    }
</style>

<script>
    let utterancesLoaded = false;

    function setUtterancesTheme(theme) {
        let utterances = document.querySelector('.utterances iframe');
        if (utterances) {
            utterances.contentWindow.postMessage(
                {
                    type: 'set-theme',
                    theme: `github-${theme}`
                },
                'https://utteranc.es'
            );
        }
    }

    addEventListener('message', event => {
        if (event.origin !== 'https://utteranc.es') return;

        
        utterancesLoaded = true;
        setUtterancesTheme(document.documentElement.dataset.scheme)
    });

    window.addEventListener('onColorSchemeChange', (e) => {
        if (!utterancesLoaded) return;
        setUtterancesTheme(e.detail)
    })
</script>


    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2024 - 
        
        2025 OrientalGlass
    </section>
    
    <section class="powerby">
        使用 <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> 构建 <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.27.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
