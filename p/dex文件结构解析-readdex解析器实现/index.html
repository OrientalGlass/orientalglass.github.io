<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="前言 近期学习DEX文件结构为学习APP加壳脱壳打基础,自实现了一个简易的DEX解析器加深理解\nDEX文件结构整体看不复杂,深究时发现DexCLassDef结构非常复杂,编码的数据结构,嵌套和指向关系\n">
<title>Dex文件结构解析 ReadDex解析器实现</title>

<link rel='canonical' href='https://example.com/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/'>

<link rel="stylesheet" href="/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css"><meta property='og:title' content="Dex文件结构解析 ReadDex解析器实现">
<meta property='og:description' content="前言 近期学习DEX文件结构为学习APP加壳脱壳打基础,自实现了一个简易的DEX解析器加深理解\nDEX文件结构整体看不复杂,深究时发现DexCLassDef结构非常复杂,编码的数据结构,嵌套和指向关系\n">
<meta property='og:url' content='https://example.com/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/'>
<meta property='og:site_name' content='OrientalGlass'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2024-12-26T13:47:07&#43;08:00'/><meta property='article:modified_time' content='2024-12-26T13:47:07&#43;08:00'/><meta property='og:image' content='https://example.com/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/1-dex%E6%96%87%E4%BB%B6%E6%95%B4%E4%BD%93%E7%BB%93%E6%9E%84.png' />
<meta name="twitter:title" content="Dex文件结构解析 ReadDex解析器实现">
<meta name="twitter:description" content="前言 近期学习DEX文件结构为学习APP加壳脱壳打基础,自实现了一个简易的DEX解析器加深理解\nDEX文件结构整体看不复杂,深究时发现DexCLassDef结构非常复杂,编码的数据结构,嵌套和指向关系\n"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://example.com/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/1-dex%E6%96%87%E4%BB%B6%E6%95%B4%E4%BD%93%E7%BB%93%E6%9E%84.png' />
    <link rel="shortcut icon" href="/favicon.jpg" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu_149d93b4b8d2abf8.jpg" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">OrientalGlass</a></h1>
            <h2 class="site-description">Welcome to my blog!</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://space.bilibili.com/21031513'
                        target="_blank"
                        title="Bilibili"
                        rel="me"
                    >
                        
                        
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-brand-bilibili"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 10a4 4 0 0 1 4 -4h10a4 4 0 0 1 4 4v6a4 4 0 0 1 -4 4h-10a4 4 0 0 1 -4 -4v-6z" /><path d="M8 3l2 3" /><path d="M16 3l-2 3" /><path d="M9 13v-2" /><path d="M15 11v2" /></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='oriental0glass@gmail.com'
                        target="_blank"
                        title="Eamil"
                        rel="me"
                    >
                        
                        
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-mail"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 7a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v10a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-10z" /><path d="M3 7l9 6l9 -6" /></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/OrientalGlass'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>主页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#前言">前言</a></li>
    <li><a href="#准备">准备</a></li>
    <li><a href="#数据类型">数据类型</a>
      <ol>
        <li><a href="#leb128">Leb128</a></li>
        <li><a href="#encoded_value">encoded_value</a></li>
        <li><a href="#encoded_array">encoded_array</a></li>
        <li><a href="#encoded_annotation">encoded_annotation</a></li>
        <li><a href="#annotation_element">annotation_element</a></li>
      </ol>
    </li>
    <li><a href="#dex整体结构">Dex整体结构</a></li>
    <li><a href="#dex-header">Dex Header</a></li>
    <li><a href="#dex-string-id">Dex String ID</a></li>
    <li><a href="#dex-type-id">Dex Type ID</a></li>
    <li><a href="#dex-proto-id">Dex Proto ID</a>
      <ol>
        <li><a href="#dextypelist">DexTypeList</a></li>
      </ol>
    </li>
    <li><a href="#dex-field-id">Dex Field ID</a></li>
    <li><a href="#dex-method-id">Dex Method ID</a></li>
    <li><a href="#dex-map-list">Dex Map List</a></li>
    <li><a href="#dex-class-def">Dex Class Def</a>
      <ol>
        <li><a href="#classdefbasicinfo">ClassDefBasicInfo</a></li>
        <li><a href="#dexannotationsdirectoryitem">DexAnnotationsDirectoryItem</a>
          <ol>
            <li><a href="#类注解-dexannotationsetitem">类注解 DexAnnotationSetItem</a></li>
            <li><a href="#域注解-dexfieldannotationsitem">域注解 DexFieldAnnotationsItem</a></li>
            <li><a href="#方法注解-dexmethodannotationsitem">方法注解 DexMethodAnnotationsItem</a></li>
            <li><a href="#参数注解-dexparameterannotationsitem">参数注解 DexParameterAnnotationsItem</a></li>
          </ol>
        </li>
        <li><a href="#dexclassdata">DexClassData</a></li>
        <li><a href="#dexencodedarray">DexEncodedArray</a></li>
      </ol>
    </li>
    <li><a href="#android系统可执行文件">Android系统可执行文件</a>
      <ol>
        <li><a href="#从jvm到dalvik再到art">从JVM到Dalvik再到ART</a></li>
        <li><a href="#dex">DEX</a></li>
        <li><a href="#odex">ODEX</a></li>
        <li><a href="#oat">OAT</a></li>
        <li><a href="#vdex">VDEX</a></li>
        <li><a href="#art">ART</a></li>
      </ol>
    </li>
    <li><a href="#todo">Todo</a></li>
    <li><a href="#references">References</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/">
                <img src="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/1-dex%E6%96%87%E4%BB%B6%E6%95%B4%E4%BD%93%E7%BB%93%E6%9E%84_hu_33c8eff55e871f6e.png"
                        srcset="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/1-dex%E6%96%87%E4%BB%B6%E6%95%B4%E4%BD%93%E7%BB%93%E6%9E%84_hu_33c8eff55e871f6e.png 800w, /p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/1-dex%E6%96%87%E4%BB%B6%E6%95%B4%E4%BD%93%E7%BB%93%E6%9E%84_hu_1814cac529a93fce.png 1600w"
                        width="800" 
                        height="734" 
                        loading="lazy"
                        alt="Featured image of post Dex文件结构解析 ReadDex解析器实现" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/android/" >
                Android
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/">Dex文件结构解析 ReadDex解析器实现</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2024-12-26</time>
            </div>
        

        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="前言">前言
</h1><p>近期学习DEX文件结构为学习APP加壳脱壳打基础,自实现了一个简易的DEX解析器加深理解</p>
<p>DEX文件结构整体看不复杂,深究时发现DexCLassDef结构非常复杂,编码的数据结构,嵌套和指向关系</p>
<p>本文作为近期学习的一个阶段总结以及知识分享,后期再完善Todo部分</p>
<p><strong>由于本人水平有限,文章错漏之处还望大佬批评指正</strong></p>
<p>环境&amp;工具:</p>
<ul>
<li>
<p>010editor 15.0.1 (13.0.1有bug,打开大文件分析时容易崩溃)</p>
</li>
<li>
<p>Clion 2024.2.3</p>
</li>
<li>
<p>JDK 11.0.23</p>
</li>
<li>
<p>MinGW 14.2.0</p>
</li>
<li>
<p>Android Studio</p>
</li>
</ul>
<h1 id="准备">准备
</h1><p>自行编译dex文件供后续分析</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">HelloDEX</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Hello Dex!&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">javac HelloDEX.java
</span></span><span class="line"><span class="cl">d8 HelloDEX.class
</span></span></code></pre></td></tr></table>
</div>
</div><p>可能遇到报错如下,这是因为d8需要java11+的环境,不支持java8</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">Error</span><span class="p">:</span> <span class="n">A</span> <span class="n">JNI</span> <span class="n">error</span> <span class="n">has</span> <span class="n">occurred</span><span class="p">,</span> <span class="n">please</span> <span class="n">check</span> <span class="n">your</span> <span class="n">installation</span> <span class="ow">and</span> <span class="n">try</span> <span class="n">again</span>
</span></span><span class="line"><span class="cl"><span class="n">Exception</span> <span class="ow">in</span> <span class="n">thread</span> <span class="s2">&#34;main&#34;</span> <span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">UnsupportedClassVersionError</span><span class="p">:</span> <span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">tools</span><span class="o">/</span><span class="n">r8</span><span class="o">/</span><span class="n">D8</span> <span class="n">has</span> <span class="n">been</span> <span class="n">compiled</span> <span class="n">by</span> <span class="n">a</span> <span class="n">more</span> <span class="n">recent</span> <span class="n">version</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Java</span> <span class="n">Runtime</span> <span class="p">(</span><span class="k">class</span> <span class="n">file</span> <span class="n">version</span> <span class="mf">55.0</span><span class="p">),</span> <span class="n">this</span> <span class="n">version</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Java</span> <span class="n">Runtime</span> <span class="n">only</span> <span class="n">recognizes</span> <span class="k">class</span> <span class="n">file</span> <span class="n">versions</span> <span class="n">up</span> <span class="n">to</span> <span class="mf">52.0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="数据类型">数据类型
</h1><p>Android源码 <a class="link" href="http://androidxref.com/2.3.7/xref/dalvik/libdex/DexFile.h"  target="_blank" rel="noopener"
    >http://androidxref.com/2.3.7/xref/dalvik/libdex/DexFile.h</a> 定义了dex文件用到的数据结构</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th style="text-align: left">自定义类型</th>
          <th style="text-align: left">原类型</th>
          <th style="text-align: left">含义</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">s1</td>
          <td style="text-align: left">int8_t</td>
          <td style="text-align: left">有符号单字节</td>
      </tr>
      <tr>
          <td style="text-align: left">u1</td>
          <td style="text-align: left">uint8_t</td>
          <td style="text-align: left">无符号单字节</td>
      </tr>
      <tr>
          <td style="text-align: left">s2</td>
          <td style="text-align: left">int16_t</td>
          <td style="text-align: left"></td>
      </tr>
      <tr>
          <td style="text-align: left">u2</td>
          <td style="text-align: left">uint16_t</td>
          <td style="text-align: left"></td>
      </tr>
      <tr>
          <td style="text-align: left">s4</td>
          <td style="text-align: left">int32_t</td>
          <td style="text-align: left"></td>
      </tr>
      <tr>
          <td style="text-align: left">u4</td>
          <td style="text-align: left">uint32_t</td>
          <td style="text-align: left"></td>
      </tr>
      <tr>
          <td style="text-align: left">s8</td>
          <td style="text-align: left">int64_t</td>
          <td style="text-align: left"></td>
      </tr>
      <tr>
          <td style="text-align: left">u8</td>
          <td style="text-align: left">uint64_t</td>
          <td style="text-align: left"></td>
      </tr>
      <tr>
          <td style="text-align: left">sleb128</td>
          <td style="text-align: left">无</td>
          <td style="text-align: left">有符号LEB128,可变长度</td>
      </tr>
      <tr>
          <td style="text-align: left">uleb128</td>
          <td style="text-align: left">无</td>
          <td style="text-align: left">无符号LEB128,可变长度</td>
      </tr>
      <tr>
          <td style="text-align: left">uleb128p1</td>
          <td style="text-align: left">无</td>
          <td style="text-align: left">等于ULEB128加1,可变长度</td>
      </tr>
  </tbody>
</table></div>
<h2 id="leb128">Leb128
</h2><p>sleb128、uleb128、uleb128p1是Dex文件中特有的LEB128类型.在下述Android源码位置可以找到LEB128的实现.http://androidxref.com/2.3.7/xref/dalvik/libdex/Leb128.h</p>
<p>每个LEB128由1-5字节组成,所有字节组合在一起表示一个32位的数据, 每个字节只有低7位为有效位,最高位标识是否需要使用额外字节</p>
<p>如果第1个字节的最高位为1,表示LEB128需要使用第2个字节,如果第2个字节的最高位为1,表示会使用第3个字节,依次类推,直到最后一个字节的最高位为0</p>
<p>uleb128读取代码如下</p>
<p>值得注意的是参数为二级指针,也就是说,调用该函数时会移动一级指针,一级指针的偏移量即为读取到的uleb128的大小</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">readUnsignedLeb128</span><span class="p">(</span><span class="k">const</span> <span class="n">u1</span><span class="o">**</span> <span class="n">pStream</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">u1</span><span class="o">*</span> <span class="n">ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">pStream</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">++</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">cur</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">++</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">cur</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">&gt;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">cur</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">++</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">cur</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">&gt;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">cur</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">++</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">cur</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">&gt;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">                     * Note: We don&#39;t check to see if cur is out of
</span></span></span><span class="line"><span class="cl"><span class="cm">                     * range here, meaning we tolerate garbage in the
</span></span></span><span class="line"><span class="cl"><span class="cm">                     * high four-order bits.
</span></span></span><span class="line"><span class="cl"><span class="cm">                     */</span>
</span></span><span class="line"><span class="cl">                    <span class="n">cur</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">++</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">result</span> <span class="o">|=</span> <span class="n">cur</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">pStream</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>为方便使用自定义了myReadUnsignedLeb128函数,参数为一级指针,返回读取的数据及其大小</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// 传入指针直接读取数据并返回数据和读取的大小(可选)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">myReadUnsignedLeb128</span><span class="p">(</span><span class="k">const</span> <span class="n">u1</span><span class="o">*</span> <span class="n">pData</span><span class="p">,</span><span class="n">size_t</span><span class="o">*</span> <span class="n">readSize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">u1</span><span class="o">**</span> <span class="n">pStream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span> <span class="n">result</span><span class="o">=</span><span class="n">readUnsignedLeb128</span><span class="p">(</span><span class="n">pStream</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">readSize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">readSize</span><span class="o">=</span><span class="n">unsignedLeb128Size</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="encoded_value">encoded_value
</h2><p>参考Android官方文档https://source.android.com/docs/core/dalvik/dex-format?hl=zh-cn#encoding</p>
<p>解析代码参考以下文档,只找到了java代码</p>
<p><a class="link" href="http://androidxref.com/2.3.7/xref/cts/tools/dex-tools/src/dex/reader/DexEncodedValueImpl.java"  target="_blank" rel="noopener"
    >http://androidxref.com/2.3.7/xref/cts/tools/dex-tools/src/dex/reader/DexEncodedValueImpl.java</a></p>
<p><a class="link" href="http://androidxref.com/2.3.7/xref/dalvik/dx/src/com/android/dx/dex/file/ValueEncoder.java"  target="_blank" rel="noopener"
    >http://androidxref.com/2.3.7/xref/dalvik/dx/src/com/android/dx/dex/file/ValueEncoder.java</a></p>
<p>解析DexClassDef结构时,Annotation的annotation_element和encoded_array_item会使用该编码</p>
<p>编码格式如下,1字节的头用于指定value格式和大小,后续紧跟数据,需要根据类型解析</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th style="text-align: left">名称</th>
          <th style="text-align: left">格式</th>
          <th style="text-align: left">说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">(value_arg &laquo; 5) | value_type</td>
          <td style="text-align: left">ubyte</td>
          <td style="text-align: left">高3位为value_arg的值，低5位为value_type的值，value_type指定value的格式。</td>
      </tr>
      <tr>
          <td style="text-align: left">value</td>
          <td style="text-align: left">ubyte[]</td>
          <td style="text-align: left">用于表示值的字节，不同 value_type 字节的长度不同且采用不同的解译方式；不过一律采用小端字节序。</td>
      </tr>
  </tbody>
</table></div>
<p>value_type枚举定义如下</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th style="text-align: left">类型名称</th>
          <th style="text-align: left">value_type</th>
          <th style="text-align: left">value_arg</th>
          <th style="text-align: left">value格式</th>
          <th style="text-align: left">说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">VALUE_BYTE</td>
          <td style="text-align: left">0x00</td>
          <td style="text-align: left">（无；必须为 <code>0</code>）</td>
          <td style="text-align: left">ubyte[1]</td>
          <td style="text-align: left">有符号的单字节整数值</td>
      </tr>
      <tr>
          <td style="text-align: left">VALUE_SHORT</td>
          <td style="text-align: left">0x02</td>
          <td style="text-align: left">size - 1 (0…1)</td>
          <td style="text-align: left">ubyte[size]</td>
          <td style="text-align: left">有符号的双字节整数值，符号扩展</td>
      </tr>
      <tr>
          <td style="text-align: left">VALUE_CHAR</td>
          <td style="text-align: left">0x03</td>
          <td style="text-align: left">size - 1 (0…1)</td>
          <td style="text-align: left">ubyte[size]</td>
          <td style="text-align: left">无符号的双字节整数值，零扩展</td>
      </tr>
      <tr>
          <td style="text-align: left">VALUE_INT</td>
          <td style="text-align: left">0x04</td>
          <td style="text-align: left">size - 1 (0…3)</td>
          <td style="text-align: left">ubyte[size]</td>
          <td style="text-align: left">有符号的四字节整数值，符号扩展</td>
      </tr>
      <tr>
          <td style="text-align: left">VALUE_LONG</td>
          <td style="text-align: left">0x06</td>
          <td style="text-align: left">size - 1 (0…7)</td>
          <td style="text-align: left">ubyte[size]</td>
          <td style="text-align: left">有符号的八字节整数值，符号扩展</td>
      </tr>
      <tr>
          <td style="text-align: left">VALUE_FLOAT</td>
          <td style="text-align: left">0x10</td>
          <td style="text-align: left">size - 1 (0…3)</td>
          <td style="text-align: left">ubyte[size]</td>
          <td style="text-align: left">四字节位模式，向右零扩展，系统会将其解译为 IEEE754 32 位浮点值</td>
      </tr>
      <tr>
          <td style="text-align: left">VALUE_DOUBLE</td>
          <td style="text-align: left">0x11</td>
          <td style="text-align: left">size - 1 (0…7)</td>
          <td style="text-align: left">ubyte[size]</td>
          <td style="text-align: left">八字节位模式，向右零扩展，系统会将其解译为 IEEE754 64 位浮点值</td>
      </tr>
      <tr>
          <td style="text-align: left">VALUE_METHOD_TYPE</td>
          <td style="text-align: left">0x15</td>
          <td style="text-align: left">size - 1 (0…3)</td>
          <td style="text-align: left">ubyte[size]</td>
          <td style="text-align: left">无符号（零扩展）四字节整数值，会被解译为要编入 <code>proto_ids</code> 区段的索引；表示方法类型值</td>
      </tr>
      <tr>
          <td style="text-align: left">VALUE_METHOD_HANDLE</td>
          <td style="text-align: left">0x16</td>
          <td style="text-align: left">size - 1 (0…3)</td>
          <td style="text-align: left">ubyte[size]</td>
          <td style="text-align: left">无符号（零扩展）四字节整数值，会被解译为要编入 <code>method_handles</code> 区段的索引；表示方法句柄值</td>
      </tr>
      <tr>
          <td style="text-align: left">VALUE_STRING</td>
          <td style="text-align: left">0x17</td>
          <td style="text-align: left">size - 1 (0…3)</td>
          <td style="text-align: left">ubyte[size]</td>
          <td style="text-align: left">无符号（零扩展）四字节整数值，会被解译为要编入 <code>string_ids</code> 区段的索引；表示字符串值</td>
      </tr>
      <tr>
          <td style="text-align: left">VALUE_TYPE</td>
          <td style="text-align: left">0x18</td>
          <td style="text-align: left">size - 1 (0…3)</td>
          <td style="text-align: left">ubyte[size]</td>
          <td style="text-align: left">无符号（零扩展）四字节整数值，会被解译为要编入 <code>type_ids</code> 区段的索引；表示反射类型/类值</td>
      </tr>
      <tr>
          <td style="text-align: left">VALUE_FIELD</td>
          <td style="text-align: left">0x19</td>
          <td style="text-align: left">size - 1 (0…3)</td>
          <td style="text-align: left">ubyte[size]</td>
          <td style="text-align: left">无符号（零扩展）四字节整数值，会被解译为要编入 <code>field_ids</code> 区段的索引；表示反射字段值</td>
      </tr>
      <tr>
          <td style="text-align: left">VALUE_METHOD</td>
          <td style="text-align: left">0x1a</td>
          <td style="text-align: left">size - 1 (0…3)</td>
          <td style="text-align: left">ubyte[size]</td>
          <td style="text-align: left">无符号（零扩展）四字节整数值，会被解译为要编入 <code>method_ids</code> 区段的索引；表示反射方法值</td>
      </tr>
      <tr>
          <td style="text-align: left">VALUE_ENUM</td>
          <td style="text-align: left">0x1b</td>
          <td style="text-align: left">size - 1 (0…3)</td>
          <td style="text-align: left">ubyte[size]</td>
          <td style="text-align: left">无符号（零扩展）四字节整数值，会被解译为要编入 <code>field_ids</code> 区段的索引；表示枚举类型常量的值</td>
      </tr>
      <tr>
          <td style="text-align: left">VALUE_ARRAY</td>
          <td style="text-align: left">0x1c</td>
          <td style="text-align: left">（无；必须为 <code>0</code>）</td>
          <td style="text-align: left">encoded_array</td>
          <td style="text-align: left">值的数组，采用下文“<code>encoded_array</code> 格式”所指定的格式。<code>value</code> 的大小隐含在编码中。</td>
      </tr>
      <tr>
          <td style="text-align: left">VALUE_ANNOTATION</td>
          <td style="text-align: left">0x1d</td>
          <td style="text-align: left">（无；必须为 <code>0</code>）</td>
          <td style="text-align: left">encoded_annotation</td>
          <td style="text-align: left">子注解，采用下文“<code>encoded_annotation</code> 格式”所指定的格式。<code>value</code> 的大小隐含在编码中。</td>
      </tr>
      <tr>
          <td style="text-align: left">VALUE_NULL</td>
          <td style="text-align: left">0x1e</td>
          <td style="text-align: left">（无；必须为 <code>0</code>）</td>
          <td style="text-align: left">（无）</td>
          <td style="text-align: left"><code>null</code> 引用值</td>
      </tr>
      <tr>
          <td style="text-align: left">VALUE_BOOLEAN</td>
          <td style="text-align: left">0x1f</td>
          <td style="text-align: left">布尔值 (0…1)</td>
          <td style="text-align: left">（无）</td>
          <td style="text-align: left">一位值；<code>0</code> 表示 <code>false</code>，<code>1</code> 表示 <code>true</code>。该位在 <code>value_arg</code> 中表示。</td>
      </tr>
  </tbody>
</table></div>
<p>解析代码如下(<strong>该函数在解析DexClassDef的Annotation时才会使用,可先忽略</strong>)</p>
<p>parseEncodedValue函数会自动读取单个encoded_value并返回解析后的字符串(类型:值 的键值对形式)以及value占用的真实字节数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// 读取EncodedValue, 由于大小不固定, 故直接以数组赋值形式取值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">getEncodedValue</span><span class="p">(</span><span class="n">ubyte</span><span class="o">*</span> <span class="n">pDest</span><span class="p">,</span><span class="k">const</span> <span class="n">ubyte</span><span class="o">*</span> <span class="n">pValue</span><span class="p">,</span><span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">size</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">pDest</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">pValue</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 解析EncodedValue, 返回解析后的字符串以及value真实大小 Todo: 完善解析逻辑,剩余3个分支
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">parseEncodedValue</span><span class="p">(</span><span class="n">ubyte</span><span class="o">*</span> <span class="n">pEncodedValue</span><span class="p">,</span><span class="n">size_t</span><span class="o">&amp;</span> <span class="n">valueRealSize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ubyte</span> <span class="n">valueArg</span> <span class="o">=</span> <span class="n">GetValueArg</span><span class="p">(</span><span class="n">pEncodedValue</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="c1">// arg=size-1,值占用的字节数&lt;=对应类型大小,不含头部的单字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ubyte</span> <span class="n">valueType</span> <span class="o">=</span> <span class="n">GetValueType</span><span class="p">(</span><span class="n">pEncodedValue</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 假如int=0时,占2字节,头1字节,值0占1字节,所以要同时判断arg和type
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">valueArg</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//arg==0时,要确定是arg固定为0的特殊类型还是其他类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//特殊类型只有1字节头,其他类型是1字节头+1字节数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">bool</span> <span class="n">isSpecialType</span><span class="o">=</span><span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="p">(</span><span class="n">valueType</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nl">VALUE_BYTE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nl">VALUE_ARRAY</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nl">VALUE_ANNOTATION</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nl">VALUE_NULL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nl">VALUE_BOOLEAN</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">isSpecialType</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">isSpecialType</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">valueRealSize</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="n">valueRealSize</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="n">valueRealSize</span><span class="o">=</span><span class="n">valueArg</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span><span class="c1">// 头部1字节+实际大小 size=head+arg+1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">readValueSize</span><span class="o">=</span><span class="n">valueArg</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span><span class="c1">// 需要读取的字节数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ubyte</span><span class="o">*</span> <span class="n">pValue</span><span class="o">=&amp;</span><span class="n">pEncodedValue</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span><span class="p">(</span><span class="n">valueType</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 有符号单字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">case</span> <span class="nl">VALUE_BYTE</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">char</span> <span class="n">byte</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">getEncodedValue</span><span class="p">((</span><span class="n">ubyte</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">byte</span><span class="p">,</span><span class="n">pValue</span><span class="p">,</span><span class="n">readValueSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span><span class="o">=</span><span class="s">&#34;byte:&#34;</span><span class="o">+</span><span class="n">std</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">&#34;0x{:x}&#34;</span><span class="p">,</span><span class="n">byte</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 有符号双字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">case</span> <span class="nl">VALUE_SHORT</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">short</span> <span class="n">value_short</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">getEncodedValue</span><span class="p">((</span><span class="n">ubyte</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">value_short</span><span class="p">,</span><span class="n">pValue</span><span class="p">,</span><span class="n">readValueSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span><span class="o">=</span><span class="s">&#34;short:&#34;</span><span class="o">+</span><span class="n">std</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">&#34;0x{:x}&#34;</span><span class="p">,</span><span class="n">value_short</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 无符号双字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">case</span> <span class="nl">VALUE_CHAR</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">value_char</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">getEncodedValue</span><span class="p">((</span><span class="n">ubyte</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">value_char</span><span class="p">,</span><span class="n">pValue</span><span class="p">,</span><span class="n">readValueSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span><span class="o">=</span><span class="s">&#34;char:&#34;</span><span class="o">+</span><span class="n">std</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">&#34;0x{:x}&#34;</span><span class="p">,</span><span class="n">value_char</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 有符号4字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">case</span> <span class="nl">VALUE_INT</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">value_int</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">getEncodedValue</span><span class="p">((</span><span class="n">ubyte</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">value_int</span><span class="p">,</span><span class="n">pValue</span><span class="p">,</span><span class="n">readValueSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span><span class="o">=</span><span class="s">&#34;int:&#34;</span><span class="o">+</span><span class="n">std</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">&#34;0x{:x}&#34;</span><span class="p">,</span><span class="n">value_int</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 有符号8字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">case</span> <span class="nl">VALUE_LONG</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">long</span> <span class="kt">long</span> <span class="n">value_long</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">getEncodedValue</span><span class="p">((</span><span class="n">ubyte</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">value_long</span><span class="p">,</span><span class="n">pValue</span><span class="p">,</span><span class="n">readValueSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span><span class="o">=</span><span class="s">&#34;long:&#34;</span><span class="o">+</span><span class="n">std</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">&#34;0x{:x}&#34;</span><span class="p">,</span><span class="n">value_long</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 4字节浮点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">case</span> <span class="nl">VALUE_FLOAT</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">float</span> <span class="n">value_float</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">getEncodedValue</span><span class="p">((</span><span class="n">ubyte</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">value_float</span><span class="p">,</span><span class="n">pValue</span><span class="p">,</span><span class="n">readValueSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span><span class="o">=</span><span class="s">&#34;float:&#34;</span><span class="o">+</span><span class="n">std</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">&#34;{:f}&#34;</span><span class="p">,</span><span class="n">value_float</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 8字节浮点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">case</span> <span class="nl">VALUE_DOUBLE</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">double</span> <span class="n">value_double</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">getEncodedValue</span><span class="p">((</span><span class="n">ubyte</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">value_double</span><span class="p">,</span><span class="n">pValue</span><span class="p">,</span><span class="n">readValueSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span><span class="o">=</span><span class="s">&#34;double:&#34;</span><span class="o">+</span><span class="n">std</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">&#34;{:f}&#34;</span><span class="p">,</span><span class="n">value_double</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 无符号4字节索引 指向对应结构
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">case</span> <span class="nl">VALUE_METHOD_TYPE</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ProtoId
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">getEncodedValue</span><span class="p">((</span><span class="n">ubyte</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">index</span><span class="p">,</span><span class="n">pValue</span><span class="p">,</span><span class="n">readValueSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span><span class="o">=</span><span class="s">&#34;MethodType:&#34;</span><span class="o">+</span><span class="n">std</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">&#34;0x{:x}&#34;</span><span class="p">,</span><span class="n">index</span><span class="p">)</span><span class="o">+</span><span class="s">&#34; &#34;</span><span class="o">+</span><span class="n">getProtoIdDataByIndex</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// todo: 这部分没有定义的成员指向,暂时不知如何解析,参考 https://source.android.com/docs/core/runtime/dex-format?hl=zh-cn#method-handle-item
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">case</span> <span class="nl">VALUE_METHOD_HANDLE</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// MethodHandles
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">getEncodedValue</span><span class="p">((</span><span class="n">ubyte</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">index</span><span class="p">,</span><span class="n">pValue</span><span class="p">,</span><span class="n">readValueSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span><span class="o">=</span><span class="s">&#34;MethodHandle Index:&#34;</span><span class="o">+</span><span class="n">std</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">&#34;0x{:x}&#34;</span><span class="p">,</span><span class="n">index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">VALUE_STRING</span><span class="p">:</span> <span class="p">{</span>         
</span></span><span class="line"><span class="cl">            <span class="c1">// StringId
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">getEncodedValue</span><span class="p">((</span><span class="n">ubyte</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">index</span><span class="p">,</span><span class="n">pValue</span><span class="p">,</span><span class="n">readValueSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span><span class="o">=</span><span class="s">&#34;String:&#34;</span><span class="o">+</span><span class="n">getStringIdDataByIndex</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">VALUE_TYPE</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// TypeId
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">getEncodedValue</span><span class="p">((</span><span class="n">ubyte</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">index</span><span class="p">,</span><span class="n">pValue</span><span class="p">,</span><span class="n">readValueSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span><span class="o">=</span><span class="s">&#34;Type:&#34;</span><span class="o">+</span><span class="n">parseString</span><span class="p">(</span><span class="n">getTypeIdDataByIndex</span><span class="p">(</span><span class="n">index</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">VALUE_FIELD</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// FieldId
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">getEncodedValue</span><span class="p">((</span><span class="n">ubyte</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">index</span><span class="p">,</span><span class="n">pValue</span><span class="p">,</span><span class="n">readValueSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span><span class="o">=</span><span class="s">&#34;Field:&#34;</span><span class="o">+</span><span class="n">parseString</span><span class="p">(</span><span class="n">getFieldIdDataByIndex</span><span class="p">(</span><span class="n">index</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">VALUE_METHOD</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// MethodId
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">getEncodedValue</span><span class="p">((</span><span class="n">ubyte</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">index</span><span class="p">,</span><span class="n">pValue</span><span class="p">,</span><span class="n">readValueSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span><span class="o">=</span><span class="s">&#34;Method:&#34;</span><span class="o">+</span><span class="n">parseString</span><span class="p">(</span><span class="n">getMethodIdDataByIndex</span><span class="p">(</span><span class="n">index</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">VALUE_ENUM</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// FieldId
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">getEncodedValue</span><span class="p">((</span><span class="n">ubyte</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">index</span><span class="p">,</span><span class="n">pValue</span><span class="p">,</span><span class="n">readValueSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span><span class="o">=</span><span class="s">&#34;Enum:&#34;</span><span class="o">+</span><span class="n">parseString</span><span class="p">(</span><span class="n">getFieldIdDataByIndex</span><span class="p">(</span><span class="n">index</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// todo encoded_array和encoded_annotation结构,不太容易解析
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">case</span> <span class="nl">VALUE_ARRAY</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//getEncodedValue((ubyte*)&amp;index,pValue,readValueSize);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// DexEncodedArray encodedArray;//直接解析貌似不正确
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// getEncodedValue((ubyte*)&amp;encodedArray,pValue,readValueSize);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// printClassDefStaticValues(encodedArray);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// int sizeLen=0;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// u4 size=myReadUnsignedLeb128(pValue,&amp;sizeLen);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// u1* pValues=pValue+sizeLen;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// printf(&#34;EncodedArray contains %d values\n&#34;,size);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// unsigned int offset=0;// offset保存前方已访问的结构大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// for(int i=0;i&lt;size;i++) {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//     printf(&#34;%s\n&#34;,parseEncodedValue(pValues+offset,offset).c_str());
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//system(&#34;pause&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">VALUE_ANNOTATION</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span><span class="o">=</span><span class="s">&#34;Todo......&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">VALUE_NULL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span><span class="o">=</span><span class="s">&#34;null&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// boolean的值存在value_arg中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">case</span> <span class="nl">VALUE_BOOLEAN</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span><span class="o">=</span><span class="s">&#34;bool:&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="n">valueArg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">result</span><span class="o">+=</span><span class="s">&#34;true&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span>
</span></span><span class="line"><span class="cl">                <span class="n">result</span><span class="o">+=</span><span class="s">&#34;false&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span><span class="o">=</span><span class="s">&#34;Unknown value type&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="encoded_array">encoded_array
</h2><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th style="text-align: left">名称</th>
          <th style="text-align: left">格式</th>
          <th style="text-align: left">说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">size</td>
          <td style="text-align: left">uleb128</td>
          <td style="text-align: left">数组中的元素数量</td>
      </tr>
      <tr>
          <td style="text-align: left">values</td>
          <td style="text-align: left">encoded_value[size]</td>
          <td style="text-align: left">采用本部分所指定格式的一系列 <code>size</code> <code>encoded_value</code> 字节序列；依序串联。</td>
      </tr>
  </tbody>
</table></div>
<p>由于encoded_array.values数组元素为encoded_value,所以每个元素的大小不固定,不能当作一般的数组解析</p>
<h2 id="encoded_annotation">encoded_annotation
</h2><p>该类型主要在DexClassDef的Annotations部分使用,此处仅做介绍</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th style="text-align: left">名称</th>
          <th style="text-align: left">格式</th>
          <th style="text-align: left">说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">type_idx</td>
          <td style="text-align: left">uleb128</td>
          <td style="text-align: left">注释的类型。这种类型必须是“类”（而非“数组”或“基元”）。</td>
      </tr>
      <tr>
          <td style="text-align: left">size</td>
          <td style="text-align: left">uleb128</td>
          <td style="text-align: left">此注解中 name-value 映射的数量</td>
      </tr>
      <tr>
          <td style="text-align: left">elements</td>
          <td style="text-align: left">annotation_element[size]</td>
          <td style="text-align: left">注解的元素，直接以内嵌形式（不作为偏移量）表示。元素必须按 <code>string_id</code> 索引以升序进行排序。</td>
      </tr>
  </tbody>
</table></div>
<h2 id="annotation_element">annotation_element
</h2><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th style="text-align: left">名称</th>
          <th style="text-align: left">格式</th>
          <th style="text-align: left">说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">name_idx</td>
          <td style="text-align: left">uleb128</td>
          <td style="text-align: left">元素名称，表示为要编入 <code>string_ids</code> 区段的索引。该字符串必须符合上文定义的 MemberName 的语法。</td>
      </tr>
      <tr>
          <td style="text-align: left">value</td>
          <td style="text-align: left">encoded_value</td>
          <td style="text-align: left">元素值</td>
      </tr>
  </tbody>
</table></div>
<h1 id="dex整体结构">Dex整体结构
</h1><p>dex文件整体结构分为: dex文件头, 索引结构区, data数据区, 示意图如下:</p>
<ol>
<li>
<p>dex文件头</p>
<p>保存了dex文件的基本信息, 例如文件大小,dex头大小,大小端序,索引表的起始地址和大小等</p>
</li>
<li>
<p>索引结构区</p>
<p>这部分保存了字符串表,类型表,方法原型表,域表,方法表等结构</p>
<p>根据这些表和索引可以访问到对应数据</p>
</li>
<li>
<p>data数据区</p>
<p>所有的代码和数据存放在该区域</p>
</li>
</ol>
<p><img src="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/1-dex%E6%96%87%E4%BB%B6%E6%95%B4%E4%BD%93%E7%BB%93%E6%9E%84.png"
	width="603"
	height="553"
	srcset="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/1-dex%E6%96%87%E4%BB%B6%E6%95%B4%E4%BD%93%E7%BB%93%E6%9E%84_hu_8de259537e0d1b9d.png 480w, /p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/1-dex%E6%96%87%E4%BB%B6%E6%95%B4%E4%BD%93%E7%BB%93%E6%9E%84_hu_a3eba4eb819988d7.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="109"
		data-flex-basis="261px"
	
></p>
<p>dex文件结构体的定义在Android源码目录/dalvik/libdex/DexFile.h中可以找到，其中定义的dex文件结构体如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">DexFile</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* directly-mapped &#34;opt&#34; header */</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">DexOptHeader</span><span class="o">*</span> <span class="n">pOptHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* pointers to directly-mapped structs and arrays in base DEX */</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">DexHeader</span><span class="o">*</span>    <span class="n">pHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">DexStringId</span><span class="o">*</span>  <span class="n">pStringIds</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">DexTypeId</span><span class="o">*</span>    <span class="n">pTypeIds</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">DexFieldId</span><span class="o">*</span>   <span class="n">pFieldIds</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">DexMethodId</span><span class="o">*</span>  <span class="n">pMethodIds</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">DexProtoId</span><span class="o">*</span>   <span class="n">pProtoIds</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">DexClassDef</span><span class="o">*</span>  <span class="n">pClassDefs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">DexLink</span><span class="o">*</span>      <span class="n">pLinkData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">     * These are mapped out of the &#34;auxillary&#34; section, and may not be
</span></span></span><span class="line"><span class="cl"><span class="cm">     * included in the file.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">DexClassLookup</span><span class="o">*</span> <span class="n">pClassLookup</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">void</span><span class="o">*</span>         <span class="n">pRegisterMapPool</span><span class="p">;</span>       <span class="c1">// RegisterMapClassPool
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* points to start of DEX file data */</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">u1</span><span class="o">*</span>           <span class="n">baseAddr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* track memory overhead for auxillary structures */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span>                 <span class="n">overhead</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* additional app-specific data structures associated with the DEX */</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//void*               auxData;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>为方便使用仅保留部分字段,编写相关函数如下</p>
<p>通过字节buffer或文件路径创建DexFile类并初始化各个字段</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DexFile</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">u1</span><span class="o">*</span>           <span class="n">baseAddr</span><span class="p">{</span><span class="k">nullptr</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">DexHeader</span><span class="o">*</span>    <span class="n">pHeader</span><span class="p">{</span><span class="k">nullptr</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">DexStringId</span><span class="o">*</span>  <span class="n">pStringIds</span><span class="p">{</span><span class="k">nullptr</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">DexTypeId</span><span class="o">*</span>    <span class="n">pTypeIds</span><span class="p">{</span><span class="k">nullptr</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">DexFieldId</span><span class="o">*</span>   <span class="n">pFieldIds</span><span class="p">{</span><span class="k">nullptr</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">DexMethodId</span><span class="o">*</span>  <span class="n">pMethodIds</span><span class="p">{</span><span class="k">nullptr</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">DexProtoId</span><span class="o">*</span>   <span class="n">pProtoIds</span><span class="p">{</span><span class="k">nullptr</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">DexClassDef</span><span class="o">*</span>  <span class="n">pClassDefs</span><span class="p">{</span><span class="k">nullptr</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">initFields</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Init functions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">initFields</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">buffer</span><span class="o">==</span><span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Null pointer provided!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">baseAddr</span><span class="o">=</span><span class="n">buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pHeader</span><span class="o">=</span><span class="p">(</span><span class="n">DexHeader</span><span class="o">*</span><span class="p">)</span><span class="n">baseAddr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pStringIds</span><span class="o">=</span><span class="p">(</span><span class="n">DexStringId</span><span class="o">*</span><span class="p">)(</span><span class="n">baseAddr</span><span class="o">+</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">stringIdsOff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pTypeIds</span><span class="o">=</span><span class="p">(</span><span class="n">DexTypeId</span><span class="o">*</span><span class="p">)(</span><span class="n">baseAddr</span><span class="o">+</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">typeIdsOff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pFieldIds</span><span class="o">=</span><span class="p">(</span><span class="n">DexFieldId</span><span class="o">*</span><span class="p">)(</span><span class="n">baseAddr</span><span class="o">+</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">fieldIdsOff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pMethodIds</span><span class="o">=</span><span class="p">(</span><span class="n">DexMethodId</span><span class="o">*</span><span class="p">)(</span><span class="n">baseAddr</span><span class="o">+</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">methodIdsOff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pProtoIds</span><span class="o">=</span><span class="p">(</span><span class="n">DexProtoId</span><span class="o">*</span><span class="p">)(</span><span class="n">baseAddr</span><span class="o">+</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">protoIdsOff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pClassDefs</span><span class="o">=</span><span class="p">(</span><span class="n">DexClassDef</span><span class="o">*</span><span class="p">)(</span><span class="n">baseAddr</span><span class="o">+</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">classDefsOff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">DexFile</span><span class="o">::</span><span class="n">DexFile</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">initFields</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">DexFile</span><span class="o">::</span><span class="n">DexFile</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">size_t</span> <span class="n">fileLength</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">initFields</span><span class="p">(</span><span class="n">readFileToBytes</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="n">fileLength</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">DexFile</span><span class="o">::~</span><span class="n">DexFile</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">delete</span> <span class="n">baseAddr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="dex-header">Dex Header
</h1><p>DexHeader定义如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">DexHeader</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">u1</span>  <span class="n">magic</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>			<span class="c1">//Dex版本号 dex.035 .035即为版本号 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">u4</span>  <span class="n">checksum</span><span class="p">;</span>           <span class="c1">//adler32检验,如果修改了Dex文件,需要修正这个值,否则会运行不起来
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">u1</span>  <span class="n">signature</span><span class="p">[</span><span class="n">kSHA1DigestLen</span><span class="p">];</span> <span class="c1">//SHA-1值,Android不检测该值,但如果修改了Dex文件,最好修复该值,再修checksum
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">u4</span>  <span class="n">fileSize</span><span class="p">;</span>           <span class="c1">//整个dex文件的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">u4</span>  <span class="n">headerSize</span><span class="p">;</span>         <span class="c1">//DexHeader结构的大小,固定为0x70
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">u4</span>  <span class="n">endianTag</span><span class="p">;</span>          <span class="c1">//字节序标记,若该字段按小端方式读出来为0x12345678,则整个Dex文件就是小端方式.如果按大端方式读出来为0x12345678,那整个Dex文件就是大端方式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">u4</span>  <span class="n">linkSize</span><span class="p">;</span>			<span class="c1">//链接段大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">u4</span>  <span class="n">linkOff</span><span class="p">;</span>			<span class="c1">//链接段偏移
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">u4</span>  <span class="n">mapOff</span><span class="p">;</span>				<span class="c1">//DexMapList文件偏移
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">u4</span>  <span class="n">stringIdsSize</span><span class="p">;</span>		<span class="c1">//DexStringId个数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">u4</span>  <span class="n">stringIdsOff</span><span class="p">;</span>		<span class="c1">//DexStringId文件偏移
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">u4</span>  <span class="n">typeIdsSize</span><span class="p">;</span>		<span class="c1">//DexTypeId个数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">u4</span>  <span class="n">typeIdsOff</span><span class="p">;</span>			<span class="c1">//DexTypeId文件偏移
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">u4</span>  <span class="n">protoIdsSize</span><span class="p">;</span>		<span class="c1">//DexProtoId个数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">u4</span>  <span class="n">protoIdsOff</span><span class="p">;</span>		<span class="c1">//DexProtoId文件偏移
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">u4</span>  <span class="n">fieldIdsSize</span><span class="p">;</span>		<span class="c1">//DexFieldId个数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">u4</span>  <span class="n">fieldIdsOff</span><span class="p">;</span>		<span class="c1">//DexFieldId文件偏移
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">u4</span>  <span class="n">methodIdsSize</span><span class="p">;</span>		<span class="c1">//DexMethodId个数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">u4</span>  <span class="n">methodIdsOff</span><span class="p">;</span>		<span class="c1">//DexMethodId文件偏移
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">u4</span>  <span class="n">classDefsSize</span><span class="p">;</span>		<span class="c1">//DexClassDef个数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">u4</span>  <span class="n">classDefsOff</span><span class="p">;</span>		<span class="c1">//DexClassDef文件偏移
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">u4</span>  <span class="n">dataSize</span><span class="p">;</span>			<span class="c1">//数据段大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">u4</span>  <span class="n">dataOff</span><span class="p">;</span>			<span class="c1">//数据段文件偏移
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="n">DexHeader</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>打印DexHeader</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">printDexHeader</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;DexHeader:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">magic: &#34;</span><span class="p">);</span><span class="n">printHexBytes</span><span class="p">(</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">));</span><span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">checksum: %#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">checksum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">signature: &#34;</span><span class="p">);</span><span class="n">printHexBytes</span><span class="p">(</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">signature</span><span class="p">,</span><span class="n">kSHA1DigestLen</span><span class="p">);</span><span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">FileSize: %#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">fileSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">HeaderSize: %#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">headerSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">EndianTag: %#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">endianTag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">LinkOff: %#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">linkOff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">LinkSize: %#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">linkSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">MapOff: %#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">mapOff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">StringIDs Offset: %#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">stringIdsOff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">Num of StringIDs: %#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">stringIdsSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">TypeIDs Offset: %#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">typeIdsOff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">Num of TypeIDs: %#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">typeIdsSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">ProtoIDs Offset: %#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">protoIdsOff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">Num of ProtoIDs: %#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">protoIdsSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">FieldIDs Offset: %#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">fieldIdsOff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">Num of FieldIDs: %#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">fieldIdsSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">MethodIDs Offset: %#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">methodIdsOff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">Num of MethodIDs: %#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">methodIdsSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">ClassDefs Offset: %#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">classDefsOff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">Num of ClassDefs: %#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">classDefsSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">Data Offset: %#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">dataOff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">Size of Data: %#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">dataSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;DexHeader End</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>效果如下</p>
<p><img src="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/14-PrintDexHeader.png"
	width="719"
	height="655"
	srcset="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/14-PrintDexHeader_hu_b4d33c544a91033d.png 480w, /p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/14-PrintDexHeader_hu_695a9b65ea1b2570.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="109"
		data-flex-basis="263px"
	
></p>
<h1 id="dex-string-id">Dex String ID
</h1><p>定义如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">DexStringId</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span> <span class="n">stringDataOff</span><span class="p">;</span>      <span class="cm">/* 字符串的文件偏移量 */</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//伪结构表示如下:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">string_data_item</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="n">uleb128</span> <span class="n">utf16_size</span><span class="p">;</span> <span class="c1">//字符串长度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="n">ubyte</span><span class="p">[]</span> <span class="n">data</span><span class="p">;</span>       <span class="c1">//字符串数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意dex文件的字符串采用MUTF-8编码,与UTF-8区别如下:</p>
<ol>
<li>MUTF-8使用1~3字节编码</li>
<li>大于16位的Unicode编码U+10000~U+10ffff使用3字节编码</li>
<li>U+000采用2字节编码</li>
<li>以0x00空字符作为字符串结尾</li>
</ol>
<p>MUTF-8字符串头部保存的是字符串长度,是uleb128类型</p>
<p><img src="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/2-DexString.png"
	width="1525"
	height="297"
	srcset="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/2-DexString_hu_2dd7b1ed9e929ac3.png 480w, /p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/2-DexString_hu_ad9e568b5261a041.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="513"
		data-flex-basis="1232px"
	
></p>
<p>相关函数定义如下,解析StringId</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// StringId functions
</span></span></span><span class="line"><span class="cl"><span class="c1">// 通过索引获取对应StringId
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">DexStringId</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">getStringIdByIndex</span><span class="p">(</span><span class="n">u4</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">checkIndexIsLegal</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">stringIdsSize</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">pStringIds</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;No such index: %x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 解析StringId 获取字符串长度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">size_t</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">getStringDataLength</span><span class="p">(</span><span class="n">DexStringId</span><span class="o">&amp;</span> <span class="n">stringId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">u1</span><span class="o">*</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">stringId</span><span class="p">.</span><span class="n">stringDataOff</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">size_t</span> <span class="n">size</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">myReadUnsignedLeb128</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 解析StringId 获取字符串
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">getStringIdData</span><span class="p">(</span><span class="k">const</span> <span class="n">DexStringId</span><span class="o">&amp;</span> <span class="n">stringId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">u1</span><span class="o">*</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">stringId</span><span class="p">.</span><span class="n">stringDataOff</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">++</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x7f</span><span class="p">);</span><span class="c1">// Skip the uleb128 length.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 通过索引获取StringId的字符串
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">getStringIdDataByIndex</span><span class="p">(</span><span class="n">u4</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">checkIndexIsLegal</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">stringIdsSize</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">getStringIdData</span><span class="p">(</span><span class="n">pStringIds</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>打印所有StringId,没有做MUTF编码处理,直接打印ASCII字符串</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">printStringIds</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;StringIds:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">Nums</span><span class="se">\t\t</span><span class="s">Strings</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">stringIdsSize</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%08x</span><span class="se">\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">getStringIdDataByIndex</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;StringIds End</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>效果如下,没有做编码处理故可能出现乱码</p>
<p><img src="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/12-PrintStringIds.png"
	width="616"
	height="555"
	srcset="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/12-PrintStringIds_hu_c81ef4b468147981.png 480w, /p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/12-PrintStringIds_hu_d01a3615b971ee89.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="110"
		data-flex-basis="266px"
	
></p>
<h1 id="dex-type-id">Dex Type ID
</h1><p>定义如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">DexTypeId</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span>  <span class="n">descriptorIdx</span><span class="p">;</span>     <span class="c1">//指向DexStringId列表的索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="n">DexTypeId</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>descriptorIdx为DexStringID表的索引,对应字符串表示类的类型</p>
<p>例如此处DexTypeID[3].descriptorIdx=6, 而DexStringID[6]对应的字符串为&quot;Ljava/lang/String;&quot;</p>
<p><img src="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/3-DexType.png"
	width="826"
	height="682"
	srcset="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/3-DexType_hu_b602aabe7411fb9a.png 480w, /p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/3-DexType_hu_585097ec9d9af47c.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="121"
		data-flex-basis="290px"
	
></p>
<p>和StringId类似,TypeId的解析代码如下,通过索引获取StringId及其对应的字符串</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// TypeId functions
</span></span></span><span class="line"><span class="cl"><span class="c1">// 通过索引获取对应TypeId
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">DexTypeId</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">getTypeIdByIndex</span><span class="p">(</span><span class="n">u4</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">checkIndexIsLegal</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">typeIdsSize</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">pTypeIds</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;No such index: %x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 通过索引获取TypeId对应的字符串
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">getTypeIdDataByIndex</span><span class="p">(</span><span class="n">u4</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">checkIndexIsLegal</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">typeIdsSize</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">getStringIdDataByIndex</span><span class="p">(</span><span class="n">pTypeIds</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">descriptorIdx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>打印所有TypeId</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">printTypeIds</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;TypeIds:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">Nums</span><span class="se">\t\t</span><span class="s">TypeIds</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">typeIdsSize</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%08x</span><span class="se">\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">getTypeIdDataByIndex</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;TypeIds End</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>效果如下</p>
<p><img src="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/13-PrintTypeIds.png"
	width="736"
	height="520"
	srcset="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/13-PrintTypeIds_hu_98884977a905deb.png 480w, /p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/13-PrintTypeIds_hu_ecb14df42f48a3e8.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="141"
		data-flex-basis="339px"
	
></p>
<h1 id="dex-proto-id">Dex Proto ID
</h1><p>DexProtoId是**方法声明（方法签名）**的结构体,保存方法(函数)的返回值类型和参数类型列表,没有函数名,定义如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">DexProtoId</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span>  <span class="n">shortyIdx</span><span class="p">;</span>          <span class="c1">//方法声明字符串,指向DexStringId列表的索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">u4</span>  <span class="n">returnTypeIdx</span><span class="p">;</span>      <span class="c1">//方法返回类型字符串,指向DexTypeId列表的索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">u4</span>  <span class="n">parametersOff</span><span class="p">;</span>      <span class="c1">//方法的参数列表,指向DexTypeList列表的索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="n">DexProtoId</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>parametersOff是DexTypeList的文件偏移</p>
<h2 id="dextypelist">DexTypeList
</h2><p>结构定义如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">DexTypeList</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span>  <span class="n">size</span><span class="p">;</span>               <span class="c1">//DexTypeItem个数, 即参数个数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DexTypeItem</span> <span class="n">list</span><span class="p">[</span><span class="n">size</span><span class="p">];</span> <span class="c1">//DexTypeItem数组, 按从左到右的顺序保存了方法的参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="n">DexTypeList</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">DexTypeItem</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">u2</span>  <span class="n">typeIdx</span><span class="p">;</span>           <span class="c1">//指向DexTypeId列表的索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="n">DexTypeItem</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>例如此处DexProtoID[1]</p>
<p>方法声明 DexStringID[shortyIdx]=&ldquo;VL&rdquo;</p>
<p>返回类型 DexStringID[DexTypeID[returnTypeIdx]]=&ldquo;V&rdquo;</p>
<p>参数列表 DexStringID[DexTypeID[typeIdx]]=&ldquo;Ljava/lang/String;&rdquo;</p>
<p><img src="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/4-DexProto.png"
	width="839"
	height="681"
	srcset="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/4-DexProto_hu_a0d3b534b3cab22.png 480w, /p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/4-DexProto_hu_2c34ddd53faecf61.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="123"
		data-flex-basis="295px"
	
></p>
<p>解析代码如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// ProtoId functions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">const</span> <span class="n">DexProtoId</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">getProtoIdByIndex</span><span class="p">(</span><span class="n">u4</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">checkIndexIsLegal</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">protoIdsSize</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">pProtoIds</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">illegalIndex</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">getProtoIdShorty</span><span class="p">(</span><span class="k">const</span> <span class="n">DexProtoId</span><span class="o">&amp;</span> <span class="n">protoId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">getStringIdDataByIndex</span><span class="p">(</span><span class="n">protoId</span><span class="p">.</span><span class="n">shortyIdx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">getProtoIdReturnType</span><span class="p">(</span><span class="k">const</span> <span class="n">DexProtoId</span><span class="o">&amp;</span> <span class="n">protoId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">getTypeIdDataByIndex</span><span class="p">(</span><span class="n">protoId</span><span class="p">.</span><span class="n">returnTypeIdx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 获取ProtoId的参数列表,解析TypeList结构
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">getProtoIdParameters</span><span class="p">(</span><span class="k">const</span> <span class="n">DexProtoId</span><span class="o">&amp;</span> <span class="n">protoId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">parameters</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//无参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">protoId</span><span class="p">.</span><span class="n">parametersOff</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">parameters</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//解析TypeList结构 获取参数列表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DexTypeList</span><span class="o">*</span> <span class="n">typeList</span><span class="o">=</span><span class="p">(</span><span class="n">DexTypeList</span><span class="o">*</span><span class="p">)(</span><span class="n">baseAddr</span><span class="o">+</span><span class="n">protoId</span><span class="p">.</span><span class="n">parametersOff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">typeList</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">parameters</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">getTypeIdDataByIndex</span><span class="p">(</span><span class="n">typeList</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">typeIdx</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">parameters</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 解析DexProtoId结构体 返回解析后的字符串
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">parseProtoId</span><span class="p">(</span><span class="k">const</span> <span class="n">DexProtoId</span><span class="o">&amp;</span> <span class="n">protoId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">shorty</span><span class="o">=</span><span class="n">getProtoIdShorty</span><span class="p">(</span><span class="n">protoId</span><span class="p">);</span><span class="c1">//c++的string类型会自动遍历const char*字符串并复制
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">return_type</span> <span class="o">=</span> <span class="n">getProtoIdReturnType</span><span class="p">(</span><span class="n">protoId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">parameters</span><span class="o">=</span><span class="n">getProtoIdParameters</span><span class="p">(</span><span class="n">protoId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span><span class="o">+=</span><span class="n">parseString</span><span class="p">(</span><span class="n">return_type</span><span class="p">)</span><span class="o">+</span><span class="s">&#34; (&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//解析参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">parameters</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span><span class="o">+=</span><span class="n">parseString</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">!=</span><span class="n">parameters</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="c1">//多个参数以,分隔
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">result</span><span class="o">+=</span><span class="s">&#34;,&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span><span class="o">+=</span><span class="s">&#34;)&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 通过索引解析ProtoId,返回解析后的对应字符串
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">getProtoIdDataByIndex</span><span class="p">(</span><span class="n">u4</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">checkIndexIsLegal</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">protoIdsSize</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">parseProtoId</span><span class="p">(</span><span class="n">getProtoIdByIndex</span><span class="p">(</span><span class="n">index</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>打印所有ProtoId</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">printProtoIds</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;ProtoIds:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">Nums</span><span class="se">\t\t</span><span class="s">ProtoIds</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">protoIdsSize</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%08x</span><span class="se">\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">getProtoIdDataByIndex</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;ProtoIds End</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>效果如下</p>
<p><img src="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/9-PrintProtoIds.png"
	width="675"
	height="786"
	srcset="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/9-PrintProtoIds_hu_7124218c39231518.png 480w, /p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/9-PrintProtoIds_hu_1462b4155b0f636f.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="85"
		data-flex-basis="206px"
	
></p>
<h1 id="dex-field-id">Dex Field ID
</h1><p>DexFieldID结构体指明了成员变量所在的类,类型以及变量名</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">DexFieldId</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">u2</span>  <span class="n">classIdx</span><span class="p">;</span>           <span class="c1">//类的类型,指向DexTypeId列表的索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">u2</span>  <span class="n">typeIdx</span><span class="p">;</span>            <span class="c1">//字段类型,指向DexTypeId列表的索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">u4</span>  <span class="n">nameIdx</span><span class="p">;</span>            <span class="c1">//字段名,指向DexStringId列表的索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="n">DexFieldId</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>寻找方法类似,out是java.lang.System类的成员,类型为java.io.PrintStream</p>
<p><img src="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/5-DexField.png"
	width="849"
	height="677"
	srcset="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/5-DexField_hu_74a06f9d4c3f21e2.png 480w, /p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/5-DexField_hu_54a1beac8c201cdd.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="125"
		data-flex-basis="300px"
	
></p>
<p>解析代码如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// FieldId functions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">const</span> <span class="n">DexFieldId</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">getFieldIdByIndex</span><span class="p">(</span><span class="n">u4</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">checkIndexIsLegal</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">fieldIdsSize</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">pFieldIds</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">illegalIndex</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 获取FieldId所在类类名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">getFieldIdClass</span><span class="p">(</span><span class="k">const</span> <span class="n">DexFieldId</span><span class="o">&amp;</span> <span class="n">fieldId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">getTypeIdDataByIndex</span><span class="p">(</span><span class="n">fieldId</span><span class="p">.</span><span class="n">classIdx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 获取FieldId类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">getFieldIdType</span><span class="p">(</span><span class="k">const</span> <span class="n">DexFieldId</span><span class="o">&amp;</span> <span class="n">fieldId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">getTypeIdDataByIndex</span><span class="p">(</span><span class="n">fieldId</span><span class="p">.</span><span class="n">typeIdx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 获取FieldId名称
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">getFieldIdName</span><span class="p">(</span><span class="k">const</span> <span class="n">DexFieldId</span><span class="o">&amp;</span> <span class="n">fieldId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">getStringIdDataByIndex</span><span class="p">(</span><span class="n">fieldId</span><span class="p">.</span><span class="n">nameIdx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 解析DexFieldId结构,字段所在类,类型,名称
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">parseFieldId</span><span class="p">(</span><span class="k">const</span> <span class="n">DexFieldId</span><span class="o">&amp;</span> <span class="n">fieldId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">fieldClass</span><span class="o">=</span><span class="n">getFieldIdClass</span><span class="p">(</span><span class="n">fieldId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">fieldType</span><span class="o">=</span><span class="n">getFieldIdType</span><span class="p">(</span><span class="n">fieldId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">fieldName</span><span class="o">=</span><span class="n">getFieldIdName</span><span class="p">(</span><span class="n">fieldId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">parseString</span><span class="p">(</span><span class="n">fieldType</span><span class="p">)</span><span class="o">+</span><span class="s">&#34; &#34;</span><span class="o">+</span><span class="n">parseString</span><span class="p">(</span><span class="n">fieldClass</span><span class="p">)</span><span class="o">+</span><span class="s">&#34;.&#34;</span><span class="o">+</span><span class="n">fieldName</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 通过索引获取FieldId对应的字符串
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">getFieldIdDataByIndex</span><span class="p">(</span><span class="n">u4</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">checkIndexIsLegal</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">fieldIdsSize</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">parseFieldId</span><span class="p">(</span><span class="n">getFieldIdByIndex</span><span class="p">(</span><span class="n">index</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>打印所有ProtoId</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">printFieldIds</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;FieldIds:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">Nums</span><span class="se">\t\t</span><span class="s">FieldIds</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">fieldIdsSize</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%08x</span><span class="se">\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">getFieldIdDataByIndex</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;FieldId End</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>效果如下</p>
<p><img src="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/10-PrintFieldIds.png"
	width="1010"
	height="505"
	srcset="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/10-PrintFieldIds_hu_94c08afbd7aca01c.png 480w, /p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/10-PrintFieldIds_hu_bf0ad38cbcf6fcae.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="200"
		data-flex-basis="480px"
	
></p>
<h1 id="dex-method-id">Dex Method ID
</h1><p>DexMethodId结构体指明了方法所在的类、方法声明（签名）以及方法名, 即完整的方法声明</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">DexMethodId</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">u2</span>  <span class="n">classIdx</span><span class="p">;</span>           <span class="cm">/* 方法的所属的类，指向DexTypeId列表的索引 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">u2</span>  <span class="n">protoIdx</span><span class="p">;</span>           <span class="cm">/* 声明类型，指向DexProtoId列表的索引 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span>  <span class="n">nameIdx</span><span class="p">;</span>            <span class="cm">/* 方法名，指向DexStringId列表的索引 */</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>寻找方法</p>
<p><img src="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/6-DexMethod.png"
	width="848"
	height="670"
	srcset="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/6-DexMethod_hu_90b2c359600692ef.png 480w, /p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/6-DexMethod_hu_cea32c166b51bcbf.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="126"
		data-flex-basis="303px"
	
></p>
<p>对应解析代码如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// MethodId functions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">const</span> <span class="n">DexMethodId</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">getMethodIdByIndex</span><span class="p">(</span><span class="n">u4</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">checkIndexIsLegal</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">methodIdsSize</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">pMethodIds</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">illegalIndex</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 获取MethodId所在类名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">getMethodIdClass</span><span class="p">(</span><span class="k">const</span> <span class="n">DexMethodId</span><span class="o">&amp;</span> <span class="n">methodId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">getTypeIdDataByIndex</span><span class="p">(</span><span class="n">methodId</span><span class="p">.</span><span class="n">classIdx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 获取MethodId对应方法签名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">getMethodIdProto</span><span class="p">(</span><span class="k">const</span> <span class="n">DexMethodId</span><span class="o">&amp;</span> <span class="n">methodId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">getProtoIdDataByIndex</span><span class="p">(</span><span class="n">methodId</span><span class="p">.</span><span class="n">protoIdx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 获取MethodId对应方法名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">getMethodIdName</span><span class="p">(</span><span class="k">const</span> <span class="n">DexMethodId</span><span class="o">&amp;</span> <span class="n">methodId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">getStringIdDataByIndex</span><span class="p">(</span><span class="n">methodId</span><span class="p">.</span><span class="n">nameIdx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 解析DexMethodId结构
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">parseMethodId</span><span class="p">(</span><span class="k">const</span> <span class="n">DexMethodId</span><span class="o">&amp;</span> <span class="n">methodId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">methodProto</span><span class="o">=</span><span class="n">getMethodIdProto</span><span class="p">(</span><span class="n">methodId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//解析class并拼接name
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">methodFullName</span><span class="o">=</span><span class="n">parseString</span><span class="p">(</span><span class="n">getMethodIdClass</span><span class="p">(</span><span class="n">methodId</span><span class="p">))</span><span class="o">+</span><span class="n">getMethodIdName</span><span class="p">(</span><span class="n">methodId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//拼接proto和class.name
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">methodProto</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">methodProto</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="sc">&#39; &#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">methodFullName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 通过索引获取MethodId对应字符串
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">getMethodIdDataByIndex</span><span class="p">(</span><span class="n">u4</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">checkIndexIsLegal</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">methodIdsSize</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">parseMethodId</span><span class="p">(</span><span class="n">getMethodIdByIndex</span><span class="p">(</span><span class="n">index</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>打印所有MethodId</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">printMethodIds</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;MethodIds:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">Nums</span><span class="se">\t\t</span><span class="s">MethodIds</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">methodIdsSize</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%08x</span><span class="se">\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">getMethodIdDataByIndex</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;MethodIds End</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>效果如下</p>
<p><img src="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/11-PrintMethodIds.png"
	width="1106"
	height="531"
	srcset="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/11-PrintMethodIds_hu_1de8141f6c8922bc.png 480w, /p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/11-PrintMethodIds_hu_4aca01eee6f597eb.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="208"
		data-flex-basis="499px"
	
></p>
<h1 id="dex-map-list">Dex Map List
</h1><p>Dalvik虚拟机解析dex文件后,映射为DexMapList的数据结构, 该结构由DexHeader.mapOff指明位置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">DexMapList</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span>  <span class="n">size</span><span class="p">;</span>               <span class="cm">/* DexMapItem个数 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">DexMapItem</span> <span class="n">list</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>     <span class="cm">/* DexMapItem数组 */</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">DexMapItem</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">u2</span> <span class="n">type</span><span class="p">;</span>              <span class="cm">/* KDexType开头的类型 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">u2</span> <span class="n">unused</span><span class="p">;</span>			  <span class="cm">/* 未使用，用于字节对齐 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span> <span class="n">size</span><span class="p">;</span>              <span class="cm">/* 类型的个数 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span> <span class="n">offset</span><span class="p">;</span>            <span class="cm">/* 类型数据的文件偏移 */</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>type是枚举常量,用于判断类型</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* map item type codes */</span>
</span></span><span class="line"><span class="cl"><span class="k">enum</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">kDexTypeHeaderItem</span>               <span class="o">=</span> <span class="mh">0x0000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">kDexTypeStringIdItem</span>             <span class="o">=</span> <span class="mh">0x0001</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">kDexTypeTypeIdItem</span>               <span class="o">=</span> <span class="mh">0x0002</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">kDexTypeProtoIdItem</span>              <span class="o">=</span> <span class="mh">0x0003</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">kDexTypeFieldIdItem</span>              <span class="o">=</span> <span class="mh">0x0004</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">kDexTypeMethodIdItem</span>             <span class="o">=</span> <span class="mh">0x0005</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">kDexTypeClassDefItem</span>             <span class="o">=</span> <span class="mh">0x0006</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">kDexTypeCallSiteIdItem</span>           <span class="o">=</span> <span class="mh">0x0007</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">kDexTypeMethodHandleItem</span>         <span class="o">=</span> <span class="mh">0x0008</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">kDexTypeMapList</span>                  <span class="o">=</span> <span class="mh">0x1000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">kDexTypeTypeList</span>                 <span class="o">=</span> <span class="mh">0x1001</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">kDexTypeAnnotationSetRefList</span>     <span class="o">=</span> <span class="mh">0x1002</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">kDexTypeAnnotationSetItem</span>        <span class="o">=</span> <span class="mh">0x1003</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">kDexTypeClassDataItem</span>            <span class="o">=</span> <span class="mh">0x2000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">kDexTypeCodeItem</span>                 <span class="o">=</span> <span class="mh">0x2001</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">kDexTypeStringDataItem</span>           <span class="o">=</span> <span class="mh">0x2002</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">kDexTypeDebugInfoItem</span>            <span class="o">=</span> <span class="mh">0x2003</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">kDexTypeAnnotationItem</span>           <span class="o">=</span> <span class="mh">0x2004</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">kDexTypeEncodedArrayItem</span>         <span class="o">=</span> <span class="mh">0x2005</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">kDexTypeAnnotationsDirectoryItem</span> <span class="o">=</span> <span class="mh">0x2006</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>size指定了类型个数,在dex文件中连续存放, offset是起始地址文件偏移</p>
<p>例如DexMapList[1] type=string_id_item, size=0xF, offset=0x70</p>
<p>和DexStringID表正好对应,起始地址,表项数</p>
<p><img src="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/7-DexMapList.png"
	width="1764"
	height="912"
	srcset="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/7-DexMapList_hu_8d2f984ad6b72b2a.png 480w, /p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/7-DexMapList_hu_e7d8ee928834deb1.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="193"
		data-flex-basis="464px"
	
></p>
<p>解析代码如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">printMapList</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">MapItemTypeToStringMap</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">kDexTypeHeaderItem</span><span class="p">,</span> <span class="s">&#34;HeaderItem&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">kDexTypeStringIdItem</span><span class="p">,</span> <span class="s">&#34;StringIdItem&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">kDexTypeTypeIdItem</span><span class="p">,</span> <span class="s">&#34;TypeIdItem&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">kDexTypeProtoIdItem</span><span class="p">,</span> <span class="s">&#34;ProtoIdItem&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">kDexTypeFieldIdItem</span><span class="p">,</span> <span class="s">&#34;FieldIdItem&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">kDexTypeMethodIdItem</span><span class="p">,</span> <span class="s">&#34;MethodIdItem&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">kDexTypeClassDefItem</span><span class="p">,</span> <span class="s">&#34;ClassDefItem&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">kDexTypeMapList</span><span class="p">,</span> <span class="s">&#34;MapList&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">kDexTypeTypeList</span><span class="p">,</span> <span class="s">&#34;TypeList&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">kDexTypeAnnotationSetRefList</span><span class="p">,</span> <span class="s">&#34;AnnotationSetRefList&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">kDexTypeAnnotationSetItem</span><span class="p">,</span> <span class="s">&#34;AnnotationSetItem&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">kDexTypeClassDataItem</span><span class="p">,</span> <span class="s">&#34;ClassDataItem&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">kDexTypeCodeItem</span><span class="p">,</span> <span class="s">&#34;CodeItem&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">kDexTypeStringDataItem</span><span class="p">,</span> <span class="s">&#34;StringDataItem&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">kDexTypeDebugInfoItem</span><span class="p">,</span> <span class="s">&#34;DebugInfoItem&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">kDexTypeAnnotationItem</span><span class="p">,</span> <span class="s">&#34;AnnotationItem&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">kDexTypeEncodedArrayItem</span><span class="p">,</span> <span class="s">&#34;EncodedArrayItem&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">kDexTypeAnnotationsDirectoryItem</span><span class="p">,</span> <span class="s">&#34;AnnotationsDirectoryItem&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">DexMapList</span><span class="o">*</span> <span class="n">pMapList</span><span class="o">=</span><span class="p">(</span><span class="n">DexMapList</span><span class="o">*</span><span class="p">)(</span><span class="n">baseAddr</span><span class="o">+</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">mapOff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">DexMapItem</span><span class="o">*</span> <span class="n">pMapItems</span><span class="o">=</span><span class="n">pMapList</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;MapList has %d items, start at: %#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">pMapList</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">mapOff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Nums</span><span class="se">\t\t</span><span class="s">Type</span><span class="se">\t\t\t\t</span><span class="s">ItemNums</span><span class="se">\t</span><span class="s">StartOff</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">pMapList</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 解析MapType
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">auto</span> <span class="n">it</span><span class="o">=</span><span class="n">MapItemTypeToStringMap</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">pMapItems</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">mapType</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">it</span><span class="o">!=</span> <span class="n">MapItemTypeToStringMap</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="n">mapType</span><span class="o">=</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="n">mapType</span><span class="o">=</span><span class="s">&#34;Unknown Type&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%08d</span><span class="se">\t</span><span class="s">%-24s</span><span class="se">\t</span><span class="s">%08d</span><span class="se">\t</span><span class="s">%08x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">mapType</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="n">pMapItems</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">,</span><span class="n">pMapItems</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;MapList End</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>打印效果如下</p>
<p><img src="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/15-PrintMapList.png"
	width="675"
	height="549"
	srcset="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/15-PrintMapList_hu_719543717e958b2d.png 480w, /p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/15-PrintMapList_hu_6b2a3f081d02af8e.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="122"
		data-flex-basis="295px"
	
></p>
<h1 id="dex-class-def">Dex Class Def
</h1><p>该结构较为复杂(这部分相关代码比前文所有结构代码之和都大)</p>
<p>有了对Dex文件的基本了解和上面各个结构的基础,才能解析该结构</p>
<p>DexClassDef保存了类的相关信息,定义如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">DexClassDef</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span>  <span class="n">classIdx</span><span class="p">;</span>           <span class="cm">/* 类的类型（即全限定类名），指向DexTypeId列表的索引 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span>  <span class="n">accessFlags</span><span class="p">;</span>		<span class="cm">/* 访问标志，以ACC_开头的枚举值，如ACC_PUBLIC（0x1）、ACC_PRIVATE（0x2）*/</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span>  <span class="n">superclassIdx</span><span class="p">;</span>      <span class="cm">/* 父类类型，指向DexTypeId列表的索引*/</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span>  <span class="n">interfacesOff</span><span class="p">;</span>      <span class="cm">/* 接口，指向DexTypeList的文件偏移，如果类中不含有接口声明和实现，则值为0 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span>  <span class="n">sourceFileIdx</span><span class="p">;</span>      <span class="cm">/* 类所在源文件的文件名，指向DexStringId列表的索引 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span>  <span class="n">annotationsOff</span><span class="p">;</span>     <span class="cm">/* 注解，指向DexAnnotationsDirectoryItem结构体，根据类型不同会有注解类、注解方法、注解字段与注解参数，如果类中没有注解，则值为0 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span>  <span class="n">classDataOff</span><span class="p">;</span>       <span class="cm">/* 指向DexClassData结构的文件偏移，DexClassData结构是类的数据部分 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span>  <span class="n">staticValuesOff</span><span class="p">;</span>    <span class="cm">/* 指向DexEncodedArray结构的文件偏移，记录类中的静态数据, 没有则为0 */</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>解析代码如下</p>
<p>将ClassDef结构划分为4部分解析: BasicInfo, Annotations, ClassData, StaticValues, 从classIdx到sourceFileIx属于BasicInfo</p>
<p>每部分使用单独的打印函数进行处理</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// 打印所有ClassDef信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">printClassDefs</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;ClassDefs:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">classDefsSize</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">DexClassDef</span> <span class="n">classDef</span><span class="o">=</span><span class="n">pClassDefs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 1.Basic info
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;=========================ClassDef %08d=========================</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">printClassDefBasicInfo</span><span class="p">(</span><span class="n">classDef</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2. Annotations
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="p">(</span><span class="n">classDef</span><span class="p">.</span><span class="n">annotationsOff</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Annotations:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">printClassDefAnnotations</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">DexAnnotationsDirectoryItem</span><span class="o">*</span><span class="p">)(</span><span class="n">baseAddr</span><span class="o">+</span><span class="n">classDef</span><span class="p">.</span><span class="n">annotationsOff</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 值传递只保留前16字节导致内存访问错,需要引用传递
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// DexAnnotationsDirectoryItem annotations_directory_item=*(DexAnnotationsDirectoryItem*)(baseAddr+classDef.annotationsOff);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// parseClassDefAnnotations(annotations_directory_item);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;No Annotations</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 3. ClassData
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="p">(</span><span class="n">classDef</span><span class="p">.</span><span class="n">classDataOff</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">printClassDefClassData</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">DexClassData</span><span class="o">*</span><span class="p">)(</span><span class="n">baseAddr</span><span class="o">+</span><span class="n">classDef</span><span class="p">.</span><span class="n">classDataOff</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span><span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;No ClassData</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 4. StaticValues
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="p">(</span><span class="n">classDef</span><span class="p">.</span><span class="n">staticValuesOff</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">printClassDefStaticValues</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">DexEncodedArray</span><span class="o">*</span><span class="p">)(</span><span class="n">baseAddr</span><span class="o">+</span><span class="n">classDef</span><span class="p">.</span><span class="n">staticValuesOff</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span><span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;No StaticValues</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;===================================================================</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;ClassDefs End</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="classdefbasicinfo">ClassDefBasicInfo
</h2><p>代码如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// ClassDef Basic Info functions
</span></span></span><span class="line"><span class="cl"><span class="c1">// 获取class
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">getClassDefClass</span><span class="p">(</span><span class="n">DexClassDef</span><span class="o">&amp;</span> <span class="n">classDef</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">parseString</span><span class="p">(</span><span class="n">getTypeIdDataByIndex</span><span class="p">(</span><span class="n">classDef</span><span class="p">.</span><span class="n">classIdx</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 解析权限修饰符
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">parseAccessFlags</span><span class="p">(</span><span class="n">u4</span> <span class="n">accessFlags</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">AccessFlagMap</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">ACC_PUBLIC</span><span class="p">,</span> <span class="s">&#34;public&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">ACC_PRIVATE</span><span class="p">,</span> <span class="s">&#34;private&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">ACC_PROTECTED</span><span class="p">,</span> <span class="s">&#34;protected&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">ACC_STATIC</span><span class="p">,</span> <span class="s">&#34;static&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">ACC_FINAL</span><span class="p">,</span> <span class="s">&#34;final&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">ACC_SYNCHRONIZED</span><span class="p">,</span> <span class="s">&#34;synchronized&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">ACC_SUPER</span><span class="p">,</span> <span class="s">&#34;super&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">ACC_VOLATILE</span><span class="p">,</span> <span class="s">&#34;volatile&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">ACC_BRIDGE</span><span class="p">,</span> <span class="s">&#34;bridge&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">ACC_TRANSIENT</span><span class="p">,</span> <span class="s">&#34;transient&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">ACC_VARARGS</span><span class="p">,</span> <span class="s">&#34;varargs&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">ACC_NATIVE</span><span class="p">,</span> <span class="s">&#34;native&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">ACC_INTERFACE</span><span class="p">,</span> <span class="s">&#34;interface&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">ACC_ABSTRACT</span><span class="p">,</span> <span class="s">&#34;abstract&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">ACC_STRICT</span><span class="p">,</span> <span class="s">&#34;strict&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">ACC_SYNTHETIC</span><span class="p">,</span> <span class="s">&#34;synthetic&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">ACC_ANNOTATION</span><span class="p">,</span> <span class="s">&#34;annotation&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">ACC_ENUM</span><span class="p">,</span> <span class="s">&#34;enum&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">ACC_CONSTRUCTOR</span><span class="p">,</span> <span class="s">&#34;constructor&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="n">ACC_DECLARED_SYNCHRONIZED</span><span class="p">,</span> <span class="s">&#34;declared_synchronized&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">32</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">accessFlags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span><span class="o">+=</span><span class="n">AccessFlagMap</span><span class="p">[</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s">&#34; &#34;</span><span class="p">;</span><span class="c1">//遍历添加权限控制属性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">result</span><span class="p">.</span><span class="n">length</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span><span class="c1">//去除末尾多余空格
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 获取父类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">getClassDefSuperClass</span><span class="p">(</span><span class="n">DexClassDef</span><span class="o">&amp;</span> <span class="n">classDef</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">parseString</span><span class="p">(</span><span class="n">getTypeIdDataByIndex</span><span class="p">(</span><span class="n">classDef</span><span class="p">.</span><span class="n">superclassIdx</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 获取接口列表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">getClassDefInterfaces</span><span class="p">(</span><span class="n">DexClassDef</span><span class="o">&amp;</span> <span class="n">classDef</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">interfaces</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//无参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">classDef</span><span class="p">.</span><span class="n">interfacesOff</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">interfaces</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">DexTypeList</span><span class="o">*</span> <span class="n">typeList</span><span class="o">=</span><span class="p">(</span><span class="n">DexTypeList</span><span class="o">*</span><span class="p">)(</span><span class="n">baseAddr</span><span class="o">+</span><span class="n">classDef</span><span class="p">.</span><span class="n">interfacesOff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">typeList</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">interfaces</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">getTypeIdDataByIndex</span><span class="p">(</span><span class="n">typeList</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">typeIdx</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">interfaces</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 获取源文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">getClassDefSourceFile</span><span class="p">(</span><span class="n">DexClassDef</span><span class="o">&amp;</span> <span class="n">classDef</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">getStringIdDataByIndex</span><span class="p">(</span><span class="n">classDef</span><span class="p">.</span><span class="n">sourceFileIdx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 打印ClassDef结构的基本信息: 类名 父类 源文件名 接口
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">printClassDefBasicInfo</span><span class="p">(</span><span class="n">DexClassDef</span><span class="o">&amp;</span> <span class="n">classDef</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">className</span><span class="o">=</span><span class="n">getClassDefClass</span><span class="p">(</span><span class="n">classDef</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">accessFlags</span><span class="o">=</span><span class="n">parseAccessFlags</span><span class="p">(</span><span class="n">classDef</span><span class="p">.</span><span class="n">accessFlags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">superClass</span><span class="o">=</span><span class="n">getClassDefSuperClass</span><span class="p">(</span><span class="n">classDef</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">interfaces</span><span class="o">=</span><span class="n">getClassDefInterfaces</span><span class="p">(</span><span class="n">classDef</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">sourceFile</span><span class="o">=</span><span class="n">getClassDefSourceFile</span><span class="p">(</span><span class="n">classDef</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Basic info, class super_class source_file interfaces
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Class:</span><span class="se">\t\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">combineAccFlagsAndName</span><span class="p">(</span><span class="n">accessFlags</span><span class="p">,</span><span class="n">className</span><span class="p">).</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Super Class:</span><span class="se">\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">superClass</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Source File:</span><span class="se">\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">sourceFile</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// print interfaces if have it
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">interfaces</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Interfaces:</span><span class="se">\n</span><span class="s">Nums</span><span class="se">\t\t</span><span class="s">Interface</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">interfaces</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%08d</span><span class="se">\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">parseString</span><span class="p">(</span><span class="n">interfaces</span><span class="p">[</span><span class="n">j</span><span class="p">]).</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;No Interfaces</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>效果如下</p>
<p><img src="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/16-PrintClassDefBasicInfo.png"
	width="690"
	height="229"
	srcset="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/16-PrintClassDefBasicInfo_hu_f33d50274d040303.png 480w, /p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/16-PrintClassDefBasicInfo_hu_5f8cd6110efc9f85.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="301"
		data-flex-basis="723px"
	
></p>
<h2 id="dexannotationsdirectoryitem">DexAnnotationsDirectoryItem
</h2><p>annotationsOff指向该结构,用于指向类的所有注解,定义如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">DexAnnotationsDirectoryItem</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span>  <span class="n">classAnnotationsOff</span><span class="p">;</span>  <span class="cm">/* 类注解，值为DexAnnotationSetItem的文件偏移量, 为0表示不存在*/</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span>  <span class="n">fieldsSize</span><span class="p">;</span>           <span class="cm">/* 域注解，值为DexFieldAnnotationsItem的数量 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span>  <span class="n">methodsSize</span><span class="p">;</span>          <span class="cm">/* 方法注解，值为DexMethodAnnotationsItem的数量 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span>  <span class="n">parametersSize</span><span class="p">;</span>       <span class="cm">/* 参数注解。值为DexParameterAnnotationsItem的数量 */</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* 后3结构中存在1个或多个，则在后面追加以下数据，并按顺序排列 */</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* followed by DexFieldAnnotationsItem[fieldsSize] */</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* followed by DexMethodAnnotationsItem[methodsSize] */</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* followed by DexParameterAnnotationsItem[parametersSize] */</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>printClassDefAnnotations函数用于打印该结构,根据不同注解类型调用不同函数解析</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// 打印ClassDef的所有Annotations
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">printClassDefAnnotations</span><span class="p">(</span><span class="n">DexAnnotationsDirectoryItem</span><span class="o">&amp;</span> <span class="n">annotationsDirectory</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//1. 类注解
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">annotationsDirectory</span><span class="p">.</span><span class="n">classAnnotationsOff</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">printClassAnnotations</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">DexAnnotationSetItem</span><span class="o">*</span><span class="p">)(</span><span class="n">baseAddr</span><span class="o">+</span><span class="n">annotationsDirectory</span><span class="p">.</span><span class="n">classAnnotationsOff</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;No Class Annotations</span><span class="se">\n\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//2. 域(字段)注解
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">annotationsDirectory</span><span class="p">.</span><span class="n">fieldsSize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printFieldAnnotations</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="n">DexFieldAnnotationsItem</span><span class="o">*</span><span class="p">)((</span><span class="n">uintptr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">annotationsDirectory</span>
</span></span><span class="line"><span class="cl">                <span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="n">DexAnnotationsDirectoryItem</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="p">,</span><span class="n">annotationsDirectory</span><span class="p">.</span><span class="n">fieldsSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;No Field Annotations</span><span class="se">\n\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//3. 方法注解
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">annotationsDirectory</span><span class="p">.</span><span class="n">methodsSize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printMethodAnnotations</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="n">DexMethodAnnotationsItem</span><span class="o">*</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">((</span><span class="n">uintptr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">annotationsDirectory</span>
</span></span><span class="line"><span class="cl">            <span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="n">DexAnnotationsDirectoryItem</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="n">DexFieldAnnotationsItem</span><span class="p">)</span><span class="o">*</span><span class="n">annotationsDirectory</span><span class="p">.</span><span class="n">fieldsSize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">,</span><span class="n">annotationsDirectory</span><span class="p">.</span><span class="n">methodsSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;No Method Annotations</span><span class="se">\n\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//4. 参数注解
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">annotationsDirectory</span><span class="p">.</span><span class="n">parametersSize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printParameterAnnotations</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="n">DexParameterAnnotationsItem</span><span class="o">*</span><span class="p">)((</span><span class="n">uintptr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">annotationsDirectory</span>
</span></span><span class="line"><span class="cl">            <span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="n">DexAnnotationsDirectoryItem</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="n">DexFieldAnnotationsItem</span><span class="p">)</span><span class="o">*</span><span class="n">annotationsDirectory</span><span class="p">.</span><span class="n">fieldsSize</span>
</span></span><span class="line"><span class="cl">            <span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="n">DexMethodAnnotationsItem</span><span class="p">)</span><span class="o">*</span><span class="n">annotationsDirectory</span><span class="p">.</span><span class="n">methodsSize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">,</span><span class="n">annotationsDirectory</span><span class="p">.</span><span class="n">parametersSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;No Parameter Annotations</span><span class="se">\n\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="类注解-dexannotationsetitem">类注解 DexAnnotationSetItem
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">DexAnnotationSetItem</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span>  <span class="n">size</span><span class="p">;</span>						<span class="cm">/* DexAnnotationItem的数量 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span>  <span class="n">entries</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>                 <span class="cm">/* entries数组,存储DexAnnotationItem的文件偏移量 */</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">DexAnnotationItem</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">u1</span>  <span class="n">visibility</span><span class="p">;</span>					<span class="cm">/* 此注释的预期可见性 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">u1</span>  <span class="n">annotation</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>              <span class="cm">/* encoded_annotation格式的注释内容 */</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>visibility表示注释的可见性，主要有以下几种情况：</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th style="text-align: left">名称</th>
          <th style="text-align: left">值</th>
          <th style="text-align: left">说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">VISIBILITY_BUILD</td>
          <td style="text-align: left">0x00</td>
          <td style="text-align: left">预计仅在构建（例如，在编译其他代码期间）时可见</td>
      </tr>
      <tr>
          <td style="text-align: left">VISIBILITY_RUNTIME</td>
          <td style="text-align: left">0x01</td>
          <td style="text-align: left">预计在运行时可见</td>
      </tr>
      <tr>
          <td style="text-align: left">VISIBILITY_SYSTEM</td>
          <td style="text-align: left">0x02</td>
          <td style="text-align: left">预计在运行时可见，但仅对基本系统（而不是常规用户代码）可见</td>
      </tr>
  </tbody>
</table></div>
<p>annotation是采用encoded_annotation格式的注释内容, <strong>encoded_annotation格式</strong>如下：</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th style="text-align: left">名称</th>
          <th style="text-align: left">格式</th>
          <th style="text-align: left">说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">type_idx</td>
          <td style="text-align: left">uleb128</td>
          <td style="text-align: left">注解的类型，指向DexTypeId列表的索引值</td>
      </tr>
      <tr>
          <td style="text-align: left">size</td>
          <td style="text-align: left">uleb128</td>
          <td style="text-align: left">此注解中 name-value 映射的数量</td>
      </tr>
      <tr>
          <td style="text-align: left">elements</td>
          <td style="text-align: left">annotation_element[size]</td>
          <td style="text-align: left">注解的元素，直接以内嵌形式（不作为偏移量）表示。元素必须按 <code>string_id</code> 索引以升序进行排序。</td>
      </tr>
  </tbody>
</table></div>
<p><strong>annotation_element元素格式</strong>如下：</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th style="text-align: left">名称</th>
          <th style="text-align: left">格式</th>
          <th style="text-align: left">说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">name_idx</td>
          <td style="text-align: left">uleb128</td>
          <td style="text-align: left">元素名称，指向DexStringId列表的索引值</td>
      </tr>
      <tr>
          <td style="text-align: left">value</td>
          <td style="text-align: left">encoded_value</td>
          <td style="text-align: left">元素值</td>
      </tr>
  </tbody>
</table></div>
<p><img src="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/8-DexAnnotationSetItem.png"
	width="1109"
	height="806"
	srcset="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/8-DexAnnotationSetItem_hu_825a0a814d3069d7.png 480w, /p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/8-DexAnnotationSetItem_hu_c69e68d90ef78ee0.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="137"
		data-flex-basis="330px"
	
></p>
<p>解析代码如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// Annotation functions
</span></span></span><span class="line"><span class="cl"><span class="c1">// 将权限修饰符和方法/类名组合
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">combineAccFlagsAndName</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">accFlags</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">accFlags</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span><span class="o">=</span><span class="n">name</span><span class="p">;</span><span class="c1">//无权限控制关键字,完整名即可
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span><span class="o">=</span><span class="n">accFlags</span><span class="o">+</span><span class="s">&#34; &#34;</span><span class="o">+</span><span class="n">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 打印DexAnnotationItem结构信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">printAnnotation</span><span class="p">(</span><span class="n">DexAnnotationItem</span><span class="o">&amp;</span> <span class="n">annotationItem</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">visibility</span><span class="p">;</span><span class="c1">//注解可见性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">switch</span><span class="p">(</span><span class="n">annotationItem</span><span class="p">.</span><span class="n">visibility</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">kDexVisibilityBuild</span><span class="p">:</span> <span class="n">visibility</span><span class="o">=</span><span class="s">&#34;build&#34;</span><span class="p">;</span><span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">kDexVisibilityRuntime</span><span class="p">:</span><span class="n">visibility</span><span class="o">=</span><span class="s">&#34;runtime&#34;</span><span class="p">;</span><span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">kDexVisibilitySystem</span><span class="p">:</span><span class="n">visibility</span><span class="o">=</span><span class="s">&#34;system&#34;</span><span class="p">;</span><span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="o">:</span><span class="n">visibility</span><span class="o">=</span><span class="s">&#34;unknown&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 解析encoded_annotation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">u1</span><span class="o">*</span> <span class="n">pAnnotation</span><span class="o">=</span><span class="n">annotationItem</span><span class="p">.</span><span class="n">annotation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">size_t</span> <span class="n">typeSize</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">sizeSize</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span> <span class="n">encoded_annotation_type_idx</span><span class="o">=</span><span class="n">myReadUnsignedLeb128</span><span class="p">(</span><span class="n">pAnnotation</span><span class="p">,</span><span class="o">&amp;</span><span class="n">typeSize</span><span class="p">);</span><span class="c1">//注解类型偏移
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">u4</span> <span class="n">encoded_annotation_size</span><span class="o">=</span><span class="n">myReadUnsignedLeb128</span><span class="p">(</span><span class="n">pAnnotation</span><span class="o">+</span><span class="n">typeSize</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sizeSize</span><span class="p">);</span><span class="c1">//注解name-value映射数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">encoded_annotation_type</span><span class="o">=</span><span class="n">parseString</span><span class="p">(</span><span class="n">getTypeIdDataByIndex</span><span class="p">(</span><span class="n">encoded_annotation_type_idx</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//Size Visibility Type
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%08d</span><span class="se">\t</span><span class="s">%s</span><span class="se">\t\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">encoded_annotation_size</span><span class="p">,</span><span class="n">visibility</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="n">encoded_annotation_type</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 解析encoded_annotation.elements
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">u1</span><span class="o">*</span> <span class="n">pAnnotationElements</span><span class="o">=</span><span class="n">pAnnotation</span><span class="o">+</span><span class="n">typeSize</span><span class="o">+</span><span class="n">sizeSize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">encoded_annotation_size</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">size_t</span> <span class="n">name_idx_size</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="c1">// name_idx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="o">=</span><span class="n">parseString</span><span class="p">(</span><span class="n">getStringIdDataByIndex</span><span class="p">(</span><span class="n">myReadUnsignedLeb128</span><span class="p">(</span><span class="n">pAnnotationElements</span><span class="p">,</span><span class="o">&amp;</span><span class="n">name_idx_size</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">        <span class="n">size_t</span> <span class="n">valueSize</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">value</span><span class="o">=</span><span class="n">parseString</span><span class="p">(</span><span class="n">parseEncodedValue</span><span class="p">(</span><span class="n">pAnnotationElements</span><span class="o">+</span><span class="n">name_idx_size</span><span class="p">,</span><span class="n">valueSize</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">%s=%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">name</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="n">value</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 打印DexAnnotationSetItem信息 即多个DexAnnotationItem结构
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">printAnnotationSet</span><span class="p">(</span><span class="n">DexAnnotationSetItem</span><span class="o">&amp;</span> <span class="n">annotationSet</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Size</span><span class="se">\t\t</span><span class="s">Visibility</span><span class="se">\t</span><span class="s">Type</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//AnnotationSetItem.entries[] 数组保存AnnotationItem结构的文件偏移值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">annotationSet</span><span class="p">.</span><span class="n">size</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printAnnotation</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">DexAnnotationItem</span><span class="o">*</span><span class="p">)(</span><span class="n">annotationSet</span><span class="p">.</span><span class="n">entries</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">baseAddr</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 打印所有类注解 DexAnnotationSetItem
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">printClassAnnotations</span><span class="p">(</span><span class="n">DexAnnotationSetItem</span><span class="o">&amp;</span> <span class="n">classAnnotations</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Class Annotations start at %#llx, contains %d entries</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,(</span><span class="n">uintptr_t</span><span class="p">)</span><span class="n">classAnnotations</span><span class="p">.</span><span class="n">entries</span><span class="o">-</span><span class="p">(</span><span class="n">uintptr_t</span><span class="p">)</span><span class="n">baseAddr</span><span class="p">,</span><span class="n">classAnnotations</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printAnnotationSet</span><span class="p">(</span><span class="n">classAnnotations</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Class Annotations End</span><span class="se">\n\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>效果如下, 打印类注解及其包含的encoded_element内容</p>
<p><img src="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/17-PrintClassDefClassAnnotations.png"
	width="864"
	height="451"
	srcset="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/17-PrintClassDefClassAnnotations_hu_4cbbae22ea8d6ce2.png 480w, /p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/17-PrintClassDefClassAnnotations_hu_423096572f1ae1b7.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="191"
		data-flex-basis="459px"
	
></p>
<h3 id="域注解-dexfieldannotationsitem">域注解 DexFieldAnnotationsItem
</h3><p>定义如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">DexFieldAnnotationsItem</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span>  <span class="n">fieldIdx</span><span class="p">;</span>					<span class="cm">/* 指向DexFieldId列表的索引值 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span>  <span class="n">annotationsOff</span><span class="p">;</span>             <span class="cm">/* DexAnnotationSetItem的文件偏移量 */</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>由于指向DexAnnotationSetItem结构,故解析方式和类注解类似</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// 打印所有域注解 DexFieldAnnotationsItem
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">printFieldAnnotations</span><span class="p">(</span><span class="n">DexFieldAnnotationsItem</span><span class="o">*</span> <span class="n">pFieldAnnotations</span><span class="p">,</span><span class="n">u4</span> <span class="n">fieldsNum</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Field Annotations start at %#llx, contains %d entries</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,(</span><span class="n">uintptr_t</span><span class="p">)</span><span class="n">pFieldAnnotations</span><span class="o">-</span><span class="p">(</span><span class="n">uintptr_t</span><span class="p">)</span><span class="n">baseAddr</span><span class="p">,</span><span class="n">fieldsNum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">fieldsNum</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">field</span><span class="o">=</span><span class="n">getFieldIdDataByIndex</span><span class="p">(</span><span class="n">pFieldAnnotations</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fieldIdx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Field%d:</span><span class="se">\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">field</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">printAnnotationSet</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">DexAnnotationSetItem</span><span class="o">*</span><span class="p">)(</span><span class="n">baseAddr</span><span class="o">+</span><span class="n">pFieldAnnotations</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">annotationsOff</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Field Annotations End</span><span class="se">\n\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>效果如下</p>
<p><img src="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/18-PrintClassDefFieldAnnotations.png"
	width="884"
	height="484"
	srcset="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/18-PrintClassDefFieldAnnotations_hu_16ba4a59ca0f311c.png 480w, /p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/18-PrintClassDefFieldAnnotations_hu_8c803ec6877b1a89.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="182"
		data-flex-basis="438px"
	
></p>
<h3 id="方法注解-dexmethodannotationsitem">方法注解 DexMethodAnnotationsItem
</h3><p>定义如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Direct-mapped &#34;method_annotations_item&#34;.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">DexMethodAnnotationsItem</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span>  <span class="n">methodIdx</span><span class="p">;</span>					<span class="cm">/* 指向DexMethodId列表的索引值 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span>  <span class="n">annotationsOff</span><span class="p">;</span>             <span class="cm">/* DexAnnotationSetItem的文件偏移量 */</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>解析方法类似</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// 打印方法注解 DexMethodAnnotationsItem
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">printMethodAnnotations</span><span class="p">(</span><span class="n">DexMethodAnnotationsItem</span><span class="o">*</span> <span class="n">pMethodAnnotations</span><span class="p">,</span><span class="n">u4</span> <span class="n">methodsNum</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Method Annotations start at %#llx, contains %d entries</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,(</span><span class="n">uintptr_t</span><span class="p">)</span> <span class="n">pMethodAnnotations</span><span class="o">-</span><span class="p">(</span><span class="n">uintptr_t</span><span class="p">)</span><span class="n">baseAddr</span><span class="p">,</span><span class="n">methodsNum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">methodsNum</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">method</span><span class="o">=</span><span class="n">getMethodIdDataByIndex</span><span class="p">(</span><span class="n">pMethodAnnotations</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">methodIdx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Method%d:</span><span class="se">\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">method</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">printAnnotationSet</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">DexAnnotationSetItem</span><span class="o">*</span><span class="p">)(</span><span class="n">baseAddr</span><span class="o">+</span> <span class="n">pMethodAnnotations</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">annotationsOff</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Method Annotations End</span><span class="se">\n\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>效果如下</p>
<h3 id="参数注解-dexparameterannotationsitem">参数注解 DexParameterAnnotationsItem
</h3><p>定义如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Direct-mapped &#34;parameter_annotations_item&#34;.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">DexParameterAnnotationsItem</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span>  <span class="n">methodIdx</span><span class="p">;</span>					<span class="cm">/* 指向DexMethodId列表的索引值 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span>  <span class="n">annotationsOff</span><span class="p">;</span>             <span class="cm">/* DexAnotationSetRefList的文件偏移量 */</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>DexAnotationSetRefList结构体定义如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Direct-mapped &#34;annotation_set_ref_list&#34;.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">DexAnnotationSetRefList</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span>  <span class="n">size</span><span class="p">;</span>							<span class="cm">/* 列表中元素个数，即DexAnnotationSetRefItem的个数 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">DexAnnotationSetRefItem</span> <span class="n">list</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>	<span class="cm">/* 第一个DexAnnotationSetRefItem的内容，非偏移量 */</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Direct-mapped &#34;annotation_set_ref_item&#34;.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">DexAnnotationSetRefItem</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span>  <span class="n">annotationsOff</span><span class="p">;</span>             <span class="cm">/* DexAnnotationSetItem的偏移量 */</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>解析方法略有不同,代码如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// 打印DexAnnotationSetRefList
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">printAnnotationSetRefList</span><span class="p">(</span><span class="n">DexAnnotationSetRefList</span><span class="o">&amp;</span> <span class="n">annotationSetRefList</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;AnnotationSetRefList contains %d AnnotationSetItems</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">annotationSetRefList</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// AnnotationSetRefList.list是AnnotationSetRefItem数组
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DexAnnotationSetRefItem</span><span class="o">*</span> <span class="n">pAnnotationSetRefItem</span><span class="o">=</span><span class="n">annotationSetRefList</span><span class="p">.</span><span class="n">list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">annotationSetRefList</span><span class="p">.</span><span class="n">size</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">pAnnotationSetRefItem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">annotationsOff</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">printf</span><span class="p">(</span><span class="s">&#34;No This Annotation Set!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span><span class="c1">//可能存在空项
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//AnnotationSetRefItem.annotationsOff指向AnnotationSetItem结构
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">printAnnotationSet</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">DexAnnotationSetItem</span><span class="o">*</span><span class="p">)(</span><span class="n">baseAddr</span><span class="o">+</span><span class="n">pAnnotationSetRefItem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">annotationsOff</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;AnnotationSetRefList End</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 打印参数注解 DexParameterAnnotationsItem
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">printParameterAnnotations</span><span class="p">(</span><span class="n">DexParameterAnnotationsItem</span><span class="o">*</span> <span class="n">pParameterAnnotations</span><span class="p">,</span><span class="n">u4</span> <span class="n">parametersNum</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Parameter Annotations start at %#llx, contains %d entries</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,(</span><span class="n">uintptr_t</span><span class="p">)</span> <span class="n">pParameterAnnotations</span><span class="o">-</span><span class="p">(</span><span class="n">uintptr_t</span><span class="p">)</span><span class="n">baseAddr</span><span class="p">,</span><span class="n">parametersNum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">parametersNum</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">method</span><span class="o">=</span><span class="n">getMethodIdDataByIndex</span><span class="p">(</span><span class="n">pParameterAnnotations</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">methodIdx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Method%d:</span><span class="se">\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">method</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// PatameterAnnotationsItem.annotationsOff指向DexAnnotationSetRefList结构,和其他三个不同
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">printAnnotationSetRefList</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">DexAnnotationSetRefList</span><span class="o">*</span><span class="p">)(</span><span class="n">baseAddr</span><span class="o">+</span><span class="n">pParameterAnnotations</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">annotationsOff</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Parameter Annotations End</span><span class="se">\n\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>效果如下</p>
<p><img src="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/20-PrintClassDefParameterAnnotations.png"
	width="1113"
	height="725"
	srcset="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/20-PrintClassDefParameterAnnotations_hu_f6b6f04e45e71e5.png 480w, /p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/20-PrintClassDefParameterAnnotations_hu_87d38c4b5928c59b.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="153"
		data-flex-basis="368px"
	
></p>
<h2 id="dexclassdata">DexClassData
</h2><p>定义在http://androidxref.com/2.3.7/xref/dalvik/libdex/DexClass.h中</p>
<p>注意: <strong>DexClass.h定义的结构体中,u4类型实际类型为uleb128</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* expanded form of class_data_item. Note: If a particular item is
</span></span></span><span class="line"><span class="cl"><span class="cm"> * absent (e.g., no static fields), then the corresponding pointer
</span></span></span><span class="line"><span class="cl"><span class="cm"> * is set to NULL. */</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">DexClassData</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DexClassDataHeader</span> <span class="n">header</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DexField</span><span class="o">*</span>          <span class="n">staticFields</span><span class="p">;</span>	<span class="c1">//下面4个连续数组,如果对应长度存在才有效
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DexField</span><span class="o">*</span>          <span class="n">instanceFields</span><span class="p">;</span>	<span class="c1">//按顺序排列	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DexMethod</span><span class="o">*</span>         <span class="n">directMethods</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DexMethod</span><span class="o">*</span>         <span class="n">virtualMethods</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">DexClassData</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>内部的结构体定义如下:</p>
<p>注意u4均为uleb128,所以这些结构大小不固定,无法通过sizeof计算,需要手动计算</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* expanded form of a class_data_item header */</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">DexClassDataHeader</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span> <span class="n">staticFieldsSize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span> <span class="n">instanceFieldsSize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span> <span class="n">directMethodsSize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span> <span class="n">virtualMethodsSize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">DexClassDataHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* expanded form of encoded_field */</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">DexField</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span> <span class="n">fieldIdx</span><span class="p">;</span>    <span class="cm">/* index to a field_id_item */</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span> <span class="n">accessFlags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">DexField</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* expanded form of encoded_method */</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">DexMethod</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span> <span class="n">methodIdx</span><span class="p">;</span>    <span class="cm">/* index to a method_id_item */</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span> <span class="n">accessFlags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span> <span class="n">codeOff</span><span class="p">;</span>      <span class="cm">/* file offset to a code_item */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">DexMethod</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中codeOff指向DexCode结构,定义如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Direct-mapped &#34;code_item&#34;.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * The &#34;catches&#34; table is used when throwing an exception,
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &#34;debugInfo&#34; is used when displaying an exception stack trace or
</span></span></span><span class="line"><span class="cl"><span class="cm"> * debugging. An offset of zero indicates that there are no entries.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">DexCode</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">u2</span>  <span class="n">registersSize</span><span class="p">;</span>		<span class="cm">/* 使用的寄存器个数 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">u2</span>  <span class="n">insSize</span><span class="p">;</span>			<span class="cm">/* 参数个数 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">u2</span>  <span class="n">outsSize</span><span class="p">;</span>			<span class="cm">/* 调用其他方法时使用的寄存器个数 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">u2</span>  <span class="n">triesSize</span><span class="p">;</span>			<span class="cm">/* try_item的个数 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span>  <span class="n">debugInfoOff</span><span class="p">;</span>       <span class="cm">/* 指向调试信息的文件偏移量 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span>  <span class="n">insnsSize</span><span class="p">;</span>          <span class="cm">/* 指令集个数，以2字节为单位 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">u2</span>  <span class="n">insns</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>			<span class="cm">/* 指令集，insns 数组中的代码格式由随附文档 Dalvik 字节码指定 */</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* 如果 triesSize 不为零，下面存在*/</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* 两字节填充，使下面的try_item实现4字节对齐 */</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* followed by try_item[triesSize]，用于表示代码中捕获异常的位置以及如何对异常进行处理的数组 */</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* followed by uleb128 handlersSize */</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* followed by catch_handler_item[handlersSize]，用于表示“捕获类型列表和关联处理程序地址”的列表的字节 */</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>解析代码如下,</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// 打印DexCode Todo: 解析DexCode字段
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">printDexCode</span><span class="p">(</span><span class="n">DexCode</span><span class="o">&amp;</span> <span class="n">dexCode</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 打印基本信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;DexCode:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;RegsNum</span><span class="se">\t\t</span><span class="s">ParamsNum</span><span class="se">\t</span><span class="s">OutsNum</span><span class="se">\t\t</span><span class="s">TriesNum</span><span class="se">\t</span><span class="s">DebugInfoOff</span><span class="se">\t</span><span class="s">InsnsNum</span><span class="se">\t</span><span class="s">InsnsOff</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%08d</span><span class="se">\t</span><span class="s">%08d</span><span class="se">\t</span><span class="s">%08d</span><span class="se">\t</span><span class="s">%08d</span><span class="se">\t</span><span class="s">%08x</span><span class="se">\t</span><span class="s">%08d</span><span class="se">\t</span><span class="s">%08x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">dexCode</span><span class="p">.</span><span class="n">registersSize</span><span class="p">,</span><span class="n">dexCode</span><span class="p">.</span><span class="n">insSize</span><span class="p">,</span><span class="n">dexCode</span><span class="p">.</span><span class="n">outsSize</span><span class="p">,</span><span class="n">dexCode</span><span class="p">.</span><span class="n">triesSize</span><span class="p">,</span><span class="n">dexCode</span><span class="p">.</span><span class="n">debugInfoOff</span><span class="p">,</span><span class="n">dexCode</span><span class="p">.</span><span class="n">insnsSize</span><span class="p">,(</span><span class="n">uintptr_t</span><span class="p">)</span><span class="n">dexCode</span><span class="p">.</span><span class="n">insns</span><span class="o">-</span><span class="p">(</span><span class="n">uintptr_t</span><span class="p">)</span><span class="n">baseAddr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 打印
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;DexCode End</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 打印DexClassData的DexField项目 返回对应数组结构的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">printClassDataItem</span><span class="p">(</span><span class="n">DexField</span><span class="o">*</span> <span class="n">pFields</span><span class="p">,</span><span class="n">u4</span> <span class="n">fieldsNum</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span> <span class="n">prevFieldIndex</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">fieldsNum</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">DexField</span><span class="o">*</span>  <span class="n">pField</span><span class="o">=</span><span class="p">(</span><span class="n">DexField</span><span class="o">*</span><span class="p">)((</span><span class="n">uintptr_t</span><span class="p">)</span><span class="n">pFields</span><span class="o">+</span><span class="n">offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 注意由于内部元素为uleb128类型,所以DexField大小并不固定,需要计算
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">size_t</span> <span class="n">fieldIndexSize</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">accessFlagsValueSize</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">u4</span> <span class="n">fieldIndex</span><span class="o">=</span><span class="n">myReadUnsignedLeb128</span><span class="p">((</span><span class="n">u1</span><span class="o">*</span><span class="p">)</span><span class="n">pField</span><span class="p">,</span><span class="o">&amp;</span><span class="n">fieldIndexSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">u4</span> <span class="n">accessFlagsValue</span><span class="o">=</span><span class="n">myReadUnsignedLeb128</span><span class="p">((</span><span class="n">u1</span><span class="o">*</span><span class="p">)</span><span class="n">pField</span><span class="o">+</span><span class="n">fieldIndexSize</span><span class="p">,</span><span class="o">&amp;</span><span class="n">accessFlagsValueSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">fieldName</span><span class="o">=</span><span class="n">getFieldIdDataByIndex</span><span class="p">(</span><span class="n">prevFieldIndex</span><span class="o">+</span><span class="n">fieldIndex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">accessFlags</span><span class="o">=</span><span class="n">parseAccessFlags</span><span class="p">(</span><span class="n">accessFlagsValue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Field%d: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">combineAccFlagsAndName</span><span class="p">(</span><span class="n">accessFlags</span><span class="p">,</span><span class="n">fieldName</span><span class="p">).</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">prevFieldIndex</span><span class="o">+=</span><span class="n">fieldIndex</span><span class="p">;</span><span class="c1">// 更新前一个filedIndex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">offset</span><span class="o">+=</span><span class="n">fieldIndexSize</span><span class="o">+</span><span class="n">accessFlagsValueSize</span><span class="p">;</span><span class="c1">//当前数组结构的偏移
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">offset</span><span class="p">;</span><span class="c1">//返回当前数组大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 打印DexClassData的DexMethod项目 返回对应数组结构的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">printClassDataItem</span><span class="p">(</span><span class="n">DexMethod</span><span class="o">*</span> <span class="n">pMethods</span><span class="p">,</span><span class="n">u4</span> <span class="n">methodsNum</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span> <span class="n">prevMethodIndex</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">methodsNum</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">DexMethod</span><span class="o">*</span> <span class="n">pMethod</span><span class="o">=</span><span class="p">(</span><span class="n">DexMethod</span><span class="o">*</span><span class="p">)((</span><span class="n">uintptr_t</span><span class="p">)</span><span class="n">pMethods</span><span class="o">+</span><span class="n">offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">size_t</span> <span class="n">methodIndexSize</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">accessFlagsValueSize</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">codeOffSize</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="c1">// 相比DexField多了codeOff,指向DexCode结构
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">u4</span> <span class="n">methodIndex</span><span class="o">=</span><span class="n">myReadUnsignedLeb128</span><span class="p">((</span><span class="n">u1</span><span class="o">*</span><span class="p">)</span><span class="n">pMethod</span><span class="p">,</span><span class="o">&amp;</span><span class="n">methodIndexSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">u4</span> <span class="n">accessFlagsValue</span><span class="o">=</span><span class="n">myReadUnsignedLeb128</span><span class="p">((</span><span class="n">u1</span><span class="o">*</span><span class="p">)</span><span class="n">pMethod</span><span class="o">+</span><span class="n">methodIndexSize</span><span class="p">,</span><span class="o">&amp;</span><span class="n">accessFlagsValueSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">u4</span> <span class="n">codeOff</span><span class="o">=</span><span class="n">myReadUnsignedLeb128</span><span class="p">((</span><span class="n">u1</span><span class="o">*</span><span class="p">)</span><span class="n">pMethod</span><span class="o">+</span><span class="n">methodIndexSize</span><span class="o">+</span><span class="n">accessFlagsValueSize</span><span class="p">,</span><span class="o">&amp;</span><span class="n">codeOffSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">methodName</span><span class="o">=</span><span class="n">getMethodIdDataByIndex</span><span class="p">(</span><span class="n">prevMethodIndex</span><span class="o">+</span><span class="n">methodIndex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">accessFlags</span><span class="o">=</span><span class="n">parseAccessFlags</span><span class="p">(</span><span class="n">accessFlagsValue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Method%d: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">combineAccFlagsAndName</span><span class="p">(</span><span class="n">accessFlags</span><span class="p">,</span><span class="n">methodName</span><span class="p">).</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">codeOff</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">printf</span><span class="p">(</span><span class="s">&#34;CodeOff: %08x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">codeOff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">printDexCode</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">DexCode</span><span class="o">*</span><span class="p">)(</span><span class="n">baseAddr</span><span class="o">+</span><span class="n">codeOff</span><span class="p">));</span><span class="c1">//打印codeOff指向的DexCode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;No DexCode</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">prevMethodIndex</span><span class="o">+=</span><span class="n">methodIndex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">offset</span><span class="o">+=</span><span class="n">methodIndexSize</span><span class="o">+</span><span class="n">accessFlagsValueSize</span><span class="o">+</span><span class="n">codeOffSize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 打印DexClassData
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">printClassDefClassData</span><span class="p">(</span><span class="n">DexClassData</span><span class="o">&amp;</span> <span class="n">classData</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;ClassData:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1.解析DexClassDataHeader 获取各uleb128字段保存的长度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">const</span> <span class="n">u1</span><span class="o">*</span> <span class="n">pClassDataHeader</span><span class="o">=</span><span class="p">(</span><span class="n">u1</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">classData</span><span class="p">.</span><span class="n">header</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">u1</span><span class="o">**</span> <span class="n">pPClassDataHeader</span><span class="o">=&amp;</span><span class="n">pClassDataHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span> <span class="n">staticFieldsNum</span><span class="o">=</span><span class="n">readUnsignedLeb128</span><span class="p">(</span><span class="n">pPClassDataHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span> <span class="n">instanceFieldsNum</span><span class="o">=</span><span class="n">readUnsignedLeb128</span><span class="p">(</span><span class="n">pPClassDataHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span> <span class="n">directMethodsNum</span><span class="o">=</span><span class="n">readUnsignedLeb128</span><span class="p">(</span><span class="n">pPClassDataHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span> <span class="n">virtualMethodsNum</span><span class="o">=</span><span class="n">readUnsignedLeb128</span><span class="p">(</span><span class="n">pPClassDataHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// pointer指向DexClassDataHeader后方第一个字节(即4个数组的内容),用于后续计算
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">uintptr_t</span> <span class="n">pointer</span><span class="o">=</span><span class="p">((</span><span class="n">uintptr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">classData</span><span class="o">+</span><span class="n">unsignedLeb128Size</span><span class="p">(</span><span class="n">staticFieldsNum</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                <span class="o">+</span><span class="n">unsignedLeb128Size</span><span class="p">(</span><span class="n">instanceFieldsNum</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                <span class="o">+</span><span class="n">unsignedLeb128Size</span><span class="p">(</span><span class="n">directMethodsNum</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                <span class="o">+</span><span class="n">unsignedLeb128Size</span><span class="p">(</span><span class="n">virtualMethodsNum</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 2. 解析各个字段(判断是否存在对应字段)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 注意:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 1. fieldIdx和accessFlags均为uleb128类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 2. 数组首个fieldIndex和methodIndex是正确的,后续index是相对前一个index的偏移值(大部分为1)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 3. 由于各个结构大小不固定,但是四个数组是连续的,所以要使用offset记录前方数据的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">staticFieldsNum</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;ClassData contains %d Static Fields:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">staticFieldsNum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">offset</span><span class="o">+=</span><span class="n">printClassDataItem</span><span class="p">((</span><span class="n">DexField</span><span class="o">*</span><span class="p">)(</span><span class="n">pointer</span><span class="o">+</span><span class="n">offset</span><span class="p">),</span><span class="n">staticFieldsNum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Static Fields End</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;No Static Field</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">instanceFieldsNum</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;ClassData contains %d Instance Fields:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">instanceFieldsNum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">offset</span><span class="o">+=</span><span class="n">printClassDataItem</span><span class="p">((</span><span class="n">DexField</span><span class="o">*</span><span class="p">)(</span><span class="n">pointer</span><span class="o">+</span><span class="n">offset</span><span class="p">),</span><span class="n">staticFieldsNum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Instance Fields End</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;No Instance Field</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">directMethodsNum</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;ClassData contains %d Directed Methods:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">directMethodsNum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">offset</span><span class="o">+=</span><span class="n">printClassDataItem</span><span class="p">((</span><span class="n">DexMethod</span><span class="o">*</span><span class="p">)(</span><span class="n">pointer</span><span class="o">+</span><span class="n">offset</span><span class="p">),</span><span class="n">directMethodsNum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Directed Methods End</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;No Directed Method</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">virtualMethodsNum</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;ClassData contains %d Virtual Methods:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">virtualMethodsNum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">offset</span><span class="o">+=</span><span class="n">printClassDataItem</span><span class="p">((</span><span class="n">DexMethod</span><span class="o">*</span><span class="p">)(</span><span class="n">pointer</span><span class="o">+</span><span class="n">offset</span><span class="p">),</span><span class="n">virtualMethodsNum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Virtual Methods End</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;No Virtual Method</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;ClassData End</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>效果如下</p>
<p><img src="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/21-PrintClassDefClassData.png"
	width="1115"
	height="787"
	srcset="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/21-PrintClassDefClassData_hu_d89c0202ee6343a0.png 480w, /p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/21-PrintClassDefClassData_hu_123ac9fb10dc3162.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="141"
		data-flex-basis="340px"
	
></p>
<h2 id="dexencodedarray">DexEncodedArray
</h2><p>定义如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">DexEncodedArray</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">u1</span>  <span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>		<span class="c1">//encoded_array格式的数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>encoded_array格式定义如下：</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th style="text-align: left">名称</th>
          <th style="text-align: left">格式</th>
          <th style="text-align: left">说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">size</td>
          <td style="text-align: left">uleb128</td>
          <td style="text-align: left">表示数组中的元素数量</td>
      </tr>
      <tr>
          <td style="text-align: left">values</td>
          <td style="text-align: left">encoded_value[size]</td>
          <td style="text-align: left">采用encoded_value编码的数据</td>
      </tr>
  </tbody>
</table></div>
<p>解析代码如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// 打印StaticValues 实际为DexEncodedArray结构
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">DexFile</span><span class="o">::</span><span class="n">printClassDefStaticValues</span><span class="p">(</span><span class="n">DexEncodedArray</span><span class="o">&amp;</span> <span class="n">encodedArray</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">size_t</span> <span class="n">sizeLen</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">u4</span> <span class="n">size</span><span class="o">=</span><span class="n">myReadUnsignedLeb128</span><span class="p">((</span><span class="n">u1</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">encodedArray</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sizeLen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">u1</span><span class="o">*</span> <span class="n">pValues</span><span class="o">=</span><span class="p">(</span><span class="n">u1</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">encodedArray</span><span class="o">+</span><span class="n">sizeLen</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;StaticValues contains %d values</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">size_t</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">readSize</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="c1">// offset保存前方已访问的结构大小,readSize为单次读取的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">size</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">parseEncodedValue</span><span class="p">(</span><span class="n">pValues</span><span class="o">+</span><span class="n">offset</span><span class="p">,</span><span class="n">readSize</span><span class="p">).</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">offset</span><span class="o">+=</span><span class="n">readSize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;StaticValues End</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>效果如下</p>
<p><img src="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/22-PrintClassStaticValues.png"
	width="636"
	height="483"
	srcset="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/22-PrintClassStaticValues_hu_3c887a41ed752f22.png 480w, /p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/22-PrintClassStaticValues_hu_50496af4d542ab4b.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="131"
		data-flex-basis="316px"
	
></p>
<h1 id="android系统可执行文件">Android系统可执行文件
</h1><h2 id="从jvm到dalvik再到art">从JVM到Dalvik再到ART
</h2><ol>
<li>
<p>JVM是java语言的虚拟机,运行.class文件</p>
</li>
<li>
<p>Dalvik是google设计的用于Android平台的虚拟机,运行.dex文件</p>
<p>JVM基于栈,DVM基于寄存器,可以做到更好的提前优化,并且运行速度更快</p>
</li>
<li>
<p>Android 4.4首次提出ART虚拟机,在Android 5.0后弃用Dalvik,默认使用ART,运行oat文件</p>
<p>DVM应用运行时,字节码需要通过即时编译器JIT转换为机器码运行</p>
<p>ART则在应用第一次安装时,预先将字节码编译为机器码,该过程称之为预编译(AOT Ahead of time)</p>
</li>
</ol>
<h2 id="dex">DEX
</h2><p>.java文件 经javac编译后生成 .class 文件 再通过dx/d8生成.dex文件</p>
<p>Dalvik虚拟机运行.dex文件,一个apk包内可能含有多个dex文件</p>
<h2 id="odex">ODEX
</h2><p>Android5.0前,使用Dalvik虚拟机,ODEX是Dalvik对Dex文件优化后的产物, 通常存放在/data/dalvik-cache目录下</p>
<p>运行程序时直接加载odex文件,避免重复验证和优化</p>
<p>Android 5.0后,使用ART虚拟机, .odex实际上是OAT文件(ART定制的ELF文件)</p>
<h2 id="oat">OAT
</h2><p>OAT文件是Android4.4中引入的, Android5.0后,系统默认虚拟机为ART</p>
<p>OAT文件即是ART虚拟机对Dex优化后的产物,是Android定制的ELF文件</p>
<p>OAT文件结构随Android版本变化而变化,没有向后兼容性</p>
<h2 id="vdex">VDEX
</h2><p>VDEX文件在Android 8.0后引入, 不是Android系统的可执行文件,</p>
<p>Android 8.0后, dex2oat将class.dex优化生成2个文件: OAT文件(.odex)和VDEX文件(.vdex)</p>
<ul>
<li>.odex文件包含了本机代码的OAT文件</li>
<li>.vdex文件包含了原始的dex文件副本</li>
<li>vdex文件同oat文件一样,随系统版本变化,且没有向后兼容性</li>
</ul>
<p><img src="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/OAT%E5%92%8CVDEX.png"
	width="1569"
	height="668"
	srcset="/p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/OAT%E5%92%8CVDEX_hu_e9428f9e8564686c.png 480w, /p/dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90-readdex%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0/OAT%E5%92%8CVDEX_hu_f4eaefbda2d8d986.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="234"
		data-flex-basis="563px"
	
></p>
<h2 id="art">ART
</h2><p>.art文件是一种ELF可执行文件 借助odex文件优化生成, 记录应用启动的热点函数相关地址,便于寻址加速</p>
<p>art文件结构随android版本变化,无向后兼容性</p>
<h1 id="todo">Todo
</h1><ol>
<li>完善encoded_value剩余3个分支解析逻辑</li>
<li>绘制Dex文件结构图加深理解</li>
<li>整理代码架构</li>
</ol>
<h1 id="references">References
</h1><p><a class="link" href="https://source.android.com/docs/core/dalvik/dex-format"  target="_blank" rel="noopener"
    >Dalvik 可执行文件格式 </a> Android官方文档</p>
<p><a class="link" href="https://xialuohun.top/posts/android/android%E5%9F%BA%E7%A1%80/dex%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F"  target="_blank" rel="noopener"
    >Dex文件格式</a></p>
<p><a class="link" href="https://gal2xy.github.io/2023/11/10/Android%E5%AE%89%E5%85%A8/dex%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E8%A7%A3%E6%9E%90"  target="_blank" rel="noopener"
    >dex文件格式解析</a></p>
<p><a class="link" href="https://cloud.tencent.com/developer/article/1634762"  target="_blank" rel="noopener"
    >从JVM到Dalivk再到ART（class,dex,odex,vdex,ELF）</a></p>
<p><a class="link" href="https://www.cnblogs.com/revercc/p/16677841.html"  target="_blank" rel="noopener"
    >android的dex，odex，oat，vdex，art文件格式</a></p>
<p><a class="link" href="https://www.52pojie.cn/thread-1992796-1-1.html"  target="_blank" rel="noopener"
    >一图全览DEX文件格式</a></p>

</section>


    <footer class="article-footer">
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI&#43;WdtXRGWt2kTvGFasHpSy3SV"crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG&#43;vnGctmUb0ZY0l8"crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"integrity="sha384-&#43;VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4&#43;/RRE05"crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.body, {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist"]
        });})
</script>
    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">相关文章</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/android%E4%BB%8E%E6%95%B4%E4%BD%93%E5%8A%A0%E5%9B%BA%E5%88%B0%E6%8A%BD%E5%8F%96%E5%8A%A0%E5%9B%BA%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86/">
        
        
            <div class="article-image">
                <img src="/p/android%E4%BB%8E%E6%95%B4%E4%BD%93%E5%8A%A0%E5%9B%BA%E5%88%B0%E6%8A%BD%E5%8F%96%E5%8A%A0%E5%9B%BA%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86/27-Apk%E5%90%88%E5%B9%B6%E5%9B%BE.46f2f51dac420eddd22372d9ad26e97c_hu_9ee9f24bdfd2b321.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Android从整体加固到抽取加固的实现及原理"
                        
                        data-hash="md5-RvL1HaxCDt3SI3LZrSbpfA==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Android从整体加固到抽取加固的实现及原理</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/">
        
        
            <div class="article-image">
                <img src="/p/elf%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%85%E6%9E%90-%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0/1-%E7%9B%AE%E6%A0%87%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F.fe2213b576eef45317998ee1c132656c_hu_fbc5ad0c4a06e52a.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post ELF文件结构浅析-解析器和加载器实现"
                        
                        data-hash="md5-/iITtXbu9FMXmY7hwTJlbA==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">ELF文件结构浅析-解析器和加载器实现</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/fridastudy/">
        
        

        <div class="article-details">
            <h2 class="article-title">FridaStudy</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/androidbasicstudy/">
        
        
            <div class="article-image">
                <img src="/p/androidbasicstudy/8_%E6%B4%BB%E5%8A%A8%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.b6d9e6ef6be71ee1bd6ad48f04fc0eb5_hu_b0bc600821d22529.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post AndroidBasicStudy"
                        
                        data-hash="md5-ttnm72vnHuG9atSPBPwOtQ==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">AndroidBasicStudy</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/ndkstudy/">
        
        

        <div class="article-details">
            <h2 class="article-title">NDKStudy</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script src="https://utteranc.es/client.js" 
        repo="OrientalGlass/utterances-comments"
        issue-term="pathname"
        
        crossorigin="anonymous"
        async
        >
</script>

<style>
    .utterances {
        max-width: unset;
    }
</style>

<script>
    let utterancesLoaded = false;

    function setUtterancesTheme(theme) {
        let utterances = document.querySelector('.utterances iframe');
        if (utterances) {
            utterances.contentWindow.postMessage(
                {
                    type: 'set-theme',
                    theme: `github-${theme}`
                },
                'https://utteranc.es'
            );
        }
    }

    addEventListener('message', event => {
        if (event.origin !== 'https://utteranc.es') return;

        
        utterancesLoaded = true;
        setUtterancesTheme(document.documentElement.dataset.scheme)
    });

    window.addEventListener('onColorSchemeChange', (e) => {
        if (!utterancesLoaded) return;
        setUtterancesTheme(e.detail)
    })
</script>


    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2024 - 
        
        2025 OrientalGlass
    </section>
    
    <section class="powerby">
        使用 <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> 构建 <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.27.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
